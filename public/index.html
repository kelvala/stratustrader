<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stratus Chart — Clean Boxes (Price • MACD • RSI) v.042</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    :root{
      /* Finviz-style dark palette */
      --bg:#0f1115; --text:#e5e7eb; --muted:#9ca3af;
      --panel:#121827; --border:#22304a; --hover:#141b2a;
      --accent:#22c55e; --focus:#3b82f6;
      --grid:#253146;
      --up:#16a34a; --down:#e11d48;
      --sma20:#22c55e; --sma50:#60a5fa; --sma200:#f59e0b;
      --rsi:#a78bfa; --macd:#38bdf8; --vol:#10b981;
      --ichi-tenkan:#f59e0b; --ichi-kijun:#60a5fa; --ichi-chikou:#93c5fd;
      --ichi-up:rgba(34,197,94,.32); --ichi-down:rgba(239,68,68,.28);
    }
    body{margin:0;background:var(--bg);color:var(--text);
         font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .container{max-width:1200px;margin:16px auto;padding:0 16px;}
    .toolbar{display:grid;gap:10px;grid-template-columns:1fr 1fr auto;align-items:end;
             background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;}
    @media (max-width:860px){ .toolbar{grid-template-columns:1fr; align-items:stretch;} }
    label{font-size:12px; font-weight:800; color:#cbd5ff; display:block; margin-bottom:6px;}
    select{width:100%; background:#0c1220; color:var(--text); border:1px solid var(--border);
           border-radius:10px; padding:10px;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);
          background:var(--panel);color:var(--text);font-weight:700;cursor:pointer;user-select:none}
    .chip.active{box-shadow:0 0 0 1px currentColor, 0 0 14px 3px currentColor}
    .chip[data-k="SMA20"]{color:var(--sma20); border-color:var(--sma20)}
    .chip[data-k="SMA50"]{color:var(--sma50); border-color:var(--sma50)}
    .chip[data-k="SMA200"]{color:var(--sma200); border-color:var(--sma200)}
    .chip[data-k="RSI"]{color:var(--rsi); border-color:var(--rsi)}
    .chip[data-k="MACD"]{color:var(--macd); border-color:var(--macd)}
    .chip[data-k="VOL"]{color:var(--vol); border-color:var(--vol)}
    .chip[data-k="ICHI"]{color:var(--sma50); border-color:var(--sma50)}
    .title{font-weight:900; letter-spacing:.2px; margin:0;}
    .row{display:grid; gap:16px; margin-top:16px;}
    .box{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px;}
    .box-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;}
    .box-title{font-weight:800; opacity:.95;}
    .box-sub{color:var(--muted); font-size:12px;}
    .divider{height:2px; background:linear-gradient(90deg, var(--focus), var(--accent)); opacity:.85; border-radius:999px; margin:6px 0 8px;}
    #priceChart, #macdChart, #rsiChart{height:56vh; min-height:420px;}
    #macdChart, #rsiChart{height:28vh; min-height:220px;}
    .legend-note{font-size:12px;color:var(--muted);}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">Stratus Chart</h1>
    <div class="toolbar">
      <div>
        <label for="timeSel">Time</label>
        <select id="timeSel">
          <option value="1d">1 day</option>
          <option value="2d">2 days</option>
          <option value="5d">5 days</option>
          <option value="10d">10 days</option>
          <option disabled>──────────</option>
          <option value="1mo">1 month</option>
          <option value="2mo">2 months</option>
          <option value="3mo">3 months</option>
          <option value="6mo" selected>6 months</option>
          <option value="ytd">YTD</option>
          <option value="1y">1 year</option>
          <option value="2y">2 years</option>
          <option value="5y">5 years</option>
          <option value="10y">10 years</option>
          <option value="max">Max</option>
        </select>
      </div>
      <div>
        <label for="freqSel">Frequency</label>
        <select id="freqSel">
          <option value="1m">1-Minute</option>
          <option value="5m">5-Minute</option>
          <option value="15m">15-Minute</option>
          <option value="60m">Hourly</option>
          <option disabled>──────────</option>
          <option value="1d" selected>Daily</option>
          <option value="1wk">Weekly</option>
          <option value="1mo">Monthly</option>
        </select>
      </div>
      <div class="chips" id="chips">
        <div class="chip active" data-k="SMA20">SMA 20</div>
        <div class="chip active" data-k="SMA50">SMA 50</div>
        <div class="chip active" data-k="SMA200">SMA 200</div>
        <div class="chip active" data-k="VOL">Volume</div>
        <div class="chip active" data-k="ICHI">Ichimoku</div>
        <div class="chip active" data-k="MACD">MACD</div>
        <div class="chip active" data-k="RSI">RSI</div>
      </div>
    </div>

    <div class="row">
      <!-- PRICE BOX -->
      <section class="box" id="boxPrice">
        <div class="box-header">
          <div>
            <div class="box-title" id="headline">—</div>
            <div class="legend-note"><span id="lastLine">Last: —</span> · <span id="prevCloseLine">Prev Close: —</span></div>
          </div>
          <div class="box-sub">Price</div>
        </div>
        <div class="divider" aria-hidden="true"></div>
        <div id="priceChart"></div>
      </section>

      <!-- MACD BOX -->
      <section class="box" id="boxMACD">
        <div class="box-header">
          <div class="box-title">MACD (12, 26, 9)</div>
          <div class="box-sub">Momentum</div>
        </div>
        <div class="divider" aria-hidden="true"></div>
        <div id="macdChart"></div>
      </section>

      <!-- RSI BOX -->
      <section class="box" id="boxRSI">
        <div class="box-header">
          <div class="box-title">RSI (14)</div>
          <div class="box-sub">Relative Strength</div>
        </div>
        <div class="divider" aria-hidden="true"></div>
        <div id="rsiChart"></div>
      </section>
    </div>
  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const css = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();

  const els = {
    time: $('#timeSel'), freq: $('#freqSel'), chips: $('#chips'),
    headline: $('#headline'), last: $('#lastLine'), prev: $('#prevCloseLine'),
    price: $('#priceChart'), macd: $('#macdChart'), rsi: $('#rsiChart')
  };

  /* ---------------- Utils ---------------- */
  const fmt = n => (Number.isFinite(n)?n.toFixed(2):'—');
  const debounce = (fn,ms) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
  const toET = (d)=> new Date(d.toLocaleString('en-US', { timeZone: 'America/New_York' }));
  const toETISO = (d)=> {
    const e = toET(d);
    return new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds())).toISOString();
  };

  /* ---------------- Data fetch ---------------- */
  function normalizePair(range,freq){
    const intraday = ['1m','5m','15m','60m'];
    if (intraday.includes(freq)) {
      const minFor = { '1m':'1d', '5m':'5d', '15m':'10d', '60m':'1mo' };
      const order = ['1d','2d','5d','10d','1mo','2mo','3mo','6mo','ytd','1y','2y','5y','10y','max'];
      const idx = v => Math.max(0,order.indexOf(v));
      const minRange=minFor[freq];
      if (idx(range) < idx(minRange)) range = minRange;
      return { range, interval: freq };
    }
    const map = { '1d':'1d', '1wk':'1wk', '1mo':'1mo' };
    return { range, interval: map[freq] || '1d' };
  }
  function getVisibleData(fullRows, range){
    if (range==='ytd'){
      const now = new Date();
      const jan1 = new Date(now.getFullYear(),0,1);
      return fullRows.filter(r => toET(r.date) >= toET(jan1));
    }
    const daysMap={'1d':1,'2d':2,'5d':5,'10d':10,'1mo':31,'2mo':62,'3mo':93,'6mo':182,'1y':365,'2y':730,'5y':1825,'10y':3650,'max':36500};
    const days = daysMap[range] ?? 365;
    const cutoff = new Date(Date.now() - days*864e5);
    return fullRows.filter(r => toET(r.date) >= toET(cutoff));
  }
  async function fetchChart(ticker, range, interval){
    try{
      const r = await fetch(`/api/chart?ticker=${encodeURIComponent(ticker)}&range=${range}&interval=${interval}`, { cache:'no-store' });
      if(!r.ok) throw new Error('chart '+r.status);
      const j = await r.json();
      const res = j?.chart?.result?.[0]; if(!res) throw new Error('no result');
      const q = res.indicators?.quote?.[0] || {};
      const ts = res.timestamp || [];
      const rows = [];
      for(let i=0;i<ts.length;i++){
        const o=q.open?.[i], h=q.high?.[i], l=q.low?.[i];
        const adj=res.indicators?.adjclose?.[0]?.adjclose;
        const c=(adj && adj[i]!=null) ? adj[i] : q.close?.[i];
        const v=q.volume?.[i];
        if([o,h,l,c].every(Number.isFinite)) rows.push({date:new Date(ts[i]*1000), o:+o,h:+h,l:+l,c:+c, v:Number.isFinite(+v)?+v:0});
      }
      return rows;
    }catch(e){ console.warn(e); return []; }
  }

  /* ---------------- Indicators ---------------- */
  function SMA(vals,w){ const out=new Array(vals.length).fill(null); let sum=0, cnt=0;
    for(let i=0;i<vals.length;i++){ const v=vals[i]; if(Number.isFinite(v)){sum+=v;cnt++;}
      if(i>=w){ const old=vals[i-w]; if(Number.isFinite(old)){sum-=old;cnt--;} }
      if(i>=w-1) out[i]=sum/cnt;
    } return out;
  }
  function EMA(vals,span){ const out=new Array(vals.length).fill(null); const k=2/(span+1); let ema=null;
    for(let i=0;i<vals.length;i++){ const v=vals[i]; if(!Number.isFinite(v)){ out[i]=(i>0?out[i-1]:null); continue; }
      ema = (ema==null) ? v : (v*k + ema*(1-k)); out[i]=ema; } return out;
  }
  function RSI(values, period=14){ const rsi=new Array(values.length).fill(null); if(values.length<=period) return rsi;
    let gain=0,loss=0; for(let i=1;i<=period;i++){ const d=values[i]-values[i-1]; if(d>0) gain+=d; else loss-=d; }
    gain/=period; loss/=period; rsi[period]=100-100/(1+(gain/(loss||1e-10)));
    for(let i=period+1;i<values.length;i++){ const d=values[i]-values[i-1];
      if(d>0){ gain=(gain*(period-1)+d)/period; loss=(loss*(period-1))/period; }
      else { gain=(gain*(period-1))/period; loss=(loss*(period-1)-d)/period; }
      rsi[i]=100-100/(1+(gain/(loss||1e-10)));
    } return rsi;
  }
  function MACD(closes,f=12,s=26,sig=9){
    const ef=EMA(closes,f), es=EMA(closes,s);
    const macd=closes.map((_,i)=> (ef[i]!=null && es[i]!=null)? ef[i]-es[i] : null);
    const signal=EMA(macd.map(v=>v==null?null:v), sig);
    const hist=macd.map((m,i)=> (m!=null && signal[i]!=null) ? (m - signal[i]) : null);
    return {macd, signal, hist};
  }

  /* ---------------- Ichimoku ---------------- */
  function rollingHigh(arr, w){ const out=new Array(arr.length).fill(null);
    for(let i=0;i<arr.length;i++){ if(i<w-1) continue; let hi=-Infinity; for(let j=i-w+1;j<=i;j++) if(Number.isFinite(arr[j])) hi=Math.max(hi,arr[j]); out[i]=Number.isFinite(hi)?hi:null; } return out; }
  function rollingLow(arr, w){ const out=new Array(arr.length).fill(null);
    for(let i=0;i<arr.length;i++){ if(i<w-1) continue; let lo=Infinity; for(let j=i-w+1;j<=i;j++) if(Number.isFinite(arr[j])) lo=Math.min(lo,arr[j]); out[i]=Number.isFinite(lo)?lo:null; } return out; }
  function shiftFwd(arr,k,n){ const out=new Array(n).fill(null); for(let i=0;i<n;i++) if(i+k<n) out[i+k]=arr[i]; return out; }
  function shiftBack(arr,k,n){ const out=new Array(n).fill(null); for(let i=0;i<n;i++) if(i-k>=0) out[i-k]=arr[i]; return out; }
  function calcIchimoku(rows){
    const n=rows.length, hi=rows.map(r=>r.h), lo=rows.map(r=>r.l), cl=rows.map(r=>r.c);
    const convHi=rollingHigh(hi,9),  convLo=rollingLow(lo,9);
    const kijHi =rollingHigh(hi,26), kijLo=rollingLow(lo,26);
    const spHi  =rollingHigh(hi,52), spLo =rollingLow(lo,52);
    const tenkan=convHi.map((h,i)=> (h!=null&&convLo[i]!=null)?(h+convLo[i])/2:null);
    const kijun =kijHi .map((h,i)=> (h!=null&&kijLo[i]!=null)?(h+kijLo[i])/2:null);
    const spanA0=tenkan.map((t,i)=> (t!=null&&kijun[i]!=null)?(t+kijun[i])/2:null);
    const spanB0=spHi.map((h,i)=> (h!=null&&spLo[i]!=null)?(h+spLo[i])/2:null);
    const shift=26, spanA=shiftFwd(spanA0,shift,n), spanB=shiftFwd(spanB0,shift,n), chikou=shiftBack(cl,shift,n);
    return { tenkan, kijun, spanA, spanB, chikou };
  }
  function fillEdges(arr){
    const out=arr.slice(); let last=null;
    for(let i=0;i<out.length;i++){ if(Number.isFinite(out[i])) last=out[i]; else if(last!=null) out[i]=last; }
    const fi=out.findIndex(v=>Number.isFinite(v)); if(fi>0){ for(let i=0;i<fi;i++) out[i]=out[fi]; }
    let li=-1; for(let i=out.length-1;i>=0;i--){ if(Number.isFinite(out[i])){ li=i; break; } } if(li>=0){ for(let i=li+1;i<out.length;i++) out[i]=out[li]; }
    return out;
  }
  function exaggerateCloud(A,B,mag=1.6,loClip=-Infinity,hiClip=Infinity){
    if(!(mag>1)) return {A,B};
    const a=A.slice(), b=B.slice();
    for(let i=0;i<a.length;i++){ const x=a[i], y=b[i]; if(!Number.isFinite(x)||!Number.isFinite(y)) continue; const mid=(x+y)/2, half=(x-y)/2; a[i]=Math.min(Math.max(mid+half*mag,loClip),hiClip); b[i]=Math.min(Math.max(mid-half*mag,loClip),hiClip); }
    return {A:a,B:b};
  }
  function segmentCloud(a,b){
    const n=a.length, gL=Array(n).fill(null), gU=Array(n).fill(null), rL=Array(n).fill(null), rU=Array(n).fill(null);
    for(let i=0;i<n;i++){ const A=a[i], B=b[i]; if(!Number.isFinite(A)||!Number.isFinite(B)) continue; if(A>=B){ gL[i]=B; gU[i]=A; } else { rL[i]=A; rU[i]=B; } }
    return {gL,gU,rL,rU};
  }

  /* ---------------- Axis fitting (PRICE ONLY) ---------------- */
  async function fitPriceAxisToCandlesStrict(){
    const gd = els.price;
    const data = gd.data || []; const c = data.find(t => t.type==='candlestick'); if(!c) return;
    const toMs = v => new Date(v).getTime();
    const L = gd._fullLayout || gd.layout || {}; const xa = L.xaxis || {};
    let x0ms, x1ms;
    if (Array.isArray(xa.range) && xa.autorange===false) { x0ms = toMs(xa.range[0]); x1ms = toMs(xa.range[1]); }
    else { x0ms = toMs(c.x[0]); x1ms = toMs(c.x[c.x.length-1]); }
    const cx = c.x.map(toMs);
    let i0=0; while(i0<cx.length && cx[i0]<x0ms) i0++;
    let i1=cx.length-1; while(i1>i0 && cx[i1]>x1ms) i1--;
    if(i1<=i0) return;
    let hi=-Infinity, lo=Infinity;
    for(let i=i0;i<=i1;i++){ const H=c.high[i], Lw=c.low[i]; if(Number.isFinite(H)) hi=Math.max(hi,H); if(Number.isFinite(Lw)) lo=Math.min(lo,Lw); }
    if(!Number.isFinite(hi)||!Number.isFinite(lo)) return;
    if(hi===lo){ hi+=1; lo-=1; }
    const pad = Math.max((hi-lo)*0.08, 0.5);
    try {
      await Plotly.relayout(gd, { 'yaxis.autorange': false, 'yaxis.range': [lo-pad, hi+pad], 'yaxis.rangemode':'normal' });
    } catch {}
  }

  /* ---------------- Draw ---------------- */
  async function draw(ticker){
    const range = els.time.value;
    const freq  = els.freq.value;
    const {range:rg, interval:intv} = normalizePair(range, freq);
    const full = await fetchChart(ticker, rg, intv);
    if(!full.length){ els.headline.textContent=ticker; els.last.textContent='Last: —'; els.prev.textContent='Prev Close: —'; return; }

    let vis = getVisibleData(full, range);
    const x = vis.map(r=>toETISO(r.date)), o=vis.map(r=>r.o), h=vis.map(r=>r.h), l=vis.map(r=>r.l), c=vis.map(r=>r.c), v=vis.map(r=>r.v);

    const sma20=SMA(c,20), sma50=SMA(c,50), sma200=SMA(c,200);
    const rsi = RSI(c,14);
    const m   = MACD(c,12,26,9);

    const last=c.at(-1), prev=c.length>1?c.at(-2):null;
    els.headline.textContent=`${ticker}`;
    els.last.textContent=`Last: $${fmt(last)}`;
    els.prev.textContent=`Prev Close: ${prev==null?'—':'$'+fmt(prev)}`;

    /* --- PRICE box --- */
    const tracesPrice = [];
    // Ichimoku (optional)
    if(chipOn('ICHI')){
      const ichi = calcIchimoku(vis);
      const hiVis=Math.max(...h.filter(Number.isFinite)), loVis=Math.min(...l.filter(Number.isFinite)), pad=(hiVis-loVis)*0.04;
      let A=fillEdges(ichi.spanA), B=fillEdges(ichi.spanB);
      ({A,B}=exaggerateCloud(A,B,1.8, loVis-pad, hiVis+pad));
      const seg=segmentCloud(A,B);
      tracesPrice.push(
        {type:'scatter', x, y:seg.gL, line:{width:0}, hoverinfo:'skip', showlegend:false, connectgaps:true},
        {type:'scatter', x, y:seg.gU, fill:'tonexty', line:{width:0}, fillcolor:css('--ichi-up'), hoverinfo:'skip', name:'Kumo +', opacity:1, connectgaps:true},
        {type:'scatter', x, y:seg.rL, line:{width:0}, hoverinfo:'skip', showlegend:false, connectgaps:true},
        {type:'scatter', x, y:seg.rU, fill:'tonexty', line:{width:0}, fillcolor:css('--ichi-down'), hoverinfo:'skip', name:'Kumo -', opacity:1, connectgaps:true},
        {type:'scatter', x, y:ichi.tenkan, name:'Tenkan', line:{color:css('--ichi-tenkan'), width:1}},
        {type:'scatter', x, y:ichi.kijun,  name:'Kijun',  line:{color:css('--ichi-kijun'),  width:1}},
        {type:'scatter', x, y:ichi.chikou, name:'Chikou', line:{color:css('--ichi-chikou'), width:1}}
      );
    }

    tracesPrice.push({
      type:'candlestick', x, open:o, high:h, low:l, close:c, name:ticker,
      increasing:{line:{color:css('--up'), width:1.15}}, decreasing:{line:{color:css('--down'), width:1.15}},
      whiskerwidth:0.4, opacity:0.95,
      hovertemplate:'O %{open:.2f}<br>H %{high:.2f}<br>L %{low:.2f}<br>C %{close:.2f}<extra></extra>'
    });
    if(chipOn('SMA20')) tracesPrice.push({type:'scatter', x, y:sma20,  name:'SMA 20',  line:{color:css('--sma20'), width:1.3}});
    if(chipOn('SMA50')) tracesPrice.push({type:'scatter', x, y:sma50,  name:'SMA 50',  line:{color:css('--sma50'), width:1.3}});
    if(chipOn('SMA200'))tracesPrice.push({type:'scatter', x, y:sma200, name:'SMA 200', line:{color:css('--sma200'), width:1.3}});
    if(chipOn('VOL'))   tracesPrice.push({type:'bar', x, y:v, name:'Volume', opacity:.35, yaxis:'y2', marker:{color:css('--vol')}});

    const layoutPrice = {
      margin:{l:56,r:28,t:6,b:24},
      xaxis:{showgrid:true, gridcolor:css('--grid')},
      yaxis:{title:'Price', side:'right', showgrid:true, gridcolor:css('--grid')},
      yaxis2:{overlaying:'y', side:'right', showgrid:false},
      legend:{orientation:'h'},
      paper_bgcolor:getComputedStyle($('#boxPrice')).backgroundColor,
      plot_bgcolor:getComputedStyle($('#boxPrice')).backgroundColor
    };

    await Plotly.newPlot(els.price, tracesPrice, layoutPrice, {responsive:true, displaylogo:false});
    await fitPriceAxisToCandlesStrict();
    els.price.on('plotly_relayout', debounce(fitPriceAxisToCandlesStrict, 60));

    /* --- MACD box --- */
    const tracesMACD=[
      {type:'scatter', x, y:m.macd,   name:'MACD',   line:{color:css('--macd'), width:1.2}},
      {type:'scatter', x, y:m.signal, name:'Signal', line:{width:1}},
      {type:'bar',     x, y:m.hist,   name:'Hist',   opacity:.45}
    ];
    const layoutMACD={
      margin:{l:56,r:28,t:6,b:24},
      xaxis:{showgrid:true, gridcolor:css('--grid')},
      yaxis:{title:'MACD', side:'right', showgrid:true, gridcolor:css('--grid')},
      paper_bgcolor:getComputedStyle($('#boxMACD')).backgroundColor,
      plot_bgcolor:getComputedStyle($('#boxMACD')).backgroundColor,
      showlegend:true,
      legend:{orientation:'h'}
    };
    await Plotly.newPlot(els.macd, tracesMACD, layoutMACD, {responsive:true, displaylogo:false});

    /* --- RSI box --- */
    const tracesRSI=[
      {type:'scatter', x, y:rsi, name:'RSI', line:{color:css('--rsi'), width:1.2}},
      {type:'scatter', x, y:Array(x.length).fill(70), name:'70', line:{dash:'dot', width:.9}},
      {type:'scatter', x, y:Array(x.length).fill(30), name:'30', line:{dash:'dot', width:.9}}
    ];
    const layoutRSI={
      margin:{l:56,r:28,t:6,b:24},
      xaxis:{showgrid:true, gridcolor:css('--grid')},
      yaxis:{title:'RSI', range:[0,100], side:'right', showgrid:true, gridcolor:css('--grid')},
      paper_bgcolor:getComputedStyle($('#boxRSI')).backgroundColor,
      plot_bgcolor:getComputedStyle($('#boxRSI')).backgroundColor,
      showlegend:true,
      legend:{orientation:'h'}
    };
    await Plotly.newPlot(els.rsi, tracesRSI, layoutRSI, {responsive:true, displaylogo:false});
  }

  /* ---------------- State & controls ---------------- */
  const active = new Set(['SMA20','SMA50','SMA200','VOL','ICHI','MACD','RSI']);
  function chipOn(k){ return active.has(k); }
  els.chips.addEventListener('click', e=>{
    const el=e.target.closest('.chip'); if(!el) return;
    const k=el.dataset.k; if(!k) return;
    if(active.has(k)){ active.delete(k); el.classList.remove('active'); }
    else { active.add(k); el.classList.add('active'); }
    go();
  });
  els.time.addEventListener('change', ()=>go());
  els.freq.addEventListener('change', ()=>go());

  async function go(){
    const t = (window.location.hash.replace('#','') || 'TSLA').toUpperCase();
    await draw(t);
  }

  // initialize
  document.querySelectorAll('.chip').forEach(c=>c.classList.add('active'));
  go();

})();</script>
</body>
</html>
