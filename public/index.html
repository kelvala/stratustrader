<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stratus Chart v.039</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    :root{
      --bg:#0f1115; --text:#e5e7eb; --muted:#9ca3af;
      --panel:#121827; --border:#22304a; --grid:#253146;
      --up:#22c55e; --down:#ef4444;
      --sma20:#22c55e; --sma50:#60a5fa; --sma200:#f59e0b;
      --rsi:#a78bfa; --macd:#38bdf8; --vol:#10b981;
      --ichi-tenkan:#f59e0b; --ichi-kijun:#60a5fa; --ichi-chikou:#93c5fd;
      --ichi-up:rgba(34,197,94,.28); --ichi-down:rgba(239,68,68,.22);
      --fib-line:#93c5fd; --fib-major:#c084fc; --fib-zone:rgba(147,197,253,.10); --fib-label-bg:#0b1020;
      --focus:#3b82f6;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .container{max-width:1200px;margin:16px auto;padding:0 16px;}
    .title{font-weight:900;margin:0 0 10px 0;}

    .toolbar{display:grid;gap:10px;grid-template-columns:minmax(260px,1fr) 130px 150px 1fr;align-items:end;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;}
    @media (max-width:980px){ .toolbar{grid-template-columns:1fr 1fr;} }
    @media (max-width:640px){ .toolbar{grid-template-columns:1fr;} }

    label{font-size:12px;font-weight:800;color:#cbd5ff;display:block;margin-bottom:6px;}
    select,input{width:100%;background:#0c1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;outline:none}
    input:focus,select:focus{box-shadow:0 0 0 2px var(--focus)}
    #tickerInput{text-transform:uppercase}
    .input-row{display:flex;gap:8px;align-items:center}
    .btn{height:40px;padding:0 12px;border:1px solid var(--border);background:#0c1220;color:#cbd5ff;border-radius:10px;font-weight:800;cursor:pointer}
    .btn:hover{background:#101831}
    .btn-go{min-width:70px}

    .chips{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end;}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#101826;color:var(--text);font-weight:700;cursor:pointer;user-select:none}
    .chip.active{box-shadow:0 0 0 1px currentColor, 0 0 16px 3px currentColor}
    .chip[data-k="SMA20"]{color:var(--sma20);border-color:var(--sma20)}
    .chip[data-k="SMA50"]{color:var(--sma50);border-color:var(--sma50)}
    .chip[data-k="SMA200"]{color:var(--sma200);border-color:var(--sma200)}
    .chip[data-k="VOL"]{color:var(--vol);border-color:var(--vol)}
    .chip[data-k="ICHI"]{color:var(--sma50);border-color:var(--sma50)}
    .chip[data-k="FIB"]{color:var(--fib-line);border-color:var(--fib-line)}
    .chip[data-k="MACD"]{color:var(--macd);border-color:var(--macd)}
    .chip[data-k="RSI"]{color:var(--rsi);border-color:var(--rsi)}

    .row{display:grid;gap:16px;margin-top:16px;}
    .box{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;}
    .box-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
    .box-title{font-weight:900;font-size:22px;}
    .divider{height:2px;background:linear-gradient(90deg,#60a5fa,#22c55e);opacity:.9;border-radius:999px;margin:6px 0 8px;}

    #priceChart{height:56vh;min-height:420px;}
    #macdChart,#rsiChart{height:28vh;min-height:220px;}

    .legend-note{font-size:13px;color:#cbd5e1;display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid transparent;font-weight:800}
    .pill.up{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.45);color:#86efac;}
    .pill.down{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.45);color:#fecaca;}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">Stratus Chart</h1>

    <div class="toolbar">
      <div>
        <label for="tickerInput">Ticker</label>
        <div class="input-row">
          <input id="tickerInput" type="text" placeholder="TSLA" autocapitalize="characters" autocorrect="off" spellcheck="false" autocomplete="on" list="tickerList" enterkeyhint="go" />
          <button id="btnGo" class="btn btn-go" title="Load (Enter)">Go ↵</button>
          <button id="btnRefresh" class="btn" title="Refresh current">↻</button>
        </div>
        <datalist id="tickerList"></datalist>
      </div>

      <div>
        <label for="timeSel">Time</label>
        <select id="timeSel">
          <option value="1d">1 d</option><option value="2d">2 d</option><option value="5d">5 d</option><option value="10d">10 d</option>
          <option disabled>──────────</option>
          <option value="1mo">1 m</option><option value="2mo">2 m</option><option value="3mo">3 m</option>
          <option value="6mo" selected>6 m</option><option value="ytd">YTD</option><option value="1y">1 y</option>
          <option value="2y">2 y</option><option value="5y">5 y</option><option value="10y">10 y</option><option value="max">Max</option>
        </select>
      </div>

      <div>
        <label for="freqSel">Frequency</label>
        <select id="freqSel">
          <option value="1m">1-min</option><option value="5m">5-min</option><option value="15m">15-min</option><option value="60m">Hourly</option>
          <option disabled>──────────</option><option value="1d" selected>Daily</option><option value="1wk">Weekly</option><option value="1mo">Monthly</option>
        </select>
      </div>

      <div class="chips" id="chips">
        <div class="chip" data-k="SMA20">SMA 20</div>
        <div class="chip" data-k="SMA50">SMA 50</div>
        <div class="chip" data-k="SMA200">SMA 200</div>
        <div class="chip" data-k="VOL">Volume</div>
        <div class="chip" data-k="ICHI">Ichimoku</div>
        <div class="chip" data-k="FIB">Auto Fib</div>
        <div class="chip" data-k="MACD">MACD</div>
        <div class="chip" data-k="RSI">RSI</div>
      </div>
    </div>

    <div class="row">
      <section class="box" id="boxPrice">
        <div class="box-header">
          <div>
            <div class="box-title" id="headline">—</div>
            <div class="legend-note">
              <span id="lastLine">Last: —</span>
              <span id="deltaLine" class="pill muted">—</span>
              <span id="prevCloseLine" class="muted">Prev Close: —</span>
              <span id="updatedLine" class="muted">Updated: —</span>
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <div id="priceChart"></div>
      </section>

      <section class="box" id="boxMACD">
        <div class="box-header">
          <div class="box-title">MACD (12, 26, 9)</div>
          <div class="muted">Momentum</div>
        </div>
        <div class="divider"></div>
        <div id="macdChart"></div>
      </section>

      <section class="box" id="boxRSI">
        <div class="box-header">
          <div class="box-title">RSI (14)</div>
          <div class="muted">Relative Strength</div>
        </div>
        <div class="divider"></div>
        <div id="rsiChart"></div>
      </section>
    </div>
  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const css = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();

  const els = {
    tkr: $('#tickerInput'), time: $('#timeSel'), freq: $('#freqSel'), chips: $('#chips'),
    headline: $('#headline'), last: $('#lastLine'), prev: $('#prevCloseLine'),
    delta: $('#deltaLine'), updated: $('#updatedLine'),
    price: $('#priceChart'), macd: $('#macdChart'), rsi: $('#rsiChart'),
    goBtn: $('#btnGo'), refreshBtn: $('#btnRefresh')
  };

  /* ===== State: persist indicator toggles ===== */
  const STORAGE_KEY = 'stratus.indicators.v1';
  const DEFAULT_ACTIVE = new Set(['SMA20','SMA50','SMA200']); // only these ON by default
  function loadActive(){
    try { const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)); return arr ? new Set(arr) : new Set(DEFAULT_ACTIVE); }
    catch { return new Set(DEFAULT_ACTIVE); }
  }
  function saveActive(set){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify([...set])); } catch{} }
  let active = loadActive();
  function syncChips(){
    document.querySelectorAll('.chip').forEach(ch=>{
      const k=ch.dataset.k; ch.classList.toggle('active', active.has(k));
    });
  }
  syncChips();

  /* ===== Utilities ===== */
  const fmt = n => (Number.isFinite(n)?n.toFixed(2):'—');
  const debounce = (fn,ms) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
  const toET = (d)=> new Date(d.toLocaleString('en-US', { timeZone: 'America/New_York' }));
  const toETISO = (d)=> { const e=toET(d);
    return new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds())).toISOString();
  };
  const getTicker = () => (els.tkr.value.trim() || (window.location.hash.replace('#','') || 'TSLA')).toUpperCase();
  const etTime = () => new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'America/New_York'}) + ' ET';

  /* ===== Data fetch & normalization ===== */
  const order=['1d','2d','5d','10d','1mo','2mo','3mo','6mo','ytd','1y','2y','5y','10y','max'];
  const daysMap={'1d':1,'2d':2,'5d':5,'10d':10,'1mo':31,'2mo':62,'3mo':93,'6mo':182,'ytd':365,'1y':365,'2y':730,'5y':1825,'10y':3650,'max':36500};
  const bumpToAtLeast=(range,target)=> order.indexOf(range)<order.indexOf(target)?target:range;

  function normalizePair(range,freq){
    const intraday=['1m','5m','15m','60m'];
    if(intraday.includes(freq)){
      const minFor={ '1m':'1d','5m':'5d','15m':'10d','60m':'1mo' };
      if(order.indexOf(range)<order.indexOf(minFor[freq])) range=minFor[freq];
      return {range, interval:freq};
    }
    const map={'1d':'1d','1wk':'1wk','1mo':'1mo'};
    return {range, interval:map[freq]||'1d'};
  }
  function getVisibleIdx(fullRows, range){
    let startCut;
    if(range==='ytd'){ const now=new Date(); startCut = new Date(now.getFullYear(),0,1); }
    else{ const days=daysMap[range]??365; startCut = new Date(Date.now()-days*864e5); }
    const idx=[]; for(let i=0;i<fullRows.length;i++){ if(toET(fullRows[i].date)>=toET(startCut)) idx.push(i); }
    return idx;
  }
  async function fetchChart(ticker, range, interval){
    try{
      const r=await fetch(`/api/chart?ticker=${encodeURIComponent(ticker)}&range=${range}&interval=${interval}`,{cache:'no-store'});
      if(!r.ok) throw new Error('chart '+r.status);
      const j=await r.json(); const res=j?.chart?.result?.[0]; if(!res) throw new Error('no result');
      const q=res.indicators?.quote?.[0]||{}; const ts=res.timestamp||[];
      const rows=[];
      for(let i=0;i<ts.length;i++){
        const o=q.open?.[i],h=q.high?.[i],l=q.low?.[i];
        const adj=res.indicators?.adjclose?.[0]?.adjclose;
        const c=(adj && adj[i]!=null)?adj[i]:q.close?.[i];
        const v=q.volume?.[i];
        if([o,h,l,c].every(Number.isFinite)) rows.push({date:new Date(ts[i]*1000),o:+o,h:+h,l:+l,c:+c,v:Number.isFinite(+v)?+v:0});
      }
      return rows;
    }catch(e){ console.warn(e); return []; }
  }

  /* ===== Indicators ===== */
  function SMA(vals,w){ const out=new Array(vals.length).fill(null); let sum=0,cnt=0;
    for(let i=0;i<vals.length;i++){ const v=vals[i]; if(Number.isFinite(v)){sum+=v;cnt++;}
      if(i>=w){ const old=vals[i-w]; if(Number.isFinite(old)){sum-=old;cnt--;} }
      if(i>=w-1) out[i]=sum/cnt; } return out;
  }
  function EMA(vals,span){ const out=new Array(vals.length).fill(null); const k=2/(span+1); let ema=null;
    for(let i=0;i<vals.length;i++){ const v=vals[i]; if(!Number.isFinite(v)){ out[i]=(i>0?out[i-1]:null); continue; }
      ema = (ema==null) ? v : (v*k + ema*(1-k)); out[i]=ema; } return out;
  }
  function RSI(values,period=14){ const rsi=new Array(values.length).fill(null); if(values.length<=period) return rsi;
    let g=0,l=0; for(let i=1;i<=period;i++){ const d=values[i]-values[i-1]; if(d>0) g+=d; else l-=d; }
    g/=period; l/=period; rsi[period]=100-100/(1+(g/(l||1e-10)));
    for(let i=period+1;i<values.length;i++){ const d=values[i]-values[i-1];
      if(d>0){ g=(g*(period-1)+d)/period; l=(l*(period-1))/period; }
      else   { g=(g*(period-1))/period;    l=(l*(period-1)-d)/period; }
      rsi[i]=100-100/(1+(g/(l||1e-10)));
    } return rsi;
  }

  /* ==== helpers ==== */
  function fillEdges(arr){ // carry first/last valid values to edges and forward-fill gaps
    const out = arr.slice();
    let last = null;
    for(let i=0;i<out.length;i++){ if(Number.isFinite(out[i])) last = out[i]; else if(last!=null) out[i]=last; }
    const fi = out.findIndex(v=>Number.isFinite(v));
    if(fi>0) for(let i=fi-1;i>=0;i--) out[i]=out[fi];
    return out;
  }

  /* ===== Price fit + Auto Fib ===== */
  async function fitPriceAxisToCandlesStrict(){
    const gd=els.price, data=gd.data||[]; const c=data.find(t=>t.type==='candlestick'); if(!c) return;
    const toMs=v=>new Date(v).getTime();
    const L=gd._fullLayout||gd.layout||{}, xa=L.xaxis||{};
    let x0ms,x1ms;
    if(Array.isArray(xa.range)&&xa.autorange===false){ x0ms=toMs(xa.range[0]); x1ms=toMs(xa.range[1]); }
    else { x0ms=toMs(c.x[0]); x1ms=toMs(c.x[c.length-1]); }
    const cx=c.x.map(toMs); let i0=0; while(i0<cx.length&&cx[i0]<x0ms) i0++; let i1=cx.length-1; while(i1>i0&&cx[i1]>x1ms) i1--;
    if(i1<=i0) return;
    let hi=-Infinity,lo=Infinity;
    for(let i=i0;i<=i1;i++){ hi=Math.max(hi,c.high[i]); lo=Math.min(lo,c.low[i]); }
    if(!(isFinite(hi)&&isFinite(lo))) return;
    if(hi===lo){ hi+=1; lo-=1; }
    const pad=Math.max((hi-lo)*0.08,0.5);
    try{ await Plotly.relayout(gd,{ 'yaxis.autorange':false,'yaxis.range':[lo-pad,hi+pad],'yaxis.rangemode':'normal' }); }catch{}
  }
  function rangeBreaksFor(interval){
    const rb=[{pattern:'day of week', bounds:[6,1]}];
    if(['1m','5m','15m','60m'].includes(interval)){ rb.push({pattern:'hour', bounds:[16,9]}); }
    return rb;
  }
  function fibLevels(hi,lo){ const span=hi-lo; const P=[1,0.786,0.618,0.5,0.382,0.236,0]; return P.map(p=>({pct:p,y:lo+span*p})); }
  function rightX(gd){ const L=gd._fullLayout||gd.layout||{}, xa=L.xaxis||{}; if(Array.isArray(xa.range)) return xa.range[1]; const c=(gd.data||[]).find(t=>t.type==='candlestick'); return c?c.x[c.x.length-1]:null; }
  async function updateAutoFib(){
    if(!active.has('FIB')){ const L=els.price.layout||els.price._fullLayout||{}; const shapes=(L.shapes||[]).filter(s=>!s._fib); const ann=(L.annotations||[]).filter(a=>!a._fib); await Plotly.relayout(els.price,{shapes,annotations:ann}); return; }
    const data=els.price.data||[]; const c=data.find(t=>t.type==='candlestick'); if(!c) return;
    const toMs=v=>new Date(v).getTime(); const L=els.price._fullLayout||els.price.layout||{}, xa=L.xaxis||{};
    let x0ms,x1ms; if(Array.isArray(xa.range)&&xa.autorange===false){ x0ms=toMs(xa.range[0]); x1ms=toMs(xa.range[1]); } else { x0ms=toMs(c.x[0]); x1ms=toMs(c.x[c.x.length-1]); }
    const cx=c.x.map(toMs); let i0=0; while(i0<cx.length&&cx[i0]<x0ms) i0++; let i1=cx.length-1; while(i1>i0&&cx[i1]>x1ms) i1--;
    if(i1<=i0) return;
    let hi=-Infinity,lo=Infinity; for(let i=i0;i<=i1;i++){ hi=Math.max(hi,c.high[i]); lo=Math.min(lo,c.low[i]); }
    const levels=fibLevels(hi,lo); const x0=c.x[i0], x1=c.x[i1]; const rx=rightX(els.price) ?? x1;
    const zoneTop=levels.find(l=>l.pct===0.618).y, zoneBot=levels.find(l=>l.pct===0.382).y;
    const shapes=[ {type:'rect',xref:'x',yref:'y',x0:x0,x1:x1,y0:zoneBot,y1:zoneTop,line:{width:0},fillcolor:css('--fib-zone'),opacity:1,_fib:true},
      ...levels.map(l=>({type:'line',xref:'x',yref:'y',x0:x0,x1:x1,y0:l.y,y1:l.y,line:{color:(l.pct===0.618||l.pct===0.382)?css('--fib-major'):css('--fib-line'),width:(l.pct===0.5?2:1),dash:(l.pct===0.5?'dash':'solid')},_fib:true})) ];
    const annotations=levels.map(l=>({_fib:true,x:rx,xref:'x',y:l.y,yref:'y',xanchor:'left',text:`${(l.pct*100).toFixed(1)}%`,bgcolor:css('--fib-label-bg'),bordercolor:css('--fib-line'),font:{size:10,color:css('--text')},borderwidth:1,opacity:.9,showarrow:false,ay:0,ax:6}));
    const prevShapes=(els.price.layout?.shapes||[]).filter(s=>!s._fib); const prevAnn=(els.price.layout?.annotations||[]).filter(a=>!a._fib);
    await Plotly.relayout(els.price,{shapes:[...prevShapes,...shapes],annotations:[...prevAnn,...annotations]});
  }
  async function refreshPricePanelExtras(){ await fitPriceAxisToCandlesStrict(); await updateAutoFib(); }

  /* ===== Draw ===== */
  let refreshTimer=null;
  async function draw(ticker){
    const displayRange=els.time.value, freq=els.freq.value;

    // ensure enough history for SMA200 on Daily
    let fetchRange = displayRange;
    const peek = normalizePair(displayRange, freq);
    if (active.has('SMA200') && peek.interval==='1d') fetchRange = bumpToAtLeast(displayRange, '1y');

    const {range:rg, interval:intv} = normalizePair(fetchRange, freq);
    const full=await fetchChart(ticker, rg, intv);
    if(!full.length){ els.headline.textContent=ticker; els.last.textContent='Last: —'; els.prev.textContent='Prev Close: —'; els.delta.textContent='—'; els.delta.className='pill muted'; return; }

    // FULL arrays
    const xAll=full.map(r=>toETISO(r.date)), oAll=full.map(r=>r.o), hAll=full.map(r=>r.h), lAll=full.map(r=>r.l), cAll=full.map(r=>r.c), vAll=full.map(r=>r.v);

    // Indicators on FULL
    const sma20All=fillEdges(SMA(cAll,20));
    const sma50All=fillEdges(SMA(cAll,50));
    const sma200All=fillEdges(SMA(cAll,200));  // <-- spans entire visible window
    const rsiAll=RSI(cAll,14);
    const macdAll=(function MACD(closes,f=12,s=26,sig=9){
      const ef=EMA(closes,f), es=EMA(closes,s);
      const macd=closes.map((_,i)=> (ef[i]!=null&&es[i]!=null)?ef[i]-es[i]:null);
      const signal=EMA(macd.map(v=>v==null?null:v),sig);
      const hist=macd.map((m,i)=> (m!=null&&signal[i]!=null)?(m-signal[i]):null);
      return {macd,signal,hist};
    })(cAll,12,26,9);

    // Slice to visible
    const vidx=getVisibleIdx(full, displayRange);
    const pick=arr=>vidx.map(i=>arr[i]);
    const x=pick(xAll), o=pick(oAll), h=pick(hAll), l=pick(lAll), c=pick(cAll), v=pick(vAll);
    const sma20=pick(sma20All), sma50=pick(sma50All), sma200=pick(sma200All);
    const rsi=pick(rsiAll);
    const m={macd:pick(macdAll.macd),signal:pick(macdAll.signal),hist:pick(macdAll.hist)};

    // Header metrics
    const last=c.at(-1), prevClose=c.length>1?c.at(-2):null;
    els.headline.textContent=ticker;
    els.last.textContent=`Last: $${fmt(last)}`;
    els.prev.textContent=`Prev Close: ${prevClose==null?'—':'$'+fmt(prevClose)}`;
    els.updated.textContent=`Updated: ${etTime()}`;
    const diff=(last!=null&&prevClose!=null)?(last-prevClose):null;
    const pct=(diff!=null&&prevClose)?(diff/prevClose*100):null;
    els.delta.textContent=(diff==null?'—':`${diff>=0?'+':''}${fmt(diff)} (${diff>=0?'+':''}${pct.toFixed(2)}%)`);
    els.delta.className = `pill ${diff==null?'muted':(diff>=0?'up':'down')}`;

    /* --- PRICE traces --- */
    const traces=[];
    // (Ichimoku left out here to keep changes minimal; toggle will add via future pass if you want)

    traces.push({
      type:'candlestick', x, open:o, high:h, low:l, close:c, name:ticker,
      increasing:{line:{color:css('--up'),width:1.15}},
      decreasing:{line:{color:css('--down'),width:1.15}},
      whiskerwidth:0.4, opacity:0.95,
      hovertemplate:'O %{open:.2f}<br>H %{high:.2f}<br>L %{low:.2f}<br>C %{close:.2f}<extra></extra>'
    });
    if(active.has('SMA20'))  traces.push({type:'scatter',x,y:sma20,name:'SMA 20',line:{color:css('--sma20'),width:1.4},connectgaps:true});
    if(active.has('SMA50'))  traces.push({type:'scatter',x,y:sma50,name:'SMA 50',line:{color:css('--sma50'),width:1.4},connectgaps:true});
    if(active.has('SMA200')) traces.push({type:'scatter',x,y:sma200,name:'SMA 200',line:{color:css('--sma200'),width:1.6},connectgaps:true});
    if(active.has('VOL')){
      const volColors = c.map((ci,i)=> ci>=o[i] ? 'rgba(34,197,94,.38)' : 'rgba(239,68,68,.34)');
      traces.push({type:'bar',x,y:v,name:'Volume',opacity:1,yaxis:'y2',marker:{color:volColors}});
    }

    const layoutPrice={
      margin:{l:56,r:28,t:6,b:24},
      xaxis:{showgrid:true,gridcolor:var('--grid'),rangeslider:{visible:false}},
      yaxis:{title:'',side:'right',showgrid:true,gridcolor:var('--grid')},
      yaxis2:{overlaying:'y',side:'right',showgrid:false},
      legend:{orientation:'h'},
      paper_bgcolor:getComputedStyle($('#boxPrice')).backgroundColor,
      plot_bgcolor:getComputedStyle($('#boxPrice')).backgroundColor,
      shapes:[], annotations:[]
    };
    await Plotly.newPlot(els.price,traces,layoutPrice,{responsive:true,displaylogo:false});
    await refreshPricePanelExtras();
    els.price.on('plotly_relayout', debounce(refreshPricePanelExtras,60));

    /* --- MACD --- */
    const tracesMACD=[];
    if(active.has('MACD')){
      tracesMACD.push(
        {type:'scatter',x,y:m.macd,name:'MACD',line:{color:css('--macd'),width:1.2}},
        {type:'scatter',x,y:m.signal,name:'Signal',line:{width:1}},
        {type:'bar',x,y:m.hist,name:'Hist',opacity:.45}
      );
    }
    await Plotly.newPlot(els.macd,tracesMACD,{margin:{l:56,r:28,t:6,b:24},xaxis:{rangeslider:{visible:false}},yaxis:{side:'right'},paper_bgcolor:getComputedStyle($('#boxMACD')).backgroundColor,plot_bgcolor:getComputedStyle($('#boxMACD')).backgroundColor},{responsive:true,displaylogo:false});

    /* --- RSI --- */
    const tracesRSI=[];
    if(active.has('RSI')){
      tracesRSI.push(
        {type:'scatter',x,y:rsi,name:'RSI',line:{color:css('--rsi'),width:1.2}},
        {type:'scatter',x,y:Array(x.length).fill(70),name:'70',line:{dash:'dot',width:.9}},
        {type:'scatter',x,y:Array(x.length).fill(30),name:'30',line:{dash:'dot',width:.9}}
      );
    }
    await Plotly.newPlot(els.rsi,tracesRSI,{margin:{l:56,r:28,t:6,b:24},xaxis:{rangeslider:{visible:false}},yaxis:{title:'RSI',range:[0,100],side:'right'},paper_bgcolor:getComputedStyle($('#boxRSI')).backgroundColor,plot_bgcolor:getComputedStyle($('#boxRSI')).backgroundColor},{responsive:true,displaylogo:false});

    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(()=> { draw(getTicker()); }, 60000);
  }

  /* ===== Controls ===== */
  els.chips.addEventListener('click',e=>{
    const el=e.target.closest('.chip'); if(!el) return;
    const k=el.dataset.k;
    if(active.has(k)){ active.delete(k); } else { active.add(k); }
    saveActive(active);
    syncChips();
    draw(getTicker());
  });
  els.time.addEventListener('change',()=>draw(getTicker()));
  els.freq.addEventListener('change',()=>draw(getTicker()));
  els.tkr.addEventListener('keydown',e=>{ if(e.key==='Enter'){ window.location.hash = els.tkr.value.trim().toUpperCase(); draw(getTicker()); } });
  els.goBtn.addEventListener('click',()=>{ window.location.hash = els.tkr.value.trim().toUpperCase(); draw(getTicker()); });
  els.refreshBtn.addEventListener('click',()=> draw(getTicker()));

  // Uppercase input always (desktop ignores autocapitalize)
  els.tkr.addEventListener('input', () => {
    const { selectionStart:s, selectionEnd:e } = els.tkr;
    const up = els.tkr.value.toUpperCase();
    if (els.tkr.value !== up) { els.tkr.value = up; if (s != null && e != null) els.tkr.setSelectionRange(s, e); }
  });

  // Datalist from CSV with visible company names
  (async () => {
    try {
      const res = await fetch('./stock_data.csv', { cache: 'no-store' });
      const csv = await res.text();
      const rows = csv.trim().split(/\r?\n/).slice(1);
      const parse = s => s.match(/("([^"]*)"|[^,]+)/g).map(x => x.replace(/^"|"$/g,''));
      const list = document.getElementById('tickerList');
      let count = 0;
      for (const r of rows) {
        const [symbol, name] = parse(r);
        if (!symbol) continue;
        const opt = document.createElement('option');
        opt.value = symbol.toUpperCase();
        opt.textContent = name ? `${symbol.toUpperCase()} — ${name}` : symbol.toUpperCase();
        list.appendChild(opt);
        if (++count > 4000) break;
      }
    } catch (err) { console.warn('datalist load failed:', err); }
  })();

  // boot
  function bootSync(){ syncChips(); els.tkr.value = getTicker(); }
  bootSync(); draw(getTicker());
})();
</script>
</body>
</html>
