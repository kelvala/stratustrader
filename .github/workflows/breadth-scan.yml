name: Breadth scan

# Ensure the job has permission to push a commit to the repository
permissions:
  contents: write

on:
  schedule:
    # Run hourly during US market hours (ET 9:30–16:00 -> UTC 14:30–21:00) Mon-Fri
    - cron: '30 14-20 * * 1-5'  # 14:30 through 20:30 UTC (hourly)
    - cron: '0 21 * * 1-5'      # 21:00 UTC (market close 16:00 ET)
  workflow_dispatch: {}

jobs:
  compute-breadth:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run breadth script
        run: |
          chmod +x scripts/compute-breadth.mjs
          node --experimental-fetch scripts/compute-breadth.mjs

      - name: Commit breadth results (branch + PR fallback)
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -e
          retry() {
            attempts=$1; shift
            delay=$1; shift
            n=1
            until "$@"; do
              if [ $n -ge $attempts ]; then
                echo "Command failed after $n attempts: $*"
                return 1
              fi
              echo "Attempt $n failed; retrying in ${delay}s..."
              sleep "$delay"
              n=$((n+1))
              delay=$((delay*2))
            done
          }
          # Harden git HTTP behavior against transient 5xx
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 60
          git config --global safe.directory "$GITHUB_WORKSPACE"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/breadth.json || true
          if git diff --cached --quiet; then
            echo "no changes"
            exit 0
          fi
          # Create a branch for the update and push it. This avoids direct pushes to protected main.
          SHORT=$(git rev-parse --short HEAD)
          TS=$(date -u +%s)
          BRANCH="breadth-update-${SHORT}-${TS}"
          git commit -m "chore(breadth): update breadth.json [skip ci]" || true
          git checkout -b ${BRANCH}
          # Retry more aggressively for GitHub 500/502 blips
          if retry 8 2 git push origin ${BRANCH}; then
            echo "pushed ${BRANCH}"
            # Create a pull request to merge into main
            PR_TITLE="chore(breadth): update breadth.json (${TS})"
            PR_BODY="Automated breadth update generated by GitHub Actions."
            API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls"
            PR_RESPONSE=$(retry 5 2 curl -sS --fail -X POST -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github.v3+json" \
              ${API_URL} -d "{\"title\": \"${PR_TITLE}\", \"head\": \"${BRANCH}\", \"base\": \"main\", \"body\": \"${PR_BODY}\"}") || PR_RESPONSE=''
            PR_NUM=$(echo "$PR_RESPONSE" | python -c "import sys,json; d=sys.stdin.read(); print(json.loads(d).get('number','') if d.strip() else '')" 2>/dev/null || true)
            if [ -n "$PR_NUM" ]; then
              echo "Created PR #$PR_NUM — attempting to merge"
              MERGE_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${PR_NUM}/merge"
              retry 5 2 curl -sS --fail -X PUT -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github.v3+json" \
                ${MERGE_URL} -d '{"commit_title":"chore(breadth): merge breadth update","merge_method":"merge"}' || echo "merge attempt failed or requires review"
            else
              echo "No PR number returned; skipping merge"
            fi
          else
            echo "branch push failed - skipping PR creation"
          fi
