<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Analyzer v.024</title>
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<style>
  :root{
    --bg:#0f1115;--panel:#151923;--text:#e5e7eb;--muted:#9ca3af;
    --accent:#22c55e;--focus:#3b82f6;--border:#23283a;--hover:#161a25;
    --metric-bg:#1a1f2e;--metric-border:#2a2f3e;
    --field-bg:#0c0f16;--field-text:#e5e7eb;

    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#60a5fa;--c-sma200:#f59e0b;
    --c-rsi:#a78bfa;--c-macd:#38bdf8;--c-vol:#10b981;

    --grid:#283044;

    /* Screener level colors */
    --lvl-beginner:#22c55e;
    --lvl-intermediate:#f59e0b;
    --lvl-advanced:#ef4444;

    /* Purple card */
    --tf-bg:#1c1f35;
    --tf-head:#1a214e;
    --tf-glow:#3b82f6;

    /* Ichimoku */
    --c-ichi-tenkan:#f59e0b;  /* orange, dashed */
    --c-ichi-kijun:#60a5fa;   /* blue, dashed  */
    --c-ichi-chikou:#93c5fd;  /* light blue    */
    /* cloud fills */
    --c-ichi-up:   rgba(34,197,94,.22);   /* green  */
    --c-ichi-down: rgba(239,68,68,.22);   /* red    */
  }
  .light{
    --bg:#f8fafc;--panel:#fff;--text:#222;--muted:#64748b;
    --accent:#22c55e;--focus:#3b82f6;--border:#e2e8f0;--hover:#f1f5f9;
    --metric-bg:#f1f5f9;--metric-border:#e2e8f0;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#2563eb;--c-sma200:#f59e0b;
    --c-rsi:#7c3aed;--c-macd:#0ea5e9;--c-vol:#16a34a;
    --grid:#e5e7eb;

    --tf-bg:#eef2ff; --tf-head:#c7d2fe; --tf-glow:#6366f1;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh;padding:20px;transition:background .2s,color .2s}
  .container{max-width:1100px;margin:0 auto}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .header .title{ display:none; }
  .ver-chip{
    margin-left:8px; padding:2px 8px; border-radius:999px;
    border:1px solid var(--border); background:var(--panel); color:var(--muted);
    font-size:12px; font-weight:800;
  }
  .theme-toggle{margin-left:16px;cursor:pointer;padding:8px 14px;border-radius:8px;background:var(--panel);color:var(--text);border:1px solid var(--border);font-weight:600}
  .theme-toggle:hover{background:var(--hover)}
  .theme-toggle.active{background:var(--accent);color:#fff}

  /* Top toolbar */
  .toolbar{
    position: sticky;
    top: 0;
    z-index: 12000;
  }
  .toolbar{display:flex;gap:10px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin-bottom:16px}
  .ticker-wrap{display:flex;align-items:center;gap:8px;flex:1}
  .ticker-wrap label{font-weight:800;opacity:.9}
  .ticker-input{flex:1;min-width:120px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--field-bg);color:var(--field-text);text-transform:uppercase}
  .btn{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn.inline{padding:8px 12px}
  .toolsbar{display:flex;align-items:center;gap:8px;margin-left:auto}
  .tool-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:700;cursor:pointer}
  .tool-btn:hover{background:var(--hover)}
  .tool-ic{font-size:15px}

  /* Autocomplete */
  .ac{position:absolute;left:0;right:0;top:calc(100% + 6px);background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;z-index:1000;display:none;max-height:320px;overflow:auto}
  .ac.show{display:block}
  .ac-item{padding:12px 14px;display:grid;grid-template-columns:110px 1fr;gap:12px;align-items:center;cursor:pointer;border-bottom:1px solid var(--metric-border)}
  .ac-item:hover,.ac-item.active{background:var(--hover)}
  .ticker{font-weight:800}
  .company{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* Info */
  .info{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
  /* Place logo **inside** the info (ticker) box */
  .info { position: relative; }

  /* In-card logo */
  .info-logo{
    position:absolute;
    top:10px;
    right:12px;
    height:54px;
    opacity:.92;
    pointer-events:none;
    filter: drop-shadow(0 2px 8px rgba(0,0,0,.35));
  }

  /* Light theme slight dim so it still feels subtle */
  .light .info-logo{ opacity:.88; }
  @media (max-width:640px){
    .info-logo{ height:42px; right:10px; }
  }

  /* Chart + controls */
  #chartCard{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  position: relative;
}
  #chart{height:68vh;min-height:520px}
  .container.wide{max-width:100%!important}
  #chartCard.max{position:fixed; inset:12px; z-index:9999; margin:0!important; width:auto!important; height:auto!important; overflow:auto; }
  #chartCard.max #chart{height:calc(100vh - 160px)!important; min-height:400px; cursor: zoom-out; }

  /* Time frame card */
  .tf-card{background:var(--tf-bg);border:1px solid rgba(99,102,241,.25);border-radius:12px;padding:10px;margin-bottom:10px;box-shadow:0 0 0 1px rgba(99,102,241,.15) inset}
  .tf-head{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg, var(--tf-head), transparent);border-radius:8px;padding:6px 10px;margin:-4px -2px 8px;font-weight:800}
  .tf-head .carat{display:inline-block;transform:rotate(-90deg);transition:transform .15s ease}
  .tf-card[data-open="true"] .carat{transform:rotate(0)}
  .tf-body{display:none}
  .tf-card[data-open="true"] .tf-body{display:grid}
  .tf-body{grid-template-columns:1fr 1fr;gap:10px}
  .control label{display:block;font-size:13px;font-weight:800;margin-bottom:6px;color:#cbd5ff}
  .control select{width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px}

  /* Indicator chips */
  .toggle-row{ display:flex; flex-wrap:wrap; gap:8px; margin:12px 0 10px; }
  .chip{ border:1px solid #2b3548; border-radius:999px; padding:6px 12px; cursor:pointer; font-weight:700; opacity:.95; user-select:none; transition:background .15s ease, color .15s ease, border-color .15s ease; }
  .chip[data-k="SMA20"]{border-color:var(--c-sma20);color:var(--c-sma20)}
  .chip[data-k="SMA50"]{border-color:var(--c-sma50);color:var(--c-sma50)}
  .chip[data-k="SMA200"]{border-color:var(--c-sma200);color:var(--c-sma200)}
  .chip[data-k="RSI"]{border-color:var(--c-rsi);color:var(--c-rsi)}
  .chip[data-k="MACD"]{border-color:var(--c-macd);color:var(--c-macd)}
  .chip[data-k="VOL"]{border-color:var(--c-vol);color:var(--c-vol)}
  .chip[data-k="AUTOFIB"]{border-color:#8b5cf6;color:#8b5cf6}
  .chip[data-k="ICHI"]{border-color:#60a5fa;color:#60a5fa}
  .chip.active[data-k="SMA20"]{background:rgba(34,197,94,.12)}
  .chip.active[data-k="SMA50"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SMA200"]{background:rgba(245,158,11,.12)}
  .chip.active[data-k="RSI"]{background:rgba(167,139,250,.12)}
  .chip.active[data-k="MACD"]{background:rgba(56,189,248,.12)}
  .chip.active[data-k="VOL"]{background:rgba(16,185,129,.12)}
  .chip.active[data-k="AUTOFIB"]{background:rgba(139,92,246,.12)}
  .chip.active[data-k="ICHI"]{background:rgba(96,165,250,.12)}

  /* Separator */
  .section-sep{ margin:20px -16px 16px; padding:0 16px; }
  .section-sep .rule{ height:3px; border-radius:999px; background:linear-gradient(90deg,var(--focus),var(--accent)); opacity:.9; }

  /* Sheets (click-to-open/close only) */
  .sheet{ position:fixed; left:0; right:0; bottom:0; top:auto; background:transparent; display:flex; justify-content:center; z-index:2000; }
  .sheet[hidden]{ display:none!important }
  .sheet-inner{ width:min(760px, 100%); background:var(--panel); border-top:1px solid var(--border); border-radius:16px 16px 0 0; box-shadow:0 -8px 30px rgba(0,0,0,.35); padding:14px; animation:sheetUp .18s ease-out; }
  .sheet-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  .sheet-title{ font-weight:800; font-size:16px; }
  .sheet-close{ background:transparent; border:0; color:var(--text); font-size:18px; cursor:pointer; }
  .sheet-body{ max-height:58vh; overflow:auto; }
  @keyframes sheetUp{ from{ transform:translateY(16px); opacity:.0 } to{ transform:translateY(0); opacity:1 } }

  /* Screeners list */
  .scr-list{ display:flex; flex-direction:column; gap:8px; }
  .scr-item{
    position:relative; display:flex; gap:10px; align-items:flex-start;
    padding:10px 12px; border:1px solid var(--border); border-radius:12px;
    background:color-mix(in hsl, var(--panel), var(--bg) 35%);
    text-decoration:none; color:inherit; cursor:pointer;
    transition:background .15s ease, border-color .15s ease, transform .06s ease;
  }
  .scr-item:hover{ background:var(--hover); border-color:#2b3548; transform:translateY(-1px); }
  .scr-item::before{
    content:""; position:absolute; left:0; top:8px; bottom:8px; width:4px; border-radius:999px;
    background: var(--lvl-color, #64748b); opacity:.8;
  }
  .scr-item{ padding-left:16px; }
  .scr-item[data-lvl="Beginner"]     { --lvl-color: var(--lvl-beginner); }
  .scr-item[data-lvl="Intermediate"] { --lvl-color: var(--lvl-intermediate); }
  .scr-item[data-lvl="Advanced"]     { --lvl-color: var(--lvl-advanced); }
  .scr-item .title{ font-weight:800; font-size:14px; line-height:1.2; }
  .scr-item .desc{ font-size:12px; color:var(--muted); margin-top:2px; }
  .badge{ font-size:11px; font-weight:800; padding:2px 8px; border-radius:999px;
          background:var(--metric-bg); border:1px solid var(--metric-border); color:var(--muted); white-space:nowrap; margin-top:2px; }

  /* Mobile btm bar */
  .btmnav{ position:fixed; left:0; right:0; bottom:0; display:none; background:var(--panel); border-top:1px solid var(--border); padding:6px 10px; z-index:1000; }
  .btmnav .tab{ flex:1; display:flex; flex-direction:column; align-items:center; gap:4px; padding:6px 8px; border-radius:10px; border:0; background:transparent; color:var(--text); font-weight:700; font-size:13px; }
  .btmnav .tab.active{ background:var(--hover); }
  .btmnav .tab span{ font-size:11px; opacity:.85; }
  @media (max-width:860px){ .toolsbar .tool-txt{display:none} .toolsbar .tool-btn{padding:8px 10px} }
  @media (max-width:720px){ .btmnav{display:flex; gap:8px} body{padding-bottom:64px} }
  @media (max-width:1024px){ #chart{height:66vh; min-height:420px} }
  @media (max-width:720px){ #chart{height:60vh; min-height:360px} }

  /* Brand logo */
  .brand-logo{
    width:48px; height:48px; border-radius:12px;
    display:block; box-shadow:0 0 0 1px var(--border), 0 8px 22px rgba(0,0,0,.35);
  }
  .ver-badge{
    display:inline-flex; align-items:center; justify-content:center;
    height:34px; padding:0 10px; margin-left:8px;
    border-radius:999px; border:1px solid var(--border);
    background:var(--panel); color:var(--muted);
    font-weight:800; font-size:12px; user-select:none;
  }
  .toolsbar{ gap:8px; }
  @media (max-width:520px){ .ver-badge{ display:none; } }

  /* Brand wordmark (Finviz style) */
  .brand-lite{
    display:none;
  }

</style>
</head>
<body>
  <div class="container">

    <!-- Toolbar: Ticker + buttons -->
    <div class="toolbar">
      <div class="ticker-wrap">
        <label for="q">Ticker</label>
        <div style="position:relative; flex:1">
          <input id="q" class="ticker-input" type="text" placeholder="AAPL, MSFT‚Ä¶" spellcheck="false" autocomplete="off"/>
          <div id="ac" class="ac" role="listbox" aria-label="Suggestions"></div>
        </div>
        <button id="searchBtn" class="btn inline" type="button">Search</button>
      </div>

      <div class="toolsbar" id="toolsBar">
        <button class="tool-btn" id="toolScreeners" aria-label="Open Screeners">
          <span class="tool-ic">üîé</span><span class="tool-txt">Screeners</span>
        </button>
        <button class="tool-btn" id="toolGPTs" aria-label="Open GPTs">
          <span class="tool-ic">üß†</span><span class="tool-txt">GPTs</span>
        </button>
        <button class="tool-btn" id="wideBtn" aria-label="Toggle Width"><span class="tool-ic">‚ÜîÔ∏é</span><span class="tool-txt">Wide</span></button>
        <button class="tool-btn" id="maxBtn" aria-label="Maximize"><span class="tool-ic">‚§¢</span><span class="tool-txt">Max</span></button>
        <button class="tool-btn" id="refreshBtn" aria-label="Refresh"><span class="tool-ic">‚ü≥</span><span class="tool-txt">Refresh</span></button>
        <button id="themeToggle" class="theme-toggle" type="button">üåô Dark</button>
      </div>
    </div>

    <div id="info" class="info">
      <h3 id="headline" style="margin:0 0 6px 0"></h3>
      <div style="opacity:.9;font-size:14px;line-height:1.6">
        <div id="lastLine">Last: ‚Äî ¬∑ Change: ‚Äî</div>
        <div id="prevCloseLine">Yesterday‚Äôs Close: ‚Äî</div>
        <div id="ivLine">Intrinsic Value: ‚Äî</div>
      </div>
      <img id="infoLogo" class="info-logo" src="/assets/stratus-trader-wide.png" alt="Stratus Trader">
    </div>

    <div id="chartCard">
      <!-- Time frame card -->
      <div class="tf-card" id="tfCard" data-open="true">
        <div class="tf-head" id="tfHead"><span class="carat">‚ñæ</span> <span style="font-style:italic">time frame</span></div>
        <div class="tf-body">
          <div class="control">
            <label for="timeSel">Time</label>
            <select id="timeSel">
              <option value="1d">1 day</option><option value="2d">2 days</option>
              <option value="5d">5 days</option><option value="10d">10 days</option>
              <option value="sep" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
              <option value="1mo">1 month</option><option value="2mo">2 months</option>
              <option value="3mo">3 months</option><option value="6mo" selected>6 months</option>
              <option value="ytd">YTD</option><option value="1y">1 year</option>
              <option value="2y">2 years</option><option value="3y">3 years</option>
              <option value="4y">4 years</option><option value="5y">5 years</option>
              <option value="10y">1 decade</option><option value="max">All Data</option>
            </select>
          </div>
          <div class="control">
            <label for="freqSel">Frequency</label>
            <select id="freqSel">
              <option value="1m">1-Minute</option><option value="5m">5-Minute</option>
              <option value="15m">15-Minute</option><option value="60m">Hourly</option>
              <option value="sep" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
              <option value="1d" selected>Daily</option><option value="1wk">Weekly</option>
              <option value="1mo">Monthly</option><option value="3mo">Quarterly</option>
              <option value="1y">Yearly</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Indicator toggles -->
      <div class="toggle-row" id="toggles">
        <div class="chip active" data-k="SMA20">SMA 20</div>
        <div class="chip active" data-k="SMA50">SMA 50</div>
        <div class="chip active" data-k="SMA200">SMA 200</div>
        <div class="chip active" data-k="RSI">RSI</div>
        <div class="chip active" data-k="MACD">MACD</div>
        <div class="chip active" data-k="VOL">Volume</div>
        <div class="chip" id="autoFib" data-k="AUTOFIB">Auto Fib</div>
        <div class="chip active" data-k="ICHI">Ichimoku</div>
      </div>

      <div id="chart"></div>
    </div>

    <div class="section-sep" aria-hidden="true"><div class="rule"></div></div>
  </div>

  <!-- =================== SHEETS =================== -->
  <div class="sheet" id="sheetScreeners" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">Screeners</div>
        <button class="sheet-close" data-close="sheetScreeners">‚úï</button>
      </div>
      <div class="sheet-body">
        <!-- Quick 3-filter row (yours) -->
        <div class="scr-quick" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
          <select id="scMarketCap"><option>Market Cap ‚â• $10B</option><option>‚â• $2B</option></select>
          <select id="scAvgVol"><option>Avg Vol ‚â• 1M</option><option>‚â• 100k</option></select>
          <select id="scRSI"><option>RSI < 30 (oversold)</option><option>RSI > 70 (overbought)</option></select>
          <div style="grid-column:1/-1;display:flex;gap:8px">
            <button class="btn" id="runScreener">Run</button>
            <button class="btn inline" id="saveScreener">Save</button>
          </div>
        </div>

        <!-- Preset list (click opens matching Finviz link) -->
        <div class="scr-list" id="scrList"></div>
      </div>
    </div>
  </div>

  <div class="sheet" id="sheetGPTs" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">GPTs</div>
        <button class="sheet-close" data-close="sheetGPTs">‚úï</button>
      </div>
      <div class="sheet-body">
        <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:12px">
          <div class="gpt-item scr-item" data-lvl="Beginner">
            <div style="flex:1">
              <div class="title">9 Prompts for Smarter Investing</div>
              <div class="desc">Bundle of prompts to guide smarter investment analysis.</div>
            </div>
            <div class="badge">GPT</div>
            <div style="display:flex;gap:8px;margin-left:8px">
              <button class="tool-btn" data-copy data-ticker-only>Copy prompt</button>
              <a class="tool-btn"
                 data-clear-clipboard
                 href="https://chatgpt.com/g/g-687b911701a08191aadd69c345a67d17-9-prompts-for-smarter-investing"
                 target="_blank" rel="noopener">Open</a>
            </div>
          </div>

          <div class="gpt-item scr-item" data-lvl="Beginner">
            <div style="flex:1">
              <div class="title">Stock Predictor Prompt GPT</div>
              <div class="desc">Structured prompt flow for scenario-led stock predictions.</div>
            </div>
            <div class="badge">GPT</div>
            <div style="display:flex;gap:8px;margin-left:8px">
              <button class="tool-btn" data-copy data-src="p-stock-predictor">Copy prompt</button>
              <a class="tool-btn"
                 data-clear-clipboard
                 href="https://chatgpt.com/g/g-686c5fc3dd948191a0ff9c14cecda1b4-stock-predictor-prompt-gpt"
                 target="_blank" rel="noopener">Open</a>
            </div>
          </div>

          <div class="gpt-item scr-item" data-lvl="Beginner">
            <div style="flex:1">
              <div class="title">High Yield Dividend Sniper</div>
              <div class="desc">Quickly target high-yield dividend candidates.</div>
            </div>
            <div class="badge">GPT</div>
            <a class="tool-btn"
               data-clear-clipboard
               href="https://chatgpt.com/g/g-6878fe277c5c819180211289d9e16148-high-yield-dividend-sniper"
               target="_blank" rel="noopener">Open</a>
          </div>
        </div>

        <div>
          <textarea id="gptInput" rows="4" placeholder="Ask a question about the current ticker‚Ä¶" style="width:100%; background:var(--field-bg); color:var(--field-text); border:1px solid var(--border); border-radius:10px; padding:10px;"></textarea>
          <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
            <button class="btn" id="askGPT">Ask</button>
            <div style="font-size:12px; color:var(--muted)">Uses the visible chart context when possible.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile bottom bar -->
  <nav class="btmnav" id="btmNav" role="navigation" aria-label="Bottom Navigation">
    <button data-tab="home" class="tab active" aria-label="Home">üè†<span>Home</span></button>
    <button data-tab="screeners" class="tab" aria-label="Screeners">üîé<span>Screeners</span></button>
    <button data-tab="gpts" class="tab" aria-label="GPTs">üß†<span>GPTs</span></button>
    <button data-tab="settings" class="tab" aria-label="Settings">‚öôÔ∏è<span>Settings</span></button>
  </nav>

  <!-- =================== MAIN APP SCRIPT =================== -->
  <script>
  (() => {
    const els = {
      input: document.getElementById('q'),
      list: document.getElementById('ac'),
      searchBtn: document.getElementById('searchBtn'),
      headline: document.getElementById('headline'),
      lastLine: document.getElementById('lastLine'),
      prevCloseLine: document.getElementById('prevCloseLine'),
      ivLine: document.getElementById('ivLine'),
      chartCard: document.getElementById('chartCard'),
      chart: document.getElementById('chart'),
      timeSel: document.getElementById('timeSel'),
      freqSel: document.getElementById('freqSel'),
      toggles: document.getElementById('toggles'),
      themeToggle: document.getElementById('themeToggle'),
      autoFib: document.getElementById('autoFib'),
      refreshBtn: document.getElementById('refreshBtn'),
      maxBtn: document.getElementById('maxBtn'),
      wideBtn: document.getElementById('wideBtn'),
      tfCard: document.getElementById('tfCard'),
      tfHead: document.getElementById('tfHead'),
    };

    /* ===== Toolbar toggles ===== */
    els.tfHead.addEventListener('click', () => {
      const open = els.tfCard.getAttribute('data-open') === 'true';
      els.tfCard.setAttribute('data-open', open ? 'false' : 'true');
    });

    /* ===== Small utils ===== */
    const fmt = n => (Number.isFinite(n) ? n.toFixed(2) : '‚Äî');
    const css = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();

    let CURRENT = { ticker: null, company: "" };
    let FUNDAMENTALS = {};
    let traceMap = {};

    function refreshMinis(){}

    /* ===== Fib helpers ===== */
    function getAxisState() {
      const L = els.chart && (els.chart._fullLayout || els.chart.layout);
      const g = (ax) => ({ range: (L?.[ax]?.range) ? [...L[ax].range] : null, autorange: L?.[ax]?.autorange !== false });
      return { x:g('xaxis'), y:g('yaxis'), y2:g('yaxis2'), y3:g('yaxis3'), y4:g('yaxis4') };
    }
    function relayoutPreserve(payload) {
      const S = getAxisState();
      const keep = (axKey, s) => {
        if (!s) return {};
        const out = {};
        if (s.range) { out[`${axKey}.range`] = s.range; out[`${axKey}.autorange`] = false; }
        else if (s.autorange) { out[`${axKey}.autorange`] = true; }
        return out;
      };
      return Plotly.relayout(els.chart, { ...payload, ...keep('xaxis',S.x), ...keep('yaxis',S.y), ...keep('yaxis2',S.y2), ...keep('yaxis3',S.y3), ...keep('yaxis4',S.y4) });
    }
    const fibActive = () => els.autoFib.classList.contains('active');

    function getCandleTrace() {
      const d = els.chart?.data || [];
      const i = d.findIndex(t => t && t.type === 'candlestick');
      return i >= 0 ? d[i] : null;
    }

    function addOrUpdateAutoFibTraces(){
      if (!fibActive()) return;
      const c = getCandleTrace();
      if (!c) return;

      const cx = c.x, ch = c.high, cl = c.low;

      // current visible x-range (fallback to full series)
      const xa = els.chart.layout?.xaxis || {};
      const xr = (Array.isArray(xa.range) && xa.autorange === false)
        ? xa.range
        : [cx[0], cx[cx.length - 1]];

      // indices within range
      const i0 = Math.max(0, cx.findIndex(d => d >= xr[0]));
      let i1 = cx.findIndex(d => d > xr[1]); if (i1 === -1) i1 = cx.length;
      if (i1 <= i0) return;

      // hi/lo of the window
      let hi = -Infinity, lo = Infinity;
      for (let i = i0; i < i1; i++) {
        if (Number.isFinite(ch[i])) hi = Math.max(hi, ch[i]);
        if (Number.isFinite(cl[i])) lo = Math.min(lo, cl[i]);
      }
      if (!Number.isFinite(hi) || !Number.isFinite(lo) || hi === lo) return;

      const x0 = xr[0], x1 = xr[1];
      const lvls = [
        {p:1,    lbl:'100%'}, {p:.786, lbl:'78.6%'}, {p:.618, lbl:'61.8%'},
        {p:.5,   lbl:'50%' }, {p:.382, lbl:'38.2%'}, {p:.236, lbl:'23.6%'},
        {p:0,    lbl:'0%'}
      ];
      const color = css('--c-rsi') || '#8b5cf6';
      const prices = lvls.map(({p,lbl}) => ({ y: hi - (hi - lo) * p, lbl }));

      const fibShapes = prices.map(({y}) => ({
        type:'line', xref:'x', yref:'y', x0, x1, y0:y, y1:y,
        line:{ color, width:1.25, dash:'dot' }, layer:'above', opacity:.95
      }));
      const fibAnn = prices.map(({y,lbl}) => ({
        x:x1, y, xref:'x', yref:'y', xanchor:'right', yanchor:'middle',
        text:`${lbl}  ${y.toFixed(2)}`,
        showarrow:false,
        font:{ size:11, color },
        bgcolor:'rgba(0,0,0,0)',
        borderpad:2
      }));

      // IMPORTANT: replace (don‚Äôt append) to avoid duplicates
      return relayoutPreserve({ shapes: fibShapes, annotations: fibAnn });
    }
    function clearAutoFib(){
      if (!els.chart) return;
      return relayoutPreserve({ shapes: [], annotations: [] });
    }

    /* ===== Indicators ===== */
    function SMA(vals,w){ const out=new Array(vals.length).fill(null); let sum=0,count=0;
      for(let i=0;i<vals.length;i++){ const v=vals[i]; if(Number.isFinite(v)){sum+=v;count++;} if(i>=w){const old=vals[i-w]; if(Number.isFinite(old)){sum-=old;count--;}} if(i>=w-1) out[i]=sum/count; } return out; }
    function EMA(vals,span){ const out=new Array(vals.length).fill(null),k=2/(span+1); let ema=null;
      for(let i=0;i<vals.length;i++){ const v=vals[i]; if(!Number.isFinite(v)){ out[i]=(i>0?out[i-1]:null); continue; } ema=(ema==null)?v:v*k+ema*(1-k); out[i]=ema; } return out; }
    function RSI(values, period=14){ const rsi=new Array(values.length).fill(null); if(values.length<=period) return rsi;
      let gain=0,loss=0; for(let i=1;i<=period;i++){ const d=values[i]-values[i-1]; if(d>0) gain+=d; else loss-=d; }
      gain/=period; loss/=period; rsi[period]=100-100/(1+(gain/(loss||1e-10)));
      for(let i=period+1;i<values.length;i++){ const d=values[i]-values[i-1];
        if(d>0){ gain=(gain*(period-1)+d)/period; loss=(loss*(period-1))/period; }
        else { gain=(gain*(period-1))/period; loss=(loss*(period-1)-d)/period; }
        rsi[i]=100-100/(1+(gain/(loss||1e-10)));
      } return rsi;
    }
    function MACD(closes,f=12,s=26,sig=9){ const ef=EMA(closes,f), es=EMA(closes,s);
      const macd=closes.map((_,i)=> (ef[i]!=null&&es[i]!=null)? ef[i]-es[i] : null);
      const signal=EMA(macd.map(x=>x==null?null:x),sig);
      const hist=macd.map((m,i)=> (m!=null&&signal[i]!=null)? (m-signal[i]) : null);
      return {macd,signal,hist};
    }

    /* ===== Ichimoku helpers ===== */
    function rollingHigh(arr, window) {
      const out = new Array(arr.length).fill(null);
      for (let i = 0; i < arr.length; i++) {
        if (i < window-1) continue;
        let hi = -Infinity;
        for (let j = i-window+1; j <= i; j++) if (Number.isFinite(arr[j])) hi = Math.max(hi, arr[j]);
        out[i] = Number.isFinite(hi) ? hi : null;
      }
      return out;
    }
    function rollingLow(arr, window) {
      const out = new Array(arr.length).fill(null);
      for (let i = 0; i < arr.length; i++) {
        if (i < window-1) continue;
        let lo = Infinity;
        for (let j = i-window+1; j <= i; j++) if (Number.isFinite(arr[j])) lo = Math.min(lo, arr[j]);
        out[i] = Number.isFinite(lo) ? lo : null;
      }
      return out;
    }
    function arrShiftFwd(arr, k, n) {
      // shift forward by k periods (values move to the right)
      const out = new Array(n).fill(null);
      for (let i = 0; i < n; i++) if (i + k < n) out[i + k] = arr[i];
      return out;
    }
    function arrShiftBack(arr, k, n) {
      const out = new Array(n).fill(null);
      for (let i = 0; i < n; i++) if (i - k >= 0) out[i - k] = arr[i];
      return out;
    }
    function calcIchimoku(rows) {
      // standard 9-26-52 settings
      const n = rows.length;
      const high = rows.map(r=>r.h), low = rows.map(r=>r.l), close = rows.map(r=>r.c);

      const convHi = rollingHigh(high, 9),  convLo = rollingLow(low, 9);
      const kijHi  = rollingHigh(high, 26), kijLo  = rollingLow(low, 26);
      const senBHi = rollingHigh(high, 52), senBLo = rollingLow(low, 52);

      const tenkan = convHi.map((h,i)=> (h!=null && convLo[i]!=null) ? (h + convLo[i]) / 2 : null);
      const kijun  = kijHi .map((h,i)=> (h!=null && kijLo [i]!=null) ? (h + kijLo [i]) / 2 : null);
      const senA0  = tenkan.map((t,i)=> (t!=null && kijun[i]!=null) ? (t + kijun[i]) / 2 : null);
      const senB0  = senBHi.map((h,i)=> (h!=null && senBLo[i]!=null) ? (h + senBLo[i]) / 2 : null);

      // shifts
      const shift = 26;
      const spanA = arrShiftFwd(senA0, shift, n);   // forward 26
      const spanB = arrShiftFwd(senB0, shift, n);   // forward 26
      const chikou = arrShiftBack(close, shift, n); // back 26

      return { tenkan, kijun, spanA, spanB, chikou };
    }
    function segmentCloud(a, b) {
      // returns lower/upper arrays for green (A>=B) and red (A<B)
      const n = a.length;
      const gLow = new Array(n).fill(null), gUp = new Array(n).fill(null);
      const rLow = new Array(n).fill(null), rUp = new Array(n).fill(null);
      for (let i = 0; i < n; i++) {
        const A = a[i], B = b[i];
        if (!Number.isFinite(A) || !Number.isFinite(B)) continue;
        if (A >= B) { gLow[i] = B; gUp[i] = A; }
        else        { rLow[i] = A; rUp[i] = B; }
      }
      return { gLow, gUp, rLow, rUp };
    }

    /* ===== Fundamentals ===== */
    async function getFundamentals(ticker){
      try{
        const r = await fetch(`/api/summary?ticker=${encodeURIComponent(ticker)}&modules=defaultKeyStatistics,financialData,earningsTrend`, { cache:'no-store' });
        if(!r.ok) throw new Error('summary '+r.status);
        const j = await r.json();
        const res = j?.quoteSummary?.result?.[0] || {};
        const ek=res.defaultKeyStatistics||{}, fd=res.financialData||{}, et=res.earningsTrend||{};
        const eps = (ek.trailingEps?.raw ?? fd.epsTrailingTwelveMonths?.raw);
        let growth=null; const trends=Array.isArray(et.trend)?et.trend:[]; const fiveY=trends.find(t=>(t.period||'').toLowerCase().includes('5y'));
        if(fiveY?.growth?.raw!=null) growth=fiveY.growth.raw; else if(fd.growth?.raw!=null) growth=fd.growth.raw;
        const ivGraham = (Number.isFinite(eps) && Number.isFinite(growth)) ? eps * (8.5 + 2 * (growth*100)) : null;
        return { eps: +eps || null, growth: +growth || null, ivGraham };
      }catch(e){ return {}; }
    }

    /* ===== Search & autocomplete ===== */
    let LOCAL_SYMBOLS = [];
    let suggestions = [], activeIndex = -1;
    const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); } };

    async function loadSymbolsFromCSV(){
      try{
        const r = await fetch('/stock_data.csv', { cache:'no-store' });
        if (!r.ok) throw new Error('CSV not found');
        const text = await r.text();
        const lines = text.split(/\r?\n/).filter(Boolean);
        if (!lines.length) return;
        const first = lines[0]; const delim = first.includes('\t') ? '\t' : ',';
        const hdr = first.split(delim).map(s => s.trim().toLowerCase());
        const hasHeader = hdr.some(h => /^(symbol|ticker)$/.test(h)) || hdr.some(h => /(name|company|security)/.test(h));
        let start = hasHeader ? 1 : 0;
        let symIdx = hasHeader ? (hdr.findIndex(h => /^(symbol|ticker)$/.test(h)) ?? 0) : 0;
        let nameIdx = hasHeader ? (hdr.findIndex(h => /(name|company|security)/.test(h)) ?? 1) : 1;
        if (symIdx < 0) symIdx = 0; if (nameIdx < 0) nameIdx = 1;

        const tmp = [];
        for (let i = start; i < lines.length; i++){
          const row = lines[i].split(delim);
          const s = (row[symIdx] || '').toUpperCase().trim();
          const n = (row[nameIdx] || '').trim();
          if (/^[A-Z0-9.^$\-]{1,12}$/.test(s)) tmp.push({ symbol:s, name:n });
        }
        LOCAL_SYMBOLS = tmp;
      }catch(e){
        LOCAL_SYMBOLS = [
          { symbol:'AAPL', name:'Apple Inc' },
          { symbol:'MSFT', name:'Microsoft Corp' },
          { symbol:'TSLA', name:'Tesla Inc' },
          { symbol:'NVDA', name:'NVIDIA Corp' },
          { symbol:'AMZN', name:'Amazon.com Inc' },
        ];
      }
    }

    function searchLocalSymbols(q){
      if (!q) return [];
      const out = [];
      for (const r of LOCAL_SYMBOLS){ if (r.symbol.startsWith(q)){ out.push(r); if (out.length >= 12) break; } }
      if (out.length < 12){
        const seen = new Set(out.map(r => r.symbol));
        for (const r of LOCAL_SYMBOLS){
          if (seen.has(r.symbol)) continue;
          if (r.symbol.includes(q) || (r.name && r.name.toUpperCase().includes(q))){
            out.push(r); if (out.length >= 12) break;
          }
        }
      }
      return out;
    }

    function escapeHTML(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function renderAC(){
      els.list.innerHTML = '';
      if (!suggestions.length) { els.list.classList.remove('show'); return; }
      suggestions.forEach((it,i) => {
        const div = document.createElement('div');
        div.className = 'ac-item' + (i===activeIndex ? ' active' : '');
        div.dataset.i = i;
        div.innerHTML = `<div class="ticker">${it.symbol}</div><div class="company">${escapeHTML(it.name||'')}</div>`;
        div.addEventListener('mousedown', e => { e.preventDefault(); pick(i); });
        els.list.appendChild(div);
      });
      els.list.classList.add('show');
    }
    function hideAC(){ els.list.classList.remove('show'); activeIndex = -1; }
    function pick(i){
      const it = suggestions[i]; if (!it) return;
      els.input.value = it.symbol;
      hideAC();
      onSearch(it.symbol, it.name || '');
    }

    els.input.addEventListener('input', debounce(async () => {
      if (!LOCAL_SYMBOLS.length) await loadSymbolsFromCSV();
      const val = els.input.value;
      if (val !== val.toUpperCase()){
        const st = els.input.selectionStart, en = els.input.selectionEnd;
        els.input.value = val.toUpperCase(); els.input.setSelectionRange(st, en);
      }
      const q = els.input.value.trim().toUpperCase();
      if (!q) { hideAC(); return; }
      suggestions = searchLocalSymbols(q);
      activeIndex = -1;
      renderAC();
    }, 120));
    els.input.addEventListener('keydown', e => {
      if (!els.list.classList.contains('show')) return;
      if (e.key === 'ArrowDown'){ e.preventDefault(); activeIndex = (activeIndex + 1) % suggestions.length; renderAC(); }
      else if (e.key === 'ArrowUp'){ e.preventDefault(); activeIndex = (activeIndex - 1 + suggestions.length) % suggestions.length; renderAC(); }
      else if (e.key === 'Enter' || e.key === 'Tab'){ if (activeIndex >= 0){ e.preventDefault(); pick(activeIndex); } }
      else if (e.key === 'Escape'){ hideAC(); }
    });
    document.addEventListener('click', e => { if (!e.target.closest('.ticker-wrap')) hideAC(); });

    function niceTickerError(t){
      els.headline.textContent = 'Symbol not found';
      els.lastLine.innerHTML =
        `<span style="color:${css('--c-down')};font-weight:800">
           ‚Äú${t}‚Äù isn‚Äôt a valid ticker. Please check the spelling and try again.
         </span>`;
      els.prevCloseLine.textContent = '';
      els.ivLine.textContent = '';
    }
    function doSearchFromInput(){
      const t = els.input.value.trim().toUpperCase();
      if (!t) return;
      // quick client-side sanity check
      if (!/^[A-Z0-9.^$-]{1,12}$/.test(t)) { niceTickerError(t); return; }
      const found = LOCAL_SYMBOLS.find(r => r.symbol === t) ||
                    LOCAL_SYMBOLS.find(r => (r.name||'').toUpperCase() === t);
      const comp = found?.name || '';
      onSearch(t, comp);
    }
    els.searchBtn.addEventListener('click', doSearchFromInput);
    els.input.addEventListener('keydown', e => {
      if (e.key !== 'Enter') return;
      // If the AC list is open and an item is highlighted, the other handler will pick it.
      // Otherwise, run a search directly.
      if (!els.list.classList.contains('show') || activeIndex < 0) {
        e.preventDefault();
        doSearchFromInput();
      }
    });

    /* ===== Chart flow ===== */
    function alignAndExtendSMA(smaArr, visibleLen, startIdx){
      const arr = smaArr.slice(startIdx, startIdx + visibleLen);
      while (arr.length < visibleLen) arr.unshift(null);
      const firstIdx = arr.findIndex(v => Number.isFinite(v));
      if (firstIdx > 0) { const firstVal = arr[firstIdx]; for (let i = 0; i < firstIdx; i++) arr[i] = firstVal; }
      for (let i = 1; i < arr.length; i++) if (arr[i] == null && Number.isFinite(arr[i-1])) arr[i] = arr[i-1];
      return arr;
    }

    function normalizePair(time, freq){
      const minFor = { '1m':'1d', '5m':'5d', '15m':'10d', '60m':'1mo' };
      const order = ['1d','2d','5d','10d','1mo','2mo','3mo','6mo','ytd','1y','2y','3y','4y','5y','10y','max'];
      const idx = v => Math.max(0, order.indexOf(v));
      if (['1m','5m','15m','60m'].includes(freq)) {
        const minRange = minFor[freq];
        if (idx(time) < idx(minRange)) time = minRange;
        return { range: time, interval: freq === '60m' ? '60m' : freq };
      }
      const map = { '1d':'1d', '1wk':'1wk', '1mo':'1mo', '3mo':'3mo', '1y':'1y' };
      return { range: time, interval: map[freq] || '1d' };
    }

    async function fetchChart(ticker, time, freq){
      const widen = { '1m':['1d','2d','5d'], '5m':['5d','10d','1mo','2mo'], '15m':['10d','1mo','2mo'], '60m':['1mo','2mo','3mo'] };
      const tryRanges = ['1m','5m','15m','60m'].includes(freq) ? [...new Set([time, ...(widen[freq]||[])])] : [time];
      let lastErr;
      for (const candidate of tryRanges) {
        try {
          const { range, interval } = normalizePair(candidate, freq);
          const r = await fetch(`/api/chart?ticker=${encodeURIComponent(ticker)}&range=${range}&interval=${interval}`, { cache:'no-store' });
          if (!r.ok) throw new Error(`Proxy ${r.status}`);
          const j = await r.json();
          const res = j?.chart?.result?.[0]; if (!res) throw new Error('No result');
          const q = res.indicators?.quote?.[0] || {};
          const adj = res.indicators?.adjclose?.[0]?.adjclose;
          const ts = res.timestamp || [];
          const rows=[];
          for(let i=0;i<ts.length;i++){
            const o=q.open?.[i], h=q.high?.[i], l=q.low?.[i],
                  c=(adj?.[i]!==undefined ? adj[i] : q.close?.[i]), v=q.volume?.[i];
            if ([o,h,l,c].every(Number.isFinite)) rows.push({date:new Date(ts[i]*1000), o:+o, h:+h, l:+l, c:+c, v:Number.isFinite(v)?+v:0});
          }
          return rows;
        } catch(e){ lastErr=e; }
      }
      throw lastErr || new Error('Fetch failed');
    }

    function historyRangeFor(freq){ if (freq==='1m') return '7d'; if (['5m','15m','60m'].includes(freq)) return '2mo'; return '1y'; }
    async function fetchFullHistory(ticker, freq) { return await fetchChart(ticker, historyRangeFor(freq), freq); }

    function toEastern(date) { return new Date(date.toLocaleString('en-US', { timeZone: 'America/New_York' })); }
    function formatEasternISO(date) { const est = toEastern(date); return est.toISOString().replace('Z', ''); }

    function getVisibleData(fullData, range, freq) {
      if (range === '1d' && freq === '1m') {
        if (!fullData.length) return [];
        const lastDate = toEastern(fullData.at(-1).date);
        const preOpen = new Date(lastDate); preOpen.setHours(4,0,0,0);
        const open    = new Date(lastDate); open.setHours(9,30,0,0);
        const close   = new Date(lastDate); close.setHours(16,0,0,0);
        const post    = new Date(lastDate); post.setHours(20,0,0,0);
        return fullData.filter(item => {
          const d = toEastern(item.date);
          return d >= preOpen && d <= post && d.getDate() === open.getDate();
        });
      }
      if (range === 'ytd') { const now = new Date(); const jan1 = new Date(now.getFullYear(),0,1); return fullData.filter(it=>toEastern(it.date)>=toEastern(jan1)); }
      const days = {'1d':1,'2d':2,'5d':5,'10d':10,'1mo':31,'2mo':62,'3mo':93,'6mo':182,'1y':365,'2y':730,'3y':1095,'4y':1460,'5y':1825,'10y':3650,'max':36500}[range] || 365;
      const cutoff = new Date(Date.now() - days*864e5);
      return fullData.filter(item => toEastern(item.date) >= toEastern(cutoff));
    }

    async function onSearch(ticker, company){
      if (!FUNDAMENTALS[ticker]) FUNDAMENTALS[ticker] = await getFundamentals(ticker).catch(()=>({}));
      await go(ticker, company);
    }

    async function go(ticker, company){
      CURRENT = { ticker, company };
      els.headline.textContent = `${ticker}${company ? ' ‚Äî ' + company : ''}`;
      els.lastLine.textContent = 'Loading‚Ä¶';
      els.prevCloseLine.textContent = '';
      els.ivLine.textContent = '';

      try{
        const time = els.timeSel.value, freq = els.freqSel.value;
        const fullRows = await fetchFullHistory(ticker, freq);
        if (!fullRows.length) throw new Error('No price data');

        const visibleRows = getVisibleData(fullRows, time, freq);
        const startIdx = fullRows.length - visibleRows.length;

        const x    = visibleRows.map(r => formatEasternISO(r.date));
        const open = visibleRows.map(r => r.o);
        const high = visibleRows.map(r => r.h);
        const low  = visibleRows.map(r => r.l);
        const close= visibleRows.map(r => r.c);
        const vol  = visibleRows.map(r => r.v);

        const closeAll = fullRows.map(r=>r.c);
        const sma20All  = SMA(closeAll,20), sma50All = SMA(closeAll,50), sma200All = SMA(closeAll,200);
        const sma20  = alignAndExtendSMA(sma20All,  visibleRows.length, startIdx);
        const sma50  = alignAndExtendSMA(sma50All,  visibleRows.length, startIdx);
        const sma200 = alignAndExtendSMA(sma200All, visibleRows.length, startIdx);

        const rsi  = RSI(close, 14);
        const macd = MACD(close, 12, 26, 9);

        const last   = close.at(-1);
        const prev   = close.length > 1 ? close.at(-2) : null;
        const dayChg = (prev!=null) ? (last - prev) : null;
        const dayPct = (prev!=null && prev!==0) ? (dayChg / prev) * 100 : null;

        const upClr = css('--c-up'), dnClr = css('--c-down');
        const signChg = dayChg > 0 ? '+' : dayChg < 0 ? '-' : '';
        const signPct = dayPct > 0 ? '+' : dayPct < 0 ? '-' : '';
        const chgClr  = dayChg > 0 ? upClr : dayChg < 0 ? dnClr : '#cbd5e1';
        els.lastLine.innerHTML =
          `Last: <b>$${fmt(last)}</b> ¬∑ ` +
          (dayChg == null
            ? 'Change: ‚Äî'
            : `<span style="font-weight:800;color:${chgClr}">
                 Change: ${signChg}$${fmt(Math.abs(dayChg))}
                 <span style="opacity:.85">(${signPct}${fmt(Math.abs(dayPct))}%)</span>
               </span>`);

        els.prevCloseLine.textContent = `Yesterday‚Äôs Close: ${prev==null ? '‚Äî' : '$'+fmt(prev)}`;

        const ivs = [];
        const f = FUNDAMENTALS[ticker] || {};
        if (Number.isFinite(f.ivGraham)) ivs.push(f.ivGraham);
        const s50 = sma50.at(-1), s200 = sma200.at(-1);
        if (Number.isFinite(s50) && Number.isFinite(s200)) ivs.push((s50 + s200)/2);
        const iv = ivs.length ? (ivs.reduce((a,b)=>a+b,0)/ivs.length) : null;
        els.ivLine.textContent = `Intrinsic Value: ${iv==null ? '‚Äî' : '$'+fmt(iv)}`;
        const { rec, color } = getRecommendation(last, iv);
        els.ivLine.innerHTML += ` &nbsp;|&nbsp; Recommendation: <b style='color:${color};font-weight:800'>${rec}</b>`;

        const candles = {
          type:'candlestick', x, open, high, low, close, name:ticker,
          increasing:{ line:{ color: css('--c-up') } },
          decreasing:{ line:{ color: css('--c-down') } }
        };
        const volColors = close.map((c,i)=> i===0 ? css('--c-vol') : (c>=close[i-1] ? css('--c-up') : css('--c-down')));
        const trVol = {type:'bar',x,y:vol,marker:{color:volColors},name:'Volume',yaxis:'y3',hovertemplate:'Vol: %{y:,}<extra></extra>'};

        const trSMA20  = {type:'scatter',mode:'lines',x,y:sma20 ,name:'SMA20' ,line:{width:1.8,color:css('--c-sma20')}};
        const trSMA50  = {type:'scatter',mode:'lines',x,y:sma50 ,name:'SMA50' ,line:{width:1.8,color:css('--c-sma50')}};
        const trSMA200 = {type:'scatter',mode:'lines',x,y:sma200,name:'SMA200',line:{width:2.6,color:css('--c-sma200')}};

        const trRSI   = {type:'scatter',mode:'lines',x,y:rsi,name:'RSI',line:{width:1.6,color:css('--c-rsi')},yaxis:'y2'};
        const trRSI70 = {type:'scatter',mode:'lines',x,y:rsi.map(()=>70),name:'70',line:{width:1,dash:'dot',color:'#ef4444'},yaxis:'y2',hoverinfo:'skip'};
        const trRSI30 = {type:'scatter',mode:'lines',x,y:rsi.map(()=>30),name:'30',line:{width:1,dash:'dot',color:'#22c55e'},yaxis:'y2',hoverinfo:'skip'};

        const trMACD   = {type:'scatter',mode:'lines',x,y:macd.macd  ,name:'MACD' ,line:{width:1.6,color:css('--c-macd')},yaxis:'y4'};
        const trSignal = {type:'scatter',mode:'lines',x,y:macd.signal,name:'Signal',line:{width:1.6,color:'#f97316'},yaxis:'y4'};
        const trHist   = {type:'bar',x,y:macd.hist,name:'Hist',marker:{color:macd.hist.map(h=>h>=0?css('--c-up'):css('--c-down'))},yaxis:'y4'};

        /* ===== Ichimoku (built on full history, sliced to visible) ===== */
        const ichiAll = calcIchimoku(fullRows);

        // slice to visible window
        const take = (arr) => arr.slice(startIdx, startIdx + visibleRows.length);
        const tenkan = take(ichiAll.tenkan);
        const kijun  = take(ichiAll.kijun);
        const spanA  = take(ichiAll.spanA);
        const spanB  = take(ichiAll.spanB);
        const chikou = take(ichiAll.chikou);

        // split cloud into green/red fill segments
        const { gLow, gUp, rLow, rUp } = segmentCloud(spanA, spanB);

        // Draw cloud BEHIND candles: add these before the candlesticks
        const trCloudGreenBottom = { type:'scatter', x, y:gLow,  name:'Cloud+', line:{width:0}, hoverinfo:'skip', yaxis:'y' };
        const trCloudGreenTop    = { type:'scatter', x, y:gUp,   name:'Cloud+', line:{width:0}, fill:'tonexty', fillcolor:getComputedStyle(document.documentElement).getPropertyValue('--c-ichi-up').trim(),  hoverinfo:'skip', yaxis:'y' };

        const trCloudRedBottom   = { type:'scatter', x, y:rLow,  name:'Cloud-', line:{width:0}, hoverinfo:'skip', yaxis:'y' };
        const trCloudRedTop      = { type:'scatter', x, y:rUp,   name:'Cloud-', line:{width:0}, fill:'tonexty', fillcolor:getComputedStyle(document.documentElement).getPropertyValue('--c-ichi-down').trim(), hoverinfo:'skip', yaxis:'y' };

        // Lines
        const trTenkan = { type:'scatter', mode:'lines', x, y:tenkan, name:'Tenkan', line:{ width:1.4, color:css('--c-ichi-tenkan'), dash:'dot' }, yaxis:'y' };
        const trKijun  = { type:'scatter', mode:'lines', x, y:kijun,  name:'Kijun',  line:{ width:1.4, color:css('--c-ichi-kijun'),  dash:'dash' }, yaxis:'y' };
        const trChikou = { type:'scatter', mode:'lines', x, y:chikou, name:'Chikou', line:{ width:1.1, color:css('--c-ichi-chikou') },              yaxis:'y', opacity:.9 };

        const data = [
          // Ichimoku first (behind candles)
          trCloudGreenBottom, trCloudGreenTop, trCloudRedBottom, trCloudRedTop,
          trTenkan, trKijun, trChikou,
          // price + indicators
          candles, trSMA20, trSMA50, trSMA200, trRSI, trRSI70, trRSI30, trMACD, trSignal, trHist, trVol
        ];

        const panelBg = getComputedStyle(els.chartCard).backgroundColor;
        const txt     = css('--text') || '#e5e7eb';
        const grid    = css('--grid') || '#222837';
        const layout = {
          paper_bgcolor: panelBg,
          plot_bgcolor:  panelBg,
          showlegend:false, margin:{l:60,r:24,t:10,b:24},
          xaxis:{domain:[0,1],rangeslider:{visible:false},gridcolor:grid,tickfont:{color:txt}},
          yaxis :{domain:[0.50,1.00],gridcolor:grid,tickfont:{color:txt},side:'right',title:'Price'},
          yaxis2:{domain:[0.38,0.48],gridcolor:grid,tickfont:{color:txt},range:[0,100],title:'RSI'},
          yaxis4:{domain:[0.22,0.36],gridcolor:grid,tickfont:{color:txt},title:'MACD'},
          yaxis3:{domain:[0.00,0.20],gridcolor:grid,tickfont:{color:txt},title:'Vol'},
          hovermode:'x unified',
          edits:{ shapePosition:true },
          dragmode:'zoom'
        };

        await Plotly.newPlot(els.chart, data, layout, {responsive:true,displaylogo:false});

        if (fibActive()) addOrUpdateAutoFibTraces();

        if (!els.chart._fibBound) {
          els.chart._fibBound = true;
          els.chart.on('plotly_relayout', () => {
            if (!fibActive()) return;
            clearTimeout(els.chart._fibT);
            els.chart._fibT = setTimeout(() => { if (fibActive()) addOrUpdateAutoFibTraces(); }, 40);
          });
          window.addEventListener('resize', () => {
            if (els.chart && els.chart.data) {
              Plotly.Plots.resize(els.chart);
              if (fibActive()) {
                clearTimeout(els.chart._fibT);
                els.chart._fibT = setTimeout(() => { if (fibActive()) addOrUpdateAutoFibTraces(); }, 40);
              }
            }
          });
        }

        traceMap = {
          SMA20:data.indexOf(trSMA20),
          SMA50:data.indexOf(trSMA50),
          SMA200:data.indexOf(trSMA200),
          RSI:[data.indexOf(trRSI),data.indexOf(trRSI70),data.indexOf(trRSI30)],
          MACD:[data.indexOf(trMACD),data.indexOf(trSignal),data.indexOf(trHist)],
          VOL:data.indexOf(trVol),
          ICHI: [
            data.indexOf(trCloudGreenBottom), data.indexOf(trCloudGreenTop),
            data.indexOf(trCloudRedBottom),   data.indexOf(trCloudRedTop),
            data.indexOf(trTenkan),           data.indexOf(trKijun),
            data.indexOf(trChikou)
          ]
        };

        applyVisibilityFromChips();

      }catch(e){
        console.error(e);
        niceTickerError(ticker);
        return;
      }
    }

    function applyVisibilityFromChips(){
      Object.entries(traceMap).forEach(([key, idx])=>{
        const chip = els.toggles.querySelector(`.chip[data-k="${key}"]`);
        if(!chip) return;
        const visible = chip.classList.contains('active') ? true : 'legendonly';
        const indices = Array.isArray(idx) ? idx : [idx];
        Plotly.restyle(els.chart, { visible }, indices);
      });
    }

    // Toggle indicator chips
    els.toggles.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip'); if (!chip) return;
      const key = chip.dataset.k;

      if (key === 'AUTOFIB') {
        const isActive = chip.classList.contains('active');
        chip.classList.toggle('active');
        chip.setAttribute('aria-pressed', !isActive ? 'true' : 'false');
        if (!isActive) { clearTimeout(els.chart._fibT); addOrUpdateAutoFibTraces(); }
        else { clearTimeout(els.chart._fibT); els.chart._fibT=null; clearAutoFib(); }
        return;
      }

      chip.classList.toggle('active');
      chip.setAttribute('aria-pressed', chip.classList.contains('active') ? 'true' : 'false');
      const idx = traceMap[key]; if (idx == null) return;
      const indices = Array.isArray(idx) ? idx : [idx];
      Plotly.restyle(els.chart, { visible: chip.classList.contains('active') ? true : 'legendonly' }, indices);
    });

    /* Theme */
    const THEMES = {
      dark:{'--bg':'#0f1115','--panel':'#151923','--text':'#e5e7eb','--muted':'#9ca3af','--accent':'#22c55e','--focus':'#3b82f6','--border':'#23283a','--hover':'#161a25','--metric-bg':'#1a1f2e','--metric-border':'#2a2f3e'},
      light:{'--bg':'#f8fafc','--panel':'#fff','--text':'#222','--muted':'#64748b','--accent':'#22c55e','--focus':'#3b82f6','--border':'#e2e8f0','--hover':'#f1f5f9','--metric-bg':'#f1f5f9','--metric-border':'#e2e8f0'}
    };
    function applyChartTheme() {
      if (!els.chart || !els.chart.layout) return;
      const panelBg = getComputedStyle(els.chartCard).backgroundColor;
      const txt  = css('--text') || '#e5e7eb';
      const grid = css('--grid') || '#222837';
      Plotly.relayout(els.chart, {
        paper_bgcolor: panelBg,
        plot_bgcolor:  panelBg,
        'xaxis.gridcolor': grid,  'yaxis.gridcolor':  grid,
        'yaxis2.gridcolor': grid, 'yaxis3.gridcolor': grid, 'yaxis4.gridcolor': grid,
        'xaxis.tickfont.color': txt,
        'yaxis.tickfont.color':  txt,
        'yaxis2.tickfont.color': txt,
        'yaxis3.tickfont.color': txt,
        'yaxis4.tickfont.color': txt
      });
    }
    function setTheme(t){
      Object.entries(THEMES[t]).forEach(([k,v])=>document.documentElement.style.setProperty(k,v));
      els.themeToggle.textContent = t==='dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
      els.themeToggle.classList.toggle('active', t==='dark');
      localStorage.setItem('theme',t);
      // update colors immediately; optionally re-render data later
      requestAnimationFrame(() => {
        applyChartTheme();
        if (CURRENT.ticker) go(CURRENT.ticker, CURRENT.company);
      });
      refreshMinis();
    }
    function getTheme(){ return localStorage.getItem('theme')||'dark'; }
    els.themeToggle.addEventListener('click',()=> setTheme(getTheme()==='dark'?'light':'dark'));
    setTheme(getTheme());

    // Controls
    [els.timeSel, els.freqSel].forEach(sel => sel.addEventListener('change', () => { if (CURRENT.ticker) go(CURRENT.ticker, CURRENT.company); }));
    els.refreshBtn.addEventListener('click', () => { if (CURRENT.ticker) go(CURRENT.ticker, CURRENT.company); });
    els.wideBtn.addEventListener('click', () => {
      document.querySelector('.container').classList.toggle('wide');
      els.wideBtn.querySelector('.tool-txt').textContent = document.querySelector('.container').classList.contains('wide') ? 'Normal' : 'Wide';
      if (els.chart && els.chart.data) Plotly.Plots.resize(els.chart);
    });
    function setMaxState(on){
      els.chartCard.classList.toggle('max', on);
      // ensure the exit pill exists
      if (!document.getElementById('exitMax')) {
        const b = document.createElement('button');
                                                         b.id = 'exitMax';
        b.className = 'max-exit';
        b.title = 'Exit (Esc)';
        b.innerHTML = '‚§¢ Exit';
        b.addEventListener('click', () => setMaxState(false));
        els.chartCard.appendChild(b);
      }
      const label = on ? 'Min' : 'Max';
      const btnTxt = els.maxBtn.querySelector('.tool-txt');
      if (btnTxt) btnTxt.textContent = label;
      if (els.chart && els.chart.data) Plotly.Plots.resize(els.chart);
    }
    // Button toggles
    els.maxBtn.addEventListener('click', () =>
      setMaxState(!els.chartCard.classList.contains('max'))
    );
    // Esc exits Max (capture so it works even when Plotly has focus)
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && els.chartCard.classList.contains('max')) {
        e.preventDefault();
        setMaxState(false);
      }
    }, true);
    // Double-click anywhere on the chart toggles Max
    els.chart.addEventListener('dblclick', () =>
      setMaxState(!els.chartCard.classList.contains('max'))
    );
    window.addEventListener('resize', () => { if (els.chart && els.chart.data) Plotly.Plots.resize(els.chart); });

    // Initial render
    (async () => {
      await loadSymbolsFromCSV();
      els.input.value = 'AAPL';
      await onSearch('AAPL', 'Apple Inc.');
    })();

    function getRecommendation(last, iv) {
      if (!Number.isFinite(last) || !Number.isFinite(iv)) return { rec: 'HOLD', color: '#fbbf24' };
      const ratio = last / iv;
      if (ratio < 0.85) return { rec: 'BUY', color: '#16a34a' };

      if (ratio > 1.15) return { rec: 'SELL', color: '#dc2626' };
      return { rec: 'HOLD', color: '#fbbf24' };
    }

    /* ===== Sheets: open/close ===== */
    const SHEETS = {
      sheetScreeners: document.getElementById('sheetScreeners'),
      sheetGPTs: document.getElementById('sheetGPTs'),
    };

    function openSheet(id) {
      const el = SHEETS[id];
      if (!el) return;
      el.removeAttribute('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeSheet(id) {
      const el = SHEETS[id];
      if (!el) return;
      el.setAttribute('hidden', '');
      document.body.style.overflow = '';
    }

    // Openers
    document.getElementById('toolScreeners')?.addEventListener('click', () => openSheet('sheetScreeners'));
    document.getElementById('toolGPTs')?.addEventListener('click', () => openSheet('sheetGPTs'));

    // Any element with [data-close="sheetId"] will close its sheet
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-close]');
      if (btn) closeSheet(btn.getAttribute('data-close'));
    });

    // Click backdrop to close (clicks outside .sheet-inner)
    Object.values(SHEETS).forEach((sheet) => {
      sheet?.addEventListener('click', (e) => {
        if (!e.target.closest('.sheet-inner')) closeSheet(sheet.id);
      });
    });

    // ESC to close whichever is open
    window.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;
      for (const [id, el] of Object.entries(SHEETS)) {
        if (!el.hasAttribute('hidden')) { closeSheet(id); break; }
      }
    });

    // === GPT Copy/Open handlers ===
    (() => {
      const gptSheet = document.getElementById('sheetGPTs');

      // Context for tokens
      function ctx() {
        const input = document.getElementById('q');
        const timeSel = document.getElementById('timeSel');
        const freqSel = document.getElementById('freqSel');
        // CURRENT is created in your main script; fall back to input if needed
        const ticker = (window.CURRENT?.ticker || input?.value || '').trim().toUpperCase();
        return {
          TICKER: ticker,
          COMPANY: window.CURRENT?.company || '',
          TIME: timeSel?.value || '',
          FREQ: freqSel?.value || ''
        };
      }
      const fillTokens = (s, c) => (s || '').replace(/\{\{(\w+)\}\}/g, (_, k) => c[k] ?? '');
      const maybeAppendTicker = (text, c) =>
        (!c.TICKER || /\{\{TICKER\}\}/.test(text) || text.includes(c.TICKER))
          ? text
          : (text + `\n\nTicker: ${c.TICKER}`);

      // One delegated listener on the sheet
      gptSheet?.addEventListener('click', async (e) => {
        // COPY
        const copyBtn = e.target.closest('button[data-copy]');
        if (copyBtn) {
          e.preventDefault();
          const c = ctx();
          if (!c.TICKER) { alert('Pick a ticker first (e.g., AAPL).'); return; }

          let text = '';
          if (copyBtn.hasAttribute('data-ticker-only')) {
            // Always exactly "<TICKER> stock ticker"
            text = `${c.TICKER} stock ticker`;
          } else {
            // Template or inline prompt
            const srcId = copyBtn.getAttribute('data-src');
            if (srcId) {
              const tpl = document.getElementById(srcId);
              if (tpl?.content) text = tpl.content.textContent.trim();
            }
            if (!text) text = (copyBtn.getAttribute('data-prompt') || '').trim();
            text = fillTokens(text, c);
            const extra = copyBtn.getAttribute('data-append');
            if (extra) text += (text ? '\n\n' : '') + fillTokens(extra, c);
            if (!text) text = `${c.TICKER} stock ticker`; // final fallback
            text = maybeAppendTicker(text, c);
          }

          try {
            await copyHard(text);
            const orig = copyBtn.textContent;
            copyBtn.disabled = true;
            copyBtn.textContent = 'Copied!';
            setTimeout(() => { copyBtn.textContent = orig; copyBtn.disabled = false; }, 1000);
          } catch (err) {
            console.error('Clipboard blocked:', err);
            alert(`Your browser blocked clipboard access.\n\nCopy this manually:\n\n${text}`);
          }
          return;
        }

        // OPEN (clear clipboard first to stop auto-paste in ChatGPT)
        const openLink = e.target.closest('a[data-clear-clipboard]');
        if (openLink) {
          try { 
            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText('');
            }
          } catch {}
          // allow navigation
        }
      });
    })();
  })();

  window.addEventListener('error', e => {
    const msg = (e.error && e.error.stack) ? e.error.stack : (e.message || String(e));
    console.error('üí• Script error:', msg);
    const box = document.getElementById('headline');
    if (box) box.textContent = 'Script error: ' + (e.message || 'check console');
  });

  // ====== Screeners: quick Run + preset links ======
  (() => {
    const MAP = {
      marketCap: {
        'Market Cap ‚â• $10B': 'cap_largeover',
        '‚â• $2B':             'cap_midover'
      },
      avgVol: {
        'Avg Vol ‚â• 1M': 'sh_avgvol_o1000',
        '‚â• 100k':       'sh_avgvol_o100'
      },
      rsi: {
        'RSI < 30 (oversold)':  'ta_rsi_os',
        'RSI > 70 (overbought)': 'ta_rsi_ob'
      }
    };

    function openFinvizWith(tokens) {
      const f = tokens.filter(Boolean).join(',');
      const url = `https://finviz.com/screener.ashx?v=111&f=${encodeURIComponent(f)}`;
      window.open(url, '_blank', 'noopener');
    }

    const $ = (id) => document.getElementById(id);
    const marketSel = $('scMarketCap');
    const volSel    = $('scAvgVol');
    const rsiSel    = $('scRSI');
    const runBtn    = $('runScreener');

    runBtn?.addEventListener('click', () => {
      const tokens = [
        MAP.marketCap[marketSel.value],
        MAP.avgVol[volSel.value],
        MAP.rsi[rsiSel.value],
        'geo_usa'
      ];
      openFinvizWith(tokens);
    });

    // Presets ‚Üí Finviz links
    const FINVIZ = {
      'Oversold Reversal (RSI < 30 + Green)':
        'v=111&f=sh_price_o5,sh_avgvol_o1000,ta_rsi_os,ta_perf_dup,geo_usa',
      'Fresh Highs (Sub-$7 Momentum)':
        'v=111&f=sh_price_u7,ta_highlow52w_nh,geo_usa',
      'High Rel-Vol in Uptrend':
        'v=111&f=sh_price_o5,sh_avgvol_o1000,sh_relvol_o1.5,ta_sma20_pa,ta_sma50_pa,ta_sma200_pa,geo_usa',
      'Weekly Dip in an Uptrend':
        'v=111&f=ta_sma50_pa,ta_sma200_pa,ta_perf_1wdown,geo_usa',
      'MA Bounce (20/50 DMA Zone)':
        'v=111&f=ta_sma20_pa,ta_sma50_pb,ta_sma200_pa,sh_avgvol_o500,geo_usa',
      'Bullish ST MA Crossover (20 vs 50)':
        'v=111&f=ta_sma20_pa,ta_sma50_pa,ta_sma200_pa,sh_avgvol_o500,geo_usa',
      'Quality Breakout':
        'v=111&f=fa_debteq_u0.5,fa_roe_o15,ta_sma20_pa,ta_sma50_pa,ta_sma200_pa,ta_highlow50d_nh,geo_usa',
      'Shorted & Liquid (Idea Source)':
        'v=111&f=cap_smallover,sh_avgvol_o750,sh_shortfloat_o10,sh_price_o3,geo_usa',
      'Classic Short Squeeze Setup':
        'v=111&f=sh_price_o2,sh_shortfloat_o15,sh_instown_u50,sh_avgvol_o300,geo_usa',
      'Weekly Earnings Gap-Ups':
        'v=111&f=earningsdate_tomorrow,ta_gap_u2,sh_avgvol_o300,geo_usa',
      'Fast EPS Growers (Above 200DMA)':
        'v=111&f=fa_epsqoq_o25,fa_epsyoy_o25,fa_estltgrow_o10,ta_sma200_pa,ta_rsi_o50,geo_usa',
      'Sales Rockets (Low Debt, High ROE)':
        'v=111&f=fa_salesqoq_o10,fa_roe_o15,fa_debteq_u0.5,sh_price_o5,sh_shortfloat_u10,geo_usa',
      'Low PE Value (Quality Checks)':
        'v=111&f=fa_pe_u20,fa_pb_u3,fa_peg_u1.5,fa_roa_pos,fa_roe_pos,sh_price_o5,geo_usa',
      'Compounding Winners (Near 52-Wk Highs)':
        'v=111&f=fa_roe_o15,fa_estltgrow_o10,sh_price_o15,ta_rsi_o50,ta_highlow52w_a10h,geo_usa',
      'Dividend Growth Value':
        'v=111&f=cap_large,fa_div_pos,fa_payoutratio_u50,fa_pe_u20,fa_estltgrow_pos,geo_usa',
      'Buy-and-Hold Value (PEG < 1)':
        'v=111&f=fa_curratio_o1.5,fa_estltgrow_o10,fa_peg_u1,fa_roe_o15,sh_beta_u1.5,ta_sma20_pa,geo_usa',
      'Earnings Pop: Oversold Growth (‚â§5d)':
        'v=111&f=earningsdate_nextdays,ta_rsi_u50,fa_epsqoq_o10,fa_salesqoq_o10,ta_perf_52w_o10,sh_avgvol_o300,geo_usa',
      'CANSLIM Core':
        'v=111&f=fa_epsqoq_o20,fa_salesqoq_o20,sh_relvol_o1.2,ta_sma50_pa,ta_sma200_pa,geo_usa'
    };

    const PRESETS = [
      { lvl:'Beginner',     title:'Oversold Reversal (RSI < 30 + Green)', desc:'$5+ names popping green today with high relative volume after RSI ‚â§ 30.' },
      { lvl:'Beginner',     title:'Fresh Highs (Sub-$7 Momentum)',        desc:'Low-priced symbols pushing new highs.' },
      { lvl:'Beginner',     title:'High Rel-Vol in Uptrend',              desc:'Liquid stocks ‚â•1.5√ó rel-vol; 20>50>200 MA structure.' },
      { lvl:'Beginner',     title:'Weekly Dip in an Uptrend',             desc:'Uptrend structure with a down week.' },
      { lvl:'Beginner',     title:'MA Bounce (20/50 DMA Zone)',           desc:'Above 20DMA, below 50DMA; decent liquidity.' },
      { lvl:'Beginner',     title:'Bullish ST MA Crossover (20 vs 50)',   desc:'Early trend-change vibe.' },

      { lvl:'Intermediate', title:'Quality Breakout',                     desc:'Low debt, high ROE, above MAs, making 50d highs.' },
      { lvl:'Intermediate', title:'Shorted & Liquid (Idea Source)',       desc:'>$300M cap, liquid, higher short interest.' },
      { lvl:'Intermediate', title:'Classic Short Squeeze Setup',          desc:'High short float, lighter inst. ownership.' },
      { lvl:'Intermediate', title:'Weekly Earnings Gap-Ups',              desc:'Earnings tomorrow (AH), gap ‚â•2%, liquid.' },
      { lvl:'Intermediate', title:'Fast EPS Growers (Above 200DMA)',      desc:'EPS growth + above 200DMA + RSI>50.' },
      { lvl:'Intermediate', title:'Sales Rockets (Low Debt, High ROE)',   desc:'Growth + quality balance sheet.' },
      { lvl:'Intermediate', title:'Low PE Value (Quality Checks)',        desc:'Cheap but profitable.' },

      { lvl:'Advanced',     title:'Compounding Winners (Near 52-Wk Highs)', desc:'Growers near highs with ROE>15%.' },
      { lvl:'Advanced',     title:'Dividend Growth Value',                  desc:'Large caps with sane payout & valuation.' },
      { lvl:'Advanced',     title:'Buy-and-Hold Value (PEG < 1)',           desc:'Discount growth with quality.' },
      { lvl:'Advanced',     title:'Earnings Pop: Oversold Growth (‚â§5d)',    desc:'Near earnings, not overheated.' },
      { lvl:'Advanced',     title:'CANSLIM Core',                           desc:'Strong EPS & Sales with trend.' },
    ];

    const list = document.getElementById('scrList');
    if (list) {
      list.innerHTML = PRESETS.map(p => {
        const base = 'https://finviz.com/screener.ashx';
        const qs = FINVIZ[p.title] || 'v=111';
        const url = `${base}?${qs}`;
        return `
          <a class="scr-item" data-lvl="${p.lvl}" target="_blank" rel="noopener" href="${url}">
            <div style="flex:1">
              <div class="title">${p.title}</div>
              <div class="desc">${p.desc}</div>
            </div>
            <span class="badge">${p.lvl}</span>
          </a>
        `;
      }).join('');
    }
  })();
</script>

<!-- 9 Prompts for Smarter Investing -->
<template id="p-smarter-investing">
Paste the long multi-step prompt here‚Ä¶
Line 2‚Ä¶
</template>

<!-- Stock Predictor Prompt GPT -->
<template id="p-stock-predictor">
Your stock predictor prompt text goes here‚Ä¶
</template>

<!-- High Yield Dividend Sniper -->
<template id="p-dividend-sniper">
Your dividend sniper prompt text goes here‚Ä¶
</template>
</body>
</html>
