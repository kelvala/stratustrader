<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock Analyzer ‚Äî FinvizColors Preserved v.040</title>
  <meta name="description" content="Candlestick + Volume, RSI, MACD, SMA20/50/200, time & interval selectors, theme toggle, CSV autocomplete, right‚Äëhand GPT sheet (Open links only) ‚Äî using FinvizColors palette throughout." />

  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* --- FinvizColors (theme tokens) ------------------------------------- */
    :root {
      /* Base Finviz‚Äëstyle dark palette (override these to YOUR exact values if different) */
      --fv-bg: #0d1117;         /* background */
      --fv-panel: #161b22;      /* card/panel */
      --fv-text: #e6edf3;       /* primary text */
      --fv-muted: #8b949e;      /* muted text */
      --fv-border: #30363d;     /* borders */

      /* Finviz up/down accents */
      --fv-green: #2ecc71;      /* up/candle+ */
      --fv-red: #e74c3c;        /* down/candle- */
      --fv-blue: #3692e7;       /* accent */

      /* Map to app tokens */
      --bg: var(--fv-bg);
      --panel: var(--fv-panel);
      --text: var(--fv-text);
      --muted: var(--fv-muted);
      --accent: var(--fv-blue);
      --border: var(--fv-border);
      --shadow: 0 6px 24px rgba(0,0,0,.28);

      /* Chart semantic colors */
      --candle-up: var(--fv-green);
      --candle-down: var(--fv-red);
      --vol-up: color-mix(in oklab, var(--fv-green) 55%, transparent);
      --vol-down: color-mix(in oklab, var(--fv-red) 55%, transparent);
    }
    .light {
      /* Light mode tokens (Finviz‚Äëstyle light) */
      --fv-bg: #f7fafc;
      --fv-panel: #ffffff;
      --fv-text: #0e141b;
      --fv-muted: #516072;
      --fv-border: #d9e1ea;
      --fv-green: #1f8c4d;
      --fv-red: #c4332a;
      --fv-blue: #0b74ff;

      --bg: var(--fv-bg);
      --panel: var(--fv-panel);
      --text: var(--fv-text);
      --muted: var(--fv-muted);
      --accent: var(--fv-blue);
      --border: var(--fv-border);
      --shadow: 0 6px 20px rgba(16,24,40,.08);

      --candle-up: var(--fv-green);
      --candle-down: var(--fv-red);
      --vol-up: color-mix(in oklab, var(--fv-green) 55%, transparent);
      --vol-down: color-mix(in oklab, var(--fv-red) 55%, transparent);
    }

    *,*::before,*::after{ box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; overflow-x: hidden; }

    .app { display: grid; grid-template-rows: auto 1fr auto; min-height: 100svh; }
    header { position: sticky; top: 0; z-index: 40; background: var(--bg); padding: 12px 14px 8px; border-bottom: 1px solid var(--border); }

    .toolbar { display: grid; gap: 10px; grid-template-columns: 1.4fr 1fr 1fr auto auto; align-items: end; }
    @media (max-width: 1100px){ .toolbar{ grid-template-columns: 1fr 1fr; } }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); }
    .input, .select, .button { border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:10px; padding:9px 11px; font-size:14px; }
    .button { cursor:pointer; }
    .muted{ color:var(--muted); }

    main { padding: 12px; display:grid; grid-template-columns: 1fr 340px; gap: 12px; }
    @media (max-width: 1200px){ main{ grid-template-columns: 1fr; } }

    .charts { display: grid; gap: 12px; }
    .chart { height: 50vh; min-height: 380px; }
    .subchart { height: 22vh; min-height: 200px; }

    .sidebar { position: sticky; top: 72px; height: fit-content; display: grid; gap: 12px; }
    @media (max-width: 1200px){ .sidebar{ position: static; } }

    .section { padding: 12px; }
    .section h3 { margin: 0 0 8px 0; font-size: 14px; letter-spacing:.2px; }
    .list { list-style: none; padding: 0; margin: 0; display: grid; gap: 6px; }
    .list li { display:flex; justify-content: space-between; align-items:center; gap: 8px; border:1px solid var(--border); border-radius:10px; padding:8px 10px; background: var(--panel); }
    .open-link { text-decoration: underline; font-size: 13px; }

    footer { color: var(--muted); font-size: 12px; padding: 14px; }

    dialog { border:none; border-radius: 12px; padding: 0; max-width: 820px; width:min(96vw,820px); box-shadow: var(--shadow); }
    .modal-body { background: var(--panel); color: var(--text); padding: 12px; border:1px solid var(--border); border-radius:12px; }
    .modal-head { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; }
    textarea.prompt { width: 100%; min-height: 240px; resize: vertical; background: #0e141b10; color: inherit; border: 1px solid var(--border); border-radius: 10px; padding: 10px; }
    .close-btn { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="toolbar">
        <div class="card section">
          <label class="muted" style="font-size:12px; display:block; margin-bottom:6px">Ticker</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="ticker" class="input" list="tickerList" placeholder="e.g., AAPL" autocomplete="off" />
            <datalist id="tickerList"></datalist>
            <button id="loadBtn" class="button">Load</button>
          </div>
        </div>
        <div class="card section">
          <div class="muted" style="font-size:12px; margin-bottom:6px">Range</div>
          <div id="rangeRow" style="display:flex; flex-wrap:wrap; gap:8px"></div>
        </div>
        <div class="card section">
          <div class="muted" style="font-size:12px; margin-bottom:6px">Interval</div>
          <div id="intervalRow" style="display:flex; flex-wrap:wrap; gap:8px"></div>
        </div>
        <div class="card section" style="display:flex; align-items:center; justify-content:center;">
          <button id="themeToggle" class="button" aria-label="Toggle theme"><span id="themeIcon">üåô</span>&nbsp;<span id="themeLabel" class="muted">Dark</span></button>
        </div>
        <div class="card section" style="display:flex; align-items:center; justify-content:center; min-width:160px;">
          <div class="muted" id="status" style="font-size:12px;">Ready</div>
        </div>
      </div>
    </header>

    <main>
      <section class="charts">
        <div class="card section">
          <div style="display:flex; justify-content:space-between; align-items:end; gap:12px; flex-wrap:wrap;">
            <div>
              <h2 id="title" style="margin:0 0 6px 0; font-size:18px;">‚Äî</h2>
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
                <span class="muted">Overlays:</span>
                <label><input type="checkbox" id="sma20" checked /> SMA 20</label>
                <label><input type="checkbox" id="sma50" checked /> SMA 50</label>
                <label><input type="checkbox" id="sma200" checked /> SMA 200</label>
              </div>
            </div>
          </div>
          <div id="priceChart" class="chart" role="img" aria-label="Candlestick with volume"></div>
        </div>
        <div class="card section">
          <div class="muted" style="font-size:12px; margin-bottom:6px">Relative Strength Index (RSI 14)</div>
          <div id="rsiChart" class="subchart" role="img" aria-label="RSI chart"></div>
        </div>
        <div class="card section">
          <div class="muted" style="font-size:12px; margin-bottom:6px">MACD (12, 26, 9)</div>
          <div id="macdChart" class="subchart" role="img" aria-label="MACD chart"></div>
        </div>
      </section>

      <aside class="sidebar">
        <div class="card section">
          <h3>Ticker Info</h3>
          <div style="display:grid; gap:6px; font-size:13px">
            <div><span class="muted">Market Cap:</span> <span id="marketCap">‚Äî</span></div>
            <div class="muted" style="font-size:12px">Load optional <code>./data/TICKER_meta.json</code> to populate.</div>
          </div>
        </div>
        <div class="card section">
          <h3>Latest Headlines</h3>
          <ul id="headlineList" class="list"></ul>
          <div class="muted" style="font-size:12px; margin-top:6px">Optional file: <code>./data/TICKER_news.json</code> (array of {title, url}).</div>
        </div>
        <div class="card section">
          <h3>GPT Sheet (Open links only)</h3>
          <ul class="list" id="promptList"></ul>
        </div>
      </aside>
    </main>

    <footer class="muted">
      Place <code>stock_data.csv</code> (headers: <code>ticker,company_name</code>) next to this file for autocomplete. Charts try <code>./data/TICKER_INTERVAL_RANGE.json</code> and gracefully fall back to synthetic data so the UI always renders.
    </footer>
  </div>

  <dialog id="promptModal">
    <div class="modal-body">
      <div class="modal-head">
        <h3 id="modalTitle" style="margin:0; font-size:16px"></h3>
        <button id="closeModal" class="button">Close</button>
      </div>
      <textarea id="modalText" class="prompt" readonly></textarea>
      <button id="closeModal2" class="button close-btn">Done</button>
    </div>
  </dialog>

  <script>
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const THEME_KEY = 'sa_theme_v1';
    function applyTheme(theme){
      const isLight = theme==='light';
      document.body.classList.toggle('light', isLight);
      $('#themeIcon').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
      $('#themeLabel').textContent = isLight ? 'Light' : 'Dark';
      localStorage.setItem(THEME_KEY, theme);
    }
    function template(){ return document.body.classList.contains('light') ? 'plotly' : 'plotly_dark'; }

    function fmt(num, digits=2){ if (num==null || Number.isNaN(num)) return '‚Äî'; return Number(num).toLocaleString(undefined,{maximumFractionDigits:digits}); }
    function cssVar(name){ return getComputedStyle(document.body).getPropertyValue(name).trim(); }

    async function loadTickerCSV(){
      try{
        const res = await fetch('stock_data.csv', {cache:'no-store'});
        if(!res.ok) return;
        const text = await res.text();
        const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
        const list = $('#tickerList'); list.innerHTML='';
        parsed.data.forEach(r=>{
          const t=(r.ticker||r.Ticker||'').trim(); if(!t) return;
          const name=(r.company_name||r.Company||'').trim();
          const opt=document.createElement('option');
          opt.value=t.toUpperCase(); if(name) opt.label=name; list.appendChild(opt);
        });
      } catch(e){ console.warn('No CSV'); }
    }

    async function fetchLocalSeries(ticker, interval, range){
      const fname = `data/${ticker}_${interval}_${range}.json`;
      try{
        const res = await fetch(fname, {cache:'no-store'});
        if(!res.ok) throw 0; return await res.json();
      }catch{ console.warn('No local OHLCV for', fname, '‚Äî using synthetic'); return generateSyntheticSeries(); }
    }

    function generateSyntheticSeries(points=300){
      const out=[]; const start=Date.now() - points*24*3600*1000; let price=100;
      for(let i=0;i<points;i++){
        const date=new Date(start+i*24*3600*1000);
        const drift=(Math.random()-0.5)*2;
        const open=price; const high=open+Math.random()*2+0.5; const low=open-Math.random()*2-0.5;
        const close=Math.max(low, Math.min(high, open+drift));
        const volume=1_000_000 + Math.floor(Math.random()*500_000);
        out.push({date: date.toISOString(), open, high, low, close, volume}); price=close;
      }
      return out;
    }

    function sma(values, period){ const out=Array(values.length).fill(null); let sum=0; for(let i=0;i<values.length;i++){ sum+=values[i]; if(i>=period) sum-=values[i-period]; if(i>=period-1) out[i]=sum/period; } return out; }
    function ema(values, period){ const out=Array(values.length).fill(null); const k=2/(period+1); let prev=values[0]??0; out[0]=prev; for(let i=1;i<values.length;i++){ prev=values[i]*k + prev*(1-k); out[i]=prev; } return out; }
    function rsi(values, period=14){ const out=Array(values.length).fill(null); let gain=0,loss=0; for(let i=1;i<values.length;i++){ const ch=values[i]-values[i-1]; const g=Math.max(ch,0), l=Math.max(-ch,0); if(i<=period){ gain+=g; loss+=l; if(i===period){ const rs = (loss/period)===0 ? 100 : (gain/period)/(loss/period); out[i]=100 - (100/(1+rs)); } } else { gain=(gain*(period-1)+g)/period; loss=(loss*(period-1)+l)/period; const rs = loss===0 ? 100 : (gain/loss); out[i]=100 - (100/(1+rs)); } } return out; }
    function macd(values, fast=12, slow=26, signal=9){ const ef=ema(values,fast), es=ema(values,slow); const macdLine=values.map((_,i)=> (ef[i]!=null && es[i]!=null) ? ef[i]-es[i] : null); const clean=macdLine.map(v=>v??0); const signalLine=ema(clean,signal); const hist=macdLine.map((v,i)=> (v==null||signalLine[i]==null)?null:v-signalLine[i]); return {macdLine,signalLine,hist}; }

    function toArrays(series){ return { x: series.map(d=>new Date(d.date)), open:series.map(d=>d.open), high:series.map(d=>d.high), low:series.map(d=>d.low), close:series.map(d=>d.close), volume:series.map(d=>d.volume) }; }

    function plotAll({ticker, series, show20, show50, show200}){
      const {x,open,high,low,close,volume}=toArrays(series);

      // FinvizColors: read from CSS vars so theme + your overrides propagate
      const Colors = {
        up: cssVar('--candle-up'),
        down: cssVar('--candle-down'),
        volUp: cssVar('--vol-up'),
        volDown: cssVar('--vol-down')
      };

      const candle = {
        type:'candlestick', x, open, high, low, close, name:ticker,
        increasing:{ line:{ color: Colors.up, width:1 }, fillcolor: Colors.up },
        decreasing:{ line:{ color: Colors.down, width:1 }, fillcolor: Colors.down }
      };

      const volColors = close.map((c,i)=> (c>=open[i]) ? Colors.volUp : Colors.volDown);
      const vol = { type:'bar', x, y:volume, name:'Volume', yaxis:'y2', marker:{ color: volColors } };

      const traces=[candle, vol];
      const s20=sma(close,20), s50=sma(close,50), s200=sma(close,200);
      if(show20) traces.push({type:'scatter', mode:'lines', x, y:s20, name:'SMA 20'});
      if(show50) traces.push({type:'scatter', mode:'lines', x, y:s50, name:'SMA 50'});
      if(show200) traces.push({type:'scatter', mode:'lines', x, y:s200, name:'SMA 200'});

      Plotly.react('priceChart', traces, {
        template:template(), margin:{l:50,r:36,t:10,b:24}, showlegend:true, legend:{orientation:'h', y:1.08},
        xaxis:{type:'date', rangeslider:{visible:false}}, yaxis:{title:'Price'}, yaxis2:{title:'Volume', overlaying:'y', side:'right', showgrid:false}, dragmode:'pan'
      }, {responsive:true, displaylogo:false, modeBarButtonsToRemove:['lasso2d','select2d']});

      const r = rsi(close,14);
      Plotly.react('rsiChart', [
        {type:'scatter', mode:'lines', x, y:r, name:'RSI'}
      ], {
        template:template(), height:$('#rsiChart').clientHeight,
        margin:{l:50,r:36,t:10,b:24}, showlegend:false,
        xaxis:{type:'date'}, yaxis:{title:'RSI', range:[0,100]},
        shapes:[
          {type:'line', xref:'paper', x0:0,x1:1, y0:70,y1:70, line:{ dash:'dot', color: cssVar('--muted') }},
          {type:'line', xref:'paper', x0:0,x1:1, y0:30,y1:30, line:{ dash:'dot', color: cssVar('--muted') }}
        ]
      }, {responsive:true, displaylogo:false});

      const {macdLine, signalLine, hist}=macd(close,12,26,9);
      const histColors = hist.map(v => (v ?? 0) >= 0 ? Colors.volUp : Colors.volDown);
      Plotly.react('macdChart', [
        {type:'scatter', mode:'lines', x, y:macdLine, name:'MACD'},
        {type:'scatter', mode:'lines', x, y:signalLine, name:'Signal'},
        {type:'bar', x, y:hist, name:'Hist', marker:{ color: histColors }, opacity:.85 }
      ], {
        template:template(), height:$('#macdChart').clientHeight,
        margin:{l:50,r:36,t:10,b:24}, showlegend:true, legend:{orientation:'h'},
        xaxis:{type:'date'}, yaxis:{title:'MACD'}
      }, {responsive:true, displaylogo:false});

      $('#title').textContent = `${ticker} ‚Ä¢ ${fmt(close.at(-1))}`;
      $('#status').textContent = `Loaded ${series.length} bars`;
    }

    const RANGES = ['1D','5D','1M','3M','6M','YTD','1Y','5Y','MAX'];
    const INTERVALS = ['1m','5m','15m','1h','1d'];

    function initChips(containerSel, items, initial, onChange){
      const el=$(containerSel); el.innerHTML='';
      items.forEach(v=>{ const b=document.createElement('button'); b.className='button'; b.type='button'; b.textContent=v; if(v===initial) b.style.outline='2px solid var(--accent)'; b.addEventListener('click',()=>{ Array.from(el.children).forEach(c=>c.style.outline='none'); b.style.outline='2px solid var(--accent)'; onChange(v); }); el.appendChild(b); });
    }

    let state = { ticker: localStorage.getItem('sa_ticker') || 'AAPL', range: localStorage.getItem('sa_range') || '6M', interval: localStorage.getItem('sa_interval') || '1d', show20:true, show50:true, show200:true };

    async function loadAndPlot(){
      $('#status').textContent='Loading‚Ä¶';
      const series = await fetchLocalSeries(state.ticker, state.interval, state.range);
      plotAll({ticker:state.ticker, series, show20:state.show20, show50:state.show50, show200:state.show200});
      await loadMetaAndNews(state.ticker);
      localStorage.setItem('sa_ticker', state.ticker);
      localStorage.setItem('sa_range', state.range);
      localStorage.setItem('sa_interval', state.interval);
    }

    async function loadMetaAndNews(ticker){
      try{ const m = await (await fetch(`data/${ticker}_meta.json`, {cache:'no-store'})).json(); $('#marketCap').textContent = m?.marketCap ? m.marketCap : '‚Äî'; }catch{ $('#marketCap').textContent='‚Äî'; }
      try{
        const arr = await (await fetch(`data/${ticker}_news.json`, {cache:'no-store'})).json();
        const ul=$('#headlineList'); ul.innerHTML='';
        (arr||[]).slice(0,8).forEach(n=>{ const li=document.createElement('li'); const a=document.createElement('a'); a.href=n.url||'#'; a.target='_blank'; a.rel='noopener'; a.textContent=n.title||'‚Äî'; a.className='open-link'; li.appendChild(a); ul.appendChild(li); });
        if(!arr||arr.length===0){ $('#headlineList').innerHTML='<li class="muted" style="padding:6px 8px; border:none">No local headlines found.</li>'; }
      }catch{ $('#headlineList').innerHTML='<li class="muted" style="padding:6px 8px; border:none">Add ./data/TICKER_news.json</li>'; }
    }

    const PROMPTS = [
      { id:'p1', title:'Market Trend Analysis', text:`You are my disciplined market analyst. Using recent price action and breadth (advance/decline, new highs/lows), determine if the market is trending up, down, or sideways. Summarize in 3 bullets, then note 2 risks and 2 opportunities for the next 1‚Äì2 days.` },
      { id:'p2', title:'Single‚ÄëStock Performance Analysis', text:`Analyze {{TICKER}}: current trend vs. SMA20/50/200, RSI divergences, MACD crossovers, and volume vs. 20‚Äëday average. Give a conviction score 1‚Äì5 for a tactical (1‚Äì2 day) trade with a one‚Äësentence rationale.` },
      { id:'p3', title:'Identify Opportunities', text:`Scan my watchlist for setups: pullbacks to rising SMA20/50, breakouts from bases with volume, and oversold bounces at support. Return a short table: Ticker | Setup | Trigger | Invalidation | Notes.` },
      { id:'p4', title:'Interpret Market News', text:`Given these headlines for {{TICKER}}, classify each as bullish, bearish, or neutral for the next 1‚Äì2 days, with a 1‚Äësentence justification. Then provide an overall sentiment score from ‚àí2 to +2.` },
      { id:'p5', title:'Economic Indicators Lens', text:`Explain how this week‚Äôs CPI/PPI/jobs data may affect risk assets in the next 48 hours. Provide a base case, upside, and downside scenario with probabilities that sum to 100%.` },
      { id:'p6', title:'Diversification Check', text:`Assess my portfolio‚Äôs sector and factor exposure (growth/value, size). Suggest 2‚Äì3 tweaks to reduce concentration risk without hurting expected return.` },
      { id:'p7', title:'Risk Radar', text:`List the top 5 near‚Äëterm risks (event, technical, positioning) that could hit my holdings. For each, add a quick hedge or mitigation idea.` },
      { id:'p8', title:'Portfolio Risk Assessment', text:`Summarize portfolio drawdown scenarios at ‚àí3%, ‚àí5%, and ‚àí10% in the index. Suggest stop or position‚Äësizing adjustments to cap loss at a target I set.` },
    ];

    function buildPromptList(){
      const ul = $('#promptList'); ul.innerHTML='';
      PROMPTS.forEach(p=>{ const li=document.createElement('li'); const span=document.createElement('span'); span.textContent=p.title; const btn=document.createElement('a'); btn.href='#'; btn.className='open-link'; btn.textContent='Open'; btn.addEventListener('click', (e)=>{ e.preventDefault(); openPrompt(p); }); li.appendChild(span); li.appendChild(btn); ul.appendChild(li); });
    }

    function openPrompt(p){ $('#modalTitle').textContent = p.title; $('#modalText').value = p.text; const dlg=$('#promptModal'); if(typeof dlg.showModal==='function'){ dlg.showModal(); } else { dlg.setAttribute('open',''); } }
    function closePrompt(){ const dlg=$('#promptModal'); if(typeof dlg.close==='function'){ dlg.close(); } else { dlg.removeAttribute('open'); } }

    function bind(){
      $('#loadBtn').addEventListener('click', ()=>{ const t=$('#ticker').value.trim().toUpperCase(); if(t) state.ticker=t; loadAndPlot(); });
      $('#ticker').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('#loadBtn').click(); });
      $('#sma20').addEventListener('change', (e)=>{ state.show20=e.target.checked; loadAndPlot(); });
      $('#sma50').addEventListener('change', (e)=>{ state.show50=e.target.checked; loadAndPlot(); });
      $('#sma200').addEventListener('change', (e)=>{ state.show200=e.target.checked; loadAndPlot(); });
      $('#themeToggle').addEventListener('click', ()=>{ applyTheme(document.body.classList.contains('light')?'dark':'light'); loadAndPlot(); });
      window.addEventListener('resize', ()=>{ ['priceChart','rsiChart','macdChart'].forEach(id=>Plotly.Plots.resize(id)); });
      $('#closeModal').addEventListener('click', closePrompt);
      $('#closeModal2').addEventListener('click', closePrompt);
    }

    (async function main(){
      applyTheme(localStorage.getItem(THEME_KEY)||'dark');
      await loadTickerCSV();
      buildPromptList();
      bind();
      $('#ticker').value = state.ticker;
      initChips('#rangeRow', RANGES, state.range, (v)=>{ state.range=v; loadAndPlot(); });
      initChips('#intervalRow', INTERVALS, state.interval, (v)=>{ state.interval=v; loadAndPlot(); });
      await loadAndPlot();
    })();
  </script>
</body>
</html>
