<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Analyzer v.038</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="/assets/stratus-trader-wide.png">

<!-- Plotly (no defer) -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<style>
  :root{
    --bg:#0f1115;--panel:#151923;--text:#e5e7eb;--muted:#9ca3af;
    --accent:#22c55e;--focus:#3b82f6;--border:#23283a;--hover:#161a25;
    --metric-bg:#1a1f2e;--metric-border:#2a2f3e;
    --field-bg:#0c0f16;--field-text:#e5e7eb;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#60a5fa;--c-sma200:#f59e0b;
    --c-rsi:#a78bfa;--c-macd:#38bdf8;--c-vol:#10b981;
    --grid:#283044;
    --lvl-beginner:#22c55e; --lvl-intermediate:#f59e0b; --lvl-advanced:#ef4444;
    --tf-bg:#1c1f35; --tf-head:#1a214e; --tf-glow:#3b82f6;
    --c-ichi-tenkan:#f59e0b; --c-ichi-kijun:#60a5fa; --c-ichi-chikou:#93c5fd;
    --c-ichi-up:rgba(34,197,94,.38);   /* stronger */
    --c-ichi-down:rgba(239,68,68,.34); /* stronger */
  }
  .light{
    --bg:#f8fafc;--panel:#fff;--text:#222;--muted:#64748b;
    --accent:#22c55e;--focus:#3b82f3;--border:#e2e8f0;--hover:#f1f5f9;
    --metric-bg:#f1f5f9;--metric-border:#e2e8f0;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#2563eb;--c-sma200:#f59e0b;
    --c-rsi:#7c3aed;--c-macd:#0ea5e9;--c-vol:#16a34a;
    --grid:#e5e7eb; --tf-bg:#eef2ff; --tf-head:#c7d2fe; --tf-glow:#6366f1;
    --field-bg:#ffffff; --field-text:#111827;
  }
  *{box-sizing:border-box}
  html,body{overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh;padding:20px;transition:background .2s,color .2s}
  .container{max-width:1100px;margin:0 auto}
  .toolbar{position:sticky;top:0;z-index:12000;display:flex;gap:10px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin-bottom:16px;flex-wrap:wrap}
  .ticker-wrap{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
  .ticker-wrap label{font-weight:800;opacity:.9}
  .input-wrap{position:relative;flex:0 1 460px;max-width:460px;width:100%}
  @media (max-width:720px){ .input-wrap{flex:1 1 100%;max-width:100%} }
  .ticker-input{width:100%;min-width:120px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--field-bg);color:var(--field-text);text-transform:uppercase;font-size:16px}
  .btn{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn.inline{padding:8px 12px}
  .toolsbar{display:flex;align-items:center;gap:8px;margin-left:auto;flex:1 1 100%;justify-content:flex-start;flex-wrap:wrap}
  .tool-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:700;cursor:pointer}
  .tool-btn:hover{background:var(--hover)}
  .theme-toggle{margin-left:auto;cursor:pointer;padding:8px 14px;border-radius:8px;background:var(--panel);color:var(--text);border:1px solid var(--border);font-weight:600}
  .theme-toggle:hover{background:var(--hover)}
  .theme-toggle.active{background:var(--accent);color:#fff}
  .ac{position:absolute;left:0;top:calc(100% + 6px);width:100%;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;display:none;max-height:280px;overflow:auto;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:12050}
  .ac.show{display:block}
  /* Give the ticker more room so it doesn't feel cramped */
  .ac-item{padding:12px 14px;display:grid;grid-template-columns:minmax(160px, 240px) 1fr;gap:12px;align-items:center;cursor:pointer;border-bottom:1px solid var(--metric-border)}
  .ac-item:hover,.ac-item.active{background:var(--hover)}
  .ticker{font-weight:800}
  .company{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .info{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;position:relative}
  .info-logo{position:absolute;top:10px;right:12px;height:54px;opacity:.92;pointer-events:none;filter:drop-shadow(0 2px 8px rgba(0,0,0,.35))}
  .light .info-logo{mix-blend-mode:multiply;filter:drop-shadow(0 2px 6px rgba(0,0,0,.12));opacity:.95}
  @media (max-width:640px){ .info-logo{height:42px;right:10px} }
  #chartCard{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative}
  #chart{height:68vh;min-height:520px}
  .container.wide{max-width:100%!important}
  #chartCard.max{position:fixed;inset:12px;z-index:9999;margin:0!important;width:auto!important;height:auto!important;overflow:auto}
  #chartCard.max #chart{height:calc(100vh - 160px)!important;min-height:400px;cursor:zoom-out}
  .tf-card{background:var(--tf-bg);border:1px solid rgba(99,102,241,.25);border-radius:12px;padding:10px;margin-bottom:10px;box-shadow:0 0 0 1px rgba(99,102,241,.15) inset}
  .tf-head{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg, var(--tf-head), transparent);border-radius:8px;padding:6px 10px;margin:-4px -2px 8px;font-weight:800}
  .tf-head .carat{display:inline-block;transform:rotate(-90deg);transition:transform .15s ease}
  .tf-card[data-open="true"] .carat{transform:rotate(0)}
  .tf-body{display:none}
  .tf-card[data-open="true"] .tf-body{display:grid}
  .tf-body{grid-template-columns:1fr 1fr;gap:10px}
  .control label{display:block;font-size:13px;font-weight:800;margin-bottom:6px;color:#cbd5ff}
  .control select{width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px}
  .toggle-row{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 10px}
  .chip{border:1px solid #2b3548;border-radius:999px;padding:6px 12px;cursor:pointer;font-weight:800;opacity:.98;user-select:none;transition:background .15s,color .15s,border-color .15s; -webkit-text-fill-color: currentColor; color: currentColor; background: color-mix(in srgb, var(--panel), #ffffff 3%);} 
  .chip:not(.active){filter: saturate(0.95) brightness(1.02);} 
  /* Chip base colors (fixed typos) */
  .chip[data-k="SMA20"]{border-color:var(--c-sma20);color:var(--c-sma20);} 
  .chip[data-k="SMA50"]{border-color:var(--c-sma50);color:var(--c-sma50);} 
  .chip[data-k="SMA200"]{border-color:var(--c-sma200);color:var(--c-sma200);} 
  .chip[data-k="RSI"]{border-color:var(--c-rsi);color:var(--c-rsi);} 
  .chip[data-k="MACD"]{border-color:var(--c-macd);color:var(--c-macd);} 
  .chip[data-k="VOL"]{border-color:var(--c-vol);color:var,--c-vol;} 
  .chip[data-k="AUTOFIB"]{border-color:#8b5cf6;color:#8b5cf6}
  .chip[data-k="ICHI"]{border-color:#60a5fa;color:#60a5fa}
  .chip[data-k="SESS"]{border-color:#93c5fd;color:#93c5fd}

  /* Active backgrounds (kept) */
  .chip.active[data-k="SMA20"]{background:rgba(34,197,94,.12)}
  .chip.active[data-k="SMA50"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SMA200"]{background:rgba(245,158,11,.12)}
  .chip.active[data-k="RSI"]{background:rgba(167,139,250,.12)}
  .chip.active[data-k="MACD"]{background:rgba(56,189,248,.12)}
  .chip.active[data-k="VOL"]{background:rgba(16,185,129,.12)}
  .chip.active[data-k="AUTOFIB"]{background:rgba(139,92,246,.12)}
  .chip.active[data-k="ICHI"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SESS"]{background:rgba(147,197,253,.12)}

  /* Bright glow for active chips only (already present; keep it)
     This guarantees inactive chips have NO glow. */
  .chip{position:relative}
  .chip.active{border-width:2px;box-shadow:0 0 0 1px currentColor,0 0 14px 3px currentColor}
  .chip.active::after{content:"";position:absolute;inset:-8px;border-radius:999px;background:currentColor;opacity:.4;filter:blur(10px);pointer-events:none}
  .light .chip.active::after{opacity:.5;filter:blur(12px)}
  .chip:focus-visible{outline:2px solid currentColor;outline-offset:3px}
  .section-sep{margin:20px -16px 16px;padding:0 16px}
  .section-sep .rule{height:3px;border-radius:999px;background:linear-gradient(90deg,var(--focus),var(--accent));opacity:.9}
  .sheet{position:fixed;left:0;right:0;bottom:0;top:auto;background:transparent;display:flex;justify-content:center;z-index:2000}
  .sheet[hidden]{display:none!important}
  .sheet-inner{width:min(760px,100%);background:var(--panel);border-top:1px solid var(--border);border-radius:16px 16px 0 0;box-shadow:0 -8px 30px rgba(0,0,0,.35);padding:14px;animation:sheetUp .18s ease-out;padding-bottom:max(14px, env(safe-area-inset-bottom))}
  .sheet-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .sheet-title{font-weight:800;font-size:16px}
  .sheet-close{background:transparent;border:0;color:var(--text);font-size:18px;cursor:pointer}
  .sheet-body{max-height:58vh;overflow:auto}
  @keyframes sheetUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
  .btmnav{position:fixed;left:0;right:0;bottom:0;display:none;background:var(--panel);border-top:1px solid var(--border);padding:6px 10px;z-index:1000}
  .btmnav .tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 8px;border-radius:10px;border:0;background:transparent;color:var(--text);font-weight:700;font-size:13px}
  .btmnav .tab.active{background:var(--hover)}
  .btmnav .tab span{font-size:11px;opacity:.85}
  @media (max-width:720px){ .btmnav{display:flex;gap:8px} body{padding-bottom:64px} }
  .scr-list{display:flex;flex-direction:column;gap:10px}
  .scr-item{
    position:relative; display:flex; gap:12px; align-items:flex-start;
    padding:12px 14px; border:1px solid var(--border); border-radius:12px;
    background:color-mix(in hsl, var(--panel), var(--bg) 35%);
    text-decoration:none; color:inherit; cursor:pointer;
    transition:background .15s,border-color .15s,transform .06s;
  }
  .scr-item:hover{ background:var(--hover); border-color:#2b3548; transform:translateY(-1px); }
  .scr-item::before{ content:""; position:absolute; left:0; top:8px; bottom:8px; width:4px; border-radius:999px; background: var(--lvl-color, #64748b); opacity:.8; }
  .scr-item{ padding-left:16px; }
  .scr-item[data-lvl="Beginner"]     { --lvl-color: var(--lvl-beginner); }
  .scr-item[data-lvl="Intermediate"] { --lvl-color: var(--lvl-intermediate); }
  .scr-item[data-lvl="Advanced"]     { --lvl-color: var(--lvl-advanced); }
  .scr-item .title{ font-weight:800; font-size:14px; line-height:1.25; }
  .scr-item .desc{ font-size:12px; color:var(--muted); margin-top:2px; }
  .badge{ font-size:11px; font-weight:800; padding:2px 8px; border-radius:999px; background:var(--metric-bg); border:1px solid var(--metric-border); color:var(--muted); white-space:nowrap; margin-top:2px; }
  .scr-item .open-btn{ margin-left:8px; padding:6px 10px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); text-decoration:none; font-weight:700; }
  .scr-item .open-btn:hover{ background:var(--hover); }

  /* === Button glow (added) === */
  .btn, .tool-btn, .theme-toggle, .btmnav .tab {
    --glow-color: var(--focus);
    position: relative;
    transition: box-shadow .15s, transform .06s, background .15s, border-color .15s;
  }
  .btn { --glow-color: var(--accent); }
  .btn:hover, .btn:focus-visible,
  .tool-btn:hover, .tool-btn:focus-visible,
  .theme-toggle:hover, .theme-toggle:focus-visible,
  .btmnav .tab:hover, .btmnav .tab:focus-visible {
    box-shadow:
      0 0 0 2px var(--glow-color),
      0 0 10px var(--glow-color),
      0 0 24px 6px var(--glow-color),
      0 0 40px 12px var(--glow-color);
    z-index: 1;
  }
  .btn:hover::after, .btn:focus-visible::after,
  .tool-btn:hover::after, .tool-btn:focus-visible::after,
  .theme-toggle:hover::after, .theme-toggle:focus-visible::after,
  .btmnav .tab:hover::after, .btmnav .tab:focus-visible::after {
    content: "";
    position: absolute;
    inset: -10px;
    border-radius: inherit;
    background: radial-gradient(60% 60% at 50% 50%, var(--glow-color) 0%, rgba(0,0,0,0) 80%);
    filter: blur(12px);
    z-index: -1;
    pointer-events: none;
    opacity: 0.7;
  }

  /* Nicer colorization for autocomplete tickers */
  /* Make tickers a distinct color and keep them on one line */
  .ac-item .ticker{ color: var(--accent); font-weight:900; letter-spacing:.3px; white-space:nowrap; }
  .ac-item:hover .ticker, .ac-item.active .ticker{ color: color-mix(in srgb, var(--accent), #ffffff 14%); }
  /* Company name muted so ticker stands out */
  .ac-item .company{ color: var(--muted); font-weight:700; }
  .ac-item:hover .company, .ac-item.active .company{ color: var(--muted); opacity:.95; }

</style>
</head>
<body>
  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="ticker-wrap">
        <label for="q">Ticker</label>
        <div class="input-wrap">
          <input id="q" class="ticker-input" type="text" placeholder="AAPL, MSFT… or BTC" spellcheck="false" autocomplete="off"/>
          <div id="ac" class="ac" role="listbox" aria-label="Suggestions"></div>
        </div>
        <button id="searchBtn" class="btn inline" type="button">Search</button>
      </div>
      <div class="toolsbar" id="toolsBar">
        <button class="tool-btn" id="toolGPTs" aria-label="Open GPTs">🧠 <span class="tool-txt">GPTs</span></button>
        <button class="tool-btn" id="toolScreeners" aria-label="Open Screeners">🔎 <span class="tool-txt">Screeners</span></button>
        <button class="tool-btn" id="wideBtn" aria-label="Toggle Width">↔︎ <span class="tool-txt">Wide</span></button>
        <button class="tool-btn" id="maxBtn" aria-label="Maximize">⤢ <span class="tool-txt">Max</span></button>
        <button class="tool-btn" id="refreshBtn" aria-label="Refresh">⟳ <span class="tool-txt">Refresh</span></button>
        <button id="themeToggle" class="theme-toggle" type="button">🌙 Dark</button>
      </div>
    </div>

    <!-- Info bar -->
    <div id="info" class="info">
      <h3 id="headline" style="margin:0 0 6px 0"></h3>
      <div style="opacity:.9;font-size:14px;line-height:1.6">
        <div id="lastLine">Last: — · Change: —</div>
        <div id="prevCloseLine">Yesterday’s Close: —</div>
        <div id="ivLine">Intrinsic Value: —</div>
      </div>
      <img id="infoLogo" class="info-logo" src="/assets/stratus-trader-wide.png" alt="Stratus Trader" />
    </div>

    <!-- Chart card -->
    <div id="chartCard">
      <div class="tf-card" id="tfCard" data-open="true">
        <div class="tf-head" id="tfHead"><span class="carat">▾</span> <span style="font-style:italic">time frame</span></div>
        <div class="tf-body">
          <div class="control">
            <label for="timeSel">Time</label>
            <select id="timeSel">
              <option value="1d">1 day</option><option value="2d">2 days</option>
              <option value="5d">5 days</option><option value="10d">10 days</option>
              <option value="sep" disabled>──────────</option>
              <option value="1mo">1 month</option><option value="2mo">2 months</option>
              <option value="3mo">3 months</option><option value="6mo" selected>6 months</option>
              <option value="ytd">YTD</option><option value="1y">1 year</option>
              <option value="2y">2 years</option><option value="3y">3 years</option>
              <option value="4y">4 years</option><option value="5y">5 years</option>
              <option value="10y">1 decade</option><option value="max">All Data</option>
            </select>
          </div>
          <div class="control">
            <label for="freqSel">Frequency</label>
            <select id="freqSel">
              <option value="1m">1-Minute</option><option value="5m">5-Minute</option>
              <option value="15m">15-Minute</option><option value="60m">Hourly</option>
              <option value="sep" disabled>──────────</option>
              <option value="1d" selected>Daily</option><option value="1wk">Weekly</option>
              <option value="1mo">Monthly</option><option value="3mo">Quarterly</option>
              <option value="1y">Yearly</option>
            </select>
          </div>
        </div>
      </div>

      <div class="toggle-row" id="toggles">
        <button class="chip" data-k="SMA20" type="button" aria-pressed="false">SMA 20</button>
        <button class="chip" data-k="SMA50" type="button" aria-pressed="false">SMA 50</button>
        <button class="chip" data-k="SMA200" type="button" aria-pressed="false">SMA 200</button>
        <button class="chip" data-k="RSI" type="button" aria-pressed="false">RSI</button>
        <button class="chip" data-k="MACD" type="button" aria-pressed="false">MACD</button>
        <button class="chip" data-k="VOL" type="button" aria-pressed="false">Volume</button>
        <button class="chip" id="autoFib" data-k="AUTOFIB" type="button" aria-pressed="false">Auto Fib</button>
        <button class="chip" data-k="ICHI" type="button" aria-pressed="false">Ichimoku</button>
        <button class="chip" data-k="SESS" type="button" aria-pressed="false" title="Toggle pre/post-market bands">Pre/Post</button>
      </div>

      <div id="chart"></div>
    </div>

    <div class="section-sep" aria-hidden="true"><div class="rule"></div></div>
  </div>

  <!-- GPTs Sheet -->
  <div class="sheet" id="sheetGPTs" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">GPTs</div>
        <button class="sheet-close" data-close="sheetGPTs">✕</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" style="margin-bottom:12px">
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">9 Prompts for Smarter Investing</div>
              <div class="desc">Bundle of prompts to guide smarter investment analysis.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-687b911701a08191aadd69c345a67d17-9-prompts-for-smarter-investing" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">Stock Predictor Prompt GPT</div>
              <div class="desc">Structured prompt flow for scenario-led stock predictions.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-686c5fc3dd948191a0ff9c14cecda1b4-stock-predictor-prompt-gpt" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">High Yield Dividend Sniper</div>
              <div class="desc">Quickly target high-yield dividend candidates.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-6878fe277c5c819180211289d9e16148-high-yield-dividend-sniper" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
        </div>
        <div>
          <textarea id="gptInput" rows="4" placeholder="Ask a question about the current ticker…" style="width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button class="btn" id="askGPT">Ask</button>
            <div style="font-size:12px;color:var(--muted)">Uses the visible chart context when possible.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Screeners Sheet -->
  <div class="sheet" id="sheetScreeners" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">Screeners</div>
        <button class="sheet-close" data-close="sheetScreeners">✕</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" id="scrList"></div>
      </div>
    </div>
  </div>

  <nav class="btmnav" id="btmNav" role="navigation" aria-label="Bottom Navigation">
    <button data-tab="home" class="tab active" aria-label="Home">🏠<span>Home</span></button>
    <button data-tab="screeners" class="tab" aria-label="Screeners">🔎<span>Screeners</span></button>
    <button data-tab="gpts" class="tab" aria-label="GPTs">🧠<span>GPTs</span></button>
    <button data-tab="settings" class="tab" aria-label="Settings">⚙️<span>Settings</span></button>
  </nav>

  <script>
  (function(){
    const els = {
      chart: document.getElementById('chart'),
      toggles: document.getElementById('toggles'),
      q: document.getElementById('q'),
      ac: document.getElementById('ac'),
      searchBtn: document.getElementById('searchBtn'),
      lastLine: document.getElementById('lastLine'),
      prevCloseLine: document.getElementById('prevCloseLine'),
      ivLine: document.getElementById('ivLine'),
      headline: document.getElementById('headline')
    };
    const state = { ticker: 'AAPL', range: '6mo', interval: '1d', rows: [], symbols: [], acMatches: [], acIndex: -1, quoteTimer: null, fibOn:false, fibShapes:[], sessionsOn:false };
    const isLocal = (location.hostname === 'localhost' || location.hostname === '127.0.0.1');

    // Cache timeframe selects
    els.timeSel = document.getElementById('timeSel');
    els.freqSel = document.getElementById('freqSel');

    // Utilities
    const css = v => getComputedStyle(document.body).getPropertyValue(v).trim();
    const fmt = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });
    function median(arr){
      const a = (arr||[]).map(Number).filter(v=>Number.isFinite(v)).sort((x,y)=>x-y);
      if(!a.length) return NaN; const m = Math.floor(a.length/2);
      return a.length%2 ? a[m] : (a[m-1]+a[m])/2;
    }
    const fmtPx = v => (Number.isFinite(+v) ? `$${fmt.format(+v)}` : '—');
    const fmtPxPos = v => (Number.isFinite(+v) && +v > 0 ? `$${fmt.format(+v)}` : '—');
    const fmtPct = v => (Number.isFinite(+v) ? `${(+v).toFixed(2)}%` : '—');
    // Avoid displaying -0 or +0
    const clampZero = (v, eps = 1e-6) => (Number.isFinite(v) && Math.abs(v) < eps ? 0 : v);

    function SMA(values, w, fullWidth = true){
      const out = new Array(values.length).fill(null);
      let sum = 0; let q = [];
      for(let i=0;i<values.length;i++){
        const v = values[i];
        if(Number.isFinite(v)){
          q.push(v); sum += v;
          if(q.length > w){ sum -= q.shift(); }
          if(fullWidth ? q.length>0 : q.length===w){ out[i] = sum / (fullWidth ? q.length : w); }
        }
      }
      return out;
    }
    function EMA(values, p){
      const k = 2/(p+1); let ema=null; const out=new Array(values.length).fill(null);
      for(let i=0;i<values.length;i++){
        const v = values[i]; if(!Number.isFinite(v)) continue;
        if(ema==null){ ema = v; } else { ema = v*k + ema*(1-k); }
        out[i] = ema;
      }
      return out;
    }
    function RSI(values, p=14){
      const out = new Array(values.length).fill(null);
      let gain=0, loss=0; let prev = values[0];
      for(let i=1;i<values.length;i++){
        const v = values[i];
        if(!Number.isFinite(v) || !Number.isFinite(prev)){ prev=v; continue; }
        const ch = v - prev; prev = v;
        const g = Math.max(ch,0), l = Math.max(-ch,0);
        if(i<=p){
          gain += g; loss += l;
          if(i===p){ const rs = (gain/p)/((loss/p)||1e-9); out[i] = 100 - 100/(1+rs); }
        } else {
          gain = (gain*(p-1)+g)/p; loss = (loss*(p-1)+l)/p; const rs = gain/((loss)||1e-9); out[i] = 100 - 100/(1+rs);
        }
      }
      return out;
    }
    function MACD(values, fast=12, slow=26, signal=9){
      const emaF = EMA(values, fast), emaS = EMA(values, slow);
      const macd = values.map((_,i)=> (Number.isFinite(emaF[i])&&Number.isFinite(emaS[i]))? emaF[i]-emaS[i] : null);
      const sig = EMA(macd.map(v=>Number.isFinite(v)?v:null), signal);
      const hist = macd.map((v,i)=> (Number.isFinite(v)&&Number.isFinite(sig[i])) ? v - sig[i] : null);
      return { macd, signal: sig, hist };
    }
    function Ichimoku(rows){
      const n = rows.length; const highs = rows.map(r=>r.h), lows = rows.map(r=>r.l), closes = rows.map(r=>r.c);
      const convP=9, baseP=26, spanBP=52, shift=26;
      const conv = new Array(n).fill(null), base = new Array(n).fill(null), spanA = new Array(n).fill(null), spanB = new Array(n).fill(null), chikou = new Array(n).fill(null);
      function mid(i,p){ const s=Math.max(0,i-p+1); let hi=-Infinity, lo=Infinity; for(let j=s;j<=i;j++){ const H=highs[j], L=lows[j]; if(Number.isFinite(H)) hi=Math.max(hi,H); if(Number.isFinite(L)) lo=Math.min(lo,L); } return (hi>-Infinity && lo<Infinity)? (hi+lo)/2 : null; }
      for(let i=0;i<n;i++){
        const c = mid(i,convP); const b = mid(i,baseP); const sb = mid(i,spanBP);
        conv[i]=c; base[i]=b;
        const a = (Number.isFinite(c)&&Number.isFinite(b))? (c+b)/2 : null;
        if(i+shift<n){ spanA[i+shift]=a; spanB[i+shift]=sb; }
        if(i-shift>=0){ chikou[i-shift]=closes[i]; }
      }
      return { tenkan:conv, kijun:base, spanA, spanB, chikou };
    }
    function makeFibShapes(rows){
      if(!rows?.length) return [];
      const xs = rows.map(r=>new Date(r.t)); const x0 = xs[0], x1 = xs[xs.length-1];
      let hi=-Infinity, lo=Infinity; for(const r of rows){ hi=Math.max(hi,r.h); lo=Math.min(lo,r.l); }
      if(!Number.isFinite(hi) || !Number.isFinite(lo) || hi<=lo) return [];
      const diff = hi-lo; const lvls=[0,0.236,0.382,0.5,0.618,0.786,1].map(p=>hi - diff*p);
      const color = '#8b5cf6';
      return lvls.map(y=>({ type:'line', xref:'x', yref:'y', x0, x1, y0:y, y1:y, line:{ color, width:1, dash:'dot' } }));
    }

    // Pre/Post-market shading and intraday rangebreaks
    const isIntraday = (intv)=>/^(1|5|15|60)m$/.test(intv);
    function makeSessionDecor(rows){
      const shapes=[]; const annotations=[];
      if(!rows?.length || !isIntraday(state.interval)) return { shapes, annotations };
      // Build one pre and one post rectangle per day in local time
      const byDay = new Map();
      for(const r of rows){ const d = new Date(r.t); const key = d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate(); if(!byDay.has(key)) byDay.set(key, d); }
      for(const d of byDay.values()){
        const y = d.getFullYear(), m=d.getMonth(), day=d.getDate();
        const pre0 = new Date(y,m,day,4,0,0);  const pre1 = new Date(y,m,day,9,30,0);
        const post0= new Date(y,m,day,16,0,0); const post1= new Date(y,m,day,20,0,0);
        shapes.push(
          { type:'rect', xref:'x', yref:'paper', x0:pre0, x1:pre1, y0:0, y1:1, fillcolor:'rgba(59,130,246,0.06)', line:{width:0}, layer:'below' },
          { type:'rect', xref:'x', yref:'paper', x0:post0, x1:post1, y0:0, y1:1, fillcolor:'rgba(139,92,246,0.06)', line:{width:0}, layer:'below' }
        );
        annotations.push(
          { x:new Date(y,m,day,4,10,0), y:0.98, xref:'x', yref:'paper', yanchor:'top', text:'Pre', showarrow:false, font:{size:10,color:'#93c5fd'} },
          { x:new Date(y,m,day,16,10,0), y:0.98, xref:'x', yref:'paper', yanchor:'top', text:'Post', showarrow:false, font:{size:10,color:'#c4b5fd'} }
        );
      }
      return { shapes, annotations };
    }

    // ---------- Intrinsic Value models (self-contained) ----------
    // small utils
    function _isNum(x){ return Number.isFinite(+x); }
    function ivMedian(arr){
      const a = (arr||[]).map(Number).filter(Number.isFinite).sort((x,y)=>x-y);
      if (!a.length) return NaN; const m = Math.floor(a.length/2);
      return a.length%2 ? a[m] : (a[m-1]+a[m])/2;
    }
    function ema(arr, len){
      let e=null, k=2/(len+1);
      for (const v of arr){ const n=+v; if (!Number.isFinite(n)) continue; e = e==null ? n : e + k*(n-e); }
      return e;
    }
    function vwapRows(rows){ let num=0, den=0;
      for (const r of rows||[]){ const v=+r.v||0; if (!v) continue;
        const tp=((+r.h||0)+(+r.l||0)+(+r.c||0))/3; if (!Number.isFinite(tp)) continue;
        num += tp*v; den += v;
      }
      return den>0 ? num/den : NaN;
    }
    function vwma(close, vol, len){
      let num=0, den=0, n=close.length, s=Math.max(0,n-len);
      for (let i=s;i<n;i++){ const c=+close[i], v=+vol[i]||0; if (!_isNum(c)||!v) continue; num+=c*v; den+=v; }
      return den>0 ? num/den : NaN;
    }
    // --- 1) DCF (per share)
    function dcfPerShare({ fcf, g, r, years=5, gt=Math.min(0.03, r-0.01), cash=0, debt=0, shares }){
      if (!_isNum(fcf) || !_isNum(g) || !_isNum(r) || !_isNum(shares) || shares<=0) return NaN;
      const clamp = (x, a, b)=>Math.max(a, Math.min(b, x));
      g = clamp(g, -0.02, 0.12); r = clamp(r, 0.07, 0.12); gt = Math.min(0.03, r-0.01);
      let f = fcf, pvSum = 0;
      for (let i=1;i<=years;i++){ f *= (1+g); pvSum += f / Math.pow(1+r, i); }
      const tv = (f * (1+gt)) / (r - gt);
      let equity = pvSum + tv / Math.pow(1+r, years);
      if (_isNum(cash)) equity += cash;
      if (_isNum(debt)) equity -= debt;
      const per = equity / shares;
      return _isNum(per) && per>0 ? per : NaN;
    }
    // --- 2) DDM (Gordon)
    function ddmPerShare({ D1, r, g }){
      if (!_isNum(D1) || !_isNum(r) || !_isNum(g) || r<=g) return NaN;
      const p0 = D1 / (r - g);
      return p0>0 ? p0 : NaN;
    }
    // --- 3) Benjamin Graham (revised)
    function grahamPerShare({ eps, g, aaaYield }){
      if (!_isNum(eps) || !_isNum(g) || !_isNum(aaaYield) || aaaYield<=0) return NaN;
      return eps * (8.5 + 2*g) * 4.4 / aaaYield;
    }
    // --- 4) Price/volume "anchor" (no fundamentals)
    function anchorPerShare(rows){
      if (!rows || !rows.length) return NaN;
      const c = rows.map(r=>+r.c), v = rows.map(r=>+r.v||0);
      const vwapAll = vwapRows(rows);
      const vwma50  = vwma(c, v, 50);
      const ema50   = ema(c, 50);
      const med100  = ivMedian(c.slice(-100));
      const parts=[];
      if (_isNum(vwapAll)) parts.push({w:.50, v:vwapAll});
      if (_isNum(vwma50))  parts.push({w:.30, v:vwma50});
      if (_isNum(ema50))   parts.push({w:.15, v:ema50});
      if (_isNum(med100))  parts.push({w:.05, v:med100});
      if (!parts.length) return NaN;
      const W = parts.reduce((a,p)=>a+p.w,0);
      return parts.reduce((a,p)=>a+p.v*(p.w/W), 0);
    }
    /**
     * Weighted Intrinsic Value
     * @param {Object} fund  fundamentals (per company)
     *   { fcf, gDCF, wacc, years, gt, cash, debt, shares,
     *     dividendNext, divGrowth, reqReturn,
     *     epsTTM, growthEPS, aaaYield }
     * @param {Array} rows   visible OHLCV rows (for anchor)
     * @param {Object} w     weights (defaults if omitted)
     *   { DCF:0.5, DDM:0.2, GRAHAM:0.2, ANCHOR:0.1 }
     */
    function intrinsicWeighted(fund={}, rows=[], w={}){
      const W = { DCF:.50, DDM:.20, GRAHAM:.20, ANCHOR:.10, ...w };
      const vals = [];
      // DCF
      const vDCF = dcfPerShare({
        fcf: fund.fcf, g: fund.gDCF, r: fund.wacc,
        years: fund.years ?? 5, gt: fund.gt, cash: fund.cash, debt: fund.debt, shares: fund.shares
      });
      if (_isNum(vDCF)) vals.push({k:'DCF', v:vDCF, w:W.DCF});
      // DDM
      const vDDM = ddmPerShare({ D1: fund.dividendNext, r: fund.reqReturn ?? fund.wacc, g: fund.divGrowth });
      if (_isNum(vDDM)) vals.push({k:'DDM', v:vDDM, w:W.DDM});
      // Graham
      const vGR = grahamPerShare({ eps: fund.epsTTM, g: (fund.growthEPS ?? fund.gDCF), aaaYield: fund.aaaYield });
      if (_isNum(vGR)) vals.push({k:'GRAHAM', v:vGR, w:W.GRAHAM});
      // Price/volume anchor
      const vAN = anchorPerShare(rows);
      if (_isNum(vAN)) vals.push({k:'ANCHOR', v:vAN, w:W.ANCHOR});
      if (!vals.length) return { perShare: NaN, parts: [] };
      // Normalize to only the models that produced values
      const wsum = vals.reduce((a,p)=>a+p.w,0);
      const perShare = vals.reduce((a,p)=> a + p.v * (p.w/wsum), 0);
      return { perShare, parts: vals.map(p=>({ model:p.k, value:p.v, weight:p.w/wsum })) };
    }

    // --- Live quote (independent of chart) ---
    
    // Conservative 5y DCF from Yahoo summary modules
    function buildValuationFromYahoo(root){
      const num = v => (v && typeof v==='object' && 'raw' in v) ? v.raw : (Number.isFinite(+v) ? +v : NaN);

      // Shares
      let shares = num(root?.defaultKeyStatistics?.sharesOutstanding) || num(root?.price?.sharesOutstanding);
      if(!Number.isFinite(shares) || shares <= 0) return null;

      // Cash / Debt
      const cash = num(root?.financialData?.totalCash);
      const debt = num(root?.financialData?.totalDebt);

      // Free cash flow (prefer FCF, then cashflow stmt, then 70% OCF, then 70% NI)
      let fcf = num(root?.financialData?.freeCashflow)
            || num(root?.cashflowStatementHistory?.cashflowStatements?.[0]?.freeCashFlow);
      if(!Number.isFinite(fcf)){
        const ocf = num(root?.financialData?.operatingCashflow);
        if(Number.isFinite(ocf)) fcf = ocf * 0.70;
      }
      if(!Number.isFinite(fcf) || fcf <= 0){
        const ni = num(root?.financialData?.netIncomeToCommon);
        if(Number.isFinite(ni) && ni > 0) fcf = ni * 0.70;
      }
      if(!Number.isFinite(fcf) || fcf <= 0) return null;

      // Growth (analyst trend → revenue/earnings growth → 3%), clamp −2%..12%
      let g = NaN;
      const trend = root?.earningsTrend?.trend || [];
      for(const t of trend){ const gv = num(t?.growth); if(Number.isFinite(gv)) { g = gv; break; } }
      if(!Number.isFinite(g)){
        const rG = num(root?.financialData?.revenueGrowth);
        const eG = num(root?.financialData?.earningsGrowth);
        g = Number.isFinite(rG) ? rG : Number.isFinite(eG) ? eG : 0.03;
      }
      g = Math.max(-0.02, Math.min(0.12, g));

      // Discount rate from beta (≈8.5% ±2%), clamp 7%..12%
      let beta = num(root?.defaultKeyStatistics?.beta); if(!Number.isFinite(beta)) beta = 1;
      let wacc = 0.085 + (beta - 1) * 0.02; wacc = Math.max(0.07, Math.min(0.12, wacc));

      // 5y projection + terminal growth ≤ 3%
      const n = 5, gt = Math.min(0.03, wacc - 0.01);
      let f = fcf, pvSum = 0;
      for(let i=1;i<=n;i++){ f *= (1+g); pvSum += f / Math.pow(1+wacc, i); }
      const tv = (f * (1+gt)) / (wacc - gt);
      let equity = pvSum + (tv / Math.pow(1+wacc, n));
      if(Number.isFinite(cash)) equity += cash;
      if(Number.isFinite(debt)) equity -= debt;

      const perShare = equity / shares;
      return Number.isFinite(perShare) && perShare > 0 ? { perShare } : null;
    }
    
    function parseQuotePayload(j){
      const r = j?.quoteResponse?.result?.[0];
      if (!r) return null;

      const prevClose = Number(r.regularMarketPreviousClose);

      // Build candidates with timestamps (fallback to 0 if missing)
      const cand = [];
      if (Number.isFinite(+r.postMarketPrice))    cand.push({p:+r.postMarketPrice,  t:+(r.postMarketTime||0),  d:+r.postMarketChange,  pct:+r.postMarketChangePercent});
      if (Number.isFinite(+r.preMarketPrice))     cand.push({p:+r.preMarketPrice,   t:+(r.preMarketTime||0),   d:+r.preMarketChange,   pct:+r.preMarketChangePercent});
      if (Number.isFinite(+r.regularMarketPrice)) cand.push({p:+r.regularMarketPrice,t:+(r.regularMarketTime||0),d:+r.regularMarketChange,pct:+r.regularMarketChangePercent});

      if (!cand.length) return { price:null, change:null, changePct:null, prevClose, name: r.shortName || r.longName || '', currency: r.currency || 'USD' };

      // Choose the most recent by timestamp
      cand.sort((a,b) => (b.t||0)-(a.t||0));
      const best = cand[0];

      // If Yahoo didn't give change/pct for that session, compute from prevClose
      let price  = best.p;
      let change = Number.isFinite(best.d)   ? best.d   : (Number.isFinite(prevClose) ? price - prevClose : null);
      let pct    = Number.isFinite(best.pct) ? best.pct : (Number.isFinite(prevClose) ? (price - prevClose)/prevClose*100 : null);

      return {
        price,
        change,
        changePct: pct,
        prevClose,
        name: r.shortName || r.longName || '',
        currency: r.currency || 'USD'
      };
    }

    async function refreshQuoteOnce(){
      try{
        const r = await fetch(`/api/quote?ticker=${encodeURIComponent(state.ticker)}`, { cache:'no-store' });
        if(!r.ok) throw new Error('quote '+r.status);
        const j = await r.json();
        const q = parseQuotePayload(j) || {};
        // NEW: set headline text
        els.headline.textContent = q?.name ? `${state.ticker} — ${q.name}` : state.ticker;

        // Fallbacks using chart data when fields are missing or invalid
        let price = Number.isFinite(+q.price) ? +q.price : null;
        let prevClose = Number.isFinite(+q.prevClose) && +q.prevClose > 0 ? +q.prevClose : null;
        if(!prevClose){
          const rows = (state.rows||[]);
          if(rows.length >= 2){
            const p = rows[rows.length-2]?.c; if(Number.isFinite(+p) && +p>0) prevClose = +p;
          }
          if(!prevClose){
            try{
              const last5 = await fetchRows(state.ticker, '5d', '1d');
              if(last5?.length >= 2){ const p2 = last5[last5.length-2]?.c; if(Number.isFinite(+p2) && +p2>0) prevClose = +p2; }
            }catch{}
          }
        }
        if(price==null && state.rows?.length){ const last = state.rows.at(-1)?.c; if(Number.isFinite(+last)) price = +last; }
        // Always compute change from price vs prevClose for consistency
        let change = (Number.isFinite(price) && Number.isFinite(prevClose) && prevClose>0)
          ? (price - prevClose) : null;
        let changePct = (change!=null && prevClose>0) ? (change / prevClose) * 100 : null;

        // Clean up tiny rounding artifacts
        if(change!=null) change = clampZero(change);
        if(changePct!=null) changePct = clampZero(changePct);
 
        // Intrinsic value calculation with multiple models + weighted aggregator
        let intrinsic = null;
        let valuation = null;
        try{
          const modules = 'price,financialData,defaultKeyStatistics,earningsTrend,cashflowStatementHistory,incomeStatementHistory,balanceSheetHistory,summaryDetail';
          const sr = await fetch(`/api/summary?ticker=${encodeURIComponent(state.ticker)}&modules=${encodeURIComponent(modules)}`, { cache:'no-store' });
          if(sr.ok){
            const sj = await sr.json();
            const root = sj?.quoteSummary?.result?.[0] || {};

            // Build FUND mapping from Yahoo root
            const num = v => (v && typeof v==='object' && 'raw' in v) ? v.raw : (Number.isFinite(+v) ? +v : NaN);
            let shares = num(root?.defaultKeyStatistics?.sharesOutstanding) || num(root?.price?.sharesOutstanding);
            const cash = num(root?.financialData?.totalCash);
            const debt = num(root?.financialData?.totalDebt);
            // FCF prefer freeCashflow, fallback to cashflow stmt, 70% OCF, 70% NI
            let fcf = num(root?.financialData?.freeCashflow)
                  || num(root?.cashflowStatementHistory?.cashflowStatements?.[0]?.freeCashFlow);
            if(!Number.isFinite(fcf)){
              const ocf = num(root?.financialData?.operatingCashflow);
              if(Number.isFinite(ocf)) fcf = ocf * 0.70;
            }
            if(!Number.isFinite(fcf) || fcf<=0){
              const ni = num(root?.financialData?.netIncomeToCommon);
              if(Number.isFinite(ni) && ni>0) fcf = ni * 0.70;
            }
            // Growth estimate
            let gEst = NaN; const trend = root?.earningsTrend?.trend || [];
            for(const t of trend){ const gv = num(t?.growth); if(Number.isFinite(gv)) { gEst = gv; break; } }
            if(!Number.isFinite(gEst)){
              const rG = num(root?.financialData?.revenueGrowth);
              const eG = num(root?.financialData?.earningsGrowth);
              gEst = Number.isFinite(rG) ? rG : Number.isFinite(eG) ? eG : 0.03;
            }
            gEst = Math.max(-0.02, Math.min(0.12, gEst));
            // WACC from beta
            let beta = num(root?.defaultKeyStatistics?.beta); if(!Number.isFinite(beta)) beta = 1;
            let wacc = 0.085 + (beta - 1) * 0.02; wacc = Math.max(0.07, Math.min(0.12, wacc));
            // Dividends
            let divRate = num(root?.summaryDetail?.dividendRate);
            if(!Number.isFinite(divRate)) divRate = num(root?.defaultKeyStatistics?.trailingAnnualDividendRate);
            let divG = Number.isFinite(num(root?.financialData?.dividendGrowthRate)) ? num(root?.financialData?.dividendGrowthRate) : (gEst>0? Math.min(0.05, gEst*0.5) : 0.02);
            // EPS and EPS growth
            let eps = num(root?.defaultKeyStatistics?.trailingEps);
            if(!Number.isFinite(eps)) eps = num(root?.price?.epsTrailingTwelveMonths);
            if(!Number.isFinite(eps)) eps = num(root?.financialData?.epsTrailingTwelveMonths);
            let gEPS = Number.isFinite(num(root?.financialData?.earningsGrowth)) ? num(root?.financialData?.earningsGrowth) : gEst;

            const FUND = {
              fcf, gDCF: gEst, wacc, years: 5, gt: Math.min(0.03, wacc-0.01),
              cash, debt, shares,
              dividendNext: Number.isFinite(divRate) && Number.isFinite(divG) ? divRate*(1+divG) : divRate,
              divGrowth: divG,
              reqReturn: wacc,
              epsTTM: eps,
              growthEPS: gEPS,
              aaaYield: 0.055
            };

            const rowsForIV = state.rows || [];
            const weights = { DCF:.55, DDM:.15, GRAHAM:.15, ANCHOR:.15 };
            const iv = intrinsicWeighted(FUND, rowsForIV, weights);
            if(Number.isFinite(iv?.perShare) && iv.perShare>0){
              intrinsic = iv.perShare;
              valuation = {
                perShare: iv.perShare,
                summary: (iv.parts&&iv.parts.length) ? iv.parts.map(p=>`${p.model}: ${fmtPx(p.value)} (${Math.round(p.weight*100)}%)`).join(' · ') : 'Weighted IV',
                json: { parts: iv.parts, FUND }
              };
              try{ console.debug('IV breakdown', iv.parts); }catch{}
            }

            // Fallback to analyst target median if still unavailable
            if(!Number.isFinite(intrinsic) || intrinsic <= 0){
              const getNum = v => (v && typeof v === 'object' && 'raw' in v) ? v.raw : Number(v);
              const candidates = [];
              for (const modName of ['financialData', 'summaryDetail', 'price']){
                const mod = (root && root[modName]) || {};
                for (const k of ['targetMedianPrice','targetMeanPrice','targetHighPrice','targetLowPrice']){
                  const val = getNum(mod[k]);
                  if (Number.isFinite(val) && val > 0) candidates.push(+val);
                }
              }
              if (candidates.length){
                intrinsic = median(candidates);
                valuation = { perShare: intrinsic, summary: 'Analyst targets median', json: { source:'analystTargets', candidates } };
              }
            }
          }
        }catch{}

        // Final fallback: leave blank if no model/targets (do not echo market price)
        if(!Number.isFinite(intrinsic) || intrinsic<=0){ intrinsic = NaN; }

        let chText = '—';
        let chHTML = '—';
        if(Number.isFinite(change) && Number.isFinite(changePct)){
          const sign = change>0?'+': (change<0?'-':'');
          const absCh = Math.abs(change);
          const absPct = Math.abs(changePct);
          chText = `${sign}${fmt.format(absCh)} (${sign}${absPct.toFixed(2)}%)`;
          const col = change>0 ? css('--c-up') : change<0 ? css('--c-down') : css('--muted');
           chHTML = `<span style=\"color:${col};font-weight:800\">${chText}</span>`;
         }
        els.lastLine.innerHTML = `Last: ${fmtPx(price)} · Change: ${chHTML}`;
        els.prevCloseLine.textContent = `Yesterday’s Close: ${fmtPxPos(prevClose)}`;
        els.ivLine.textContent = `Intrinsic Value: ${fmtPxPos(intrinsic)}`;
        if(valuation){ state.lastValuation = valuation; els.ivLine.title = valuation.summary ? valuation.summary : ''; try{ if(valuation.json) console.debug('DCF valuation', valuation.json); }catch{} }
      }catch(err){ /* silent */ }
    }

    function startQuoteTimer(){
      if(state.quoteTimer){ clearInterval(state.quoteTimer); state.quoteTimer = null; }
      refreshQuoteOnce();
      state.quoteTimer = setInterval(refreshQuoteOnce, 60*1000);
    }

    // Chart data fetch (proxy first to avoid CORS; direct only on localhost)
    async function fetchRows(ticker, range, interval){
      try{
        const u = `/api/chart?ticker=${encodeURIComponent(ticker)}&range=${encodeURIComponent(range)}&interval=${encodeURIComponent(interval)}`;
        const r = await fetch(u, { cache:'no-store' });
        if(r.ok){
          const j = await r.json();
          const res = j?.chart?.result?.[0];
          if(res){
            const ts = res.timestamp || [];
            const q = res.indicators?.quote?.[0]||{};
            const o=q.open||[], h=q.high||[], l=q.low||[], c=q.close||[], v=q.volume||[];
            const rows=[]; for(let i=0;i<ts.length;i++){ if(!Number.isFinite(c[i])) continue; rows.push({ t:ts[i]*1000, o:o[i], h:h[i], l:l[i], c:c[i], v:v[i] }); }
            return rows;
          }
        }
      }catch{}
      if(!isLocal) throw new Error('CORS: use /api/chart in production');
      const u2 = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?range=${encodeURIComponent(range)}&interval=${encodeURIComponent(interval)}&includeTimestamps=true`;
      const r2 = await fetch(u2, { cache:'no-store', referrerPolicy:'no-referrer' });
      if(!r2.ok) throw new Error('chart '+r2.status);
      const j2 = await r2.json();
      const res2 = j2?.chart?.result?.[0];
      if(!res2) throw new Error('no data');
      const ts2 = res2.timestamp || [];
      const q2 = res2.indicators?.quote?.[0]||{};
      const o2=q2.open||[], h2=q2.high||[], l2=q2.low||[], c2=q2.close||[], v2=q2.volume||[];
      const rows2=[]; for(let i=0;i<ts2.length;i++){ if(!Number.isFinite(c2[i])) continue; rows2.push({ t:ts2[i]*1000, o:o2[i], h:h2[i], l:l2[i], c:c2[i], v:v2[i] }); }
      return rows2;
    }

    function buildLayout(opts={}){
      const { rows=[], interval=state.interval } = opts;
      const intraday = isIntraday(interval);
      const decor = intraday ? makeSessionDecor(rows) : { shapes:[], annotations:[] };
      const layout = {
        margin: { l: 56, r: 24, t: 18, b: 28 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        showlegend: true,
        legend: { orientation: 'h', y: -0.12 },
        xaxis: { gridcolor: css('--grid'), showgrid: true, zeroline: false },
        yaxis: { gridcolor: css('--grid'), showgrid: true, zeroline: false },
        yaxis2: { overlaying:'y', side:'right', rangemode:'tozero', showgrid:false, showticklabels:false },
        yaxis3: { overlaying:'y', side:'right', range:[0,100], showgrid:false, showticklabels:false },
        yaxis4: { overlaying:'y', side:'right', showgrid:false, showticklabels:false },
        font: { color: css('--text') },
        shapes: state.sessionsOn ? decor.shapes.map(s=>({ ...s, __session:true })) : [],
        annotations: state.sessionsOn ? decor.annotations : [],
        uirevision: `${state.ticker}|${state.range}|${state.interval}`
      };
      if(intraday){
        layout.xaxis.rangebreaks = [
          { pattern:'day of week', bounds:['sat','mon'] },
          { pattern:'hour', bounds:[20, 9.5] }
        ];
      }
      return layout;
    }

    function candleTrace(rows){
      const x = rows.map(r=>new Date(r.t));
      const dateFmt = isIntraday(state.interval) ? '%b %d, %Y %H:%M' : '%b %d, %Y';
      return {
        type: 'candlestick', name: 'Price', x,
        open: rows.map(r=>r.o), high: rows.map(r=>r.h), low: rows.map(r=>r.l), close: rows.map(r=>r.c),
        increasing: { line: { color: css('--c-up') } },
        decreasing: { line: { color: css('--c-down') } },
        hovertemplate: `<b>%{x|${dateFmt}}</b><br>` +
                       `High: $%{high:,.2f}<br>` +
                       `Low: $%{low:,.2f}` +
                       `<extra></extra>`
      };
    }
    function smaTrace(rows, period, color, name){
      const x = rows.map(r=>new Date(r.t));
      const y = SMA(rows.map(r=>r.c), period, true);
      return { type:'scatter', mode:'lines', name, x, y, line:{ color, width:1.6 }, visible:false, hoverinfo:'skip' };
    }
    function volTrace(rows){
      const x = rows.map(r=>new Date(r.t));
      const y = rows.map(r=>r.v||0);
      const col = rows.map(r=> (r.c>=r.o? css('--c-up'): css('--c-down')) );
      return { type:'bar', name:'Volume', x, y, yaxis:'y2', marker:{ color: col, opacity:0.28 }, visible:false, hoverinfo:'skip' };
    }
    function rsiTrace(rows){
      const x = rows.map(r=>new Date(r.t));
      const y = RSI(rows.map(r=>r.c), 14);
      return { type:'scatter', mode:'lines', name:'RSI 14', x, y, yaxis:'y3', line:{ color: css('--c-rsi'), width:1.4 }, visible:false, hoverinfo:'skip' };
    }
    function macdTraces(rows){
      const x = rows.map(r=>new Date(r.t));
      const { macd, signal, hist } = MACD(rows.map(r=>r.c));
      const col = hist.map(v=> v>=0? css('--c-up') : css('--c-down'));
      return [
        { type:'scatter', mode:'lines', name:'MACD', x, y:macd, yaxis:'y4', line:{ color: css('--c-macd'), width:1.4 }, visible:false, hoverinfo:'skip' },
        { type:'scatter', mode:'lines', name:'Signal', x, y:signal, yaxis:'y4', line:{ color: '#94d9f8', width:1.2, dash:'dot' }, visible:false, hoverinfo:'skip' },
        { type:'bar', name:'Histogram', x, y:hist, yaxis:'y4', marker:{ color: col, opacity:.4 }, visible:false, hoverinfo:'skip' }
      ];
    }
    function ichiTraces(rows){
      const x = rows.map(r=>new Date(r.t));
      const ichi = Ichimoku(rows);
      const traces = [];
      traces.push({ type:'scatter', mode:'lines', name:'Tenkan', x, y:ichi.tenkan, line:{ color: css('--c-ichi-tenkan'), width:1.2 }, visible:false, hoverinfo:'skip', showlegend:false, meta:'ICHI' });
      traces.push({ type:'scatter', mode:'lines', name:'Kijun', x, y:ichi.kijun, line:{ color: css('--c-ichi-kijun'), width:1.2 }, visible:false, hoverinfo:'skip', showlegend:false, meta:'ICHI' });
      traces.push({ type:'scatter', mode:'lines', name:'Chikou', x, y:ichi.chikou, line:{ color: css('--c-ichi-chikou'), width:1 }, visible:false, hoverinfo:'skip', showlegend:false, meta:'ICHI' });
      const sa = ichi.spanA, sb = ichi.spanB; const n = x.length;
      let i = 0;
      function pushCloudSegment(xSeg, upper, lower, color, label){
        if(xSeg.length<2) return;
        traces.push({ type:'scatter', mode:'lines', name:label+' base', x:xSeg, y:lower, line:{ color:'rgba(0,0,0,0)', width:0.5 }, visible:false, hoverinfo:'skip', showlegend:false, meta:'ICHI' });
        traces.push({ type:'scatter', mode:'lines', name:label, x:xSeg, y:upper, line:{ color:'rgba(0,0,0,0)', width:0.5 }, fill:'tonexty', fillcolor: color, visible:false, hoverinfo:'skip', showlegend:false, meta:'ICHI' });
      }
      while(i<n){
        while(i<n && (!Number.isFinite(sa[i]) || !Number.isFinite(sb[i]))) i++;
        if(i>=n) break;
        const up = sa[i] >= sb[i];
        const xSeg = [], aSeg=[], bSeg=[];
        while(i<n && Number.isFinite(sa[i]) && Number.isFinite(sb[i]) && ((sa[i]>=sb[i])===up)){
          xSeg.push(x[i]); aSeg.push(sa[i]); bSeg.push(sb[i]); i++;
        }
        const color = up ? css('--c-ichi-up') : css('--c-ichi-down');
        const upper = up ? aSeg : bSeg;
        const lower = up ? bSeg : aSeg;
        pushCloudSegment(xSeg, upper, lower, color, up?'Cloud Up':'Cloud Down');
      }
      return traces;
    }

    // === Overlay helpers ===
    function setChip(key, on){
      const chip = els.toggles?.querySelector(`.chip[data-k="${key}"]`);
      if(!chip) return;
      chip.classList.toggle('active', !!on);
      chip.setAttribute('aria-pressed', on ? 'true' : 'false');
    }
    function setVisibilityByNames(names, on){
      const ids = [];
      (els.chart?.data||[]).forEach((t,idx)=>{ if(t && names.includes(t.name)) ids.push(idx); });
      if(ids.length) Plotly.restyle(els.chart, { visible: on }, ids);
    }
    function setSMAVisibility(key, on){
      const name = key==='SMA20'?'SMA 20': key==='SMA50'?'SMA 50':'SMA 200';
      setVisibilityByNames([name], on); setChip(key, on);
    }
    function setRSI(on){ setVisibilityByNames(['RSI 14'], on); setChip('RSI', on); }
    function setMACD(on){ setVisibilityByNames(['MACD','Signal','Histogram'], on); setChip('MACD', on); }
    function setVOL(on){ setVisibilityByNames(['Volume'], on); setChip('VOL', on); }
    function setICHI(on){
      const ids = [];
      (els.chart?.data||[]).forEach((t,idx)=>{ if(t?.meta==='ICHI') ids.push(idx); });
      if(ids.length) Plotly.restyle(els.chart, { visible: on }, ids);
      setChip('ICHI', on);
    }
    function setAutoFib(on){
      state.fibOn = !!on;
      const base = els.chart?.layout?.shapes||[];
      const others = base.filter(s=>!s.__fib);
      const fibs = (state.fibShapes||[]).map(s=>({ ...s, __fib:true }));
      const shapes = on ? [...others, ...fibs] : [...others];
      Plotly.relayout(els.chart, { shapes });
      setChip('AUTOFIB', on);
                                                                    }
       function setSessions(on){
      state.sessionsOn = !!on;
      const intraday = isIntraday(state.interval);
      const decor = intraday && state.sessionsOn ? makeSessionDecor(state.rows) : { shapes:[], annotations:[] };
      const base = els.chart?.layout?.shapes||[];
      const others = base.filter(s=>!s.__session);
      const newShapes = state.sessionsOn ? [...others, ...decor.shapes.map(s=>({ ...s, __session:true }))] : [...others];
      const yRange = els.chart?.layout?.yaxis?.range ? [...els.chart.layout.yaxis.range] : null;
      const xRange = els.chart?.layout?.xaxis?.range ? [...els.chart.layout.xaxis.range] : null;
      const upd = { shapes: newShapes, annotations: (state.sessionsOn ? decor.annotations : []) };
      if(yRange) upd['yaxis.range'] = yRange;
      if(xRange) upd['xaxis.range'] = xRange;
      Plotly.relayout(els.chart, upd);
      setChip('SESS', on);
    }

    // Toggle click handling
    els.toggles?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.chip');
      if(!btn) return;
      const key = btn.getAttribute('data-k');
      const on = !btn.classList.contains('active');
      if(/^SMA(20|50|200)$/.test(key))      return void setSMAVisibility(key, on);
      if(key==='RSI')    return void setRSI(on);
      if(key==='MACD')   return void setMACD(on);
      if(key==='VOL')    return void setVOL(on);
      if(key==='ICHI')   return void setICHI(on);
      if(key==='AUTOFIB')return void setAutoFib(on);
      if(key==='SESS')   return void setSessions(on);
    });

    async function plot(ticker, { resetChips=false } = {}){
      state.rows = await fetchRows(ticker, state.range, state.interval);
      const traces = [
        candleTrace(state.rows),
        smaTrace(state.rows, 20, css('--c-sma20'), 'SMA 20'),
        smaTrace(state.rows, 50, css('--c-sma50'), 'SMA 50'),
        smaTrace(state.rows, 200, css('--c-sma200'), 'SMA 200'),
        volTrace(state.rows),
        rsiTrace(state.rows),
        ...macdTraces(state.rows),
        ...ichiTraces(state.rows)
      ];
      const layout = buildLayout({ rows: state.rows, interval: state.interval });
      state.fibShapes = makeFibShapes(state.rows);
      await Plotly.newPlot(els.chart, traces, layout, { displayModeBar:false, responsive:true });
      if(resetChips){
        ['SMA20','SMA50','SMA200','RSI','MACD','VOL','ICHI','AUTOFIB'].forEach(k=>setChip(k,false));
        setChip('SESS', state.sessionsOn);
      } else {
        const on = k => !!els.toggles.querySelector(`.chip[data-k="${k}"]`)?.classList.contains('active');
        setSMAVisibility('SMA20', on('SMA20'));
        setSMAVisibility('SMA50', on('SMA50'));
        setSMAVisibility('SMA200', on('SMA200'));
        setRSI(on('RSI'));
        setMACD(on('MACD'));
        setVOL(on('VOL'));
        setICHI(on('ICHI'));
        setAutoFib(on('AUTOFIB'));
        setSessions(on('SESS'));
      }
    }

    // --- Timeframe selection handlers ---
    function normalizeTimeframe(range, interval){
      const isMinute = /^(1|5|15|60)m$/.test(interval);
      if(isMinute){
        if(interval==='60m'){
          const ok = new Set(['1d','2d','5d','10d','1mo','3mo','6mo']);
          if(!ok.has(range)) range = '3mo';
        } else {
          const ok = new Set(['1d','2d','5d','10d']);
          if(!ok.has(range)) range = '10d';
        }
      }
      return { range, interval };
    }

    async function applyTimeframe(range, interval){
      const norm = normalizeTimeframe(range, interval);
      state.range = norm.range; state.interval = norm.interval;
      if(els.timeSel && els.timeSel.value !== state.range) els.timeSel.value = state.range;
      if(els.freqSel && els.freqSel.value !== state.interval) els.freqSel.value = state.interval;
      await plot(state.ticker);
      await refreshQuoteOnce();
    }

    els.timeSel?.addEventListener('change', ()=>{
      const r = els.timeSel.value; const i = els.freqSel?.value || state.interval;
      applyTimeframe(r, i).catch(console.error);
    });
    els.freqSel?.addEventListener('change', ()=>{
      const r = els.timeSel?.value || state.range; const i = els.freqSel.value;
      applyTimeframe(r, i).catch(console.error);
    });

    // --- Autocomplete ---
    async function loadSymbols(){
      try{
        const r = await fetch('/stock_data.csv', { cache:'no-store' });
        if(!r.ok) return;
        const txt = await r.text();
        const lines = txt.split(/\r?\n/).filter(Boolean);
        const map = new Map();
        for(const raw of lines){
          const line = raw.trim(); if(!line) continue;
          const delim = line.includes('|') ? '|' : ',';
          let [symRaw, ...nameParts] = line.split(delim);
          let sym = (symRaw||'').trim().toUpperCase();
          if(!sym || sym==='SYMBOL' || sym==='SYMBOL|COMPANY') continue;
          let name = (nameParts.join(delim)||'').trim();
          if(sym.includes('|')){ const [s2, ...rest] = sym.split('|'); sym = s2.trim().toUpperCase(); if(!name) name = rest.join('|').trim(); }
          name = name
            .replace(/\s+/g,' ')
            .replace(/\s*-\s*ADR.*$/i,'')
            .replace(/\b(COMMON|PREFERRED)\s+STOCK.*$/i,'')
            .replace(/\b(ORDINARY\s+SHARES|CLASS\s+[A-Z]).*$/i,'')
            .replace(/^\|+/, '')
            .trim();
          if(!map.has(sym)) map.set(sym, { sym, name, nameU: (name||'').toUpperCase() });
        }
        state.symbols = Array.from(map.values());
      }catch{}
    }

    function renderAC(matches){
      if(!els.ac) return;
      if(!matches.length){ els.ac.classList.remove('show'); els.ac.innerHTML=''; state.acMatches=[]; state.acIndex=-1; return; }
      state.acMatches = matches; state.acIndex = -1;
      els.ac.innerHTML = matches.map((m,i)=>
        `<div class="ac-item" data-idx="${i}">\n           <div class="ticker">${m.sym}</div>\n           <div class="company">${m.name||''}</div>\n         </div>`).join('');
      els.ac.classList.add('show');
    }

    function updateAC(){
      const val = (els.q?.value||'').trim();
      if(!val){ renderAC([]); return; }
      const term = val.toUpperCase();
      const tlen = term.length;
      const exact = []; const symPrefix = []; const namePrefix = []; const nameContains = [];
      const seen = new Set();
      function push(arr, s){ if(!seen.has(s.sym)){ arr.push(s); seen.add(s.sym); } }
      for(const s of state.symbols){
        if(s.sym === term){ push(exact, s); continue; }
        if(s.sym.startsWith(term)){ push(symPrefix, s); continue; }
        // Avoid noisy single-letter name matches; require longer terms for name checks
        if(tlen >= 2 && s.nameU?.startsWith(term)){ push(namePrefix, s); continue; }
        if(tlen >= 3 && s.nameU?.includes(term)){ push(nameContains, s); }
      }
      const best = [...exact, ...symPrefix, ...namePrefix, ...nameContains].slice(0, 30);
      renderAC(best);
    }

    els.q?.addEventListener('input', updateAC);
    els.q?.addEventListener('focus', updateAC);
    els.q?.addEventListener('keydown', (e)=>{
      const acShown = els.ac?.classList.contains('show');
      const max = state.acMatches.length;
      if(e.key==='ArrowDown' && acShown){ e.preventDefault(); state.acIndex = (state.acIndex+1+max)%max; highlightAC(); }
      else if(e.key==='ArrowUp' && acShown){ e.preventDefault(); state.acIndex = (state.acIndex-1+max)%max; highlightAC(); }
      else if(e.key==='Enter'){
        if(acShown && state.acIndex>=0 && state.acIndex<max){ e.preventDefault(); chooseAC(state.acMatches[state.acIndex]); }
        else { e.preventDefault(); els.ac?.classList.remove('show'); doSearch(); }
      } else if(e.key==='Escape' && acShown){ els.ac.classList.remove('show'); }
    });

    function highlightAC(){
      const items = els.ac?.querySelectorAll('.ac-item')||[];
      items.forEach((el,i)=> el.classList.toggle('active', i===state.acIndex));
    }
    function chooseAC(item){
      if(!item) return;
      if(els.q) els.q.value = item.sym;
      els.ac?.classList.remove('show');
      doSearch();
    }
    els.ac?.addEventListener('mousedown', (e)=>{
      const it = e.target.closest('.ac-item'); if(!it) return;
      const idx = +it.getAttribute('data-idx');
      chooseAC(state.acMatches[idx]);
    });
    els.q?.addEventListener('blur', ()=> setTimeout(()=> els.ac?.classList.remove('show'), 120));

    // Search
    async function doSearch(){
      const t = (els.q?.value || '').trim().toUpperCase();
      if(!t) return;
      state.ticker = t;
      await plot(state.ticker).catch(console.error);
      startQuoteTimer();
      await refreshQuoteOnce();
    }
    els.searchBtn?.addEventListener('click', ()=>{ doSearch(); });

    // Fullscreen and width controls
    document.getElementById('wideBtn')?.addEventListener('click', ()=>{
      document.querySelector('.container')?.classList.toggle('wide');
      setTimeout(()=>{ if(els.chart) Plotly.Plots.resize(els.chart); }, 60);
    });
    document.getElementById('maxBtn')?.addEventListener('click', ()=>{
      const card = document.getElementById('chartCard');
      if(!card) return;
      const makeMax = !card.classList.contains('max');
      card.classList.toggle('max', makeMax);
      const txt = document.querySelector('#maxBtn .tool-txt');
      if(txt) txt.textContent = makeMax ? 'Exit' : 'Max';
      setTimeout(()=>{ if(els.chart) Plotly.Plots.resize(els.chart); }, 60);
    });

    // Sheets open/close
    function openSheet(id){ const el = document.getElementById(id); if(el) el.hidden = false; }
    function closeSheet(id){ const el = document.getElementById(id); if(el) el.hidden = true; }

    // Toolbar buttons -> sheets
    document.getElementById('toolGPTs')?.addEventListener('click', ()=> openSheet('sheetGPTs'));

    // User-provided Finviz screeners (preferred if present)
    const SCREENERS = [
      // ===== Beginner =====
      {
        id: "oversold_reversal",
        label: "Oversold Reversal",
        level: "Beginner",
        url: "https://finviz.com/screener.ashx?v=111&f=sh_price_o5,sh_relvol_o2,ta_change_u,ta_rsi_os30&ft=4&o=price",
        filters: ["sh_price_o5","sh_relvol_o2","ta_change_u","ta_rsi_os30"]
      },
      {
        id: "new_highs",
        label: "New Highs (momentum)",
        level: "Beginner",
        url: "https://finviz.com/screener.ashx?v=141&f=an_recom_buy,sh_price_u7,ta_change_u,ta_highlow20d_nh,ta_highlow50d_nh,ta_highlow52w_nh,ta_perf_dup&ft=4&o=-perf1w",
        filters: ["an_recom_buy","sh_price_u7","ta_change_u","ta_highlow20d_nh","ta_highlow50d_nh","ta_highlow52w_nh","ta_perf_dup"]
      },
      {
        id: "sma_crossover",
        label: "SMA 50 cross 20 (trend start)",
        level: "Beginner",
        url: "https://finviz.com/screener.ashx?v=141&f=fa_pe_profitable,sh_avgvol_o400,sh_relvol_o1,sh_short_low,ta_beta_o1,ta_sma50_cross20b&ft=4",
        filters: ["fa_pe_profitable","sh_avgvol_o400","sh_relvol_o1","sh_short_low","ta_beta_o1","ta_sma50_cross20b"]
      },
      {
        id: "low_pe_value",
        label: "Low P/E Value",
        level: "Beginner",
        url: "https://finviz.com/screener.ashx?v=141&f=cap_smallunder,fa_pb_low,fa_pe_low,fa_peg_low,fa_roa_pos,fa_roe_pos,sh_price_o5&ft=4&o=-perfytd",
        filters: ["cap_smallunder","fa_pb_low","fa_pe_low","fa_peg_low","fa_roa_pos","fa_roe_pos","sh_price_o5"]
      },
      {
        id: "bounce_ma",
        label: "Bounce at Moving Average",
        level: "Beginner",
        url: "https://finviz.com/screener.ashx?v=141&f=sh_avgvol_o400,sh_curvol_o2000,sh_relvol_o1,ta_sma20_pa,ta_sma50_pb&ft=4&o=-perf1w",
        filters: ["sh_avgvol_o400","sh_curvol_o2000","sh_relvol_o1","ta_sma20_pa","ta_sma50_pb"]
      },

      // ===== Intermediate =====
      {
        id: "high_rel_vol",
        label: "High Relative Volume",
        level: "Intermediate",
        url: "https://finviz.com/screener.ashx?v=131&f=fa_curratio_o1,fa_epsqoq_o15,fa_quickratio_o1,fa_salesqoq_o15,sh_avgvol_o400,sh_price_o5,sh_relvol_o1.5,ta_sma20_pa,ta_sma200_sb50,ta_sma50_sa200&ft=4&o=instown",
        filters: ["fa_curratio_o1","fa_epsqoq_o15","fa_quickratio_o1","fa_salesqoq_o15","sh_avgvol_o400","sh_price_o5","sh_relvol_o1.5","ta_sma20_pa","ta_sma200_sb50","ta_sma50_sa200"]
      },
      {
        id: "potential_uptrend_from_weekly_lows",
        label: "Potential Uptrend from Weekly Lows",
        level: "Intermediate",
        url: "https://finviz.com/screener.ashx?v=141&f=sh_avgvol_o400,ta_pattern_channelup,ta_perf_1wdown&ft=4&o=perf1w",
        filters: ["sh_avgvol_o400","ta_pattern_channelup","ta_perf_1wdown"]
      },
      {
        id: "weekly_earnings_gap_up",
        label: "Weekly Earnings Gap Up",
        level: "Intermediate",
        url: "https://finviz.com/screener.ashx?v=141&f=earningsdate_tomorrowafter,sh_avgvol_o400,sh_curvol_o50,sh_short_u25,ta_averagetruerange_o0.5,ta_gap_u2&ft=4&o=-perfytd",
        filters: ["earningsdate_tomorrowafter","sh_avgvol_o400","sh_curvol_o50","sh_short_u25","ta_averagetruerange_o0.5","ta_gap_u2"]
      },
      {
        id: "shorted_stocks",
        label: "Heavily Shorted (U.S.)",
        level: "Intermediate",
        url: "https://finviz.com/screener.ashx?v=131&f=cap_smallover,geo_usa,sh_avgvol_o500,sh_curvol_o500,sh_opt_optionshort,sh_price_o3,sh_relvol_o1,sh_short_high&o=-shortinterestshare",
        filters: ["cap_smallover","geo_usa","sh_avgvol_o500","sh_curvol_o500","sh_opt_optionshort","sh_price_o3","sh_relvol_o1","sh_short_high"]
      },
      {
        id: "short_squeeze",
        label: "Short Squeeze Setup",
        level: "Intermediate",
        url: "https://finviz.com/screener.ashx?v=131&f=sh_avgvol_o100,sh_instown_u50,sh_price_o2,sh_short_o15&ft=4&o=-shortinterestshare",
        filters: ["sh_avgvol_o100","sh_instown_u50","sh_price_o2","sh_short_o15"]
      },
      {
        id: "high_sales_growth",
        label: "High Sales Growth",
        level: "Intermediate",
        url: "https://finviz.com/screener.ashx?v=111&f=fa_debteq_u0.5,fa_roe_o15,fa_sales5years_o20,fa_salesqoq_o20,sh_avgvol_o200,sh_instown_o60,sh_price_o5,sh_short_u5&ft=4",
        filters: ["fa_debteq_u0.5","fa_roe_o15","fa_sales5years_o20","fa_salesqoq_o20","sh_avgvol_o200","sh_instown_o60","sh_price_o5","sh_short_u5"]
      },
      {
        id: "buy_hold_value",
        label: "Buy & Hold Value",
        level: "Intermediate",
        url: "https://finviz.com/screener.ashx?v=121&f=cap_microover,fa_curratio_o1.5,fa_estltgrowth_o10,fa_peg_o1,fa_roe_o15,ta_beta_o1.5,ta_sma20_pa&ft=4&o=-forwardpe",
        filters: ["cap_microover","fa_curratio_o1.5","fa_estltgrowth_o10","fa_peg_o1","fa_roe_o15","ta_beta_o1.5","ta_sma20_pa"]
      },
      {
        id: "undervalued_div_growth",
        label: "Undervalued Dividend Growth",
        level: "Intermediate",
        url: "https://finviz.com/screener.ashx?v=111&f=cap_largeover,fa_div_pos,fa_epsyoy1_o5,fa_estltgrowth_o5,fa_payoutratio_u50,fa_pe_u20,fa_peg_low&ft=4&o=-pe",
        filters: ["cap_largeover","fa_div_pos","fa_epsyoy1_o5","fa_estltgrowth_o5","fa_payoutratio_u50","fa_pe_u20","fa_peg_low"]
      },

      // ===== Advanced =====
      {
        id: "oversold_next_earnings_growth",
        label: "Oversold + Earnings in 5d + Growth",
        level: "Advanced",
        url: "https://finviz.com/screener.ashx?v=141&f=cap_smallover,earningsdate_nextdays5,fa_epsqoq_o15,fa_epsyoy_pos,fa_epsyoy1_pos,fa_grossmargin_o20,fa_netmargin_pos,fa_sales5years_o5,fa_salesqoq_pos,sh_avgvol_o750,sh_curvol_o1000,ta_perf_52w10o,ta_rsi_nob50&ft=4&o=perfytd",
        filters: ["cap_smallover","earningsdate_nextdays5","fa_epsqoq_o15","fa_epsyoy_pos","fa_epsyoy1_pos","fa_grossmargin_o20","fa_netmargin_pos","fa_sales5years_o5","fa_salesqoq_pos","sh_avgvol_o750","sh_curvol_o1000","ta_perf_52w10o","ta_rsi_nob50"]
      },
      {
        id: "breaking_out_quality",
        label: "Breaking Out (Quality balance sheet)",
        level: "Advanced",
        url: "https://finviz.com/screener.ashx?v=141&f=fa_debteq_u1,fa_roe_o20,sh_avgvol_o100,ta_highlow50d_nh,ta_sma20_pa,ta_sma200_pa,ta_sma50_pa&ft=4&o=-perf1w",
        filters: ["fa_debteq_u1","fa_roe_o20","sh_avgvol_o100","ta_highlow50d_nh","ta_sma20_pa","ta_sma200_pa","ta_sma50_pa"]
      },
      {
        id: "high_earnings_growth",
        label: "High Earnings Growth",
        level: "Advanced",
        url: "https://finviz.com/screener.ashx?v=141&f=fa_epsqoq_o25,fa_epsyoy_o25,fa_epsyoy1_o25,fa_salesqoq_o25,sh_avgvol_o400,ta_rsi_nos50,ta_sma200_pa&ft=4&o=-perfytd",
        filters: ["fa_epsqoq_o25","fa_epsyoy_o25","fa_epsyoy1_o25","fa_salesqoq_o25","sh_avgvol_o400","ta_rsi_nos50","ta_sma200_pa"]
      },
      {
        id: "consistent_growth_bullish",
        label: "Consistent Growth on Bullish Trend",
        level: "Advanced",
        url: "https://finviz.com/screener.ashx?v=141&f=fa_eps5years_pos,fa_epsqoq_o20,fa_epsyoy_o25,fa_epsyoy1_o15,fa_estltgrowth_pos,fa_roe_o15,sh_instown_o10,sh_price_o15,ta_highlow52w_a90h,ta_rsi_nos50&ft=4&o=-perfytd",
        filters: ["fa_eps5years_pos","fa_epsqoq_o20","fa_epsyoy_o25","fa_epsyoy1_o15","fa_estltgrowth_pos","fa_roe_o15","sh_instown_o10","sh_price_o15","ta_highlow52w_a90h","ta_rsi_nos50"]
      },
      {
        id: "canslim",
        label: "CANSLIM",
        level: "Advanced",
        url: "https://finviz.com/screener.ashx?v=111&f=fa_eps5years_o20,fa_epsqoq_o20,fa_epsyoy_o20,fa_sales5years_o20,fa_salesqoq_o20,sh_curvol_o200&ft=4",
        filters: ["fa_eps5years_o20","fa_epsqoq_o20","fa_epsyoy_o20","fa_sales5years_o20","fa_salesqoq_o20","sh_curvol_o200"]
      }
    ];

    function getStoredScreeners(){
      try{
        const keys = ['screeners','finviz_screeners','userScreeners'];
        for(const k of keys){
          const raw = localStorage.getItem(k);
          if(!raw) continue;
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed)){
            return parsed.filter(x=>x && (x.url || (x.filters && x.id))).map(x=>({
              title: String(x.title || x.label || 'Custom'),
              desc: String(x.desc || ''),
              lvl:  String(x.lvl || x.level || 'Beginner'),
              url:  String(x.url || ''),
              filters: Array.isArray(x.filters) ? x.filters : undefined,
              id: x.id
            }));
          }
        }
      }catch{}
      return null;
    }

    function resolveScreeners(list){
      if(Array.isArray(list) && list.length) return list;
      if(Array.isArray(SCREENERS) && SCREENERS.length){
        return SCREENERS.map(s=>({ title: s.label, desc: '', lvl: s.level, url: s.url, id: s.id, filters: s.filters }));
      }
      const stored = getStoredScreeners();
      if(stored && stored.length) return stored;
      return DEFAULT_SCREENERS;
    }

    function renderScreeners(list){
      const wrap = document.getElementById('scrList');
      if(!wrap) return;
      if(wrap.childElementCount>0) return; // already rendered
      const items = resolveScreeners(list);
      wrap.innerHTML = (items||[]).map(s=>
        `<div class="scr-item" data-lvl="${(s.lvl||'Beginner')}">
           <div style="flex:1;min-width:0">
             <div class="title">${(s.title || s.label || '')}</div>
             <div class="desc">${(s.desc || '')}</div>
           </div>
           <div style="display:flex;align-items:center;gap:8px">
             <span class="badge">Finviz</span>
             <a class="open-btn" href="${s.url}" target="_blank" rel="noopener">Open</a>
           </div>
         </div>`
      ).join('');
    }

    document.getElementById('toolScreeners')?.addEventListener('click', ()=> { renderScreeners(); openSheet('sheetScreeners'); });

    // Bottom nav shortcuts
    document.querySelector('button[data-tab="screeners"]')?.addEventListener('click', (e)=>{ e.preventDefault(); renderScreeners(); openSheet('sheetScreeners'); });
    document.querySelector('button[data-tab="gpts"]')?.addEventListener('click', (e)=>{ e.preventDefault(); openSheet('sheetGPTs'); });

    // Close buttons inside sheets
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-close]');
      if(!btn) return;
      const id = btn.getAttribute('data-close');
      if(id) closeSheet(id);
    });

    // Click outside sheet content to close
    document.querySelectorAll('.sheet').forEach(s=>{
      s.addEventListener('mousedown', (e)=>{ if(e.target === s) s.hidden = true; });
    });

    // Initial setup
    ['SMA20','SMA50','SMA200','RSI','MACD','VOL','ICHI','AUTOFIB'].forEach(k=>setChip(k,false));
    setChip('SESS', state.sessionsOn);
    loadSymbols();
    (async()=>{ await plot(state.ticker, { resetChips:true }).catch(console.error); startQuoteTimer(); await refreshQuoteOnce(); })();
    window.addEventListener('resize', ()=>{ if(els.chart) Plotly.Plots.resize(els.chart); });
  })();
  </script>
</body>
</html>