<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Analyzer v.037</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="/assets/stratus-trader-wide.png">

<!-- Plotly (no defer) -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<style>
  :root{
    --bg:#0f1115;--panel:#151923;--text:#e5e7eb;--muted:#9ca3af
    --accent:#22c55e;--focus:#3b82f6;--border:#23283a;--hover:#161a25;
    --metric-bg:#1a1f2e;--metric-border:#2a2f3e;
    --field-bg:#0c0f16;--field-text:#e5e7eb;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#60a5fa;--c-sma200:#f59e0b;
    --c-rsi:#a78bfa;--c-macd:#38bdf8;--c-vol:#10b981;
    --grid:#283044;
    --lvl-beginner:#22c55e; --lvl-intermediate:#f59e0b; --lvl-advanced:#ef4444;
    --tf-bg:#1c1f35; --tf-head:#1a214e; --tf-glow:#3b82f6;
    --c-ichi-tenkan:#f59e0b; --c-ichi-kijun:#60a5fa; --c-ichi-chikou:#93c5fd;
    --c-ichi-up:rgba(34,197,94,.38);   /* stronger */
    --c-ichi-down:rgba(239,68,68,.34); /* stronger */
  }
  .light{
    --bg:#f8fafc;--panel:#fff;--text:#222;--muted:#64748b;
    --accent:#22c55e;--focus:#3b82f3;--border:#e2e8f0;--hover:#f1f5f9;
    --metric-bg:#f1f5f9;--metric-border:#e2e8f0;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#2563eb;--c-sma200:#f59e0b;
    --c-rsi:#7c3aed;--c-macd:#0ea5e9;--c-vol:#16a34a;
    --grid:#e5e7eb; --tf-bg:#eef2ff; --tf-head:#c7d2fe; --tf-glow:#6366f1;
    --field-bg:#ffffff; --field-text:#111827;
  }
  *{box-sizing:border-box}
  html,body{overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh;padding:20px;transition:background .2s,color .2s}
  .container{max-width:1100px;margin:0 auto}
  .toolbar{position:sticky;top:0;z-index:12000;display:flex;gap:10px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin-bottom:16px;flex-wrap:wrap}
  .ticker-wrap{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
  .ticker-wrap label{font-weight:800;opacity:.9}
  .input-wrap{position:relative;flex:0 1 460px;max-width:460px;width:100%}
  @media (max-width:720px){ .input-wrap{flex:1 1 100%;max-width:100%} }
  .ticker-input{width:100%;min-width:120px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--field-bg);color:var(--field-text);text-transform:uppercase;font-size:16px}
  .btn{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn.inline{padding:8px 12px}
  .toolsbar{display:flex;align-items:center;gap:8px;margin-left:auto;flex:1 1 100%;justify-content:flex-start;flex-wrap:wrap}
  .tool-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:700;cursor:pointer}
  .tool-btn:hover{background:var(--hover)}
  .theme-toggle{margin-left:auto;cursor:pointer;padding:8px 14px;border-radius:8px;background:var(--panel);color:var(--text);border:1px solid var(--border);font-weight:600}
  .theme-toggle:hover{background:var(--hover)}
  .theme-toggle.active{background:var(--accent);color:#fff}
  .ac{position:absolute;left:0;top:calc(100% + 6px);width:100%;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;display:none;max-height:280px;overflow:auto;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:12050}
  .ac.show{display:block}
  .ac-item{padding:12px 14px;display:grid;grid-template-columns:110px 1fr;gap:12px;align-items:center;cursor:pointer;border-bottom:1px solid var(--metric-border)}
  .ac-item:hover,.ac-item.active{background:var(--hover)}
  .ticker{font-weight:800}
  .company{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .info{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;position:relative}
  .info-logo{position:absolute;top:10px;right:12px;height:54px;opacity:.92;pointer-events:none;filter:drop-shadow(0 2px 8px rgba(0,0,0,.35))}
  .light .info-logo{mix-blend-mode:multiply;filter:drop-shadow(0 2px 6px rgba(0,0,0,.12));opacity:.95}
  @media (max-width:640px){ .info-logo{height:42px;right:10px} }
  #chartCard{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative}
  #chart{height:68vh;min-height:520px}
  .container.wide{max-width:100%!important}
  #chartCard.max{position:fixed;inset:12px;z-index:9999;margin:0!important;width:auto!important;height:auto!important;overflow:auto}
  #chartCard.max #chart{height:calc(100vh - 160px)!important;min-height:400px;cursor:zoom-out}
  .tf-card{background:var(--tf-bg);border:1px solid rgba(99,102,241,.25);border-radius:12px;padding:10px;margin-bottom:10px;box-shadow:0 0 0 1px rgba(99,102,241,.15) inset}
  .tf-head{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg, var(--tf-head), transparent);border-radius:8px;padding:6px 10px;margin:-4px -2px 8px;font-weight:800}
  .tf-head .carat{display:inline-block;transform:rotate(-90deg);transition:transform .15s ease}
  .tf-card[data-open="true"] .carat{transform:rotate(0)}
  .tf-body{display:none}
  .tf-card[data-open="true"] .tf-body{display:grid}
  .tf-body{grid-template-columns:1fr 1fr;gap:10px}
  .control label{display:block;font-size:13px;font-weight:800;margin-bottom:6px;color:#cbd5ff}
  .control select{width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px}
  .toggle-row{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 10px}
  .chip{border:1px solid #2b3548;border-radius:999px;padding:6px 12px;cursor:pointer;font-weight:700;opacity:.95;user-select:none;transition:background .15s,color .15s,border-color .15s}
  /* Chip base colors — all overlays get strong color and glow */
  .chip[data-k="SMA20"]{border-color:var(--c-sma20);color:var(--c-sma20);background:transparent;}
  .chip[data-k="SMA50"]{border-color:var(--c-sma50);color:var(--c-sma50);background:transparent;}
  .chip[data-k="SMA200"]{border-color:var(--c-sma200);color:var(--c-sma200);background:transparent;}
  .chip[data-k="RSI"]{border-color:var(--c-rsi);color:var(--c-rsi);background:transparent;}
  .chip[data-k="MACD"]{border-color:var(--c-macd);color:var(--c-macd);background:transparent;}
  .chip[data-k="VOL"]{border-color:var(--c-vol);color:var(--c-vol);background:transparent;}
  .chip[data-k="AUTOFIB"]{border-color:#8b5cf6;color:#8b5cf6;background:transparent;}
  .chip[data-k="ICHI"]{border-color:#60a5fa;color:#60a5fa;background:transparent;}
  .chip{background:transparent;color:var(--text);}
  .chip.active{color:#fff;background:rgba(255,255,255,0.08);}
  /* Strong halo glow for ACTIVE chips only, using overlay color */
  .chip.active[data-k="SMA20"] {
    --chip-glow: var(--c-sma20, #22c55e);
    box-shadow:
      0 0 0 2px var(--chip-glow),
      0 0 14px 3px var(--chip-glow),
      0 0 36px 10px color-mix(in sRGB, var(--chip-glow) 40%, transparent);
  }
  .chip.active[data-k="SMA50"] {
    --chip-glow: var(--c-sma50, #60a5fa);
    box-shadow:
      0 0 0 2px var(--chip-glow),
      0 0 14px 3px var(--chip-glow),
      0 0 36px 10px color-mix(in sRGB, var(--chip-glow) 40%, transparent);
  }
  .chip.active[data-k="SMA200"] {
    --chip-glow: var(--c-sma200, #f59e0b);
    box-shadow:
      0 0 0 2px var(--chip-glow),
      0 0 14px 3px var(--chip-glow),
      0 0 36px 10px color-mix(in sRGB, var(--chip-glow) 40%, transparent);
  }
  .chip.active[data-k="RSI"] {
    --chip-glow: var(--c-rsi, #a78bfa);
    box-shadow:
      0 0 0 2px var(--chip-glow),
      0 0 14px 3px var(--chip-glow),
      0 0 36px 10px color-mix(in sRGB, var(--chip-glow) 40%, transparent);
  }
  .chip.active[data-k="MACD"] {
    --chip-glow: var(--c-macd, #38bdf8);
    box-shadow:
      0 0 0 2px var(--chip-glow),
      0 0 14px 3px var(--chip-glow),
      0 0 36px 10px color-mix(in sRGB, var(--chip-glow) 40%, transparent);
  }
  .chip.active[data-k="VOL"] {
    --chip-glow: var(--c-vol, #10b981);
    box-shadow:
      0 0 0 2px var(--chip-glow),
      0 0 14px 3px var(--chip-glow),
      0 0 36px 10px color-mix(in sRGB, var(--chip-glow) 40%, transparent);
  }
  .chip.active[data-k="AUTOFIB"] {
    --chip-glow: #8b5cf6;
    box-shadow:
      0 0 0 2px var(--chip-glow),
      0 0 14px 3px var(--chip-glow),
      0 0 36px 10px color-mix(in sRGB, var(--chip-glow) 40%, transparent);
  }
  .chip.active[data-k="ICHI"] {
    --chip-glow: #60a5fa;
    box-shadow:
      0 0 0 2px var(--chip-glow),
      0 0 14px 3px var(--chip-glow),
      0 0 36px 10px color-mix(in sRGB, var(--chip-glow) 40%, transparent);
  }
  .chip.active {
    position: relative;
    z-index: 2;
  }
  .chip.active::after {
    content: "";
    position: absolute;
    inset: -10px;
    border-radius: 999px;
    background: radial-gradient(60% 60% at 50% 50%, var(--chip-glow, #fff) 0%, transparent 75%);
    filter: blur(12px);
    opacity: .45;
    pointer-events: none;
    z-index: 1;
  }
  /* Info bar image fix */
  .info-logo{filter:none;mix-blend-mode:normal;}
  /* Chart overlay text color fix */
  .plotly .legendtext, .plotly .ytick text, .plotly .xtick text { fill: var(--text) !important; }
  .section-sep{margin:20px -16px 16px;padding:0 16px}
  .section-sep .rule{height:3px;border-radius:999px;background:linear-gradient(90deg,var(--focus),var(--accent));opacity:.9}
  .sheet{position:fixed;left:0;right:0;bottom:0;top:auto;background:transparent;display:flex;justify-content:center;z-index:2000}
  .sheet[hidden]{display:none!important}
  .sheet-inner{width:min(760px,100%);background:var(--panel);border-top:1px solid var(--border);border-radius:16px 16px 0 0;box-shadow:0 -8px 30px rgba(0,0,0,.35);padding:14px;animation:sheetUp .18s ease-out;padding-bottom:max(14px, env(safe-area-inset-bottom))}
  .sheet-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .sheet-title{font-weight:800;font-size:16px}
  .sheet-close{background:transparent;border:0;color:var(--text);font-size:18px;cursor:pointer}
  .sheet-body{max-height:58vh;overflow:auto}
  @keyframes sheetUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
  .btmnav{position:fixed;left:0;right:0;bottom:0;display:none;background:var(--panel);border-top:1px solid var(--border);padding:6px 10px;z-index:1000}
  .btmnav .tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 8px;border-radius:10px;border:0;background:transparent;color:var(--text);font-weight:700;font-size:13px}
  .btmnav .tab.active{background:var(--hover)}
  .btmnav .tab span{font-size:11px;opacity:.85}
  @media (max-width:720px){ .btmnav{display:flex;gap:8px} body{padding-bottom:64px} }
  .scr-list{display:flex;flex-direction:column;gap:10px}
  .scr-item{
    position:relative; display:flex; gap:12px; align-items:flex-start;
    padding:12px 14px; border:1px solid var(--border); border-radius:12px;
    background:color-mix(in hsl, var(--panel), var (--bg) 35%);
    text-decoration:none; color:inherit; cursor:pointer;
    transition:background .15s,border-color .15s,transform .06s;
  }
  .scr-item:hover{ background:var(--hover); border-color:#2b3548; transform:translateY(-1px); }
  .scr-item::before{ content:""; position:absolute; left:0; top:8px; bottom:8px; width:4px; border-radius:999px; background: var(--lvl-color, #64748b); opacity:.8; }
  .scr-item{ padding-left:16px; }
  .scr-item[data-lvl="Beginner"]     { --lvl-color: var(--lvl-beginner); }
  .scr-item[data-lvl="Intermediate"] { --lvl-color: var(--lvl-intermediate); }
  .scr-item[data-lvl="Advanced"]     { --lvl-color: var(--lvl-advanced); }
  .scr-item .title{ font-weight:800; font-size:14px; line-height:1.25; }
  .scr-item .desc{ font-size:12px; color:var(--muted); margin-top:2px; }
  .badge{ font-size:11px; font-weight:800; padding:2px 8px; border-radius:999px; background:var(--metric-bg); border:1px solid var(--metric-border); color:var(--muted); white-space:nowrap; margin-top:2px; }
  .scr-item .open-btn{ margin-left:8px; padding:6px 10px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); text-decoration:none; font-weight:700; }
  .scr-item .open-btn:hover{ background:var(--hover); }

  /* === Button glow (added) === */
  .btn, .tool-btn, .theme-toggle, .btmnav .tab {
    --glow-color: var(--focus);
    position: relative;
    transition: box-shadow .15s, transform .06s, background .15s, border-color .15s;
  }
  .btn { --glow-color: var(--accent); }
  .btn:hover, .btn:focus-visible,
  .tool-btn:hover, .tool-btn:focus-visible,
  .theme-toggle:hover, .theme-toggle:focus-visible,
  .btmnav .tab:hover, .btmnav .tab:focus-visible {
    box-shadow:
      0 0 0 2px var(--glow-color),
      0 0 10px var(--glow-color),
      0 0 24px 6px var(--glow-color),
      0 0 40px 12px var(--glow-color);
    z-index: 1;
  }
  .btn:hover::after, .btn:focus-visible::after,
  .tool-btn:hover::after, .tool-btn:focus-visible::after,
  .theme-toggle:hover::after, .theme-toggle:focus-visible::after,
  .btmnav .tab:hover::after, .btmnav .tab:focus-visible::after {
    content: "";
    position: absolute;
    inset: -10px;
    border-radius: inherit;
    background: radial-gradient(60% 60% at 50% 50%, var(--glow-color) 0%, rgba(0,0,0,0) 80%);
    filter: blur(12px);
    z-index: -1;
    pointer-events: none;
    opacity: 0.55;
  }

</style>
</head>
<body>
  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="ticker-wrap">
        <label for="q">Ticker</label>
        <div class="input-wrap">
          <input id="q" class="ticker-input" type="text" placeholder="AAPL, MSFT… or BTC" spellcheck="false" autocomplete="off"/>
          <div id="ac" class="ac" role="listbox" aria-label="Suggestions"></div>
        </div>
        <button id="searchBtn" class="btn inline" type="button">Search</button>
      </div>
      <div class="toolsbar" id="toolsBar">
        <button class="tool-btn" id="toolGPTs" aria-label="Open GPTs">🧠 <span class="tool-txt">GPTs</span></button>
        <button class="tool-btn" id="toolScreeners" aria-label="Open Screeners">🔎 <span class="tool-txt">Screeners</span></button>
        <button class="tool-btn" id="wideBtn" aria-label="Toggle Width">↔︎ <span class="tool-txt">Wide</span></button>
        <button class="tool-btn" id="maxBtn" aria-label="Maximize">⤢ <span class="tool-txt">Max</span></button>
        <button class="tool-btn" id="refreshBtn" aria-label="Refresh">⟳ <span class="tool-txt">Refresh</span></button>
        <button id="themeToggle" class="theme-toggle" type="button">🌙 Dark</button>
      </div>
    </div>

    <!-- Info bar -->
    <div id="info" class="info">
      <h3 id="headline" style="margin:0 0 6px 0"></h3>
      <div style="opacity:.9;font-size:14px;line-height:1.6">
        <div id="lastLine">Last: — · Change: —</div>
        <div id="prevCloseLine">Yesterday’s Close: —</div>
        <div id="ivLine">Intrinsic Value: —</div>
      </div>
      <img id="infoLogo" class="info-logo" src="/assets/stratus-trader-wide.png" alt="Stratus Trader" />
    </div>

    <!-- Chart card -->
    <div id="chartCard">
      <div class="tf-card" id="tfCard" data-open="true">
        <div class="tf-head" id="tfHead"><span class="carat">▾</span> <span style="font-style:italic">time frame</span></div>
        <div class="tf-body">
          <div class="control">
            <label for="timeSel">Time</label>
            <select id="timeSel">
              <option value="1d">1 day</option><option value="2d">2 days</option>
              <option value="5d">5 days</option><option value="10d">10 days</option>
              <option value="sep" disabled>──────────</option>
              <option value="1mo">1 month</option><option value="2mo">2 months</option>
              <option value="3mo">3 months</option><option value="6mo" selected>6 months</option>
              <option value="ytd">YTD</option><option value="1y">1 year</option>
              <option value="2y">2 years</option><option value="3y">3 years</option>
              <option value="4y">4 years</option><option value="5y">5 years</option>
              <option value="10y">1 decade</option><option value="max">All Data</option>
            </select>
          </div>
          <div class="control">
            <label for="freqSel">Frequency</label>
            <select id="freqSel">
              <option value="1m">1-Minute</option><option value="5m">5-Minute</option>
              <option value="15m">15-Minute</option><option value="60m">Hourly</option>
              <option value="sep" disabled>──────────</option>
              <option value="1d" selected>Daily</option><option value="1wk">Weekly</option>
              <option value="1mo">Monthly</option><option value="3mo">Quarterly</option>
              <option value="1y">Yearly</option>
            </select>
          </div>
        </div>
      </div>

      <div class="toggle-row" id="toggles">
        <button class="chip active" data-k="SMA20" type="button">SMA 20</button>
        <button class="chip active" data-k="SMA50" type="button">SMA 50</button>
        <button class="chip active" data-k="SMA200" type="button">SMA 200</button>
        <button class="chip active" data-k="RSI" type="button">RSI</button>
        <button class="chip active" data-k="MACD" type="button">MACD</button>
        <button class="chip active" data-k="VOL" type="button">Volume</button>
        <button class="chip" id="autoFib" data-k="AUTOFIB" type="button">Auto Fib</button>
        <button class="chip active" data-k="ICHI" type="button">Ichimoku</button>
      </div>

      <div id="chart"></div>
    </div>

    <div class="section-sep" aria-hidden="true"><div class="rule"></div></div>
  </div>

  <!-- GPTs Sheet -->
  <div class="sheet" id="sheetGPTs" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">GPTs</div>
        <button class="sheet-close" data-close="sheetGPTs">✕</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" style="margin-bottom:12px">
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">9 Prompts for Smarter Investing</div>
              <div class="desc">Bundle of prompts to guide smarter investment analysis.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-687b911701a08191aadd69c345a67d17-9-prompts-for-smarter-investing" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">Stock Predictor Prompt GPT</div>
              <div class="desc">Structured prompt flow for scenario-led stock predictions.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-686c5fc3dd948191a0ff9c14cecda1b4-stock-predictor-prompt-gpt" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">High Yield Dividend Sniper</div>
              <div class="desc">Quickly target high-yield dividend candidates.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-6878fe277c5c819180211289d9e16148-high-yield-dividend-sniper" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
        </div>
        <div>
          <textarea id="gptInput" rows="4" placeholder="Ask a question about the current ticker…" style="width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button class="btn" id="askGPT">Ask</button>
            <div style="font-size:12px;color:var(--muted)">Uses the visible chart context when possible.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Screeners Sheet -->
  <div class="sheet" id="sheetScreeners" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">Screeners</div>
        <button class="sheet-close" data-close="sheetScreeners">✕</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" id="scrList"></div>
      </div>
    </div>
  </div>

  <nav class="btmnav" id="btmNav" role="navigation" aria-label="Bottom Navigation">
    <button data-tab="home" class="tab active" aria-label="Home">🏠<span>Home</span></button>
    <button data-tab="screeners" class="tab" aria-label="Screeners">🔎<span>Screeners</span></button>
    <button data-tab="gpts" class="tab" aria-label="GPTs">🧠<span>GPTs</span></button>
    <button data-tab="settings" class="tab" aria-label="Settings">⚙️<span>Settings</span></button>
  </nav>

  <!-- Single app script -->
  

  <script>
  function showError(msg) {
    let errBox = document.getElementById('chart-error-box');
    if (!errBox) {
      errBox = document.createElement('div');
      errBox.id = 'chart-error-box';
      errBox.style.cssText = 'color:#fff;background:#c00;padding:8px 16px;margin:8px 0;border-radius:6px;font-weight:bold;text-align:center;z-index:10;';
      const chartParent = document.getElementById('chart')?.parentNode;
      if (chartParent) chartParent.insertBefore(errBox, document.getElementById('chart'));
      else document.body.prepend(errBox);
    }
    errBox.textContent = msg;
    errBox.style.display = 'block';
  }
  function clearError() {
    const errBox = document.getElementById('chart-error-box');
    if (errBox) errBox.style.display = 'none';
  }
  </script>

<script>
// ===== FIXED: Symbols + Autocomplete + Search (single source of truth) =====
(function(){
  // Safe debounce polyfill if global debounce isn't ready yet
  const _debounce = (typeof debounce === 'function') ? debounce : (fn, ms=120) => {
    let h; return (...a) => { clearTimeout(h); h = setTimeout(() => fn(...a), ms); };
  };
  // Wait until els + input/list/button exist before wiring
  function whenElsReady(cb){
    const t0 = Date.now(), max = 6000;
    const tick = () => {
      if (window.els && els.input && els.list && els.searchBtn) { cb(); return; }
      if (Date.now() - t0 > max) { console.warn('autocomplete init: els not ready'); return; }
      requestAnimationFrame(tick);
    };
    tick();
  }

  let LOCAL_SYMBOLS = [];
  let suggestions = [];
  let activeIndex = -1;

  async function loadSymbolsFromCSV() {
    if (LOCAL_SYMBOLS.length) return LOCAL_SYMBOLS;
    try {
      const r = await fetch('/assets/us_symbols.csv', { cache:'no-store' });
      if (!r.ok) throw new Error('symbols ' + r.status);
      const text = await r.text();
      const lines = text.split(/\r?\n/).filter(Boolean);
      if (!lines.length) throw new Error('CSV empty');
      const candidates = [',','|',';','\t',' '];
      let delim = ',', best = -1;
      for (const d of candidates) {
        const score = lines.slice(0, Math.min(20, lines.length))
          .map(L => L.split(d).length - 1)
          .filter(n => n > 0)
          .reduce((a,b)=>a+b,0);
        if (score > best) { best = score; delim = d; }
      }
      let start = 0;
      const first = lines[0].split(delim).map(s => s.trim().toLowerCase());
      if (first[0] && /(symbol|ticker)/.test(first[0])) start = 1;

      const out = [];
      for (let i = start; i < lines.length; i++) {
        const line = lines[i];
        const cut = line.indexOf(delim);
        if (cut === -1) continue;
        const sym = line.slice(0, cut).trim().toUpperCase();
        const name = line.slice(cut + 1).trim();
        if (/^[A-Z0-9.^$\-]{1,12}$/.test(sym)) out.push({ symbol: sym, name });
      }
      if (!out.length) throw new Error('No symbols parsed');
      LOCAL_SYMBOLS = out.sort((a,b)=>a.symbol.localeCompare(b.symbol));
    } catch (e) {
      LOCAL_SYMBOLS = [
        {symbol:'AAPL',name:'Apple Inc'},
        {symbol:'MSFT',name:'Microsoft Corp'},
        {symbol:'TSLA',name:'Tesla Inc'},
        {symbol:'NVDA',name:'NVIDIA Corp'},
        {symbol:'AMZN',name:'Amazon.com Inc'}
      ];
    }
    return LOCAL_SYMBOLS;
  }

  function searchLocalSymbols(q) {
    if (!q) return [];
    const out = [];
    const qLower = q.toLowerCase();
    for (const r of LOCAL_SYMBOLS) {
      if (r.symbol.startsWith(q)) { out.push(r); if (out.length >= 12) break; }
    }
    if (out.length < 12) {
      const seen = new Set(out.map(r => r.symbol));
      for (const r of LOCAL_SYMBOLS) {
        if (seen.has(r.symbol)) continue;
        if (r.symbol.includes(q) || (r.name && r.name.toLowerCase().includes(qLower))) {
          out.push(r);
          if (out.length >= 12) break;
        }
      }
    }
    if (typeof SYMBOL_ALIASES === 'object' && SYMBOL_ALIASES) {
      const alias = SYMBOL_ALIASES[q];
      if (alias && !out.some(r => r.symbol === alias)) {
        out.unshift({ symbol: alias, name: q + ' (USD pair)' });
      }
    }
    return out;
  }

  function renderAC() {
    els.list.innerHTML = '';
    if (!suggestions.length) { els.list.classList.remove('show'); return; }
    suggestions.forEach((it, i) => {
      const div = document.createElement('div');
      div.className = 'ac-item' + (i === activeIndex ? ' active' : '');
      div.dataset.i = i;
      div.innerHTML = '<div class="ticker">' + it.symbol + '</div>' +
                      '<div class="company">' + (escapeHTML?.(it.name || '') ?? (it.name || '')) + '</div>';
      div.addEventListener('mousedown', e => { e.preventDefault(); pick(i); });
      els.list.appendChild(div);
    });
    els.list.classList.add('show');
  }
  const hideAC = () => { els.list.classList.remove('show'); activeIndex = -1; };

  function pick(i) {
    const it = suggestions[i];
    if (!it) return;
    const sym = (typeof normalizeTicker === 'function') ? normalizeTicker(it.symbol) : it.symbol;
    els.input.value = sym;
    hideAC();
    if (typeof onSearch === 'function') onSearch(sym, it.name || '');
  }

  function doSearchFromInput() {
    let t = els.input.value.trim().toUpperCase();
    if (typeof normalizeTicker === 'function') t = normalizeTicker(t);
    hideAC();
    if (!/^[A-Z0-9.^$\-]{1,12}$/.test(t)) return;
    let comp = '';
    const found = LOCAL_SYMBOLS.find(r => r.symbol === t) ||
                  LOCAL_SYMBOLS.find(r => (r.name||'').toUpperCase() === t);
    if (found) comp = found.name || '';
    if (typeof onSearch === 'function') onSearch(t, comp);
  }

  function wire(){
    // Input events
    els.input.addEventListener('input', _debounce(async () => {
      if (!LOCAL_SYMBOLS.length) await loadSymbolsFromCSV();
      const val = els.input.value;
      if (val !== val.toUpperCase()) {
        const st = els.input.selectionStart, en = els.input.selectionEnd;
        els.input.value = val.toUpperCase();
        els.input.setSelectionRange(st, en);
      }
      const qv = els.input.value.trim().toUpperCase();
      if (!qv) { hideAC(); return; }
      suggestions = searchLocalSymbols(qv);
      activeIndex = -1;
      renderAC();
    }, 120));

    els.input.addEventListener('keydown', e => {
      if (els.list.classList.contains('show')) {
        if (e.key === 'ArrowDown') { e.preventDefault(); activeIndex = (activeIndex + 1) % suggestions.length; renderAC(); return; }
        if (e.key === 'ArrowUp')   { e.preventDefault(); activeIndex = (activeIndex - 1 + suggestions.length) % suggestions.length; renderAC(); return; }
        if (e.key === 'Enter' || e.key === 'Tab') { if (activeIndex >= 0) { e.preventDefault(); pick(activeIndex); return; } }
        if (e.key === 'Escape') { hideAC(); return; }
      }
      if (e.key === 'Enter') { e.preventDefault(); hideAC(); doSearchFromInput(); }
    });

    document.addEventListener('click', e => { if (!e.target.closest('.ticker-wrap')) hideAC(); });
    els.input.addEventListener('blur', () => setTimeout(hideAC, 100));
    window.addEventListener('scroll', hideAC, { passive: true });
    els.searchBtn.addEventListener('click', () => { hideAC(); doSearchFromInput(); });

    // Warm cache
    loadSymbolsFromCSV().catch(()=>{});
  }

  whenElsReady(wire);
})();
</script>
</body>
</html>
