<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Analyzer v.042</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="/assets/stratus-trader-wide.png">

<!-- Plotly (no defer) -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<style>
  :root{
    --bg:#0f1115;--panel:#151923;--text:#e5e7eb;--muted:#9ca3af;
    --accent:#22c55e;--focus:#3b82f6;--border:#23283a;--hover:#161a25;
    --metric-bg:#1a1f2e;--metric-border:#2a2f3e;
    --field-bg:#0c0f16;--field-text:#e5e7eb;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#60a5fa;--c-sma200:#f59e0b; /* back to yellowish 200 SMA */
    --c-rsi:#a78bfa;--c-macd:#38bdf8;--c-vol:#10b981;
    --grid:#283044;
    --lvl-beginner:#22c55e; --lvl-intermediate:#f59e0b; --lvl-advanced:#ef4444;
    --tf-bg:#1c1f35; --tf-head:#1a214e; --tf-glow:#3b82f6;
    --c-ichi-tenkan:#f59e0b; --c-ichi-kijun:#60a5fa; --c-ichi-chikou:#f472b6; /* pinkish chikou like Fidelity */
    --c-ichi-up:rgba(34,197,94,.45);
    --c-ichi-down:rgba(239,68,68,.40);
    --c-ichi-spanA:#22c55e; /* Senkou Span A line */
    --c-ichi-spanB:#ef4444; /* Senkou Span B line */
  }
  .light{
    --bg:#f8fafc;--panel:#fff;--text:#222;--muted:#64748b;
    --accent:#22c55e;--focus:#3b82f3;--border:#e2e8f0;--hover:#f1f5f9;
    --metric-bg:#f1f5f9;--metric-border:#e2e8f0;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#2563eb;--c-sma200:#f59e0b; /* yellowish in light too */
    --c-rsi:#7c3aed;--c-macd:#0ea5e9;--c-vol:#16a34a;
    --grid:#e5e7eb; --tf-bg:#eef2ff; --tf-head:#c7d2fe; --tf-glow:#6366f1;
    --field-bg:#ffffff; --field-text:#111827;
  }
  *{box-sizing:border-box}
  html,body{overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh;padding:20px;transition:background .2s,color .2s}
  .container{max-width:1100px;margin:0 auto}
  .toolbar{position:sticky;top:0;z-index:12000;display:flex;gap:10px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin-bottom:16px;flex-wrap:wrap}
  .ticker-wrap{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
  .ticker-wrap label{font-weight:800;opacity:.9}
  .input-wrap{position:relative;flex:0 1 460px;max-width:460px;width:100%}
  @media (max-width:720px){ .input-wrap{flex:1 1 100%;max-width:100%} }
  .ticker-input{width:100%;min-width:120px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--field-bg);color:var(--field-text);text-transform:uppercase;font-size:16px}
  .btn{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn.inline{padding:8px 12px}
  .toolsbar{display:flex;align-items:center;gap:8px;margin-left:auto;flex:1 1 100%;justify-content:flex-start;flex-wrap:wrap}
  .tool-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:700;cursor:pointer}
  .tool-btn:hover{background:var(--hover)}
  .theme-toggle{margin-left:auto;cursor:pointer;padding:8px 14px;border-radius:8px;background:var(--panel);color:var(--text);border:1px solid var(--border);font-weight:600}
  .theme-toggle:hover{background:var(--hover)}
  .theme-toggle.active{background:var(--accent);color:#fff}
  .ac{position:absolute;left:0;top:calc(100% + 6px);width:100%;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;display:none;max-height:280px;overflow:auto;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:12050}
  .ac.show{display:block}
  /* Give the ticker more room so it doesn't feel cramped */
  .ac-item{padding:12px 14px;display:grid;grid-template-columns:minmax(160px, 240px) 1fr;gap:12px;align-items:center;cursor:pointer;border-bottom:1px solid var(--metric-border)}
  .ac-item:hover,.ac-item.active{background:var(--hover)}
  .ticker{font-weight:800}
  .company{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .info{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;position:relative}
  .info-logo{position:absolute;top:10px;right:12px;height:54px;opacity:.92;pointer-events:none;filter:drop-shadow(0 2px 8px rgba(0,0,0,.35))}
  .light .info-logo{mix-blend-mode:multiply;filter:drop-shadow(0 2px 6px rgba(0,0,0,.12));opacity:.95}
  @media (max-width:640px){ .info-logo{height:42px;right:10px} }
  #chartCard{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative}
  #chart{height:68vh;min-height:520px}
  .container.wide{max-width:100%!important}
  #chartCard.max{position:fixed;inset:12px;z-index:9999;margin:0!important;width:auto!important;height:auto!important;overflow:auto}
  #chartCard.max #chart{height:calc(100vh - 160px)!important;min-height:400px;cursor:zoom-out}
  .tf-card{background:var(--tf-bg);border:1px solid rgba(99,102,241,.25);border-radius:12px;padding:10px;margin-bottom:10px;box-shadow:0 0 0 1px rgba(99,102,241,.15) inset}
  .tf-head{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg, var(--tf-head), transparent);border-radius:8px;padding:6px 10px;margin:-4px -2px 8px;font-weight:800}
  .tf-head .carat{display:inline-block;transform:rotate(-90deg);transition:transform .15s ease}
  .tf-card[data-open="true"] .carat{transform:rotate(0)}
  .tf-body{display:none}
  .tf-card[data-open="true"] .tf-body{display:grid}
  .tf-body{grid-template-columns:1fr 1fr;gap:10px}
  .control label{display:block;font-size:13px;font-weight:800;margin-bottom:6px;color:#cbd5ff}
  .control select{width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px}
  .toggle-row{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 10px}
  .chip{border:1px solid #2b3548;border-radius:999px;padding:6px 12px;cursor:pointer;font-weight:800;opacity:.98;user-select:none;transition:background .15s,color .15s,border-color .15s; -webkit-text-fill-color: currentColor; color: currentColor; background: color-mix(in srgb, var(--panel), #ffffff 3%);} 
  .chip:not(.active){filter: saturate(0.95) brightness(1.02);} 
  /* Chip base colors (fixed typos) */
  .chip[data-k="SMA20"]{border-color:var(--c-sma20);color:var(--c-sma20);} 
  .chip[data-k="SMA50"]{border-color:var(--c-sma50);color:var,--c-sma50;} 
  .chip[data-k="SMA200"]{border-color:var(--c-sma200);color:var,--c-sma200;} 
  .chip[data-k="RSI"]{border-color:var(--c-rsi);color:var,--c-rsi;} 
  .chip[data-k="MACD"]{border-color:var(--c-macd);color:var,--c-macd;} 
  .chip[data-k="VOL"]{border-color:var(--c-vol);color:var,--c-vol;} 
  .chip[data-k="AUTOFIB"]{border-color:#8b5cf6;color:#8b5cf6}
  .chip[data-k="ICHI"]{border-color:#60a5fa;color:#60a5fa}
  .chip[data-k="SESS"]{border-color:#93c5fd;color:#93c5fd}

  /* Active backgrounds (kept) */
  .chip.active[data-k="SMA20"]{background:rgba(34,197,94,.12)}
  .chip.active[data-k="SMA50"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SMA200"]{background:rgba(245,158,11,.12)}
  .chip.active[data-k="RSI"]{background:rgba(167,139,250,.12)}
  .chip.active[data-k="MACD"]{background:rgba(56,189,248,.12)}
  .chip.active[data-k="VOL"]{background:rgba(16,185,129,.12)}
  .chip.active[data-k="AUTOFIB"]{background:rgba(139,92,246,.12)}
  .chip.active[data-k="ICHI"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SESS"]{background:rgba(147,197,253,.12)}

  /* Bright glow for active chips only (already present; keep it)
     This guarantees inactive chips have NO glow. */
  .chip{position:relative}
  /* Make active chip glow subtle to match button color */
  .chip.active{border-width:2px; box-shadow:0 0 0 1px currentColor;}
  .chip.active::after{display:none}
  .light .chip.active::after{display:none}
  .chip:focus-visible{outline:2px solid currentColor;outline-offset:3px}
  .section-sep{margin:20px -16px 16px;padding:0 16px}
  .section-sep .rule{height:3px;border-radius:999px;background:linear-gradient(90deg,var(--focus),var(--accent));opacity:.9}
  .sheet{position:fixed;left:0;right:0;bottom:0;top:auto;background:transparent;display:flex;justify-content:center;z-index:2000}
  .sheet[hidden]{display:none!important}
  .sheet-inner{width:min(760px,100%);background:var(--panel);border-top:1px solid var(--border);border-radius:16px 16px 0 0;box-shadow:0 -8px 30px rgba(0,0,0,.35);padding:14px;animation:sheetUp .18s ease-out;padding-bottom:max(14px, env(safe-area-inset-bottom))}
  .sheet-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .sheet-title{font-weight:800;font-size:16px}
  .sheet-close{background:transparent;border:0;color:var(--text);font-size:18px;cursor:pointer}
  .sheet-body{max-height:58vh;overflow:auto}
  @keyframes sheetUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
  .btmnav{position:fixed;left:0;right:0;bottom:0;display:none;background:var(--panel);border-top:1px solid var(--border);padding:6px 10px;z-index:1000}
  .btmnav .tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 8px;border-radius:10px;border:0;background:transparent;color:var(--text);font-weight:700;font-size:13px}
  .btmnav .tab.active{background:var(--hover)}
  .btmnav .tab span{font-size:11px;opacity:.85}
  @media (max-width:720px){ .btmnav{display:flex;gap:8px} body{padding-bottom:64px} }
  .scr-list{display:flex;flex-direction:column;gap:10px}
  .scr-item{
    position:relative; display:flex; gap:12px; align-items:flex-start;
    padding:12px 14px; border:1px solid var(--border); border-radius:12px;
    background:color-mix(in hsl, var(--panel), var(--bg) 35%);
    text-decoration:none; color:inherit; cursor:pointer;
    transition:background .15s,border-color .15s,transform .06s;
  }
  .scr-item:hover{ background:var(--hover); border-color:#2b3548; transform:translateY(-1px); }
  .scr-item::before{ content:""; position:absolute; left:0; top:8px; bottom:8px; width:4px; border-radius:999px; background: var(--lvl-color, #64748b); opacity:.8; }
  .scr-item{ padding-left:16px; }
  .scr-item[data-lvl="Beginner"]     { --lvl-color: var(--lvl-beginner); }
  .scr-item[data-lvl="Intermediate"] { --lvl-color: var(--lvl-intermediate); }
  .scr-item[data-lvl="Advanced"]     { --lvl-color: var(--lvl-advanced); }
  .scr-item .title{ font-weight:800; font-size:14px; line-height:1.25; }
  .scr-item .desc{ font-size:12px; color:var(--muted); margin-top:2px; }
  .badge{ font-size:11px; font-weight:800; padding:2px 8px; border-radius:999px; background:var(--metric-bg); border:1px solid var(--metric-border); color:var(--muted); white-space:nowrap; margin-top:2px; }
  .scr-item .open-btn{ margin-left:8px; padding:6px 10px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); text-decoration:none; font-weight:700; }
  .scr-item .open-btn:hover{ background:var(--hover); }

  /* === Button glow (added) === */
  .btn, .tool-btn, .theme-toggle, .btmnav .tab {
    --glow-color: var(--focus);
    position: relative;
    transition: box-shadow .15s, transform .06s, background .15s, border-color .15s;
  }
  .btn { --glow-color: var(--accent); }
  .btn:hover, .btn:focus-visible,
  .tool-btn:hover, .tool-btn:focus-visible,
  .theme-toggle:hover, .theme-toggle:focus-visible,
  .btmnav .tab:hover, .btmnav .tab:focus-visible {
    box-shadow:
      0 0 0 2px var(--glow-color),
      0 0 10px var(--glow-color),
      0 0 24px 6px var(--glow-color),
      0 0 40px 12px var(--glow-color);
    z-index: 1;
  }
  .btn:hover::after, .btn:focus-visible::after,
  .tool-btn:hover::after, .tool-btn:focus-visible::after,
  .theme-toggle:hover::after, .theme-toggle:focus-visible::after,
  .btmnav .tab:hover::after, .btmnav .tab:focus-visible::after {
    content: "";
    position: absolute;
    inset: -10px;
    border-radius: inherit;
    background: radial-gradient(60% 60% at 50% 50%, var(--glow-color) 0%, rgba(0,0,0,0) 80%);
    filter: blur(12px);
    z-index: -1;
    pointer-events: none;
    opacity: 0.7;
  }

  /* Nicer colorization for autocomplete tickers */
  /* Make tickers a distinct color and keep them on one line */
  .ac-item .ticker{ color: var(--accent); font-weight:900; letter-spacing:.3px; white-space:nowrap; }
  .ac-item:hover .ticker, .ac-item.active .ticker{ color: color-mix(in srgb, var(--accent), #ffffff 14%); }
  /* Company name muted so ticker stands out */
  .ac-item .company{ color: var(--muted); font-weight:700; }
  .ac-item:hover .company, .ac-item.active .company{ color: var(--muted); opacity:.95; }

</style>
</head>
<body>
  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="ticker-wrap">
        <label for="q">Ticker</label>
        <div class="input-wrap">
          <input id="q" class="ticker-input" type="text" placeholder="AAPL, MSFT… or BTC" spellcheck="false" autocomplete="off"/>
          <div id="ac" class="ac" role="listbox" aria-label="Suggestions"></div>
        </div>
        <button id="searchBtn" class="btn inline" type="button">Search</button>
      </div>
      <div class="toolsbar" id="toolsBar">
        <button class="tool-btn" id="toolGPTs" aria-label="Open GPTs">🧠 <span class="tool-txt">GPTs</span></button>
        <button class="tool-btn" id="toolScreeners" aria-label="Open Screeners">🔎 <span class="tool-txt">Screeners</span></button>
        <button class="tool-btn" id="wideBtn" aria-label="Toggle Width">↔︎ <span class="tool-txt">Wide</span></button>
        <button class="tool-btn" id="maxBtn" aria-label="Maximize">⤢ <span class="tool-txt">Max</span></button>
        <button class="tool-btn" id="refreshBtn" aria-label="Refresh">⟳ <span class="tool-txt">Refresh</span></button>
      </div>
    </div>

    <!-- Info bar -->
    <div id="info" class="info">
      <h3 id="headline" style="margin:0 0 6px 0"></h3>
      <div id="subInfo" style="opacity:.85;font-size:13px;margin:-2px 0 6px 0"></div>
      <div style="opacity:.9;font-size:14px;line-height:1.6">
        <div id="lastLine">Last: — · Change: —</div>
        <div id="prevCloseLine">Yesterday’s Close: —</div>
        <div id="ivLine">Intrinsic Value: —</div>
      </div>
      <img id="infoLogo" class="info-logo" src="/assets/stratus-trader-wide.png" alt="Stratus Trader" />
    </div>

    <!-- Chart card -->
    <div id="chartCard">
      <div class="tf-card" id="tfCard" data-open="true">
        <div class="tf-head" id="tfHead"><span class="carat">▾</span> <span style="font-style:italic">time frame</span></div>
        <div class="tf-body">
          <div class="control">
            <label for="timeSel">Time</label>
            <select id="timeSel">
              <option value="1d">1 day</option><option value="2d">2 days</option>
              <option value="5d">5 days</option><option value="10d">10 days</option>
              <option value="sep" disabled>──────────</option>
              <option value="1mo">1 month</option><option value="2mo">2 months</option>
              <option value="3mo">3 months</option><option value="6mo" selected>6 months</option>
              <option value="ytd">YTD</option><option value="1y">1 year</option>
              <option value="2y">2 years</option><option value="3y">3 years</option>
              <option value="4y">4 years</option><option value="5y">5 years</option>
              <option value="10y">1 decade</option><option value="max">All Data</option>
            </select>
          </div>
          <div class="control">
            <label for="freqSel">Frequency</label>
            <select id="freqSel">
              <option value="1m">1-Minute</option><option value="5m">5-Minute</option>
              <option value="15m">15-Minute</option><option value="60m">Hourly</option>
              <option value="sep" disabled>──────────</option>
              <option value="1d" selected>Daily</option><option value="1wk">Weekly</option>
              <option value="1mo">Monthly</option><option value="3mo">Quarterly</option>
              <option value="1y">Yearly</option>
            </select>
          </div>
          <div class="control" style="grid-column:1 / -1">
            <label for="heightSel">Candle height <span id="heightLabel" style="opacity:.7;margin-left:6px">Balanced</span></label>
            <input id="heightSel" type="range" min="0" max="100" value="75" step="1" style="width:100%" />
          </div>
        </div>
      </div>

      <div class="toggle-row" id="toggles">
        <button class="chip" data-k="SMA20" type="button" aria-pressed="false">SMA 20</button>
        <button class="chip" data-k="SMA50" type="button" aria-pressed="false">SMA 50</button>
        <button class="chip" data-k="SMA200" type="button" aria-pressed="false">SMA 200</button>
        <button class="chip" data-k="RSI" type="button" aria-pressed="false">RSI</button>
        <button class="chip" data-k="MACD" type="button" aria-pressed="false">MACD</button>
        <button class="chip" data-k="VOL" type="button" aria-pressed="false">Volume</button>
        <button class="chip" id="autoFib" data-k="AUTOFIB" type="button" aria-pressed="false">Auto Fib</button>
        <button class="chip" data-k="ICHI" type="button" aria-pressed="false">Ichimoku</button>
        <button class="chip" data-k="SESS" type="button" aria-pressed="true" title="Toggle pre/post-market bands">Pre/Post</button>
      </div>

      <div id="chart"></div>
    </div>

    <div class="section-sep" aria-hidden="true"><div class="rule"></div></div>
  </div>

  <!-- GPTs Sheet -->
  <div class="sheet" id="sheetGPTs" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">GPTs</div>
        <button class="sheet-close" data-close="sheetGPTs">✕</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" style="margin-bottom:12px">
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">9 Prompts for Smarter Investing</div>
              <div class="desc">Bundle of prompts to guide smarter investment analysis.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-687b911701a08191aadd69c345a67d17-9-prompts-for-smarter-investing" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">Stock Predictor Prompt GPT</div>
              <div class="desc">Structured prompt flow for scenario-led stock predictions.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-686c5fc3dd948191a0ff9c14cecda1b4-stock-predictor-prompt-gpt" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">High Yield Dividend Sniper</div>
              <div class="desc">Quickly target high-yield dividend candidates.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-6878fe277c5c819180211289d9e16148-high-yield-dividend-sniper" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
        </div>
        <div>
          <textarea id="gptInput" rows="4" placeholder="Ask a question about the current ticker…" style="width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button class="btn" id="askGPT">Ask</button>
            <div style="font-size:12px;color:var(--muted)">Uses the visible chart context when possible.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Screeners Sheet -->
  <div class="sheet" id="sheetScreeners" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">Screeners</div>
        <button class="sheet-close" data-close="sheetScreeners">✕</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" id="scrList"></div>
      </div>
    </div>
  </div>

  <nav class="btmnav" id="btmNav" role="navigation" aria-label="Bottom Navigation">
    <button data-tab="home" class="tab active" aria-label="Home">🏠<span>Home</span></button>
    <button data-tab="screeners" class="tab" aria-label="Screeners">🔎<span>Screeners</span></button>
    <button data-tab="gpts" class="tab" aria-label="GPTs">🧠<span>GPTs</span></button>
    <button data-tab="settings" class="tab" aria-label="Settings">⚙️<span>Settings</span></button>
  </nav>

  <script>
  (() => {
    const q = s => document.querySelector(s);

    /* ---------- Elements ---------- */
    const els = {
      input:q('#q'), list:q('#ac'), searchBtn:q('#searchBtn'),
      headline:q('#headline'), lastLine:q('#lastLine'), prevCloseLine:q('#prevCloseLine'), ivLine:q('#ivLine'),
      subInfo:q('#subInfo'),
      chartCard:q('#chartCard'), chart:q('#chart'),
      timeSel:q('#timeSel'), freqSel:q('#freqSel'), toggles:q('#toggles'),
      heightSel:q('#heightSel'), heightLabel:q('#heightLabel'),
      themeToggle:q('#themeToggle'), autoFib:q('#autoFib'),
      refreshBtn:q('#refreshBtn'), maxBtn:q('#maxBtn'), wideBtn:q('#wideBtn'),
      tfCard:q('#tfCard'), tfHead:q('#tfHead')
    };

    /* ---------- State ---------- */
    let CURRENT = { ticker:null, company:"", prevClose:null };
    const state = { ticker: localStorage.getItem('lastTicker')||'AAPL', range:(q('#timeSel')?.value)||'6mo', interval:(q('#freqSel')?.value)||'1d', rows:[], candleTight:+(localStorage.getItem('candleTight')||75), symbols:[], acMatches:[], acIndex:-1, quoteTimer:null };

    /* ---------- Utils & Formatters ---------- */
    const css = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    const fmtPx = v => Number.isFinite(+v) ? `$${(+v).toFixed(2)}` : '—';
    const fmtPct = v => Number.isFinite(+v) ? `${(+v).toFixed(2)}%` : '—';
    const clampZero = (v,eps=1e-10)=> (Number.isFinite(v)&&Math.abs(v)<eps?0:v);
    const median = (arr)=>{ const a=(arr||[]).map(Number).filter(Number.isFinite).sort((x,y)=>x-y); if(!a.length) return NaN; const m=Math.floor(a.length/2); return a.length%2? a[m] : (a[m-1]+a[m])/2; };
    const $all = (sel, root=document)=> Array.from(root.querySelectorAll(sel));
    const sanitizeTicker = s => String(s||'').split('|')[0].trim().toUpperCase();
    function renderAC(){ if(!els.list) return; const items=state.acMatches||[]; if(!items.length){ els.list.innerHTML=''; els.list.classList.remove('show'); return; } const html=items.slice(0,60).map((o,i)=>`<div class="ac-item${i===state.acIndex?' active':''}" role="option" data-t="${o.t}"><span class="ticker">${o.t}</span><span class="company">${o.n||''}</span></div>`).join(''); els.list.innerHTML=html; els.list.classList.add('show'); }
    function updateAC(qstr){ const s=sanitizeTicker(qstr); if(!s){ state.acMatches=[]; state.acIndex=-1; renderAC(); return; } const sym=state.symbols||[]; const re=new RegExp('^'+s.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')); const pri = sym.filter(r=> re.test(r.t)); const sec = sym.filter(r=> !re.test(r.t) && r.t.includes(s)); const nameHits = sym.filter(r=> (r.n||'').toUpperCase().includes(s)&&!pri.includes(r)&&!sec.includes(r)); state.acMatches=[...pri,...sec,...nameHits]; state.acIndex=0; renderAC(); }
    function pickAC(i){ if(!state.acMatches?.length) return; const it=state.acMatches[i]; if(!it) return; els.input.value=it.t; state.acMatches=[]; state.acIndex=-1; renderAC(); }

    // ET helpers
    const dtfET = new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York',hour12:false,hour:'2-digit',minute:'2-digit',weekday:'short'});
    function isRegularSessionET(ms){ const parts=dtfET.formatToParts(new Date(ms)); const get=(t)=> parts.find(p=>p.type===t)?.value; const wd=(parts.find(p=>p.type==='weekday')?.value)||''; if(/Sat|Sun/i.test(wd)) return false; const h=+(get('hour')||'0'); const m=+(get('minute')||'0'); const hm=h+m/60; return hm>=9.5 && hm<=16.0; }
    const isIntraday = (interval)=> /m|h/i.test(String(interval||''));
    const padScaleFromTight = (t)=>{ t = Math.max(0, Math.min(100, +t||0)); return 1.6 - (t/100)*1.2; };

    // Helper: rows currently displayed (respect intraday pre/post chip)
    function getDisplayRows(){
      const rows = state.rows||[];
      const includeAH = q('.chip[data-k="SESS"]')?.classList.contains('active');
      return (isIntraday(state.interval) && !includeAH) ? rows.filter(r=>isRegularSessionET(r.t)) : rows;
    }

    // CSV symbols for autocomplete (minimal)
    async function loadSymbols(){
      if(state.symbols?.length) return state.symbols;
      try{
        const r = await fetch('/stock_data.csv',{cache:'no-store'}); if(!r.ok) throw 0; const text=await r.text();
        const lines=text.split(/\r?\n/).filter(Boolean); const out=[]; let start=0; if(/^\s*symbol\s*(\||,)/i.test(lines[0]||'')) start=1;
        for(let i=start;i<lines.length;i++){ const line=lines[i]; const d=line.includes('|')?'|':','; const [sym,...rest]=line.split(d); const s=(sym||'').trim().toUpperCase(); if(!s) continue; const n=rest.join(' ').replace(/\s*\|\s*/g,' ').trim(); out.push({t:s,n}); }
        state.symbols=out;
      }catch{ state.symbols=[]; }
      return state.symbols;
    }

    /* ---------- Indicators ---------- */
    const sma = (arr,p)=>{ if(!Array.isArray(arr)||!arr.length||!p) return []; const out=Array(arr.length).fill(null); let sum=0; for(let i=0;i<arr.length;i++){ const v=+arr[i]; if(Number.isFinite(v)) sum+=v; if(i>=p){ const w=+arr[i-p]; if(Number.isFinite(w)) sum-=w; } if(i>=p-1) out[i]=sum/p; } return out; };
    const ema = (arr,p)=>{ const out=Array(arr.length).fill(null); const k=2/(p+1); let prev=null; for(let i=0;i<arr.length;i++){ const v=+arr[i]; if(!Number.isFinite(v)) { out[i]=prev; continue; } prev = prev==null? v : (v - prev)*k + prev; out[i]=prev; } return out; };
    const fillForward = (arr)=>{ let last=null; return arr.map(v=>{ if(Number.isFinite(v)){ last=v; return v; } return Number.isFinite(last)? last : null; }); };
    const fillBackward = (arr)=>{ const out=arr.slice(); const fi=out.findIndex(Number.isFinite); if(fi>0){ const v=out[fi]; for(let i=0;i<fi;i++) out[i]=v; } return out; };
    const mapByTs = (rows, values)=>{ const m=new Map(); for(let i=0;i<rows.length;i++){ const t=rows[i]?.t; const v=values[i]; if(Number.isFinite(v)) m.set(t, v); } return m; };

    // Build SMA series aligned to state.rows; when < period, back/forward fill; when missing, try extended pull
    async function buildSMAAlignedSeries(){
      const rows = state.rows||[]; state.smaSeries = state.smaSeries || {}; state.smaLast = state.smaLast || {}; if(!rows.length){ state.smaSeries={}; state.smaLast={}; return; }
      const closes = rows.map(r=>r.c);
      const periods = [20,50,200];
      const pickRange=(interval,p)=>{ switch(interval){ case '1m':return '5d'; case '5m':return '1mo'; case '15m':return '3mo'; case '60m':return '6mo'; case '1wk':return '10y'; case '1mo': return 'max'; case '3mo': return 'max'; case '1y': return 'max'; default: return p>=200? '3y':'1y'; } };
      async function alignFromExtended(p){ const extR = pickRange(state.interval, p); try{ const ext = await fetchRows(state.ticker, extR, state.interval); if(Array.isArray(ext)&&ext.length){ const yExt = sma(ext.map(r=>r.c), p); const mapP = mapByTs(ext, yExt); const aligned = rows.map(r=> mapP.get(r.t) ?? null); return fillBackward(fillForward(aligned)); } }catch{} return null; }
      for(const p of periods){ let y = sma(closes, p); if(y.some(Number.isFinite)) y=fillBackward(fillForward(y)); else { const extAligned = await alignFromExtended(p); y = extAligned || Array(rows.length).fill(closes.filter(Number.isFinite).at(-1) ?? null); }
        state.smaSeries[p]=y; const last = y.filter(Number.isFinite).at(-1); if(Number.isFinite(last)) state.smaLast[p]=last; }
    }

    /* ---------- Price axis fit (uses slider) ---------- */
    async function fitPriceAxisToCandlesStrict(){
      if (!els.chart) return;
      const d = els.chart.data || []; const c = d.find(t => t && t.type === 'candlestick'); if (!c || !c.x?.length) return;
      const toMs = v=> new Date(v).getTime(); const L=els.chart._fullLayout||els.chart.layout||{}; const xa=L.xaxis||{};
      let x0ms, x1ms; if(Array.isArray(xa.range) && xa.autorange===false){ x0ms=toMs(xa.range[0]); x1ms=toMs(xa.range[1]); } else { x0ms=toMs(c.x[0]); x1ms=toMs(c.x[c.x.length-1]); }
      const cxms=c.x.map(toMs); let i0=0; while(i0<cxms.length && cxms[i0]<x0ms) i0++; let i1=cxms.length-1; while(i1>i0 && cxms[i1]>x1ms) i1--; if(i1<=i0) return;
      let hi=-Infinity, lo=Infinity; for(let i=i0;i<=i1;i++){ const h=c.high[i], l=c.low[i]; if(Number.isFinite(h)) hi=Math.max(hi,h); if(Number.isFinite(l)) lo=Math.min(lo,l); }
      if(!Number.isFinite(hi)||!Number.isFinite(lo)) return; if(hi===lo){ hi+=1; lo-=1; }
      const basePad = Math.max((hi-lo)*0.08, 0.01); const pad = basePad * padScaleFromTight(state.candleTight);
      try{ await Plotly.relayout(els.chart, { 'yaxis.autorange':false, 'yaxis.range':[lo-pad, hi+pad] }); }catch{}
    }

    // Slider bindings
    if(els.heightSel){ els.heightSel.value=String(state.candleTight); const updLbl=()=>{ const v=+els.heightSel.value; els.heightLabel.textContent = v>=80? 'Taller' : v<=20? 'Shorter' : 'Balanced'; }; updLbl(); els.heightSel.addEventListener('input', ()=>{ state.candleTight=+els.heightSel.value; localStorage.setItem('candleTight', String(state.candleTight)); updLbl(); fitPriceAxisToCandlesStrict(); }); }

    /* ---------- Chart bits ---------- */
    function candleTrace(rows){ return { type:'candlestick', x: rows.map(r=>new Date(r.t)), open: rows.map(r=>r.o), high: rows.map(r=>r.h), low: rows.map(r=>r.l), close: rows.map(r=>r.c), name: state.ticker, yaxis:'y', increasing:{ line:{ color: css('--c-up')||'#16a34a', width:2.4 } }, decreasing:{ line:{ color: css('--c-down')||'#dc2626', width:2.4 } }, showlegend:false, hovertemplate:'Date: %{x|%Y-%m-%d %H:%M}<br>O: %{open:.2f}<br>H: %{high:.2f}<br>L: %{low:.2f}<br>C: %{close:.2f}<extra></extra>' }; }
    function volTrace(rows){ const x=rows.map(r=>new Date(r.t)); const y=rows.map(r=>r.v||0); const cols=rows.map(r=> (r.c>=r.o)? 'rgba(34,197,94,0.5)':'rgba(239,68,68,0.5)'); return { type:'bar', x, y, name:'Volume', marker:{ color: cols }, yaxis:'y2', opacity:0.45, hoverinfo:'skip' }; }
    function rsiArr(rows, period=14){ const c=rows.map(r=>r.c); const gains=[], losses=[]; for(let i=1;i<c.length;i++){ const d=c[i]-c[i-1]; gains.push(Math.max(0,d)); losses.push(Math.max(0,-d)); } const avgG=ema(gains,period); const avgL=ema(losses,period); const rsi=Array(c.length).fill(null); for(let i=1;i<c.length;i++){ const gi=avgG[i-1], li=avgL[i-1]; if(Number.isFinite(gi)&&Number.isFinite(li)){ const rs = li===0? 100 : gi/li; rsi[i]=100-(100/(1+rs)); } } return rsi; }
    function rsiTrace(rows){ return { type:'scatter', mode:'lines', x:rows.map(r=>new Date(r.t)), y:rsiArr(rows), name:'RSI', line:{ color: css('--c-rsi')||'#a78bfa', width:1.6 }, yaxis:'y3', hoverinfo:'skip' }; }
    function macdTraces(rows){ const c=rows.map(r=>r.c); const e12=ema(c,12), e26=ema(c,26); const macd=e12.map((v,i)=> (Number.isFinite(v)&&Number.isFinite(e26[i]))? v-e26[i] : null); const signal=ema(macd,9); const hist=macd.map((v,i)=> (Number.isFinite(v)&&Number.isFinite(signal[i]))? v-signal[i]: null); const x=rows.map(r=>new Date(r.t)); const cols=hist.map(v=> v==null? 'rgba(0,0,0,0)' : (v>=0? 'rgba(34,197,94,0.35)':'rgba(239,68,68,0.35)')); return [ { type:'scatter', mode:'lines', x, y:macd, name:'MACD', line:{ color: css('--c-macd')||'#38bdf8', width:1.6 }, yaxis:'y4', hoverinfo:'skip' }, { type:'scatter', mode:'lines', x, y:signal, name:'Signal', line:{ color:'#f59e0b', width:1.2, dash:'dot' }, yaxis:'y4', hoverinfo:'skip' }, { type:'bar', x, y:hist, name:'Histogram', marker:{ color: cols }, yaxis:'y4', hoverinfo:'skip' } ]; }
    function ichiTraces(rows){
      const high=rows.map(r=>r.h), low=rows.map(r=>r.l), close=rows.map(r=>r.c), x=rows.map(r=>new Date(r.t));
      const rollingMid=(h,l,p)=>{ const out=Array(h.length).fill(null); for(let i=0;i<h.length;i++){ const s=Math.max(0,i-p+1); let hi=-Infinity, lo=Infinity; for(let j=s;j<=i;j++){ if(Number.isFinite(h[j])) hi=Math.max(hi,h[j]); if(Number.isFinite(l[j])) lo=Math.min(lo,l[j]); } if(hi>-Infinity&&lo<Infinity) out[i]=(hi+lo)/2; } return out; };
      const tenkan=rollingMid(high,low,9), kijun=rollingMid(high,low,26), spanB=rollingMid(high,low,52);
      const spanA=tenkan.map((v,i)=> (Number.isFinite(v)&&Number.isFinite(kijun[i]))? (v+kijun[i])/2 : null);
      const shift=26; const step = x.length>1? (x[1]-x[0]) : 24*3600*1000;
      const xExt = x.concat(Array.from({length:shift}, (_,k)=> new Date(x[x.length-1].getTime()+(k+1)*step)));
      const proj=(arr)=>{ const out=Array(xExt.length).fill(null); for(let i=0;i<arr.length;i++){ const v=arr[i]; if(Number.isFinite(v)) out[i+shift]=v; } return out; };
      const a=proj(spanA), b=proj(spanB);
      // Segmented clouds
      const upTop=Array(xExt.length).fill(null), upBot=Array(xExt.length).fill(null);
      const dnTop=Array(xExt.length).fill(null), dnBot=Array(xExt.length).fill(null);
      for(let i=0;i<xExt.length;i++){
        const A=a[i], B=b[i];
        if(Number.isFinite(A)&&Number.isFinite(B)){
          if(A>=B){ upTop[i]=A; upBot[i]=B; }
          else { dnTop[i]=B; dnBot[i]=A; }
        }
      }
      const cloudUpTop={type:'scatter',mode:'lines',x:xExt,y:upTop,line:{width:0},showlegend:false,hoverinfo:'skip'};
      const cloudUpFill={type:'scatter',mode:'lines',x:xExt,y:upBot,line:{width:0},fill:'tonexty',fillcolor:css('--c-ichi-up')||'rgba(34,197,94,.45)',showlegend:false,hoverinfo:'skip'};
      const cloudDnTop={type:'scatter',mode:'lines',x:xExt,y:dnTop,line:{width:0},showlegend:false,hoverinfo:'skip'};
      const cloudDnFill={type:'scatter',mode:'lines',x:xExt,y:dnBot,line:{width:0},fill:'tonexty',fillcolor:css('--c-ichi-down')||'rgba(239,68,68,.40)',showlegend:false,hoverinfo:'skip'};
      // Span lines for visual edges
      const spanALine={type:'scatter',mode:'lines',x:xExt,y:a,name:'Span A',line:{color:css('--c-ichi-spanA')||'#22c55e',width:1.2,dash:'dot'},hoverinfo:'skip',showlegend:false};
      const spanBLine={type:'scatter',mode:'lines',x:xExt,y:b,name:'Span B',line:{color:css('--c-ichi-spanB')||'#ef4444',width:1.2,dash:'dot'},hoverinfo:'skip',showlegend:false};
      const ten={type:'scatter',mode:'lines',x,y:tenkan,name:'Tenkan',line:{color:css('--c-ichi-tenkan')||'#f59e0b',width:1.6},hoverinfo:'skip'};
      const kij={type:'scatter',mode:'lines',x,y:kijun,name:'Kijun',line:{color:css('--c-ichi-kijun')||'#60a5fa',width:1.8},hoverinfo:'skip'};
      const chikou=Array(x.length).fill(null); for(let i=0;i<close.length;i++){ const ii=i-shift; if(ii>=0) chikou[ii]=close[i]; }
      const chi={type:'scatter',mode:'lines',x,y:chikou,name:'Chikou',line:{color:css('--c-ichi-chikou')||'#93c5fd',width:1.4,dash:'dot'},hoverinfo:'skip'};
      return [cloudUpTop,cloudUpFill,cloudDnTop,cloudDnFill,spanALine,spanBLine,ten,kij,chi];
    }

    // Build Plotly layout and traces
    function buildLayout(base){
      return Object.assign({}, base, {
        hovermode:'x unified',
        hoverlabel:{
          bgcolor: css('--panel')||'#0b1220',
          bordercolor: css('--border')||'#2b3548',
          font:{ color: css('--text')||'#e5e7eb', size:12 }
        },
        uirevision:`${state.ticker}|${state.range}|${state.interval}`
      });
    }

    // --- Auto Fib helpers ---
    const FIB_PCTS=[0,0.236,0.382,0.5,0.618,0.786,1];
    function getVisibleRangeMs(){
      if(!els.chart) return [NaN,NaN];
      const L=els.chart._fullLayout||els.chart.layout||{}; const xa=L.xaxis||{};
      const toMs=v=> new Date(v).getTime();
      if(Array.isArray(xa.range) && xa.autorange===false){ return [toMs(xa.range[0]), toMs(xa.range[1])]; }
      const rows=getDisplayRows(); if(!rows.length) return [NaN,NaN];
      return [rows[0].t, rows[rows.length-1].t];
    }
    function computeHiLoInRange(rows,x0,x1){
      let hi=-Infinity, lo=Infinity, hiIdx=-1, loIdx=-1;
      for(let i=0;i<rows.length;i++){
        const t=rows[i].t; if(t<x0||t>x1) continue; const H=rows[i].h, L=rows[i].l;
        if(Number.isFinite(H) && H>hi){ hi=H; hiIdx=i; }
        if(Number.isFinite(L) && L<lo){ lo=L; loIdx=i; }
      }
      if(!(hi<Infinity && lo>-Infinity) || hi===lo) return null;
      const dir = (hiIdx>loIdx)? 'up' : 'down';
      const span = hi-lo;
      const levels = FIB_PCTS.map(p=> hi - span*p);
      return {hi,lo,dir,levels};
    }
    function makeFibTraces(x0,x1,levels){
      const x=[new Date(x0), new Date(x1)];
      const color=css('--c-fib')||'#f59e0b';
      return levels.map((lv,i)=>{ const pct=Math.round(FIB_PCTS[i]*1000)/10; const label=`${(+lv).toFixed(2)} (${pct}%)`; return ({
        type:'scatter', mode:'lines+text', x, y:[lv,lv], name:`Fib ${pct}%`,
        line:{ color, width:1, dash:'dot' }, yaxis:'y', hoverinfo:'skip', showlegend:false,
        text:[label,label], textposition:['middle left','middle right'], textfont:{color:color, size:10},
        meta:{kind:'AUTOFIB', pct:FIB_PCTS[i]}
      }); });
    }
    function updateAutoFib(){
      if(!els.chart) return;
      if(!q('.chip[data-k="AUTOFIB"]')?.classList.contains('active')) return;
      const rows=getDisplayRows(); if(!rows.length || !Array.isArray(state.fibIdx) || !state.fibIdx.length) return;
      const [x0,x1]=getVisibleRangeMs(); if(!Number.isFinite(x0)||!Number.isFinite(x1)) return;
      const s=computeHiLoInRange(rows,x0,x1); if(!s) return;
      const xArr=[new Date(x0), new Date(x1)];
      for(let i=0;i<state.fibIdx.length && i<s.levels.length;i++){
        const lv=s.levels[i]; const pct=Math.round(FIB_PCTS[i]*1000)/10; const label=`${(+lv).toFixed(2)} (${pct}%)`;
        try{ Plotly.restyle(els.chart, { x:[xArr], y:[[lv, lv]], text:[[label,label]], textposition:[[ 'middle left','middle right' ]]}, [state.fibIdx[i]]); }catch{}
      }
    }
    const updateAutoFibDebounced = debounce(updateAutoFib, 50);

    async function renderChart(){
      const rows = state.rows||[]; if(!rows.length||!els.chart) return;
      const rowsDisplay = getDisplayRows();
      const traces = [];
      traces.push(candleTrace(rowsDisplay));
      // SMA 20/50/200 mapped from aligned series so they span full width
      const map20 = mapByTs(state.rows, state.smaSeries?.[20]||[]);
      const map50 = mapByTs(state.rows, state.smaSeries?.[50]||[]);
      const map200= mapByTs(state.rows, state.smaSeries?.[200]||[]);
      const xArr = rowsDisplay.map(r=>new Date(r.t));
      const tSMA20 = { type:'scatter', mode:'lines', x:xArr, y:fillForward(fillBackward(rowsDisplay.map(r=> map20.get(r.t) ?? null))), name:'SMA 20', line:{ color: css('--c-sma20')||'#22c55e', width:1.8 }, yaxis:'y', visible: q('.chip[data-k="SMA20"]')?.classList.contains('active')||false };
      const tSMA50 = { type:'scatter', mode:'lines', x:xArr, y:fillForward(fillBackward(rowsDisplay.map(r=> map50.get(r.t) ?? null))), name:'SMA 50', line:{ color: css('--c-sma50')||'#60a5fa', width:1.8 }, yaxis:'y', visible: q('.chip[data-k="SMA50"]')?.classList.contains('active')||false };
      const tSMA200= { type:'scatter', mode:'lines', x:xArr, y:fillForward(fillBackward(rowsDisplay.map(r=> map200.get(r.t) ?? null))), name:'SMA 200', line:{ color: css('--c-sma200')||'#f59e0b', width:2.0 }, yaxis:'y', visible: q('.chip[data-k="SMA200"]')?.classList.contains('active')||false };
      traces.push(tSMA20,tSMA50,tSMA200);
      // Other overlays
      const volOn = q('.chip[data-k="VOL"]')?.classList.contains('active')||false; if(volOn) traces.push(volTrace(rowsDisplay));
      const rsiOn = q('.chip[data-k="RSI"]')?.classList.contains('active')||false; if(rsiOn) traces.push(rsiTrace(rowsDisplay));
      const macdOn= q('.chip[data-k="MACD"]')?.classList.contains('active')||false; if(macdOn) traces.push(...macdTraces(rowsDisplay));
      const ichiOn= q('.chip[data-k="ICHI"]')?.classList.contains('active')||false; if(ichiOn) traces.push(...ichiTraces(rowsDisplay));

      // Auto Fib
      state.fibIdx = [];
      const fibOn = q('.chip[data-k="AUTOFIB"]')?.classList.contains('active') || false;
      if (fibOn) {
        const [vx0, vx1] = (function() {
          // try current visible range if available, else bounds of rowsDisplay
          const L = els.chart._fullLayout || els.chart.layout || {};
          const xa = L.xaxis || {};
          const toMs = v => new Date(v).getTime();
          if (Array.isArray(xa.range) && xa.autorange === false) {
            return [toMs(xa.range[0]), toMs(xa.range[1])];
          }
          if (xArr.length) return [xArr[0].getTime(), xArr[xArr.length - 1].getTime()];
          return [NaN, NaN];
        })();
        const stats = computeHiLoInRange(rowsDisplay, vx0, vx1);
        if (stats) {
          const start = traces.length;
          traces.push(...makeFibTraces(vx0, vx1, stats.levels));
          state.fibIdx = Array.from({ length: stats.levels.length }, (_, i) => start + i);
        }
      }

      const baseLayout = {
        margin:{l:56,r:24,t:18,b:28},
        paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)',
        showlegend:true, legend:{orientation:'h', y:-0.12},
        xaxis:{ gridcolor:css('--grid'), showgrid:true, zeroline:false },
        yaxis:{ gridcolor:css('--grid'), showgrid:true, zeroline:false },
        yaxis2:{ overlaying:'y', side:'right', rangemode:'tozero', showgrid:false, showticklabels:false },
        yaxis3:{ overlaying:'y', side:'right', range:[0,100], showgrid:false, showticklabels:false },
        yaxis4:{ overlaying:'y', side:'right', showgrid:false, showticklabels:false },
        font:{ color:css('--text') }
      };
      const layout = buildLayout(baseLayout);
      await Plotly.react(els.chart, traces, layout, { responsive:true, displayModeBar:false });
      await fitPriceAxisToCandlesStrict();
      // ensure Fib aligns to current viewport after first render
      updateAutoFibDebounced();
    }

    // Refit y-axis on interactions
    els.chart?.addEventListener?.('plotly_relayout', (ev)=>{
      if(ev && (ev['xaxis.range[0]']||ev['xaxis.range[1]']||ev['xaxis.autorange']!==undefined)){
        setTimeout(fitPriceAxisToCandlesStrict,0);
        updateAutoFibDebounced();
      }
    });
    /* ---------- Quote + subline (company info) ---------- */
    async function refreshQuoteOnce(){
      try{
        const r = await fetch(`/api/quote?ticker=${encodeURIComponent(state.ticker)}`, { cache:'no-store' }); if(!r.ok) throw 0; const j=await r.json();
        const R = j?.quoteSummary?.result?.[0]?.price || j?.quoteResponse?.result?.[0] || {};
        const name = R.longName || R.shortName || '';
        const exch = R.exchangeName || R.fullExchangeName || R.exchange || '';
        const currency = R.currency || 'USD';
        const regPrice = +(R.regularMarketPrice?.raw ?? R.regularMarketPrice);
        const prevClose = +(R.regularMarketPreviousClose?.raw ?? R.regularMarketPreviousClose);
        const postPrice = +(R.postMarketPrice?.raw ?? R.postMarketPrice);
        const prePrice  = +(R.preMarketPrice?.raw ?? R.preMarketPrice);
        const postTime  = +((R.postMarketTime?.raw ?? R.postMarketTime) || 0) * 1000;
        const preTime   = +((R.preMarketTime?.raw ?? R.preMarketTime) || 0) * 1000;
        const regTime   = +((R.regularMarketTime?.raw ?? R.regularMarketTime) || 0) * 1000;
        // pick latest session
        const triples = [
          {p:regPrice, t:regTime, s:'REG'},
          {p:postPrice,t:postTime,s:'POST'},
          {p:prePrice, t:preTime, s:'PRE'}
        ].filter(x=>Number.isFinite(x.p)&&x.t>0).sort((a,b)=>b.t-a.t);
        const best = triples[0] || {p:regPrice, t:regTime, s:'REG'};
        const price = Number.isFinite(best.p)? best.p : (state.rows?.at(-1)?.c ?? NaN);
        const chg = (Number.isFinite(price)&&Number.isFinite(prevClose)&&prevClose>0)? price-prevClose : NaN;
        const pct = Number.isFinite(chg)&&prevClose>0? (chg/prevClose*100) : NaN;
        const sessText = best.s==='PRE'? 'Pre‑Market' : best.s==='POST'? 'After‑Hours' : 'Regular';
        els.headline.textContent = `${state.ticker}${name? ' — '+name:''}`;
        els.subInfo.textContent = [exch||'', currency||'', `Session: ${sessText}`, `${state.range} · ${state.interval}`].filter(Boolean).join(' • ');
        const col = (chg>0? css('--c-up'): chg<0? css('--c-down'): css('--muted')) || '#cbd5e1';
        const chHTML = Number.isFinite(chg) ? `<span style="font-weight:800;color:${col}">${chg>0?'+':''}$${Math.abs(chg).toFixed(2)} (${chg>0?'+':''}${Math.abs(pct).toFixed(2)}%)</span>` : '—';
        els.lastLine.innerHTML = `Last: ${fmtPx(price)} · Change: ${chHTML}`;
        els.prevCloseLine.textContent = `Yesterday’s Close: ${fmtPx(prevClose)}`;
        // Simple intrinsic proxy: average of SMA50 & SMA200 when available
        const s50 = state.smaLast?.[50]; const s200 = state.smaLast?.[200]; const iv = Number.isFinite(s50)&&Number.isFinite(s200)? ((s50+s200)/2) : (Number.isFinite(s200)? s200 : Number.isFinite(s50)? s50 : NaN);
        els.ivLine.textContent = `Intrinsic Value: ${fmtPx(iv)}`;
      }catch{}
    }

    function startQuoteTimer(){ if(state.quoteTimer){ clearInterval(state.quoteTimer); state.quoteTimer=null; } refreshQuoteOnce(); state.quoteTimer=setInterval(refreshQuoteOnce, 60000); }

    /* ---------- Data fetch ---------- */
    async function fetchRows(ticker, range, interval){
      try{
        const r = await fetch(`/api/chart?ticker=${encodeURIComponent(ticker)}&range=${encodeURIComponent(range)}&interval=${encodeURIComponent(interval)}`, { cache:'no-store' });
        if(r.ok){ const j=await r.json(); const res=j?.chart?.result?.[0]; if(res){ const ts=res.timestamp||[]; const q=res.indicators?.quote?.[0]||{}; const rows=[]; for(let i=0;i<ts.length;i++){ const c=q.close?.[i]; if(!Number.isFinite(c)) continue; rows.push({ t:ts[i]*1000, o:q.open?.[i], h:q.high?.[i], l:q.low?.[i], c:+c, v:q.volume?.[i]||0 }); } return rows; } }
      }catch{}
      throw new Error('chart fetch failed');
    }

    /* ---------- Load + render pipeline ---------- */
    async function loadAndRender(){
      try{ state.rows = await fetchRows(state.ticker, state.range, state.interval); await buildSMAAlignedSeries(); await renderChart(); refreshQuoteOnce(); }catch(e){ console.error('Chart error', e); }
    }

    // UI wiring
    els.searchBtn?.addEventListener('click', ()=>{ const t=sanitizeTicker(els.input.value); if(!t) return; state.ticker=t; localStorage.setItem('lastTicker', t); loadAndRender(); });
    els.input?.addEventListener('input', (e)=>{ updateAC(e.target.value); });
    els.input?.addEventListener('keydown', (e)=>{ if(!['ArrowDown','ArrowUp','Enter','Escape','Tab'].includes(e.key)) return; if(e.key==='Escape'){ state.acMatches=[]; renderAC(); return;} if(!state.acMatches.length){ return; } if(e.key==='ArrowDown'){ e.preventDefault(); state.acIndex = (state.acIndex+1)%state.acMatches.length; renderAC(); } else if(e.key==='ArrowUp'){ e.preventDefault(); state.acIndex = (state.acIndex-1+state.acMatches.length)%state.acMatches.length; renderAC(); } else if(e.key==='Enter' || e.key==='Tab'){ const idx= state.acIndex<0?0:state.acIndex; pickAC(idx); if(e.key==='Enter'){ e.preventDefault(); els.searchBtn?.click(); } } });
    els.list?.addEventListener('mousedown', (e)=>{ const it=e.target.closest('.ac-item'); if(!it) return; pickAC(state.acMatches.findIndex(x=>x.t===it.dataset.t)); els.searchBtn?.click(); });
    els.timeSel?.addEventListener('change', ()=>{ state.range=els.timeSel.value; loadAndRender(); });
    els.freqSel?.addEventListener('change', ()=>{ state.interval=els.freqSel.value; loadAndRender(); });
    els.toggles?.addEventListener('click', (e)=>{ const chip=e.target.closest('.chip'); if(!chip) return; chip.classList.toggle('active'); chip.setAttribute('aria-pressed', chip.classList.contains('active')?'true':'false'); renderChart(); });
    // After Auto Fib toggle ensure labels update
    els.toggles?.addEventListener('click', (e)=>{ const chip=e.target.closest('.chip'); if(!chip) return; if(chip.dataset.k==='AUTOFIB'){ setTimeout(updateAutoFibDebounced, 0); } });
    // Start
    (async function boot(){ try{ await loadSymbols(); }catch{}; els.input.value=state.ticker; await loadAndRender(); startQuoteTimer(); })();
  })();
  </script>
</body>
</html>