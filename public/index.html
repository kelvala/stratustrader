<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Analyzer v.43</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="/assets/stratus-trader-wide.png">

<!-- Plotly (no defer) -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<style>
  :root{
    --bg:#0f1115;--panel:#151923;--text:#e5e7eb;--muted:#9ca3af;
    --accent:#22c55e;--focus:#3b82f6;--border:#23283a;--hover:#161a25;
    --metric-bg:#1a1f2e;--metric-border:#2a2f3e;
    --field-bg:#0c0f16;--field-text:#e5e7eb;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#60a5fa;--c-sma200:#f59e0b; /* back to yellowish 200 SMA */
    --c-rsi:#a78bfa;--c-macd:#38bdf8;--c-vol:#10b981;
  --c-div:#eab308; /* dividends marker color (amber) */
    --grid:#283044;
    --lvl-beginner:#22c55e; --lvl-intermediate:#f59e0b; --lvl-advanced:#ef4444;
    --tf-bg:#1c1f35; --tf-head:#1a214e; --tf-glow:#3b82f6;
    --c-ichi-tenkan:#f59e0b; --c-ichi-kijun:#60a5fa; --c-ichi-chikou:#f472b6; /* pinkish chikou like Fidelity */
    --c-ichi-up:rgba(34,197,94,.45);
    --c-ichi-down:rgba(239,68,68,.40);
    --c-ichi-spanA:#22c55e; /* Senkou Span A line */
    --c-ichi-spanB:#ef4444; /* Senkou Span B line */
  }
  .light{
    --bg:#f8fafc;--panel:#fff;--text:#222;--muted:#64748b;
    --accent:#22c55e;--focus:#3b82f3;--border:#e2e8f0;--hover:#f1f5f9;
    --metric-bg:#f1f5f9;--metric-border:#e2e8f0;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#2563eb;--c-sma200:#f59e0b; /* yellowish in light too */
    --c-rsi:#7c3aed;--c-macd:#0ea5e9;--c-vol:#16a34a;
    --grid:#e5e7eb; --tf-bg:#eef2ff; --tf-head:#c7d2fe; --tf-glow:#6366f1;
    --field-bg:#ffffff; --field-text:#111827;
  }
  *{box-sizing:border-box}
  html,body{overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh;padding:20px;transition:background .2s,color .2s}
  .container{max-width:1100px;margin:0 auto}
  .toolbar{position:sticky;top:0;z-index:12000;display:flex;gap:10px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin-bottom:16px;flex-wrap:wrap}
  .ticker-wrap{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
  .ticker-wrap label{font-weight:800;opacity:.9}
  .input-wrap{position:relative;flex:0 1 460px;max-width:460px;width:100%}
  @media (max-width:720px){ .input-wrap{flex:1 1 100%;max-width:100%} }
  .ticker-input{width:100%;min-width:120px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--field-bg);color:var(--field-text);text-transform:uppercase;font-size:16px}
  .btn{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn.inline{padding:8px 12px}
  .toolsbar{display:flex;align-items:center;gap:8px;margin-left:auto;flex:1 1 100%;justify-content:flex-start;flex-wrap:wrap}
  .tool-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:700;cursor:pointer}
  .tool-btn:hover{background:var(--hover)}
  /* Buffett Indicator card (prominent) */
  .buffett-card{margin-left:12px;padding:10px 14px;border-radius:12px;background:linear-gradient(180deg, rgba(59,130,246,0.06), rgba(34,197,94,0.02));border:1px solid color-mix(in srgb,var(--border), #ffffff 8%);display:flex;flex-direction:column;align-items:flex-start;gap:6px;min-width:200px}
  .buffett-title{font-weight:900;font-size:12px;opacity:.9}
  .buffett-value{font-weight:900;font-size:20px;letter-spacing:.6px}
  .buffett-sub{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
  .buffett-card .tool-btn{padding:6px 8px;border-radius:8px;font-weight:800}
  .theme-toggle{margin-left:auto;cursor:pointer;padding:8px 14px;border-radius:8px;background:var(--panel);color:var(--text);border:1px solid var(--border);font-weight:600}
  .theme-toggle:hover{background:var(--hover)}
  .theme-toggle.active{background:var(--accent);color:#fff}
  .ac{position:absolute;left:0;top:calc(100% + 6px);width:100%;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;display:none;max-height:280px;overflow:auto;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:12050}
  .ac.show{display:block}
  /* Give the ticker more room so it doesn't feel cramped */
  .ac-item{padding:12px 14px;display:grid;grid-template-columns:minmax(160px, 240px) 1fr;gap:12px;align-items:center;cursor:pointer;border-bottom:1px solid var(--metric-border)}
  .ac-item:hover,.ac-item.active{background:var(--hover)}
  .ticker{font-weight:800}
  .company{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .info{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;position:relative}
  .info-logo{position:absolute;top:10px;right:12px;height:54px;opacity:.92;pointer-events:none;filter:drop-shadow(0 2px 8px rgba(0,0,0,.35))}
  .light .info-logo{mix-blend-mode:multiply;filter:drop-shadow(0 2px 6px rgba(0,0,0,.12));opacity:.95}
  @media (max-width:640px){ .info-logo{height:42px;right:10px} }
  #chartCard{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative}
  #chart{height:68vh;min-height:520px}
  .container.wide{max-width:100%!important}
  #chartCard.max{position:fixed;inset:12px;z-index:9999;margin:0!important;width:auto!important;height:auto!important;overflow:auto}
  #chartCard.max #chart{height:calc(100vh - 160px)!important;min-height:400px;cursor:zoom-out}
  .tf-card{background:var(--tf-bg);border:1px solid rgba(99,102,241,.25);border-radius:12px;padding:10px;margin-bottom:10px;box-shadow:0 0 0 1px rgba(99,102,241,.15) inset}
  .tf-head{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg, var(--tf-head), transparent);border-radius:8px;padding:6px 10px;margin:-4px -2px 8px;font-weight:800}
  .tf-head .carat{display:inline-block;transform:rotate(-90deg);transition:transform .15s ease}
  .tf-card[data-open="true"] .carat{transform:rotate(0)}
  .tf-body{display:none}
  .tf-card[data-open="true"] .tf-body{display:grid}
  .tf-body{grid-template-columns:1fr 1fr;gap:10px}
  .control label{display:block;font-size:13px;font-weight:800;margin-bottom:6px;color:#cbd5ff}
  .control select{width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px}
  .toggle-row{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 10px}
  .chip{border:1px solid #2b3548;border-radius:999px;padding:6px 12px;cursor:pointer;font-weight:800;opacity:.98;user-select:none;transition:background .15s,color .15s,border-color .15s; -webkit-text-fill-color: currentColor; color: currentColor; background: color-mix(in srgb, var(--panel), #ffffff 3%);} 
  .chip:not(.active){filter: saturate(0.95) brightness(1.02);} 
  /* Chip base colors (fixed typos) */
  .chip[data-k="SMA20"]{border-color:var(--c-sma20);color:var(--c-sma20);} 
  /* fixed var() syntax below */
  .chip[data-k="SMA50"]{border-color:var(--c-sma50);color:var(--c-sma50);} 
  .chip[data-k="SMA200"]{border-color:var(--c-sma200);color:var(--c-sma200);} 
  .chip[data-k="RSI"]{border-color:var(--c-rsi);color:var(--c-rsi);} 
  .chip[data-k="MACD"]{border-color:var(--c-macd);color:var(--c-macd);} 
  .chip[data-k="VOL"]{border-color:var(--c-vol);color:var(--c-vol);} 
  .chip[data-k="DIV"]{border-color:var(--c-div);color:var(--c-div);} 
  .chip[data-k="AUTOFIB"]{border-color:#8b5cf6;color:#8b5cf6}
  .chip[data-k="ICHI"]{border-color:#60a5fa;color:#60a5fa}
  .chip[data-k="SESS"]{border-color:#93c5fd;color:#93c5fd}

  /* Bollinger Bands chip color */
  .chip[data-k="BB"]{ border-color:#7c3aed;color:#7c3aed; }
  .chip.active[data-k="BB"]{ background:rgba(124,58,237,.12); }

  /* Active backgrounds (kept) */
  .chip.active[data-k="SMA20"]{background:rgba(34,197,94,.12)}
  .chip.active[data-k="SMA50"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SMA200"]{background:rgba(245,158,11,.12)}
  .chip.active[data-k="RSI"]{background:rgba(167,139,250,.12)}
  .chip.active[data-k="MACD"]{background:rgba(56,189,248,.12)}
  .chip.active[data-k="VOL"]{background:rgba(16,185,129,.12)}
  .chip.active[data-k="DIV"]{background:rgba(234,179,8,.14)}
  .chip.active[data-k="AUTOFIB"]{background:rgba(139,92,246,.12)}
  .chip.active[data-k="ICHI"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SESS"]{background:rgba(147,197,253,.12)}
  /* Range + inline frequency rows */
  .range-bar{display:flex;flex-direction:column;gap:4px;margin:0 0 12px}
  .range-label,.freq-label{font-size:11px;opacity:.7;margin-left:2px}
  .range-row,.freq-row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .range-row button,.freq-row button{background:var(--panel);border:1px solid var(--border);color:var(--text);font-weight:700;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px;min-width:42px;transition:opacity .15s,background .15s,border-color .15s,color .15s}
  .range-row button.active,.freq-row button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .range-row button.disabled,.freq-row button.disabled{opacity:.35;cursor:default;border-style:dashed}
  .freq-grid button.active{background:var(--accent);color:#fff;border-color:var(--accent)}

  /* Clean UI preview mode (enable via ?ui=clean) */
  .clean-ui #tfCard{display:none!important}
  .clean-ui #chartCard{display:flex;flex-direction:column}
  .clean-ui #chart{order:2}
  .clean-ui .range-bar{order:3;margin-top:10px}
  .clean-ui #toggles,.clean-ui #smaCtrls,.clean-ui #smaCustomChips{order:1}

  /* Bright glow for active chips only (already present; keep it)
     This guarantees inactive chips have NO glow. */
  .chip{position:relative}
  /* Make active chip glow subtle to match button color */
  .chip.active{border-width:2px; box-shadow:0 0 0 1px currentColor;}
  .chip.active::after{display:none}
  .light .chip.active::after{display:none}
  .chip:focus-visible{outline:2px solid currentColor;outline-offset:3px}
  .section-sep{margin:20px -16px 16px;padding:0 16px}
  .section-sep .rule{height:3px;border-radius:999px;background:linear-gradient(90deg,var(--focus),var(--accent));opacity:.9}
  /* SMA controls row */
  .sma-ctrls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0 4px}
  .sma-ctrls select,.sma-ctrls input{background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
  .sma-ctrls input{width:92px}
  .sma-ctrls small{opacity:.7}
  /* Sheets (bottom drawers). When opened we show a full-viewport backdrop to clearly separate the sheet from the page. */
  .sheet{position:fixed;left:0;right:0;bottom:0;top:auto;background:transparent;display:flex;justify-content:center;z-index:13000}
  .sheet[hidden]{display:none!important}
  /* Backdrop when a sheet is open */
  .sheet[data-open="true"]::before{
    content:""; position:fixed; inset:0; background:rgba(2,6,23,0.58); backdrop-filter: blur(6px) saturate(1.05); z-index:13000; pointer-events:auto;
  }
  .sheet-inner{width:min(760px,100%);background:var(--panel);border-top:1px solid var(--border);border-radius:16px 16px 0 0;box-shadow:0 20px 60px rgba(0,0,0,.55);padding:14px;animation:sheetUp .18s ease-out;padding-bottom:max(14px, env(safe-area-inset-bottom));z-index:13001;position:relative}
  /* Slight visual tweak for the sheet header and close control to make it pop above the page */
  .sheet-head{z-index:13002}
  .sheet-close{background:transparent;border:0;color:var(--text);font-size:18px;cursor:pointer;padding:6px 8px;border-radius:8px}
  .sheet-close:hover{background:var(--hover);box-shadow:0 6px 18px rgba(0,0,0,.35)}

  /* GPTs sheet specific styling: stronger accent so it's clearly an overlay and not part of the page */
  #sheetGPTs .sheet-inner{ width:min(920px,98%); border-radius:12px; border:1px solid rgba(255,255,255,0.04); background:linear-gradient(180deg, color-mix(in srgb, var(--panel), #000 6%), var(--panel)); box-shadow:0 28px 80px rgba(2,6,23,.7); }
  #sheetGPTs .sheet-head .sheet-title{ color:var(--text); font-weight:900; display:flex;align-items:center;gap:10px }
  #sheetGPTs .sheet-head .sheet-title::before{ content:'üß†'; display:inline-block; transform:translateY(-1px); }
  #sheetGPTs .sheet-inner{ border-left:4px solid var(--tf-glow); }

  /* Screeners stays a bit narrower so it's visually different from GPTs */
  #sheetScreeners .sheet-inner{ width:min(760px,94%); }
  .sheet-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .sheet-title{font-weight:800;font-size:16px}
  .sheet-close{background:transparent;border:0;color:var(--text);font-size:18px;cursor:pointer}
  .sheet-body{max-height:58vh;overflow:auto}
  @keyframes sheetUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
  .btmnav{position:fixed;left:0;right:0;bottom:0;display:none;background:var(--panel);border-top:1px solid var(--border);padding:6px 10px;z-index:1000}
  .btmnav .tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 8px;border-radius:10px;border:0;background:transparent;color:var(--text);font-weight:700;font-size:13px}
  .btmnav .tab.active{background:var(--hover)}
  .btmnav .tab span{font-size:11px;opacity:.85}
  /* --- headline ticker styles (mini) --- */
  .site-ticker{display:flex;align-items:center;gap:10px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 12px;margin-bottom:12px;color:var(--text);transition: max-height 260ms ease, opacity 200ms ease, padding 200ms ease;overflow:hidden}
  .site-ticker .left{font-weight:800;color:var(--muted);background:color-mix(in srgb,var(--panel),#081018 6%);padding:6px 10px;border-radius:8px}
  .site-ticker .content{flex:1;white-space:nowrap;overflow:hidden}
  .site-ticker a.headline{color:var(--text);text-decoration:none;padding-right:28px;display:inline-block}
  .site-ticker .meta{color:var(--muted);font-size:12px;margin-right:8px}
  .site-ticker .controls{display:flex;gap:8px;margin-left:12px}
  .site-ticker .btn{background:transparent;border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:8px;cursor:pointer}
  .site-ticker.collapsed{max-height:0;padding-top:0;padding-bottom:0;opacity:0}
  @media (max-width:720px){ .btmnav{display:flex;gap:8px} body{padding-bottom:64px} }
  .scr-list{display:flex;flex-direction:column;gap:10px}
  .scr-item{
    position:relative; display:flex; gap:12px; align-items:flex-start;
    padding:12px 14px; border:1px solid var(--border); border-radius:12px;
    background:color-mix(in hsl, var(--panel), var(--bg) 35%);
    text-decoration:none; color:inherit; cursor:pointer;
    transition:background .15s,border-color .15s,transform .06s;
  }
  .scr-item:hover{ background:var(--hover); border-color:#2b3548; transform:translateY(-1px); }
  .scr-item::before{ content:""; position:absolute; left:0; top:8px; bottom:8px; width:4px; border-radius:999px; background: var(--lvl-color, #64748b); opacity:.8; }
  .scr-item{ padding-left:16px; }
  .scr-item[data-lvl="Beginner"]     { --lvl-color: var(--lvl-beginner); }
  .scr-item[data-lvl="Intermediate"] { --lvl-color: var(--lvl-intermediate); }
  .scr-item[data-lvl="Advanced"]     { --lvl-color: var(--lvl-advanced); }
  .scr-item .title{ font-weight:800; font-size:14px; line-height:1.25; }
  .scr-item .desc{ font-size:12px; color:var(--muted); margin-top:2px; }
  .badge{ font-size:11px; font-weight:800; padding:2px 8px; border-radius:999px; background:var(--metric-bg); border:1px solid var(--metric-border); color:var(--muted); white-space:nowrap; margin-top:2px; }
  .scr-item .open-btn{ margin-left:8px; padding:6px 10px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); text-decoration:none; font-weight:700; }
  .scr-item .open-btn:hover{ background:var(--hover); }

  /* === Button glow (added) === */
  .btn, .tool-btn, .theme-toggle, .btmnav .tab {
    --glow-color: var(--focus);
    position: relative;
    transition: box-shadow .15s, transform .06s, background .15s, border-color .15s;
  }
  .btn { --glow-color: var(--accent); }
  .btn:hover, .btn:focus-visible,
  .tool-btn:hover, .tool-btn:focus-visible,
  .theme-toggle:hover, .theme-toggle:focus-visible,
  .btmnav .tab:hover, .btmnav .tab:focus-visible {
    box-shadow:
      0 0 0 2px var(--glow-color),
      0 0 10px var(--glow-color),
      0 0 24px 6px var(--glow-color),
      0 0 40px 12px var(--glow-color);
    z-index: 1;
  }
  .btn:hover::after, .btn:focus-visible::after,
  .tool-btn:hover::after, .tool-btn:focus-visible::after,
  .theme-toggle:hover::after, .theme-toggle:focus-visible::after,
  .btmnav .tab:hover::after, .btmnav .tab:focus-visible::after {
    content: "";
    position: absolute;
    inset: -10px;
    border-radius: inherit;
    background: radial-gradient(60% 60% at 50% 50%, var(--glow-color) 0%, rgba(0,0,0,0) 80%);
    filter: blur(12px);
    z-index: -1;
    pointer-events: none;
    opacity: 0.7;
  }

  /* Nicer colorization for autocomplete tickers */
  /* Make tickers a distinct color and keep them on one line */
  .ac-item .ticker{ color: var(--accent); font-weight:900; letter-spacing:.3px; white-space:nowrap; }
  .ac-item:hover .ticker, .ac-item.active .ticker{ color: color-mix(in srgb, var(--accent), #ffffff 14%); }
  /* Company name muted so ticker stands out */
  .ac-item .company{ color: var(--muted); font-weight:700; }
  .ac-item:hover .company, .ac-item.active .company{ color: var(--muted); opacity:.95; }

  /* Toast */
  #toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%) translateY(40px);background:var(--panel);color:var(--text);border:1px solid var(--border);padding:10px 14px;border-radius:12px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;z-index:4000;box-shadow:0 6px 24px -2px rgba(0,0,0,.45)}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* Market Overview mini-cards */
  .mkt-row{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin:14px 0}
  @media (max-width:980px){ .mkt-row{grid-template-columns:1fr;gap:10px} }
  .mkt-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .mkt-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .mkt-title{font-weight:900;letter-spacing:.4px}
  .mkt-chg{font-weight:900}
  .mkt-chart{height:180px}

  /* Mini gauges row under market overview */
  .mkt-gauges{display:grid;grid-template-columns:repeat(5,minmax(180px,1fr));gap:10px;margin:8px 0 2px}
  @media (max-width:1160px){ .mkt-gauges{grid-template-columns:repeat(3,minmax(180px,1fr));} }
  @media (max-width:820px){ .mkt-gauges{grid-template-columns:repeat(2,minmax(180px,1fr));} }
  @media (max-width:520px){ .mkt-gauges{grid-template-columns:1fr;gap:8px} }
  .g-card{background:color-mix(in srgb, var(--panel), var(--bg) 52%);border:1px solid color-mix(in srgb, var(--border), #ffffff 18%);border-radius:10px;padding:6px 8px}
  /* make toolbar mini cards feel interactive */
  .toolsbar .g-card{cursor:pointer}
  /* Buffett mini-card pill for quick color status */
  .buffett-pill{height:6px;border-radius:4px;width:100%;margin-top:8px;background:transparent;border:1px solid rgba(255,255,255,0.02)}
  .g-head{display:flex;flex-direction:column;align-items:flex-start;gap:2px;margin-bottom:4px}
  .g-title{font-weight:600;opacity:.88;font-size:12px;white-space:normal}
  .g-metrics{font-weight:600;font-size:11px;color:var(--muted);opacity:.9;white-space:nowrap}
  .g-metrics .g-up{color:var(--c-up)}
  .g-metrics .g-dn{color:var(--c-down)}
  .g-bar{position:relative;height:5px;border-radius:5px;background:color-mix(in srgb, var(--metric-bg), #ffffff 8%);border:1px solid color-mix(in srgb, var(--metric-border), #ffffff 20%);overflow:hidden}
  .g-fill-left{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg, rgba(34,197,94,.52), rgba(34,197,94,.30));}
  .g-fill-right{position:absolute;right:0;top:0;bottom:0;background:linear-gradient(90deg, rgba(239,68,68,.30), rgba(239,68,68,.52));}
</style>
</head>
<body>
  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="ticker-wrap">
        <label for="q">Ticker</label>
        <div class="input-wrap">
          <input id="q" class="ticker-input" type="text" placeholder="AAPL, MSFT‚Ä¶ or BTC" spellcheck="false" autocomplete="off"/>
          <div id="ac" class="ac" role="listbox" aria-label="Suggestions"></div>
        </div>
        <button id="searchBtn" class="btn inline" type="button">Search</button>
      </div>
      <div class="toolsbar" id="toolsBar">
        <button class="tool-btn" id="toolGPTs" aria-label="Open GPTs">üß† <span class="tool-txt">GPTs</span></button>
        <button class="tool-btn" id="toolScreeners" aria-label="Open Screeners">üîé <span class="tool-txt">Screeners</span></button>
        <button class="tool-btn" id="wideBtn" aria-label="Toggle Width">‚ÜîÔ∏é <span class="tool-txt">Wide</span></button>
        <button class="tool-btn" id="maxBtn" aria-label="Maximize">‚§¢ <span class="tool-txt">Max</span></button>
        <button class="tool-btn" id="refreshBtn" aria-label="Refresh">‚ü≥ <span class="tool-txt">Refresh</span></button>
        <!-- compact VIX + Buffett mini-cards placed beside the refresh button -->
        <div style="display:flex;gap:8px;align-items:center;margin-left:8px">
          <div class="g-card" id="vixMini" style="min-width:96px;padding:6px">
            <div class="g-head"><div class="g-title">VIX</div><div class="g-metrics" id="vixValueMini">‚Äî</div></div>
            <div class="g-metrics" id="vixRemarkMini" style="font-size:11px;color:var(--muted)">‚Äî</div>
            <svg id="vixSpark" width="88" height="20" style="margin-top:6px;display:block"></svg>
            <div id="vixDeltaBar" style="height:5px;border-radius:5px;background:transparent;margin-top:6px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)"><div id="vixDeltaFill" style="height:100%;width:0%;background:linear-gradient(90deg,var(--c-down),var(--c-up));transition:width .3s"></div></div>
            <div class="g-metrics" id="vixActionMini" style="font-size:11px;font-weight:800;margin-top:6px;color:var(--muted)">‚Äî</div>
          </div>
          <div class="g-card" id="buffettMini" style="min-width:132px;padding:6px">
            <div class="g-head"><div class="g-title">Buffett</div><div class="g-metrics" id="buffettValueMini">‚Äî</div></div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
              <div style="flex:1"><div class="g-metrics" id="buffettRemarkMini" style="font-size:11px;color:var(--muted)">‚Äî</div>
              <div class="buffett-pill" id="buffettPill" aria-hidden="true"></div></div>
              <div style="flex:0"><button id="buffettEditBtn" class="tool-btn" title="Edit Buffett value">‚úé</button></div>
            </div>
          </div>
        </div>
      </div>
      
    </div>
    
    <!-- Inline headline ticker (mock) -->
    <div id="siteTicker" class="site-ticker" aria-live="polite">
      <div class="left">News</div>
      <div class="content" id="siteTickerContent">Loading headlines‚Ä¶</div>
      <div class="controls">
        <button id="sitePause" class="btn" type="button">Pause</button>
        <button id="siteCollapse" class="btn" type="button" aria-expanded="true">Collapse</button>
      </div>
    </div>
    <div id="siteTickerPanel" class="site-ticker-panel" aria-hidden="true" style="display:none;padding:10px 12px;margin-bottom:12px;border-radius:8px;background:color-mix(in srgb,var(--panel),#071018 6%);color:var(--text)"></div>

    <!-- Info bar -->
    <div id="info" class="info">
      <h3 id="headline" style="margin:0 0 4px 0"></h3>
      <div id="subInfo" style="font-size:12px;opacity:.7;margin:0 0 6px"></div>
      <div style="opacity:.9;font-size:14px;line-height:1.6">
        <div id="companyLine" style="margin:0 0 4px 0;opacity:.95"></div>
        <div id="lastLine">Last: ‚Äî ¬∑ Change: ‚Äî</div>
        <div id="prevCloseLine">Yesterday‚Äôs Close: ‚Äî</div>
        <div id="dayRangeLine">Day‚Äôs Range: ‚Äî</div>
        <div id="ivLine">Intrinsic Value: ‚Äî</div>
      </div>
      <img id="infoLogo" class="info-logo" src="/assets/stratus-trader-wide.png" alt="Stratus Trader" />
    </div>

    <script>
      (function(){
        // Mock headline generator that follows the currently selected ticker.
        // It polls the app state for `state.ticker` (if present) or the input #q and updates headlines.
        function nowISO(){ return new Date().toLocaleString(); }

        function makeHeadlinesFor(sym){
          const s = (sym||'TGT').toUpperCase();
          // If we have a known example article for this symbol, prefer direct links (mock)
          const examples = {
            'TGT': [
              { src: 'Reuters', title: `${s}: Target announces elimination of 1,800 corporate roles in restructuring.`, url: 'https://www.reuters.com/business/retail-consumer/target-announces-layoffs-2025-10-25/' },
              { src: 'Company PR', title: `${s} outlines cost actions and Q3 results in press release.`, url: 'https://corporate.target.com/news' },
              { src: 'MarketWatch', title: `Analysts react to ${s} restructuring and update estimates.`, url: 'https://www.marketwatch.com/search?q=Target' }
            ],
            'AAPL': [
              { src: 'Apple Newsroom', title: `${s}: Apple announces product/service update and guidance.`, url: 'https://www.apple.com/newsroom/' },
              { src: 'Reuters', title: `${s} posts quarterly results; services remain a bright spot.`, url: 'https://www.reuters.com/companies/AAPL.O' },
              { src: 'Analyst', title: `Analysts discuss ${s} supply chain and outlook.`, url: 'https://www.cnbc.com/search/?query=Apple' }
            ]
          };

          if (examples[s]) return examples[s].map(h => ({ time: nowISO(), src: h.src, title: h.title, url: h.url }));

          // Fallback: generate headlines and point to a news search for the symbol
          return [
            { time: nowISO(), src: 'Reuters', title: `${s}: Company announces restructuring to reduce costs and improve margins.`, url: `https://www.google.com/search?q=${encodeURIComponent(s + ' news')}&tbm=nws` },
            { time: nowISO(), src: 'Company PR', title: `${s} reports quarterly results; management highlights category strength.`, url: `https://www.google.com/search?q=${encodeURIComponent(s + ' press release')}&tbm=nws` },
            { time: nowISO(), src: 'Analyst', title: `Analysts update ${s} outlook after strategic changes.`, url: `https://www.google.com/search?q=${encodeURIComponent(s + ' analysts raise price target')}&tbm=nws` }
          ];
        }

        const content = document.getElementById('siteTickerContent');
        const pauseBtn = document.getElementById('sitePause');
        const collapseBtn = document.getElementById('siteCollapse');
        const panelEl = document.getElementById('siteTickerPanel');

        let HEADLINES = makeHeadlinesFor('TGT');
        let idx = 0, running = true, timer = null;
        const MODE_KEY = 'siteTickerMode_v1'; // 'compact' or 'expanded'
        let currentSym = null;

        function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
        function render(i){ const h = HEADLINES[i]||{}; content.innerHTML = `<a class="headline" href="${h.url||'#'}" target="_blank" rel="noopener"><span class="meta">${escapeHtml(h.time||'')}${h.src? ' ‚Ä¢ '+escapeHtml(h.src):''}</span> ${escapeHtml(h.title||'')}</a>`; }
        function start(){ if(timer) clearInterval(timer); timer=setInterval(()=>{ idx=(idx+1)%Math.max(1,HEADLINES.length); render(idx); },4500); running=true; pauseBtn.textContent='Pause'; }
        function stop(){ if(timer) clearInterval(timer); timer=null; running=false; pauseBtn.textContent='Play'; }
        pauseBtn.addEventListener('click', ()=> running? stop() : start());

        function applyMode(mode){
          if(mode==='expanded'){
            panelEl.style.display = '';
            const h = HEADLINES[idx]||{};
            panelEl.innerHTML = `<div style="white-space:pre-wrap">${escapeHtml(h.time||'')}${h.src? ' ‚Ä¢ '+escapeHtml(h.src):''}\n\n${escapeHtml(h.title||'')}\n\n(Full article would be fetched from the source.)</div><p style="margin-top:8px"><a href="${h.url||'#'}" target="_blank" rel="noopener" style="color:var(--accent);font-weight:800">Read original</a></p>`;
            collapseBtn.textContent = 'Compact';
            collapseBtn.setAttribute('aria-expanded','true');
            if(running) stop();
          } else {
            panelEl.style.display = 'none';
            collapseBtn.textContent = 'Expand';
            collapseBtn.setAttribute('aria-expanded','false');
            if(!running) start();
          }
          try{ localStorage.setItem(MODE_KEY, mode);}catch(e){}
        }

        // detect current ticker from global state or input
        function getCurrentTicker(){
          try{ if(window.state && window.state.ticker) return window.state.ticker; }catch(e){}
          try{ const v = document.getElementById('q')?.value; if(v) return v.trim().toUpperCase(); }catch(e){}
          try{ const v2 = localStorage.getItem('lastTicker'); if(v2) return v2; }catch(e){}
          return null;
        }

        function pollTicker(){
          const sym = getCurrentTicker() || 'TGT';
          if(sym !== currentSym){
            currentSym = sym;
            HEADLINES = makeHeadlinesFor(currentSym);
            idx = 0; render(idx);
            // if expanded, refresh panel content
            const mode = localStorage.getItem(MODE_KEY) === 'expanded' ? 'expanded' : 'compact';
            applyMode(mode);
          }
        }

        // initialize
        try{ const saved = localStorage.getItem(MODE_KEY); applyMode(saved==='expanded'?'expanded':'compact'); }catch(e){ applyMode('compact'); }
        collapseBtn.addEventListener('click', ()=>{
          const current = (localStorage.getItem(MODE_KEY) === 'expanded') ? 'expanded' : 'compact';
          const next = current === 'expanded' ? 'compact' : 'expanded';
          applyMode(next);
        });

        // poll for ticker changes so headlines follow the chart
        setInterval(pollTicker, 900);
        content.addEventListener('mouseenter', ()=>{ if(running) stop(); });
        content.addEventListener('mouseleave', ()=>{ if(!running) start(); });
        render(0); start();
      })();
    </script>

    <!-- Market Overview (auto-updating) -->
    <div id="mktRow" class="mkt-row" aria-label="Market overview">
      <div class="mkt-card">
        <div class="mkt-head"><span class="mkt-title">DOW</span><span id="mkt-dji-chg" class="mkt-chg">‚Äî</span></div>
        <div id="mkt-dji" class="mkt-chart"></div>
      </div>
      <div class="mkt-card">
        <div class="mkt-head"><span class="mkt-title">NASDAQ</span><span id="mkt-ixic-chg" class="mkt-chg">‚Äî</span></div>
        <div id="mkt-ixic" class="mkt-chart"></div>
      </div>
      <div class="mkt-card">
        <div class="mkt-head"><span class="mkt-title">S&P 500</span><span id="mkt-gspc-chg" class="mkt-chg">‚Äî</span></div>
        <div id="mkt-gspc" class="mkt-chart"></div>
      </div>
    </div>

    <!-- Mini gauges under Market Overview -->
    <div class="mkt-gauges" id="mktGauges">
      <div class="g-card" id="g-advance">
        <div class="g-head"><div class="g-title">Advancing vs Declining</div><div class="g-metrics" id="g-advance-m">‚Äî</div></div>
        <div class="g-bar"><div class="g-fill-left" id="g-advance-l" style="width:0%"></div><div class="g-fill-right" id="g-advance-r" style="width:0%"></div></div>
      </div>
      <div class="g-card" id="g-newhigh">
        <div class="g-head"><div class="g-title">New High vs New Low</div><div class="g-metrics" id="g-newhigh-m">‚Äî</div></div>
        <div class="g-bar"><div class="g-fill-left" id="g-newhigh-l" style="width:0%"></div><div class="g-fill-right" id="g-newhigh-r" style="width:0%"></div></div>
      </div>
      <div class="g-card" id="g-sma50">
        <div class="g-head"><div class="g-title">Above vs Below SMA50</div><div class="g-metrics" id="g-sma50-m">‚Äî</div></div>
        <div class="g-bar"><div class="g-fill-left" id="g-sma50-l" style="width:0%"></div><div class="g-fill-right" id="g-sma50-r" style="width:0%"></div></div>
      </div>
      <div class="g-card" id="g-sma200">
        <div class="g-head"><div class="g-title">Above vs Below SMA200</div><div class="g-metrics" id="g-sma200-m">‚Äî</div></div>
        <div class="g-bar"><div class="g-fill-left" id="g-sma200-l" style="width:0%"></div><div class="g-fill-right" id="g-sma200-r" style="width:0%"></div></div>
      </div>
      <div class="g-card" id="g-sentiment">
        <div class="g-head"><div class="g-title">Intraday Sentiment</div><div class="g-metrics" id="g-sentiment-m">‚Äî</div></div>
        <div class="g-bar"><div class="g-fill-left" id="g-sentiment-l" style="width:0%"></div><div class="g-fill-right" id="g-sentiment-r" style="width:0%"></div></div>
      </div>
    </div>

    <!-- Chart card -->
    <div id="chartCard">
      <!-- Range buttons + inline frequency buttons -->
      <div id="rangeBar" class="range-bar">
        <div class="range-label">Time</div>
        <div class="range-row">
          <button data-range="1d"  type="button">1D</button>
          <button data-range="2d"  type="button">2D</button>
          <button data-range="5d"  type="button">5D</button>
          <button data-range="10d" type="button">10D</button>
          <button data-range="1mo" type="button">1M</button>
          <button data-range="3mo" type="button">3M</button>
          <button data-range="6mo" type="button" class="active">6M</button>
          <button data-range="ytd" type="button">YTD</button>
          <button data-range="1y"  type="button">1Y</button>
          <button data-range="2y"  type="button">2Y</button>
          <button data-range="5y"  type="button">5Y</button>
          <button data-range="10y" type="button">10Y</button>
          <button data-range="max" type="button">MAX</button>
        </div>
        <div class="freq-label">Frequency</div>
        <div class="freq-row" aria-label="Frequency">
          <button data-interval="1m"  type="button">1m</button>
          <button data-interval="5m"  type="button">5m</button>
          <button data-interval="15m" type="button">15m</button>
          <button data-interval="60m" type="button">1h</button>
          <button data-interval="1d"  type="button" class="active">1D</button>
          <button data-interval="1wk" type="button">1W</button>
          <button data-interval="1mo" type="button">1M</button>
        </div>
      </div>

      <div class="toggle-row" id="toggles">
        <button class="chip" data-k="SMA20" type="button" aria-pressed="false">SMA 20</button>
        <button class="chip" data-k="SMA50" type="button" aria-pressed="false">SMA 50</button>
        <button class="chip" data-k="SMA200" type="button" aria-pressed="false">SMA 200</button>
        <button class="chip" data-k="RSI" type="button" aria-pressed="false">RSI</button>
        <button class="chip" data-k="MACD" type="button" aria-pressed="false">MACD</button>
        <button class="chip" data-k="VOL" type="button" aria-pressed="false">Volume</button>
  <button class="chip" data-k="BB" type="button" aria-pressed="false" title="Bollinger Bands">BB</button>
  <button class="chip" data-k="DIV" type="button" aria-pressed="false" title="Show dividend events">Dividends</button>
        <button class="chip" id="autoFib" data-k="AUTOFIB" type="button" aria-pressed="false">Auto Fib</button>
        <button class="chip" data-k="ICHI" type="button" aria-pressed="false">Ichimoku</button>
      </div>

      <!-- Custom SMA controls + dynamic chips -->
      <div class="sma-ctrls" id="smaCtrls">
        <label for="smaPreset" style="font-weight:800;opacity:.9">SMA</label>
        <select id="smaPreset" title="Quick add common SMAs">
          <option value="">Presets‚Ä¶</option>
          <option>10</option>
          <option>20</option>
          <option>30</option>
          <option>50</option>
          <option>100</option>
          <option>150</option>
          <option>200</option>
        </select>
        <input id="smaCustom" type="number" min="2" max="600" step="1" placeholder="Custom" title="Enter any SMA period" />
        <button id="smaAddBtn" class="btn inline" type="button" title="Add SMA period">Add SMA</button>
        <small id="smaHint">Tip: click a chip to toggle; double‚Äëclick to remove custom.</small>
      </div>
      <div class="toggle-row" id="smaCustomChips"></div>

      <div id="chart"></div>
    </div>

    <div class="section-sep" aria-hidden="true"><div class="rule"></div></div>
  </div>

  <!-- GPTs Sheet -->
  <div class="sheet" id="sheetGPTs" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">GPTs</div>
        <button class="sheet-close" data-close="sheetGPTs">‚úï</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" style="margin-bottom:12px">
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">9 Prompts for Smarter Investing</div>
              <div class="desc">Bundle of prompts to guide smarter investment analysis.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-687b911701a08191aadd69c345a67d17-9-prompts-for-smarter-investing" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">Stock Predictor Prompt GPT</div>
              <div class="desc">Structured prompt flow for scenario-led stock predictions.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-686c5fc3dd948191a0ff9c14cecda1b4-stock-predictor-prompt-gpt" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">High Yield Dividend Sniper</div>
              <div class="desc">Quickly target high-yield dividend candidates.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-6878fe277c5c819180211289d9e16148-high-yield-dividend-sniper" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
        </div>
        <div>
          <textarea id="gptInput" rows="4" placeholder="Ask a question about the current ticker‚Ä¶" style="width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button class="btn" id="askGPT">Ask</button>
            <div style="font-size:12px;color:var(--muted)">Uses the visible chart context when possible.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Screeners Sheet -->
  <div class="sheet" id="sheetScreeners" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">Screeners</div>
        <button class="sheet-close" data-close="sheetScreeners">‚úï</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" id="scrList"></div>
      </div>
    </div>
  </div>

  <nav class="btmnav" id="btmNav" role="navigation" aria-label="Bottom Navigation">
    <button data-tab="home" class="tab active" aria-label="Home">üè†<span>Home</span></button>
    <button data-tab="screeners" class="tab" aria-label="Screeners">üîé<span>Screeners</span></button>
    <button data-tab="gpts" class="tab" aria-label="GPTs">üß†<span>GPTs</span></button>
    <button data-tab="settings" class="tab" aria-label="Settings">‚öôÔ∏è<span>Settings</span></button>
  </nav>

  <script>
  (() => {
    const q = s => document.querySelector(s);

    /* ---------- Elements ---------- */
    const els = {
      input:q('#q'), list:q('#ac'), searchBtn:q('#searchBtn'),
      headline:q('#headline'), subInfo:q('#subInfo'), lastLine:q('#lastLine'), prevCloseLine:q('#prevCloseLine'), ivLine:q('#ivLine'), companyLine:q('#companyLine'),
      chartCard:q('#chartCard'), chart:q('#chart'),
      rangeBar:q('#rangeBar'), toggles:q('#toggles'),
      themeToggle:q('#themeToggle'), autoFib:q('#autoFib'),
      refreshBtn:q('#refreshBtn'), maxBtn:q('#maxBtn'), wideBtn:q('#wideBtn'),
      tfCard:q('#tfCard'), tfHead:q('#tfHead'),
      btmNav:q('#btmNav'), scrList:q('#scrList'),
      // Added: tool buttons & sheet / input refs for GPTs & Screeners
      toolGPTs:q('#toolGPTs'), toolScreeners:q('#toolScreeners'),
      gptInput:q('#gptInput'), sheetGPTs:q('#sheetGPTs'), sheetScreeners:q('#sheetScreeners'),
      // Price info extra line
      dayRangeLine:q('#dayRangeLine'),
      // Custom SMA controls
      smaPreset:q('#smaPreset'), smaCustom:q('#smaCustom'), smaAddBtn:q('#smaAddBtn'), smaChips:q('#smaCustomChips')
    };

    /* ---------- Toast ---------- */
    let toast = q('#toast');
    if(!toast){ toast = document.createElement('div'); toast.id='toast'; document.body.appendChild(toast); }
    function showToast(msg, ms=2600){ toast.textContent=msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'), ms); }

    /* ---------- Clean UI preview toggle ---------- */
    try{
      const params = new URLSearchParams(location.search);
      if((params.get('ui')||'').toLowerCase()==='clean'){
        document.body.classList.add('clean-ui');
      }
    }catch{}

    /* ---------- Sheets (GPTs / Screeners) ---------- */
    function openSheet(id){ const el=q('#'+id); if(!el) return; el.hidden=false; el.setAttribute('data-open','true'); document.body.style.overflow='hidden'; if(id==='sheetGPTs' && els.gptInput){ setTimeout(()=>els.gptInput.focus(),50); } }
    function closeSheet(id){ const el=q('#'+id); if(!el) return; el.hidden=true; el.removeAttribute('data-open'); if(![...document.querySelectorAll('.sheet')].some(s=>!s.hidden)) document.body.style.overflow=''; }
    function toggleSheet(id){ const el=q('#'+id); if(!el) return; if(el.hidden) openSheet(id); else closeSheet(id); }

    // Added handlers for Wide / Max / Refresh
    const __container = document.querySelector('.container');
    // Restore persisted wide mode
    if(localStorage.getItem('wideMode')==='1'){ __container?.classList.add('wide'); }
    if(__container?.classList.contains('wide')){ els.wideBtn?.classList.add('active'); els.wideBtn?.setAttribute('aria-pressed','true'); }

    function applyWideToggle(){ if(!__container) return; const on = __container.classList.toggle('wide'); if(on){ localStorage.setItem('wideMode','1'); } else { localStorage.removeItem('wideMode'); } const txt=els.wideBtn?.querySelector('.tool-txt'); if(txt) txt.textContent = on? 'Narrow':'Wide'; els.wideBtn?.setAttribute('aria-pressed', on?'true':'false'); }
    els.wideBtn?.addEventListener('click', ()=>{ applyWideToggle(); setTimeout(()=>{ try{ fitPriceAxisToCandlesStrict(); }catch{} }, 50); });

    function applyMaxToggle(){ const cc=els.chartCard; if(!cc) return; const now = cc.classList.toggle('max'); const txt=els.maxBtn?.querySelector('.tool-txt'); if(txt) txt.textContent = now? 'Restore':'Max'; els.maxBtn?.setAttribute('aria-pressed', now?'true':'false'); document.body.style.overflow = now? 'hidden' : ''; if(now){ setTimeout(()=>{ try{ fitPriceAxisToCandlesStrict(); }catch{} },120); } else { setTimeout(()=>{ try{ fitPriceAxisToCandlesStrict(); }catch{} },60); } }
    els.maxBtn?.addEventListener('click', applyMaxToggle);

  async function manualRefresh(){ els.refreshBtn?.setAttribute('data-busy','1'); try{ await loadAndRender(); // also refresh Buffett and VIX
    try{ await fetchBuffettAuto(); renderBuffett(); }catch{};
    try{ await renderVix(); }catch{};
    showToast('Refreshed'); } catch{ showToast('Refresh failed'); } finally { els.refreshBtn?.removeAttribute('data-busy'); } }
  els.refreshBtn?.addEventListener('click', manualRefresh);

  // Small card clicks: quick interactions
  const vixMiniEl = q('#vixMini'); if(vixMiniEl) vixMiniEl.addEventListener('click', ()=>{ renderVix(); showToast('VIX refreshed'); });
  // replace whole-card click with explicit Edit button to avoid accidental prompts
  const buffEditBtn = q('#buffettEditBtn'); if(buffEditBtn) buffEditBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openBuffettModal(); });

    // Keyboard shortcuts (optional): W=wide, M=max, R=refresh when focused on body & not typing
    document.addEventListener('keydown', e=>{ if(e.target && /INPUT|TEXTAREA|SELECT/.test(e.target.tagName)) return; if(e.metaKey||e.altKey||e.ctrlKey) return; if(e.key==='w'||e.key==='W'){ applyWideToggle(); } else if(e.key==='m'||e.key==='M'){ applyMaxToggle(); } else if(e.key==='r'||e.key==='R'){ manualRefresh(); } });

    // Added: highlightTab + bottom nav wiring (was missing, causing button logic to fail)
    function highlightTab(tab){ if(!els.btmNav) return; els.btmNav.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===tab)); }
    els.btmNav?.addEventListener('click', e=>{ const tab=e.target.closest('.tab'); if(!tab) return; const k=tab.dataset.tab; if(k==='home'){ closeSheet('sheetGPTs'); closeSheet('sheetScreeners'); highlightTab('home'); return; } if(k==='gpts'){ const isOpen = !els.sheetGPTs.hidden; if(isOpen){ closeSheet('sheetGPTs'); highlightTab('home'); } else { openSheet('sheetGPTs'); highlightTab('gpts'); } return; } if(k==='screeners'){ const isOpen = !els.sheetScreeners.hidden; if(isOpen){ closeSheet('sheetScreeners'); highlightTab('home'); } else { ensureScreeners(); openSheet('sheetScreeners'); highlightTab('screeners'); } return; } if(k==='settings'){ showToast('Settings coming soon'); highlightTab('settings'); } });

    document.addEventListener('click', e=>{ const btn=e.target.closest('[data-close]'); if(btn){ closeSheet(btn.getAttribute('data-close')); } });
    // Restored: direct open + tab highlight (no toggle) for consistent UX across devices
    // REPLACED with toggle behavior per request
    els.toolGPTs?.addEventListener('click', ()=>{ const isOpen = !els.sheetGPTs?.hidden; if(isOpen){ closeSheet('sheetGPTs'); highlightTab('home'); } else { openSheet('sheetGPTs'); highlightTab('gpts'); } });
    els.toolScreeners?.addEventListener('click', ()=>{ const isOpen = !els.sheetScreeners?.hidden; if(isOpen){ closeSheet('sheetScreeners'); highlightTab('home'); } else { ensureScreeners(); openSheet('sheetScreeners'); highlightTab('screeners'); } });

    // Escape closes top-most sheet
    document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ const open=[...document.querySelectorAll('.sheet')].filter(s=>!s.hidden).pop(); if(open){ closeSheet(open.id); highlightTab('home'); } } });

    /* ---------- Range / Frequency validity helpers ---------- */
    const INTRADAY_INTERVALS = ['1m','5m','15m','60m'];
    const SHORT_RANGES = ['1d','2d','5d','10d'];
    function isValidCombo(range, interval){
      range = String(range||'').toLowerCase();
      interval = String(interval||'').toLowerCase();
      const intraday = INTRADAY_INTERVALS.includes(interval);
      if(!intraday) return true; // daily/weekly/monthly allowed for all ranges
      return SHORT_RANGES.includes(range); // intraday only supported on short ranges
    }
    function refreshRangeFreqDisabledState(){
      if(!els.rangeBar) return;
      const currentRange = state.range;
      const currentInterval = state.interval;
      els.rangeBar.querySelectorAll('button[data-range]').forEach(btn=>{
        const r = btn.dataset.range;
        const allowed = isValidCombo(r, currentInterval);
        btn.classList.toggle('disabled', !allowed);
      });
      els.rangeBar.querySelectorAll('button[data-interval]').forEach(btn=>{
        const iv = btn.dataset.interval;
        const allowed = isValidCombo(currentRange, iv);
        btn.classList.toggle('disabled', !allowed);
      });
    }

    /* ---------- Screeners Populate (Updated with provided SCREENERS list) ---------- */
    const SCREENERS = [
      { id:"oversold_reversal", label:"Oversold Reversal", level:"Beginner", url:"https://finviz.com/screener.ashx?v=111&f=sh_price_o5,sh_relvol_o2,ta_change_u,ta_rsi_os30&ft=4&o=price", filters:["sh_price_o5","sh_relvol_o2","ta_change_u","ta_rsi_os30"] },
      { id:"new_highs", label:"New Highs (momentum)", level:"Beginner", url:"https://finviz.com/screener.ashx?v=141&f=an_recom_buy,sh_price_u7,ta_change_u,ta_highlow20d_nh,ta_highlow50d_nh,ta_highlow52w_nh,ta_perf_dup&ft=4&o=-perf1w", filters:["an_recom_buy","sh_price_u7","ta_change_u","ta_highlow20d_nh","ta_highlow50d_nh","ta_highlow52w_nh","ta_perf_dup"] },
      { id:"sma_crossover", label:"SMA 50 cross 20 (trend start)", level:"Beginner", url:"https://finviz.com/screener.ashx?v=141&f=fa_pe_profitable,sh_avgvol_o400,sh_relvol_o1,sh_short_low,ta_beta_o1,ta_sma50_cross20b&ft=4", filters:["fa_pe_profitable","sh_avgvol_o400","sh_relvol_o1","sh_short_low","ta_beta_o1","ta_sma50_cross20b"] },
      { id:"low_pe_value", label:"Low P/E Value", level:"Beginner", url:"https://finviz.com/screener.ashx?v=141&f=cap_smallunder,fa_pb_low,fa_pe_low,fa_peg_low,fa_roa_pos,fa_roe_pos,sh_price_o5&ft=4&o=-perfytd", filters:["cap_smallunder","fa_pb_low","fa_pe_low","fa_peg_low","fa_roa_pos","fa_roe_pos","sh_price_o5"] },
      { id:"bounce_ma", label:"Bounce at Moving Average", level:"Beginner", url:"https://finviz.com/screener.ashx?v=141&f=sh_avgvol_o400,sh_curvol_o2000,sh_relvol_o1,ta_sma20_pa,ta_sma50_pb&ft=4&o=-perf1w", filters:["sh_avgvol_o400","sh_curvol_o2000","sh_relvol_o1","ta_sma20_pa","ta_sma50_pb"] },
      { id:"high_rel_vol", label:"High Relative Volume", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=131&f=fa_curratio_o1,fa_epsqoq_o15,fa_quickratio_o1,fa_salesqoq_o15,sh_avgvol_o400,sh_price_o5,sh_relvol_o1.5,ta_sma20_pa,ta_sma200_sb50,ta_sma50_sa200&ft=4&o=instown", filters:["fa_curratio_o1","fa_epsqoq_o15","fa_quickratio_o1","fa_salesqoq_o15","sh_avgvol_o400","sh_price_o5","sh_relvol_o1.5","ta_sma20_pa","ta_sma200_sb50","ta_sma50_sa200"] },
      { id:"potential_uptrend_from_weekly_lows", label:"Potential Uptrend from Weekly Lows", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=141&f=sh_avgvol_o400,ta_pattern_channelup,ta_perf_1wdown&ft=4&o=perf1w", filters:["sh_avgvol_o400","ta_pattern_channelup","ta_perf_1wdown"] },
      { id:"weekly_earnings_gap_up", label:"Weekly Earnings Gap Up", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=141&f=earningsdate_tomorrowafter,sh_avgvol_o400,sh_curvol_o50,sh_short_u25,ta_averagetruerange_o0.5,ta_gap_u2&ft=4&o=-perfytd", filters:["earningsdate_tomorrowafter","sh_avgvol_o400","sh_curvol_o50","sh_short_u25","ta_averagetruerange_o0.5","ta_gap_u2"] },
      { id:"shorted_stocks", label:"Heavily Shorted (U.S.)", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=131&f=cap_smallover,geo_usa,sh_avgvol_o500,sh_curvol_o500,sh_opt_optionshort,sh_price_o3,sh_relvol_o1,sh_short_high&o=-shortinterestshare", filters:["cap_smallover","geo_usa","sh_avgvol_o500","sh_curvol_o500","sh_opt_optionshort","sh_price_o3","sh_relvol_o1","sh_short_high"] },
      { id:"short_squeeze", label:"Short Squeeze Setup", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=131&f=sh_avgvol_o100,sh_instown_u50,sh_price_o2,sh_short_o15&ft=4&o=-shortinterestshare", filters:["sh_avgvol_o100","sh_instown_u50","sh_price_o2","sh_short_o15"] },
      { id:"high_sales_growth", label:"High Sales Growth", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=111&f=fa_debteq_u0.5,fa_roe_o15,fa_sales5years_o20,fa_salesqoq_o20,sh_avgvol_o200,sh_instown_o60,sh_price_o5,sh_short_u5&ft=4", filters:["fa_debteq_u0.5","fa_roe_o15","fa_sales5years_o20","fa_salesqoq_o20","sh_avgvol_o200","sh_instown_o60","sh_price_o5","sh_short_u5"] },
      { id:"buy_hold_value", label:"Buy & Hold Value", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=121&f=cap_microover,fa_curratio_o1.5,fa_estltgrowth_o10,fa_peg_o1,fa_roe_o15,ta_beta_o1.5,ta_sma20_pa&ft=4&o=-forwardpe", filters:["cap_microover","fa_curratio_o1.5","fa_estltgrowth_o10","fa_peg_o1","fa_roe_o15","ta_beta_o1.5","ta_sma20_pa"] },
      { id:"undervalued_div_growth", label:"Undervalued Dividend Growth", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=111&f=cap_largeover,fa_div_pos,fa_epsyoy1_o5,fa_estltgrowth_o5,fa_payoutratio_u50,fa_pe_u20,fa_peg_low&ft=4&o=-pe", filters:["cap_largeover","fa_div_pos","fa_epsyoy1_o5","fa_estltgrowth_o5","fa_payoutratio_u50","fa_pe_u20","fa_peg_low"] },
      { id:"oversold_next_earnings_growth", label:"Oversold + Earnings in 5d + Growth", level:"Advanced", url:"https://finviz.com/screener.ashx?v=141&f=cap_smallover,earningsdate_nextdays5,fa_epsqoq_o15,fa_epsyoy_pos,fa_epsyoy1_pos,fa_grossmargin_o20,fa_netmargin_pos,fa_sales5years_o5,fa_salesqoq_pos,sh_avgvol_o750,sh_curvol_o1000,ta_perf_52w10o,ta_rsi_nob50&ft=4&o=perfytd", filters:["cap_smallover","earningsdate_nextdays5","fa_epsqoq_o15","fa_epsyoy_pos","fa_epsyoy1_pos","fa_grossmargin_o20","fa_netmargin_pos","fa_sales5years_o5","fa_salesqoq_pos","sh_avgvol_o750","sh_curvol_o1000","ta_perf_52w10o","ta_rsi_nob50"] },
      { id:"breaking_out_quality", label:"Breaking Out (Quality balance sheet)", level:"Advanced", url:"https://finviz.com/screener.ashx?v=141&f=fa_debteq_u1,fa_roe_o20,sh_avgvol_o100,ta_highlow50d_nh,ta_sma20_pa,ta_sma200_pa,ta_sma50_pa&ft=4&o=-perf1w", filters:["fa_debteq_u1","fa_roe_o20","sh_avgvol_o100","ta_highlow50d_nh","ta_sma20_pa","ta_sma200_pa","ta_sma50_pa"] },
      { id:"high_earnings_growth", label:"High Earnings Growth", level:"Advanced", url:"https://finviz.com/screener.ashx?v=141&f=fa_epsqoq_o25,fa_epsyoy_o25,fa_epsyoy1_o25,fa_salesqoq_o25,sh_avgvol_o400,ta_rsi_nos50,ta_sma200_pa&ft=4&o=-perfytd", filters:["fa_epsqoq_o25","fa_epsyoy_o25","fa_epsyoy1_o25","fa_salesqoq_o25","sh_avgvol_o400","ta_rsi_nos50","ta_sma200_pa"] },
      { id:"consistent_growth_bullish", label:"Consistent Growth on Bullish Trend", level:"Advanced", url:"https://finviz.com/screener.ashx?v=141&f=fa_eps5years_pos,fa_epsqoq_o20,fa_epsyoy_o25,fa_epsyoy1_o15,fa_estltgrowth_pos,fa_roe_o15,sh_instown_o10,sh_price_o15,ta_highlow52w_a90h,ta_rsi_nos50&ft=4&o=-perfytd", filters:["fa_eps5years_pos","fa_epsqoq_o20","fa_epsyoy_o25","fa_epsyoy1_o15","fa_estltgrowth_pos","fa_roe_o15","sh_instown_o10","sh_price_o15","ta_highlow52w_a90h","ta_rsi_nos50"] },
      { id:"canslim", label:"CANSLIM", level:"Advanced", url:"https://finviz.com/screener.ashx?v=111&f=fa_eps5years_o20,fa_epsqoq_o20,fa_epsyoy_o20,fa_sales5years_o20,fa_salesqoq_o20,sh_curvol_o200&ft=4", filters:["fa_eps5years_o20","fa_epsqoq_o20","fa_epsyoy_o20","fa_sales5years_o20","fa_salesqoq_o20","sh_curvol_o200"] }
    ];
    const levelRank = { Beginner:0, Intermediate:1, Advanced:2 };
    function ensureScreeners(){
      if(!els.scrList) return;
      if(els.scrList.dataset.filled) return;
      const ordered=[...SCREENERS].sort((a,b)=> levelRank[a.level]-levelRank[b.level]);
      els.scrList.innerHTML = ordered.map(s=>`<div class="scr-item" data-lvl="${s.level}" data-id="${s.id}">
        <div style=\"flex:1;min-width:0\">
          <div class=\"title\">${s.label}</div>
          <div class=\"desc\" style=\"font-size:11px;opacity:.75\">${(s.filters||[]).join(' ‚Ä¢ ')}</div>
        </div>
        <div style=\"display:flex;align-items:center;gap:8px\">
          <span class=\"badge\">${s.level}</span>
          <a class=\"open-btn\" href=\"${s.url}\" target=\"_blank\" rel=\"noopener\">Open</a>
        </div>
      </div>`).join('');
      els.scrList.dataset.filled='1';
    }

    /* ---------- Existing code continues below (chart, autocomplete, etc.) ---------- */
    /* ---------- State ---------- */
    let CURRENT = { ticker:null, company:"", prevClose:null };
    const FIRST_LOAD_KEY = 'chartFirstLoad_6m1d_v1';
    const hasSeenInitial = (()=>{ try{return localStorage.getItem(FIRST_LOAD_KEY)==='1';}catch{return true;} })();
    const defaultRange = hasSeenInitial ? (document.querySelector('#rangeBar button[data-range].active')?.dataset.range)||'6mo' : '6mo';
    const defaultInterval = hasSeenInitial ? (document.querySelector('#rangeBar button[data-interval].active')?.dataset.interval)||'15m' : '1d';
    const state = { ticker: localStorage.getItem('lastTicker')||'AAPL', range:defaultRange, interval:defaultInterval, rows:[], candleTight:+(localStorage.getItem('candleTight')||75), symbols:[], acMatches:[], acIndex:-1, quoteTimer:null, symbolsTried:0,
      divs:[],
      customSMAs: (()=>{ try{ const a=JSON.parse(sessionStorage.getItem('customSMAs')||'[]'); return Array.isArray(a)? a.filter(n=>Number.isFinite(+n)).slice(0,12) : []; }catch{return [];} })()
    };
    const FUNDAMENTALS = {}; // cache fundamentals per ticker

    /* ---------- Utils & Formatters ---------- */
    const css = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    const fmt = v => (Number.isFinite(+v)? (+v).toFixed(2):'‚Äî'); // added simple formatter
    const fmtPx = v => Number.isFinite(+v) ? `$${(+v).toFixed(2)}` : '‚Äî';
    const fmtPct = v => Number.isFinite(+v) ? `${(+v).toFixed(2)}%` : '‚Äî';
    const clampZero = (v,eps=1e-10)=> (Number.isFinite(v)&&Math.abs(v)<eps?0:v);
    const median = (arr)=>{ const a=(arr||[]).map(Number).filter(Number.isFinite).sort((x,y)=>x-y); if(!a.length) return NaN; const m=Math.floor(a.length/2); return a.length%2? a[m] : (a[m-1]+a[m])/2; };
    const $all = (sel, root=document)=> Array.from(root.querySelectorAll(sel));
    const sanitizeTicker = s => String(s||'').split('|')[0].trim().toUpperCase();
    const normalizeTickerForFetch = t => sanitizeTicker(t).replace(/\s+/g,'').replace(/\.([A-Z0-9]{1,3})$/,'-$1'); // BRK.B -> BRK-B, etc.
    // Restrict -USD behavior to known crypto bases only
    const CRYPTO_BASE = new Set(['BTC','ETH','SOL','DOGE','XRP','ADA','LTC','BCH','BNB','SHIB']);
    function isCryptoBase(sym){ return CRYPTO_BASE.has(sym); }
    function hideAC(){ if(els.list){ els.list.classList.remove('show'); els.list.innerHTML=''; } state.acMatches=[]; state.acIndex=-1; }
    function renderAC(){ if(!els.list) return; const items=state.acMatches||[]; if(!items.length){ els.list.innerHTML=''; els.list.classList.remove('show'); return; } const html=items.slice(0,60).map((o,i)=>`<div class="ac-item${i===state.acIndex?' active':''}" role="option" data-t="${o.t}"><span class="ticker">${o.t}</span><span class="company">${o.n||''}</span></div>`).join(''); els.list.innerHTML=html; els.list.classList.add('show'); }
    function updateAC(qstr){ const s=sanitizeTicker(qstr); if(!s){ hideAC(); return; } // lazy retry symbols load if empty
      if(!state.symbols.length && state.symbolsTried>0){ loadSymbols(true); }
      const sym=state.symbols||[]; if(!sym.length){ // show loading placeholder
        els.list.innerHTML='<div style="padding:10px;font-size:12px;opacity:.65">Loading symbols‚Ä¶</div>'; els.list.classList.add('show'); return; }
      // Normalized matching: treat '.' and '-' as equivalent (BRK.B ~ BRK-B). Only allow BTC->BTC-USD for crypto bases.
      const sN = s.replace(/\./g,'-');
      const base = sN.replace(/-USD$/,'');
      const allowUSDAlt = isCryptoBase(base);
      const sAlt = allowUSDAlt ? (/-USD$/.test(sN) ? base : (base+'-USD')) : sN; // only meaningful if crypto
      const escape = v=> v.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&');
      const re = new RegExp('^'+escape(sN));
      const reAlt = allowUSDAlt ? new RegExp('^'+escape(sAlt)) : null;
      const starts = r=>{
        const t=r.t||''; const tD=t.replace(/-/g,'.'); const tN=t.replace(/\./g,'-');
        return re.test(t) || re.test(tN) || re.test(tD) || (reAlt ? (reAlt.test(t)||reAlt.test(tN)) : false);
      };
      const contains = r=>{
        const t=r.t||''; const tD=t.replace(/-/g,'.'); const tN=t.replace(/\./g,'-');
        const sn=sN.toUpperCase(); return t.includes(s)||tN.includes(sn)||tD.includes(s);
      };
      const nameHits = r=> ((r.n||'').toUpperCase().includes(s)) || ((r.n||'').toUpperCase().includes(sN));
      const pri = sym.filter(starts);
      const sec = sym.filter(r=> !pri.includes(r) && (contains(r)));
      const name = sym.filter(r=> !pri.includes(r) && !sec.includes(r) && nameHits(r));
      const matches=[...pri,...sec,...name];
      // Only add a virtual -USD suggestion for known crypto bases
      if(allowUSDAlt && !matches.some(m=>m.t===sAlt)){
        matches.unshift({t:sAlt, n:'Crypto vs USD'});
      }
      if(!matches.length){ els.list.innerHTML='<div style="padding:10px;font-size:12px;opacity:.65">No matches</div>'; els.list.classList.add('show'); state.acMatches=[]; state.acIndex=-1; return; }
      state.acMatches=matches; state.acIndex=0; renderAC(); }
    function pickAC(i){ if(!state.acMatches?.length) return; const it=state.acMatches[i]; if(!it) return; els.input.value=it.t; hideAC(); }

    // Close autocomplete when clicking outside
    document.addEventListener('click', e=>{ if(!els.list) return; if(e.target===els.input || e.target.closest('#ac')) return; hideAC(); });

    // ET helpers
    const dtfET = new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York',hour12:false,hour:'2-digit',minute:'2-digit',weekday:'short'});
    function isRegularSessionET(ms){ const parts=dtfET.formatToParts(new Date(ms)); const get=(t)=> parts.find(p=>p.type===t)?.value; const wd=(parts.find(p=>p.type==='weekday')?.value)||''; if(/Sat|Sun/i.test(wd)) return false; const h=+(get('hour')||'0'); const m=+(get('minute')||'0'); const hm=h+m/60; return hm>=9.5 && hm<=16.0; }
  // Intraday means explicit minute/hour intervals like '1m','5m','15m','60m','1h'.
  // Do NOT treat '1mo'/'3mo' as intraday. Previous /m|h/ regex incorrectly matched '3mo'.
  const isIntraday = (interval)=> /^(\d{1,2}m|\d{1,2}h)$/i.test(String(interval||''));
    const padScaleFromTight = (t)=>{ t = Math.max(0, Math.min(100, +t||0)); return 1.6 - (t/100)*1.2; };

    // Convert a Yahoo-style range (e.g., '10y','5y','3mo','1y','max','ytd') to a [t0, t1] time window in ms.
    function rangeToWindow(range, lastMs){
      const now = Number.isFinite(lastMs) ? lastMs : Date.now();
      const s = String(range||'').toLowerCase();
      if(s==='max') return [NaN, now];
      if(s==='ytd'){
        const d = new Date(now); const y = d.getUTCFullYear(); const jan1 = Date.UTC(y,0,1); return [jan1, now];
      }
      const m = s.match(/^(\d+)(d|mo|y)$/);
      if(!m) return [NaN, now];
      const n = +m[1]; const u = m[2];
      const ms = u==='d' ? n*24*3600*1000 : u==='mo' ? n*30*24*3600*1000 : u==='y' ? n*365*24*3600*1000 : 0;
      return [now - ms, now];
    }

    // Helper: rows currently displayed (respect intraday pre/post chip)
    function getDisplayRows(){
      const rows = state.rows||[];
      const includeAH = q('.chip[data-k="SESS"]')?.classList.contains('active');
      return (isIntraday(state.interval) && !includeAH) ? rows.filter(r=>isRegularSessionET(r.t)) : rows;
    }

    // CSV symbols for autocomplete (robust with fallbacks + retry)
    async function loadSymbols(force){
      if(state.symbols.length && !force) return state.symbols;
      state.symbolsTried++;
      const paths = ['stock_data.csv','/stock_data.csv','/public/stock_data.csv'];
      let text = '';
      for(const p of paths){
        try{ const r = await fetch(p,{cache:'no-store'}); if(r.ok){ text = await r.text(); if(text) break; } }catch{/* try next */}
      }
      if(!text){ if(force && state.symbolsTried<4) setTimeout(()=>loadSymbols(true), 800); return state.symbols; }
      try{
        const lines = text.split(/\r?\n/).filter(Boolean);
        const out = []; let start=0; if(/^[\s]*symbol\s*(\||,)/i.test(lines[0]||'')) start=1;
        for(let i=start;i<lines.length;i++){
          const line = lines[i]; const d = line.includes('|') ? '|' : ','; const parts=line.split(d);
          const sym=(parts[0]||'').trim().toUpperCase(); if(!sym) continue; const name=parts.slice(1).join(' ').replace(/\s*\|\s*/g,' ').trim();
          out.push({ t:sym, n:name });
        }
        // Ensure common cryptos and BBBY are present even if CSV lacks them
        const ensure=(t,n)=>{ if(!out.some(x=>x.t===t)) out.unshift({t,n}); };
        ensure('BTC-USD','Bitcoin (USD)');
        ensure('ETH-USD','Ethereum (USD)');
        ensure('SOL-USD','Solana (USD)');
        ensure('DOGE-USD','Dogecoin (USD)');
        ensure('XRP-USD','XRP (USD)');
        ensure('ADA-USD','Cardano (USD)');
        ensure('LTC-USD','Litecoin (USD)');
        ensure('BCH-USD','Bitcoin Cash (USD)');
        ensure('BNB-USD','Binance Coin (USD)');
        ensure('SHIB-USD','Shiba Inu (USD)');
        ensure('BBBY','Bed Bath & Beyond (delisted)');
        state.symbols = out;
      }catch{ state.symbols=[]; }
      if(els.input && els.input.value) updateAC(els.input.value);
      return state.symbols;
    }

    /* ---------- Indicators ---------- */
    const sma = (arr,p)=>{ if(!Array.isArray(arr)||!arr.length||!p) return []; const out=Array(arr.length).fill(null); let sum=0; for(let i=0;i<arr.length;i++){ const v=+arr[i]; if(Number.isFinite(v)) sum+=v; if(i>=p){ const w=+arr[i-p]; if(Number.isFinite(w)) sum-=w; } if(i>=p-1) out[i]=sum/p; } return out; };
    const ema = (arr,p)=>{ const out=Array(arr.length).fill(null); const k=2/(p+1); let prev=null; for(let i=0;i<arr.length;i++){ const v=+arr[i]; if(!Number.isFinite(v)) { out[i]=prev; continue; } prev = prev==null? v : (v - prev)*k + prev; out[i]=prev; } return out; };
    const fillForward = (arr)=>{ let last=null; return arr.map(v=>{ if(Number.isFinite(v)){ last=v; return v; } return Number.isFinite(last)? last : null; }); };
    const fillBackward = (arr)=>{ const out=arr.slice(); const fi=out.findIndex(Number.isFinite); if(fi>0){ const v=out[fi]; for(let i=0;i<fi;i++) out[i]=v; } return out; };
    const mapByTs = (rows, values)=>{ const m=new Map(); for(let i=0;i<rows.length;i++){ const t=rows[i]?.t; const v=values[i]; if(Number.isFinite(v)) m.set(t, v); } return m; };
    const uniqSortedNums = arr=> Array.from(new Set((arr||[]).map(n=>+n).filter(n=>Number.isFinite(n)))).sort((a,b)=>a-b);
    // Palette for custom SMAs (cycled). Chosen to be distinct and readable in dark UI.
    const CUSTOM_SMA_PALETTE = ['#f97316','#a78bfa','#06b6d4','#f472b6','#84cc16','#14b8a6','#e879f9','#22d3ee','#fb7185'];

    // Custom SMA chips rendering and interactions
    function persistCustomSMAs(){ try{ sessionStorage.setItem('customSMAs', JSON.stringify(state.customSMAs||[])); }catch{} }
    function renderCustomSMAChips(){
      if(!els.smaChips) return;
      const list = uniqSortedNums(state.customSMAs||[]);
      // Rebuild mapping each render so colors are distinct and ordered by period
      state.customSMAColors = {};
      list.forEach((p,i)=>{ state.customSMAColors[p] = CUSTOM_SMA_PALETTE[i % CUSTOM_SMA_PALETTE.length]; });
      els.smaChips.innerHTML = list.map(p=>{
        const col = state.customSMAColors[p] || CUSTOM_SMA_PALETTE[0];
        return `<button class="chip" data-k="SMA${p}" data-period="${p}" type="button" aria-pressed="true" title="Toggle SMA ${p}" style="border-color:${col};color:${col}">SMA ${p}</button>`;
      }).join('');
    }
    function addCustomSMA(p){ p=+p; if(!Number.isFinite(p)||p<2||p>600) return showToast('Enter 2..600'); state.customSMAs = uniqSortedNums([...(state.customSMAs||[]), p]); persistCustomSMAs(); renderCustomSMAChips(); buildSMAAlignedSeries(/* include custom in alignment */); renderChart(); }
    function removeCustomSMA(p){ p=+p; state.customSMAs = (state.customSMAs||[]).filter(x=>+x!==p); persistCustomSMAs(); renderCustomSMAChips(); renderChart(); }

    // Build SMA series aligned to state.rows; when < period, back/forward fill; when missing, try extended pull
      async function buildSMAAlignedSeries(){
      const rows = state.rows||[]; state.smaSeries = state.smaSeries || {}; state.smaLast = state.smaLast || {}; if(!rows.length){ state.smaSeries={}; state.smaLast={}; return; }
      const closes = rows.map(r=>r.c);
      const periods = uniqSortedNums([20,50,200, ...((state.customSMAs||[]))]).slice(0, 24);

      // Choose a generous daily range to compute long SMAs when the visible interval is coarse.
      const pickRange=(interval,p)=>{
        switch(String(interval)){
          case '1m': return '5d';
          case '5m': return '1mo';
          case '15m': return '3mo';
          case '60m': return '6mo';
          case '1wk': return '10y';
          case '1mo': return 'max';
          case '3mo': return 'max';
          case '1y': return 'max';
          default: return p>=200? '10y':'3y'; // prefer 10y for very long SMAs so we have enough daily points
        }
      };

      // When aligning an SMA computed from extended (daily) data to the current rows (which may be monthly/quarterly),
      // match each row to the most recent prior SMA value (nearest earlier timestamp). This avoids exact-timestamp mismatches.
      async function alignFromExtended(p){
        const extR = pickRange(state.interval, p);
        try{
          // Always fetch daily series for SMA calculation to ensure enough granularity
          const ext = await fetchRows(state.ticker, extR, '1d');
          if(!Array.isArray(ext) || !ext.length) return null;
          const yExt = sma(ext.map(r=>r.c), p);
          // Build an array of {t, val} for quick nearest-previous lookup
          const extPairs = ext.map((r,i)=>({ t: r.t, v: Number.isFinite(yExt[i])? yExt[i] : null }));
          // For each target row, find the nearest extPairs entry with t <= row.t and use its SMA value
          const aligned = rows.map(r=>{
            // binary search in extPairs by timestamp
            let lo = 0, hi = extPairs.length - 1, found = -1;
            while(lo <= hi){ const mid = (lo+hi)>>1; if(extPairs[mid].t <= r.t){ found = mid; lo = mid + 1; } else { hi = mid - 1; } }
            return (found>=0)? extPairs[found].v : null;
          });
          return fillBackward(fillForward(aligned));
        }catch(e){ return null; }
      }

      for(const p of periods){
        let y = sma(closes, p);
        if(y.some(Number.isFinite)){
          y = fillBackward(fillForward(y));
        } else {
          const extAligned = await alignFromExtended(p);
          y = extAligned || Array(rows.length).fill(closes.filter(Number.isFinite).at(-1) ?? null);
        }
        state.smaSeries[p]=y; const last = y.filter(Number.isFinite).at(-1); if(Number.isFinite(last)) state.smaLast[p]=last;
      }
    }

    /* ---------- Price axis fit (uses slider) ---------- */
    async function fitPriceAxisToCandlesStrict(){
      if (!els.chart) return;
      const d = els.chart.data || []; const c = d.find(t => t && t.type === 'candlestick'); if (!c || !c.x?.length) return;
      const toMs = v=> new Date(v).getTime(); const L=els.chart._fullLayout||els.chart.layout||{}; const xa=L.xaxis||{};
      let x0ms, x1ms; if(Array.isArray(xa.range) && xa.autorange===false){ x0ms=toMs(xa.range[0]); x1ms=toMs(xa.range[1]); } else { x0ms=toMs(c.x[0]); x1ms=toMs(c.x[c.x.length-1]); }
      const cxms=c.x.map(toMs); let i0=0; while(i0<cxms.length && cxms[i0]<x0ms) i0++; let i1=cxms.length-1; while(i1>i0 && cxms[i1]>x1ms) i1--; if(i1<=i0) return;
      let hi=-Infinity, lo=Infinity; for(let i=i0;i<=i1;i++){ const h=c.high[i], l=c.low[i]; if(Number.isFinite(h)) hi=Math.max(hi,h); if(Number.isFinite(l)) lo=Math.min(lo,l); }
      if(!Number.isFinite(hi)||!Number.isFinite(lo)) return; if(hi===lo){ hi+=1; lo-=1; }
      const basePad = Math.max((hi-lo)*0.08, 0.01); const pad = basePad * padScaleFromTight(state.candleTight);
      try{ await Plotly.relayout(els.chart, { 'yaxis.autorange':false, 'yaxis.range':[lo-pad, hi+pad] }); }catch{}
    }

    // Candle height slider removed by request (retain default padding logic)

    /* ---------- Chart bits ---------- */
    function candleTrace(rows){ return { type:'candlestick', x: rows.map(r=>new Date(r.t)), open: rows.map(r=>r.o), high: rows.map(r=>r.h), low: rows.map(r=>r.l), close: rows.map(r=>r.c), name: state.ticker, yaxis:'y', increasing:{ line:{ color: css('--c-up')||'#16a34a', width:2.4 } }, decreasing:{ line:{ color: css('--c-down')||'#dc2626', width:2.4 } }, showlegend:false, hovertemplate:'Date: %{x|%Y-%m-%d %H:%M}<br>O: %{open:.2f}<br>H: %{high:.2f}<br>L: %{low:.2f}<br>C: %{close:.2f}<extra></extra>' }; }
    function volTrace(rows){ const x=rows.map(r=>new Date(r.t)); const y=rows.map(r=>r.v||0); const cols=rows.map(r=> (r.c>=r.o)? 'rgba(34,197,94,0.5)':'rgba(239,68,68,0.5)'); return { type:'bar', x, y, name:'Volume', marker:{ color: cols }, yaxis:'y2', opacity:0.45, hoverinfo:'skip' }; }
    function rsiArr(rows, period=14){ const c=rows.map(r=>r.c); const gains=[], losses=[]; for(let i=1;i<c.length;i++){ const d=c[i]-c[i-1]; gains.push(Math.max(0,d)); losses.push(Math.max(0,-d)); } const avgG=ema(gains,period); const avgL=ema(losses,period); const rsi=Array(c.length).fill(null); for(let i=1;i<c.length;i++){ const gi=avgG[i-1], li=avgL[i-1]; if(Number.isFinite(gi)&&Number.isFinite(li)){ const rs = li===0? 100 : gi/li; rsi[i]=100-(100/(1+rs)); } } return rsi; }
    function rsiTrace(rows){ return { type:'scatter', mode:'lines', x:rows.map(r=>new Date(r.t)), y:rsiArr(rows), name:'RSI', line:{ color: css('--c-rsi')||'#a78bfa', width:1.6 }, yaxis:'y3', hoverinfo:'skip' }; }
    function macdTraces(rows){ const c=rows.map(r=>r.c); const e12=ema(c,12), e26=ema(c,26); const macd=e12.map((v,i)=> (Number.isFinite(v)&&Number.isFinite(e26[i]))? v-e26[i] : null); const signal=ema(macd,9); const hist=macd.map((v,i)=> (Number.isFinite(v)&&Number.isFinite(signal[i]))? v-signal[i]: null); const x=rows.map(r=>new Date(r.t)); const cols=hist.map(v=> v==null? 'rgba(0,0,0,0)' : (v>=0? 'rgba(34,197,94,0.35)':'rgba(239,68,68,0.35)')); return [ { type:'scatter', mode:'lines', x, y:macd, name:'MACD', line:{ color: css('--c-macd')||'#38bdf8', width:1.6 }, yaxis:'y4', hoverinfo:'skip' }, { type:'scatter', mode:'lines', x, y:signal, name:'Signal', line:{ color:'#f59e0b', width:1.2, dash:'dot' }, yaxis:'y4', hoverinfo:'skip' }, { type:'bar', x, y:hist, name:'Histogram', marker:{ color: cols }, yaxis:'y4', hoverinfo:'skip' } ]; }
    // Bollinger Bands: rolling std + SMA band (defaults: 20 period, 2 std)
    function rollingStd(arr,p){
      const out = Array(arr.length).fill(null);
      if(!p || !arr.length) return out;
      for(let i=0;i<arr.length;i++){
        if(i < p-1) { out[i]=null; continue; }
        let sum=0, sum2=0, cnt=0;
        for(let j=i-p+1;j<=i;j++){
          const v=+arr[j];
          if(!Number.isFinite(v)) continue;
          sum += v; sum2 += v*v; cnt++;
        }
        if(!cnt){ out[i]=null; continue; }
        const mean = sum/cnt;
        const variance = Math.max(0, (sum2/cnt) - (mean*mean));
        out[i] = Math.sqrt(variance);
      }
      return out;
    }
    function bollingerTraces(rows, period=20, mult=2){
      const closes = rows.map(r=>r.c);
      const ma = sma(closes, period);
      const sd = rollingStd(closes, period);
      const upper = ma.map((v,i)=> Number.isFinite(v) && Number.isFinite(sd[i]) ? v + mult*sd[i] : null);
      const lower = ma.map((v,i)=> Number.isFinite(v) && Number.isFinite(sd[i]) ? v - mult*sd[i] : null);
      const x = rows.map(r=>new Date(r.t));
      // fill area between upper (first) and lower (second with tonexty)
      const col = css('--c-bb') || '#7c3aed';
      const fillColor = 'rgba(124,58,237,0.10)';
      const upTrace = { type:'scatter', mode:'lines', x, y:fillForward(fillBackward(upper)), name:'BB Upper', line:{ color: col, width:1 }, hoverinfo:'skip', showlegend:false, yaxis:'y' };
      const lowTrace = { type:'scatter', mode:'lines', x, y:fillForward(fillBackward(lower)), name:'BB Lower', line:{ color: col, width:1 }, fill:'tonexty', fillcolor:fillColor, hoverinfo:'skip', showlegend:false, yaxis:'y' };
      const midTrace = { type:'scatter', mode:'lines', x, y:fillForward(fillBackward(ma)), name:`BB ${period}`, line:{ color: '#6d28d9', width:1.4, dash:'dash' }, hoverinfo:'skip', yaxis:'y' };
      return [upTrace, lowTrace, midTrace];
    }
    function ichiTraces(rows){
      const high=rows.map(r=>r.h), low=rows.map(r=>r.l), close=rows.map(r=>r.c), x=rows.map(r=>new Date(r.t));
      const rollingMid=(h,l,p)=>{ const out=Array(h.length).fill(null); for(let i=0;i<h.length;i++){ const s=Math.max(0,i-p+1); let hi=-Infinity, lo=Infinity; for(let j=s;j<=i;j++){ if(Number.isFinite(h[j])) hi=Math.max(hi,h[j]); if(Number.isFinite(l[j])) lo=Math.min(lo,l[j]); } if(hi>-Infinity&&lo<Infinity) out[i]=(hi+lo)/2; } return out; };
      const tenkan=rollingMid(high,low,9), kijun=rollingMid(high,low,26), spanB=rollingMid(high,low,52);
      const spanA=tenkan.map((v,i)=> (Number.isFinite(v)&&Number.isFinite(kijun[i]))? (v+kijun[i])/2 : null);
      const shift=26; const step = x.length>1? (x[1]-x[0]) : 24*3600*1000;
      const xExt = x.concat(Array.from({length:shift}, (_,k)=> new Date(x[x.length-1].getTime()+(k+1)*step)));
      const proj=(arr)=>{ const out=Array(xExt.length).fill(null); for(let i=0;i<arr.length;i++){ const v=arr[i]; if(Number.isFinite(v)) out[i+shift]=v; } return out; };
      const a=proj(spanA), b=proj(spanB);
      // Segmented clouds
      const upTop=Array(xExt.length).fill(null), upBot=Array(xExt.length).fill(null);
      const dnTop=Array(xExt.length).fill(null), dnBot=Array(xExt.length).fill(null);
      for(let i=0;i<xExt.length;i++){
        const A=a[i], B=b[i];
        if(Number.isFinite(A)&&Number.isFinite(B)){
          if(A>=B){ upTop[i]=A; upBot[i]=B; }
          else { dnTop[i]=B; dnBot[i]=A; }
        }
      }
      const cloudUpTop={type:'scatter',mode:'lines',x:xExt,y:upTop,line:{width:0},showlegend:false,hoverinfo:'skip'};
      const cloudUpFill={type:'scatter',mode:'lines',x:xExt,y:upBot,line:{width:0},fill:'tonexty',fillcolor:css('--c-ichi-up')||'rgba(34,197,94,.45)',showlegend:false,hoverinfo:'skip'};
      const cloudDnTop={type:'scatter',mode:'lines',x:xExt,y:dnTop,line:{width:0},showlegend:false,hoverinfo:'skip'};
      const cloudDnFill={type:'scatter',mode:'lines',x:xExt,y:dnBot,line:{width:0},fill:'tonexty',fillcolor:css('--c-ichi-down')||'rgba(239,68,68,.40)',showlegend:false,hoverinfo:'skip'};
      // Span lines for visual edges
      const spanALine={type:'scatter',mode:'lines',x:xExt,y:a,name:'Span A',line:{color:css('--c-ichi-spanA')||'#22c55e',width:1.2,dash:'dot'},hoverinfo:'skip',showlegend:false};
      const spanBLine={type:'scatter',mode:'lines',x:xExt,y:b,name:'Span B',line:{color:css('--c-ichi-spanB')||'#ef4444',width:1.2,dash:'dot'},hoverinfo:'skip',showlegend:false};
      const ten={type:'scatter',mode:'lines',x,y:tenkan,name:'Tenkan',line:{color:css('--c-ichi-tenkan')||'#f59e0b',width:1.6},hoverinfo:'skip'};
      const kij={type:'scatter',mode:'lines',x,y:kijun,name:'Kijun',line:{color:css('--c-ichi-kijun')||'#60a5fa',width:1.8},hoverinfo:'skip'};
      const chikou=Array(x.length).fill(null); for(let i=0;i<close.length;i++){ const ii=i-shift; if(ii>=0) chikou[ii]=close[i]; }
      const chi={type:'scatter',mode:'lines',x,y:chikou,name:'Chikou',line:{color:css('--c-ichi-chikou')||'#93c5fd',width:1.4,dash:'dot'},hoverinfo:'skip'};
      return [cloudUpTop,cloudUpFill,cloudDnTop,cloudDnFill,spanALine,spanBLine,ten,kij,chi];
    }

    // Build Plotly layout and traces
    function buildLayout(base){
      return Object.assign({}, base, {
        hovermode:'x unified',
        hoverlabel:{
          bgcolor: css('--panel')||'#0b1220',
          bordercolor: css('--border')||'#2b3548',
          font:{ color: css('--text')||'#e5e7eb', size:12 }
        },
        uirevision:`${state.ticker}|${state.range}|${state.interval}`
      });
    }

    // --- Auto Fib helpers ---
   
    const FIB_PCTS=[0,0.236,0.382,0.5,0.618,0.786,1];
    function getVisibleRangeMs(){
      if(!els.chart) return [NaN,NaN];
      const L=els.chart._fullLayout||els.chart.layout||{}; const xa=L.xaxis||{};
      const toMs=v=> new Date(v).getTime();
      if(Array.isArray(xa.range) && xa.autorange === false){ return [toMs(xa.range[0]), toMs(xa.range[1])]; }
      const rows=getDisplayRows(); if(!rows.length) return [NaN,NaN];
      return [rows[0].t, rows[rows.length-1].t];
    }
    function computeHiLoInRange(rows,x0,x1){
      let hi=-Infinity, lo=Infinity, hiIdx=-1, loIdx=-1;
      for(let i=0;i<rows.length;i++){
        const r=rows[i]; const t=r.t; if(t<x0||t>x1) continue; const H=r.h, L=r.l;
        if(Number.isFinite(H) && H>hi){ hi=H; hiIdx=i; }
        if(Number.isFinite(L) && L<lo){ lo=L; loIdx=i; }
      }
      if(!(hi<Infinity && lo>-Infinity) || hi===lo) return null;
      const dir = (hiIdx>loIdx)? 'up' : 'down';
      const span = hi-lo;
      const levels = FIB_PCTS.map(p=> hi - span*p);
      return {hi,lo,dir,levels};
    }
    function makeFibTraces(x0,x1,levels){
      const x=[new Date(x0), new Date(x1)];
      const color=css('--c-fib')||'#f59e0b';
      return levels.map((lv,i)=>{ const pct=Math.round(FIB_PCTS[i]*1000)/10; const label=`${(+lv).toFixed(2)} (${pct}%)`; return ({
        type:'scatter', mode:'lines+text', x, y:[lv,lv], name:`Fib ${pct}%`,
        line:{ color, width:1, dash:'dot' }, yaxis:'y', hoverinfo:'skip', showlegend:false,
        text:[label,label], textposition:['middle left','middle right'], textfont:{color:color, size:10},
        meta:{kind:'AUTOFIB', pct:FIB_PCTS[i]}
      }); });
    }
    function updateAutoFib(){
      if(!els.chart) return;
      if(!q('.chip[data-k="AUTOFIB"]')?.classList.contains('active')) return;
      const rows=getDisplayRows(); if(!rows.length || !Array.isArray(state.fibIdx) || !state.fibIdx.length) return;
      const [x0,x1]=getVisibleRangeMs(); if(!Number.isFinite(x0)||!Number.isFinite(x1)) return;
      const s=computeHiLoInRange(rows,x0,x1); if(!s) return;
      const xArr=[new Date(x0), new Date(x1)];
      for(let i=0;i<state.fibIdx.length && i<s.levels.length;i++){
        const lv=s.levels[i]; const pct=Math.round(FIB_PCTS[i]*1000)/10; const label=`${(+lv).toFixed(2)} (${pct}%)`;
        try{ Plotly.restyle(els.chart, { x:[xArr], y:[[lv, lv]], text:[[label,label]], textposition:[[ 'middle left','middle right' ]]}, [state.fibIdx[i]]); }catch{}
      }
    }
    const updateAutoFibDebounced = debounce(updateAutoFib, 50);

    // Build subtle shading bands for Pre/Post when chip is active (intraday only)
    function buildSessionBands(rowsDisp){
      try{
        if(!isIntraday(state.interval)) return [];
        const includeAH = q('.chip[data-k="SESS"]')?.classList.contains('active');
        if(!includeAH) return [];
        const dtfDate = new Intl.DateTimeFormat('en-US',{ timeZone:'America/New_York', year:'numeric', month:'2-digit', day:'2-digit' });
        const key = (ms)=> dtfDate.format(new Date(ms));
        const hm = (ms)=>{ const parts=dtfET.formatToParts(new Date(ms)); const get=t=>parts.find(p=>p.type===t)?.value; const h=+(get('hour')||'0'); const m=+(get('minute')||'0'); return h + m/60; };
        const byDay = new Map();
        for(const r of rowsDisp){ const k=key(r.t); (byDay.get(k)||byDay.set(k,[]).get(k)).push(r); }
        const preColor = css('--band-pre') || 'rgba(59,130,246,0.07)';
        const postColor= css('--band-post')|| 'rgba(59,130,246,0.07)';
        const shapes=[];
        for(const [,rows] of byDay){
          if(!rows.length) continue;
          let preStart = rows[0].t, preEnd=null, postStart=null, postEnd=rows[rows.length-1].t;
          for(const r of rows){ const v=hm(r.t); if(preEnd===null && v>=9.5){ preEnd=r.t; } if(postStart===null && v>16.0){ postStart=r.t; break; } }
          if(Number.isFinite(preStart) && Number.isFinite(preEnd) && preEnd>preStart){
            shapes.push({ type:'rect', xref:'x', yref:'paper', x0:new Date(preStart), x1:new Date(preEnd), y0:0, y1:1, fillcolor:preColor, line:{width:0}, layer:'below' });
          }
          if(Number.isFinite(postStart) && Number.isFinite(postEnd) && postEnd>postStart){
            shapes.push({ type:'rect', xref:'x', yref:'paper', x0:new Date(postStart), x1:new Date(postEnd), y0:0, y1:1, fillcolor:postColor, line:{width:0}, layer:'below' });
          }
        }
        return shapes;
      }catch{ return []; }
    }

    async function renderChart(){
      const rows = state.rows||[]; if(!rows.length||!els.chart) return;
      const rowsDisplay = getDisplayRows();
      const traces = [];
      traces.push(candleTrace(rowsDisplay));
      // SMA 20/50/200 mapped from aligned series so they span full width
      const map20 = mapByTs(state.rows, state.smaSeries?.[20]||[]);
      const map50 = mapByTs(state.rows, state.smaSeries?.[50]||[]);
      const map200= mapByTs(state.rows, state.smaSeries?.[200]||[]);
      const xArr = rowsDisplay.map(r=>new Date(r.t));
      const tSMA20 = { type:'scatter', mode:'lines', connectgaps:true, x:xArr, y:fillForward(fillBackward(rowsDisplay.map(r=> map20.get(r.t) ?? null))), name:'SMA 20', line:{ color: css('--c-sma20')||'#22c55e', width:1.8 }, yaxis:'y', visible: q('.chip[data-k="SMA20"]')?.classList.contains('active')||false };
      const tSMA50 = { type:'scatter', mode:'lines', connectgaps:true, x:xArr, y:fillForward(fillBackward(rowsDisplay.map(r=> map50.get(r.t) ?? null))), name:'SMA 50', line:{ color: css('--c-sma50')||'#60a5fa', width:1.8 }, yaxis:'y', visible: q('.chip[data-k="SMA50"]')?.classList.contains('active')||false };

      // Robust SMA200: prefer aligned precomputed series; if it contains only nulls (coarse intervals),
      // compute SMA200 from daily data and align the daily SMA to the chart rows (nearest prior value).
      let y200 = fillForward(fillBackward(rowsDisplay.map(r=> map200.get(r.t) ?? null)));
      if(!y200.some(Number.isFinite)){
        try{
          // fetch a reasonable daily window to compute SMA200 (200 trading days ~ 1 year). Use 10y to be safe.
          const ext = await fetchRows(state.ticker, '10y', '1d');
          if(Array.isArray(ext) && ext.length){
            const yExt = sma(ext.map(r=>r.c), 200);
            const extPairs = ext.map((r,i)=>({ t: r.t, v: Number.isFinite(yExt[i])? yExt[i] : null }));
            // align daily SMA to each row by picking the most recent daily SMA at or before the row timestamp
            y200 = rowsDisplay.map(r=>{
              let lo=0, hi=extPairs.length-1, found=-1;
              while(lo<=hi){ const mid=(lo+hi)>>1; if(extPairs[mid].t <= r.t){ found=mid; lo=mid+1; } else { hi=mid-1; } }
              return (found>=0)? extPairs[found].v : null;
            });
            y200 = fillBackward(fillForward(y200));
          }
        }catch(e){ /* ignore fallback errors, keep original y200 */ }
      }
      const tSMA200= { type:'scatter', mode:'lines', connectgaps:true, x:xArr, y:y200, name:'SMA 200', line:{ color: css('--c-sma200')||'#f59e0b', width:2.0 }, yaxis:'y', visible: q('.chip[data-k="SMA200"]')?.classList.contains('active')||false };
      traces.push(tSMA20,tSMA50,tSMA200);
      // Other overlays
      const volOn = q('.chip[data-k="VOL"]')?.classList.contains('active')||false; if(volOn) traces.push(volTrace(rowsDisplay));
      const rsiOn = q('.chip[data-k="RSI"]')?.classList.contains('active')||false; if(rsiOn) traces.push(rsiTrace(rowsDisplay));
      const macdOn= q('.chip[data-k="MACD"]')?.classList.contains('active')||false; if(macdOn) traces.push(...macdTraces(rowsDisplay));
  const bbOn = q('.chip[data-k="BB"]')?.classList.contains('active')||false;
  if(bbOn){ traces.push(...bollingerTraces(rowsDisplay, 20, 2)); }
  const ichiOn= q('.chip[data-k="ICHI"]')?.classList.contains('active')||false; if(ichiOn) traces.push(...ichiTraces(rowsDisplay));

      // Dynamic custom SMA traces (from chips)
      const customList = Array.from(document.querySelectorAll('#smaCustomChips .chip[data-period]'));
      if(customList.length){
        const xArr = rowsDisplay.map(r=>new Date(r.t));
        for(const chip of customList){
          const p = +chip.dataset.period; if(!Number.isFinite(p)) continue;
          // use precomputed aligned SMA series (includes extended-data fallback)
          const series = Array.isArray(state.smaSeries?.[p])? state.smaSeries[p] : [];
          const mapP = mapByTs(state.rows, series);
          const y = rowsDisplay.map(r=> mapP.get(r.t) ?? null);
          const col = (state.customSMAColors && state.customSMAColors[p]) || CUSTOM_SMA_PALETTE[0];
          traces.push({ type:'scatter', mode:'lines', connectgaps:true, x:xArr, y:fillForward(fillBackward(y)), name:`SMA ${p}`, line:{ color: col, width:1.6, dash:'dot' }, yaxis:'y', visible: chip.classList.contains('active') });
        }
      }

      // Dividends overlay markers (when toggled on)
      function dividendTrace(rowsDisp){
        const divs = Array.isArray(state.divs)? state.divs : [];
        if(!divs.length || !rowsDisp.length) return null;
        const dayKey = ms=> Math.floor(ms/86400000);
        const byDay = new Map();
        for(const r of rowsDisp){ byDay.set(dayKey(r.t), r); }
        const times = rowsDisp.map(r=>r.t);
        const findContainingIndex = (t)=>{
          const n=times.length; if(n===1) return 0; if(t<times[0]) return -1; if(t>=times[n-1]) return n-1; for(let i=0;i<n-1;i++){ if(t>=times[i] && t<times[i+1]) return i; } return -1;
        };
        const x=[], y=[], cd=[];
        for(const d of divs){
          let r = byDay.get(dayKey(d.t)); if(!r){ const idx = findContainingIndex(d.t); if(idx>=0) r = rowsDisp[idx]; }
          if(!r) continue; x.push(new Date(r.t)); const span = (Number.isFinite(r.h)&&Number.isFinite(r.l))? (r.h - r.l) : 0; y.push((Number.isFinite(r.l)? r.l : r.c) + span*0.06); cd.push([d.amount]);
        }
        if(!x.length) return null;
        return { type:'scatter', mode:'markers', x, y, name:'Dividends', yaxis:'y', marker:{ symbol:'triangle-up', size:12, color: css('--c-div')||'#eab308', opacity:0.98, line:{ width:1.2, color:'#000' } }, hovertemplate:'Dividend %{customdata[0]:$.2f}<extra></extra>', customdata:cd };
      }
      const divOn = q('.chip[data-k="DIV"]')?.classList.contains('active')||false; if(divOn){ const dt = dividendTrace(rowsDisplay); if(dt) traces.push(dt); }

      // Auto Fib
      state.fibIdx = [];
      const fibOn = q('.chip[data-k="AUTOFIB"]')?.classList.contains('active') || false;

      if (fibOn) {
        const [vx0, vx1] = (function() {
          // try current visible range if available, else bounds of rowsDisplay
          const L = els.chart._fullLayout || els.chart.layout || {};
          const xa = L.xaxis || {};
          const toMs = v => new Date(v).getTime();
          if (Array.isArray(xa.range) && xa.autorange === false) {
                       return [toMs(xa.range[0]), toMs(xa.range[1])];
          }
          if (xArr.length) return [xArr[0].getTime(), xArr[xArr.length - 1].getTime()];
          return [NaN, NaN];
        })();
        const stats = computeHiLoInRange(rowsDisplay, vx0, vx1);
        if (stats) {
          const start = traces.length;
          traces.push(...makeFibTraces(vx0, vx1, stats.levels));
          state.fibIdx = Array.from({ length: stats.levels.length }, (_, i) => start + i);
        }
      }

      const baseLayout = {
        margin:{l:56,r:24,t:18,b:28},
        paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)',
        showlegend:true, legend:{orientation:'h', y:-0.12},
        xaxis:(()=>{
          const base = { gridcolor:css('--grid'), showgrid:true, zeroline:false, rangeslider:{ visible:false } };
          const intraday = ['1m','5m','15m','60m'];
          const shortRange = ['1d','2d','5d','10d'];
          if(intraday.includes(state.interval) && shortRange.includes(state.range)){
            return {
              ...base,
              rangebreaks:[
                { pattern:'day of week', bounds:[6,1] },
                { pattern:'hour', bounds:[16,9.5] }
              ]
            };
          }
          return base;
        })(),
        yaxis:{ gridcolor:css('--grid'), showgrid:true, zeroline:false },
        yaxis2:{ overlaying:'y', side:'right', rangemode:'tozero', showgrid:false, showticklabels:false },
        yaxis3:{ overlaying:'y', side:'right', range:[0,100], showgrid:false, showticklabels:false },
        yaxis4:{ overlaying:'y', side:'right', showgrid:false, showticklabels:false },
        font:{ color:css('--text') },
        shapes: buildSessionBands(rowsDisplay)
      };
      const layout = buildLayout(baseLayout);
      await Plotly.react(els.chart, traces, layout, { responsive:true, displayModeBar:false });
      await fitPriceAxisToCandlesStrict();
      // ensure Fib aligns to current viewport after first render
      updateAutoFibDebounced();
    }

    // Refit y-axis on interactions
    els.chart?.addEventListener?.('plotly_relayout', (ev)=>{
      if(ev && (ev['xaxis.range[0]']||ev['xaxis.range[1]']||ev['xaxis.autorange']!==undefined)){
        setTimeout(fitPriceAxisToCandlesStrict,0);
        updateAutoFibDebounced();
      }
    });
    /* ---------- Quote + subline (company info) ---------- */
    async function refreshQuoteOnce(){
      try{
        const r = await fetch(`/api/quote?ticker=${encodeURIComponent(state.ticker)}`, { cache:'no-store' }); if(!r.ok) throw 0; const j=await r.json();
        const R = j?.quoteSummary?.result?.[0]?.price || j?.quoteResponse?.result?.[0] || {};
        let compName = R.longName || R.shortName || '';
        if(!compName){ const found=(state.symbols||[]).find(s=>s.t===state.ticker); if(found?.n) compName=found.n; }
        const exch = R.exchangeName || R.fullExchangeName || R.exchange || '';
        const currency = R.currency || 'USD';
        const regPrice = +(R.regularMarketPrice?.raw ?? R.regularMarketPrice);
        const prevCloseRaw = +(R.regularMarketPreviousClose?.raw ?? R.regularMarketPreviousClose);
        const postPrice = +(R.postMarketPrice?.raw ?? R.postMarketPrice);
        const prePrice  = +(R.preMarketPrice?.raw ?? R.preMarketPrice);
        const postTime  = +((R.postMarketTime?.raw ?? R.postMarketTime) || 0) * 1000;
        const preTime   = +((R.preMarketTime?.raw ?? R.preMarketTime) || 0) * 1000;
        const regTime   = +((R.regularMarketTime?.raw ?? R.regularMarketTime) || 0) * 1000;
        const rowsAll = state.rows||[];
        const dtfET = new Intl.DateTimeFormat('en-US');
        const dtfETTime = new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York', hour12:true, hour:'numeric', minute:'2-digit'});
        // pick freshest timestamp (reg/post/pre) actually present (avoid stale 7PM default)
        const triples=[{p:regPrice,t:regTime,s:'REG'},{p:postPrice,t:postTime,s:'POST'},{p:prePrice,t:preTime,s:'PRE'}]
          .filter(x=>Number.isFinite(x.p)&&x.t>0 && x.t < Date.now()+5*60*1000) // reject absurd future times
          .sort((a,b)=>b.t-a.t);
        const best=triples[0]||{p:regPrice,t:regTime,s:'REG'};
        const price = Number.isFinite(best.p)? best.p : (state.rows?.at(-1)?.c ?? NaN);
        let prevClose = Number.isFinite(prevCloseRaw)? prevCloseRaw : (state.rows?.at(-2)?.c ?? NaN);
        const chg=(Number.isFinite(price)&&Number.isFinite(prevClose))? price-prevClose:NaN;
        const pct=(Number.isFinite(chg)&&Number.isFinite(prevClose)&&prevClose!==0)? (chg/prevClose*100):NaN;
        const sessLabel = best.s==='PRE'?'Pre‚ÄëMarket': best.s==='POST'?'After‚ÄëHours':'Regular';
        els.headline.textContent = compName? `${state.ticker} ‚Äî ${compName}` : state.ticker;
        if(els.subInfo) els.subInfo.textContent=[exch,currency,`${state.range} ¬∑ ${state.interval}`,`Session: ${sessLabel}`].filter(Boolean).join(' ‚Ä¢ ');
        const col = chg>0? css('--c-up') : chg<0? css('--c-down') : (css('--muted')||'#999');
        const changeHTML = Number.isFinite(chg)? `<span style="font-weight:800;color:${col}">${chg>0?'+':''}$${Math.abs(chg).toFixed(2)} (${chg>0?'+':''}${Math.abs(pct).toFixed(2)}%)</span>`:'‚Äî';
        const tsDisp = dtfETTime.format(new Date())+' ET'; // show refresh time, not stale trade time
        els.lastLine.innerHTML = `Last: $${Number.isFinite(price)? price.toFixed(2):'‚Äî'} ¬∑ Change: ${changeHTML} ¬∑ ${tsDisp}`;
        els.prevCloseLine.textContent = `Yesterday‚Äôs Close: ${Number.isFinite(prevClose)? '$'+prevClose.toFixed(2):'‚Äî'}`;
        // Day's Range (prefer quote fields, fallback to rows of the latest ET day)
        let dHi = +(R.regularMarketDayHigh?.raw ?? R.regularMarketDayHigh ?? NaN);
        let dLo = +(R.regularMarketDayLow?.raw ?? R.regularMarketDayLow ?? NaN);
        if(!(Number.isFinite(dHi) && Number.isFinite(dLo))){
          try{
            const tz='America/New_York';
            const dtfDay = new Intl.DateTimeFormat('en-US',{ timeZone:tz, year:'numeric', month:'2-digit', day:'2-digit' });
            const key = (ms)=> dtfDay.format(new Date(ms));
            const rowsAll = state.rows||[]; if(rowsAll.length){
              const k = key(rowsAll.at(-1).t);
              let hi=-Infinity, lo=Infinity; for(const rr of rowsAll){ if(key(rr.t)!==k) continue; if(Number.isFinite(rr.h)) hi=Math.max(hi, rr.h); if(Number.isFinite(rr.l)) lo=Math.min(lo, rr.l); }
              if(hi>-Infinity && lo<Infinity){ dHi=hi; dLo=lo; }
            }
          }catch{}
        }
        if(els.dayRangeLine){ els.dayRangeLine.textContent = `Day‚Äôs Range: ${(Number.isFinite(dLo)&&Number.isFinite(dHi))? '$'+dLo.toFixed(2)+' ‚Äì $'+dHi.toFixed(2) : '‚Äî'}`; }
        computeIntrinsicAndDisplay();
      }catch(e){ console.error('Quote refresh error', e); els.lastLine.innerHTML='Last: ‚Äî ¬∑ Change: ‚Äî'; }
    }

    function computeIntrinsicAndDisplay(){
      const t = state.ticker; if(!t) return; const f = FUNDAMENTALS[t]||{};
      let graham=null; if(Number.isFinite(f.eps) && Number.isFinite(f.growth)){
        const gPct = f.growth>3? f.growth : f.growth*100; // treat <3 as fraction
        graham = f.eps * (8.5 + 2 * gPct);
      }
      const s50 = state.smaSeries?.[50]?.filter(Number.isFinite).at(-1);
      const s200= state.smaSeries?.[200]?.filter(Number.isFinite).at(-1);
      let anchor = (Number.isFinite(s50) && Number.isFinite(s200)) ? (s50+s200)/2 : (Number.isFinite(s50)? s50 : (Number.isFinite(s200)? s200 : null));
      let iv=null; if(Number.isFinite(graham) && Number.isFinite(anchor)) iv = graham*0.6 + anchor*0.4; else if(Number.isFinite(graham)) iv=graham; else if(Number.isFinite(anchor)) iv=anchor;
      els.ivLine.textContent = `Intrinsic Value: ${Number.isFinite(iv)? '$'+fmt(iv) : '‚Äî'}`;
    }

    function scheduleQuoteAutoRefresh(){ clearInterval(state.quoteTimer); state.quoteTimer=setInterval(()=>refreshQuoteOnce(),60000); }

    async function go(ticker, company){
      CURRENT={...CURRENT,ticker,company};
      els.headline.textContent=`${ticker}${company?' ‚Äî '+company:''}`;
      els.lastLine.textContent='Loading‚Ä¶'; els.prevCloseLine.textContent=''; els.ivLine.textContent=''; if(els.companyLine) els.companyLine.textContent='';
      try{
        if(!FUNDAMENTALS[ticker]){ try{ FUNDAMENTALS[ticker]=await getFundamentals(ticker); }catch{ FUNDAMENTALS[ticker]={}; } }
        await waitForPlotly();
        const rows = await fetchRows(ticker, state.range, state.interval); state.rows = rows;
        await buildSMAAlignedSeries();
        await renderChart();
        await refreshQuoteOnce();
        computeIntrinsicAndDisplay();
        scheduleQuoteAutoRefresh();
        const f = FUNDAMENTALS[ticker] || {};
        if(els.companyLine){
          const name = company || f.longName || ticker;
          const parts=[]; if(f.sector) parts.push(f.sector); if(f.industry) parts.push(f.industry); if(Number.isFinite(f.eps)) parts.push(`EPS ${fmt(f.eps)}`); if(Number.isFinite(f.growth)) parts.push(`Growth ${( (f.growth>3? f.growth : f.growth*100) ).toFixed(1)}%`); if(Number.isFinite(f.ivGraham)) parts.push(`Graham IV $${fmt(f.ivGraham)}`);
          els.companyLine.innerHTML = `<b>${escapeHTML(name)}</b>${parts.length? ' ¬∑ '+parts.map(escapeHTML).join(' ¬∑ '):''}`;
        }
      }catch(e){ console.error('Go error', e); els.lastLine.innerHTML='Last: ‚Äî ¬∑ Change: ‚Äî'; }
    }

    /* ---------- Data fetch ---------- */
    async function fetchRows(ticker, range, interval){
      const T = normalizeTickerForFetch(ticker);
      try{
        const r = await fetch(`/api/chart?ticker=${encodeURIComponent(T)}&range=${encodeURIComponent(range)}&interval=${encodeURIComponent(interval)}`, { cache:'no-store' });
        if(r.ok){
          const j = await r.json();
          const res = j?.chart?.result?.[0];
          if(res){
            // Capture dividends from the primary payload when available
            try{
              const raw = res?.events?.dividends || {};
              const divs = Object.values(raw)
                .map(e=>({ t: ((e?.date||e?.timestamp)||0)*1000, amount: +e?.amount }))
                .filter(d=> Number.isFinite(d.t) && Number.isFinite(d.amount) && d.amount>0)
                .sort((a,b)=>a.t-b.t);
              state.divs = divs;
            }catch{}
            const ts = res.timestamp || [];
            const qd = res.indicators?.quote?.[0] || {};
            // Yahoo sometimes returns nulls for OHLC on long ranges (5y/10y) with 3mo/1y intervals.
            // Merge close from quote.close and adjclose per index, preferring quote.close when present; fallback to adjclose.
            const adjClose = res.indicators?.adjclose?.[0]?.adjclose || [];
            const closeArr = Array.from({length: ts.length}, (_, i) => {
              const qc = qd.close ? qd.close[i] : null;
              if (Number.isFinite(qc)) return +qc;
              const ac = adjClose ? adjClose[i] : null;
              return Number.isFinite(ac) ? +ac : NaN;
            });

            let rows = [];
            for(let i=0;i<ts.length;i++){
              const cRaw = closeArr[i];
              const c = Number.isFinite(cRaw) ? +cRaw : NaN;
              if(!Number.isFinite(c)) continue;
              const o = Number.isFinite(qd.open?.[i]) ? +qd.open[i] : c;
              const h = Number.isFinite(qd.high?.[i]) ? +qd.high[i] : c;
              const l = Number.isFinite(qd.low?.[i])  ? +qd.low[i]  : c;
              const v = Number.isFinite(qd.volume?.[i]) ? +qd.volume[i] : 0;
              // Ensure hi/lo envelope always contains open/close
              const hi = Math.max(h, o, c);
              const lo = Math.min(l, o, c);
              rows.push({ t: ts[i]*1000, o, h:hi, l:lo, c, v });
            }
            // Sort by time and collapse duplicate timestamps (keep last occurrence)
            rows.sort((a,b)=>a.t-b.t);
            if(rows.length){
              const byT = new Map();
              for(const r of rows){ byT.set(r.t, r); }
              rows = Array.from(byT.values()).sort((a,b)=>a.t-b.t);
            }
            // Fallback: if target interval is coarse (3mo/1y) and Yahoo returned too few bars,
            // rebuild from daily data aggregated to quarterly/yearly to keep the chart meaningful.
            const uniqueBars = rows.length;
            const isCoarse = (interval==='3mo' || interval==='1y');
            const isLongRange = (()=>{
              if(range==='max') return true;
              const m = String(range||'').match(/^(\d+)([a-z]+)$/i);
              if(!m) return false;
              const n=+m[1], u=m[2];
              if(u==='y') return n>=5;
              if(u==='mo') return n>=60;
              if(u==='d') return n>=1825; // ~5y
              return false;
            })();
            const needsAggregate = (isCoarse && (uniqueBars < 8 || isLongRange));
            if(!needsAggregate) return rows;

            // Helper: aggregate daily rows to quarterly/yearly buckets
            function aggregateOHLC(dailyRows, target){
              if(!Array.isArray(dailyRows) || !dailyRows.length) return rows; // fallback to original if empty
              const buckets = new Map();
              for(const r of dailyRows){
                const d = new Date(r.t);
                const y = d.getUTCFullYear();
                let key, startKey;
                if(target==='3mo'){
                  const q = Math.floor(d.getUTCMonth()/3); // 0..3
                  key = `${y}-${q}`;
                  startKey = Date.UTC(y, q*3, 1);
                } else { // '1y'
                  key = `${y}`;
                  startKey = Date.UTC(y, 0, 1);
                }
                let b = buckets.get(key);
                if(!b){ b = { t: startKey, o: r.o, h: r.h, l: r.l, c: r.c, v: r.v }; buckets.set(key,b); }
                // update
                b.h = Math.max(b.h, r.h);
                b.l = Math.min(b.l, r.l);
                b.c = r.c; // last close
                b.v = (b.v||0) + (r.v||0);
              }
              return Array.from(buckets.values()).sort((a,b)=>a.t-b.t);
            }

            // Fetch daily and aggregate (try multiple ranges in case Yahoo restricts long windows)
            try{
              const tryRanges = [range, 'max', '10y', '5y', '3y', '1y'];
              for(const R of tryRanges){
                const url = `/api/chart?ticker=${encodeURIComponent(T)}&range=${encodeURIComponent(R)}&interval=1d`;
                let j2=null;
                try{
                  const r2 = await fetch(url, { cache:'no-store' });
                  if(!r2.ok) { console.warn('daily agg: not ok', R, r2.status); continue; }
                  j2 = await r2.json();
                }catch(e){ console.warn('daily agg: fetch fail', R, e?.message||e); continue; }
                const res2 = j2?.chart?.result?.[0];
                if(!res2) { console.warn('daily agg: no result for', R); continue; }
                // Fallback dividends from daily payload if not already captured
                try{
                  if(!Array.isArray(state.divs) || !state.divs.length){
                    const raw2 = res2?.events?.dividends || {};
                    const d2 = Object.values(raw2)
                      .map(e=>({ t: ((e?.date||e?.timestamp)||0)*1000, amount: +e?.amount }))
                      .filter(d=> Number.isFinite(d.t) && Number.isFinite(d.amount) && d.amount>0)
                      .sort((a,b)=>a.t-b.t);
                    if(d2.length) state.divs = d2;
                  }
                }catch{}
                const ts2 = res2.timestamp || [];
                const qd2 = res2.indicators?.quote?.[0] || {};
                const ac2 = res2.indicators?.adjclose?.[0]?.adjclose || [];
                const close2 = Array.from({length: ts2.length}, (_, i) => {
                  const qc = qd2.close ? qd2.close[i] : null; if(Number.isFinite(qc)) return +qc; const aa = ac2 ? ac2[i] : null; return Number.isFinite(aa)? +aa : NaN; });
                const daily = [];
                for(let i=0;i<ts2.length;i++){
                  const c2 = close2[i]; if(!Number.isFinite(c2)) continue;
                  const o2 = Number.isFinite(qd2.open?.[i]) ? +qd2.open[i] : c2;
                  const h2 = Number.isFinite(qd2.high?.[i]) ? +qd2.high[i] : c2;
                  const l2 = Number.isFinite(qd2.low?.[i])  ? +qd2.low[i]  : c2;
                  const v2 = Number.isFinite(qd2.volume?.[i]) ? +qd2.volume[i] : 0;
                  const hi2 = Math.max(h2, o2, c2);
                  const lo2 = Math.min(l2, o2, c2);
                  daily.push({ t: ts2[i]*1000, o:o2, h:hi2, l:lo2, c:c2, v:v2 });
                }
                if(daily.length){
                  let agg = aggregateOHLC(daily, interval);
                  // Trim to requested visible window if applicable
                  const lastT = agg.at(-1)?.t || Date.now();
                  const [t0,t1] = rangeToWindow(range, lastT);
                  if(Number.isFinite(t0)) agg = agg.filter(r=> r.t>=t0 && r.t<=t1);
                  if(agg.length){
                    try{ console.info('Using daily aggregation:', { fromRange:R, bars:agg.length }); }catch{}
                    try{ if(typeof showToast==='function') showToast('Built '+(interval==='3mo'?'quarterly':'yearly')+' from daily'); }catch{}
                    return agg;
                  }
                }
              }
              console.warn('daily agg: all attempts failed, using coarse rows');
            }catch{ /* ignore and fall through */ }

            return rows;
          }
        }
      }catch{}
      throw new Error('chart fetch failed');
    }

    async function loadAndRender(){
      try{ state.rows = await fetchRows(state.ticker, state.range, state.interval); await buildSMAAlignedSeries(); await renderChart(); refreshQuoteOnce(); }
      catch(e){ console.error('Chart error', e); els.lastLine.innerHTML='Last: ‚Äî ¬∑ Change: ‚Äî'; if(els.rangeLine) els.rangeLine.textContent='Range: ‚Äî (no data)'; }
    }

    // UI wiring (patched search + AC close)
    els.searchBtn?.addEventListener('click', ()=>{ const raw=els.input.value; let t=sanitizeTicker(raw); if(!t){ els.input.focus(); return; }
      // Strip -USD if user typed it for a non-crypto base (e.g., ANET-USD -> ANET)
      if(/-USD$/.test(t)){
        const base = t.replace(/-USD$/,'');
        if(!isCryptoBase(base)) t = base;
      }
      state.ticker=t; localStorage.setItem('lastTicker', t); hideAC(); loadAndRender(); });
    els.input?.addEventListener('input', (e)=>{ updateAC(e.target.value); });
    els.input?.addEventListener('keydown', (e)=>{ if(!['ArrowDown','ArrowUp','Enter','Escape','Tab'].includes(e.key)) return; if(e.key==='Escape'){ hideAC(); return;} if(!state.acMatches.length){ if(e.key==='Enter'){ els.searchBtn?.click(); } return; } if(e.key==='ArrowDown'){ e.preventDefault(); state.acIndex = (state.acIndex+1)%state.acMatches.length; renderAC(); } else if(e.key==='ArrowUp'){ e.preventDefault(); state.acIndex = (state.acIndex-1+state.acMatches.length)%state.acMatches.length; renderAC(); } else if(e.key==='Enter' || e.key==='Tab'){ const idx= state.acIndex<0?0:state.acIndex; pickAC(idx); if(e.key==='Enter'){ e.preventDefault(); els.searchBtn?.click(); } } });
    els.list?.addEventListener('mousedown', (e)=>{ const it=e.target.closest('.ac-item'); if(!it) return; pickAC(state.acMatches.findIndex(x=>x.t===it.dataset.t)); els.searchBtn?.click(); });
    // Range bar handlers (days + frequency)
    els.rangeBar?.addEventListener('click', e=>{
      const rangeBtn = e.target.closest('button[data-range]');
      const freqBtn  = e.target.closest('button[data-interval]');
      if(rangeBtn){
        if(rangeBtn.classList.contains('disabled')) return;
        [...els.rangeBar.querySelectorAll('button[data-range]')].forEach(x=>x.classList.remove('active'));
        rangeBtn.classList.add('active');
        state.range = rangeBtn.dataset.range;
        refreshRangeFreqDisabledState();
        loadAndRender();
        return;
      }
      if(freqBtn){
        if(freqBtn.classList.contains('disabled')) return;
        [...els.rangeBar.querySelectorAll('button[data-interval]')].forEach(x=>x.classList.remove('active'));
        freqBtn.classList.add('active');
        state.interval = freqBtn.dataset.interval;
        refreshRangeFreqDisabledState();
        loadAndRender();
        return;
      }
    });
    els.toggles?.addEventListener('click', (e)=>{ const chip=e.target.closest('.chip'); if(!chip) return; chip.classList.toggle('active'); chip.setAttribute('aria-pressed', chip.classList.contains('active')?'true':'false'); renderChart(); });
    els.toggles?.addEventListener('click', (e)=>{ const chip=e.target.closest('.chip'); if(!chip) return; if(chip.dataset.k==='AUTOFIB'){ setTimeout(updateAutoFibDebounced, 0); } });

  // SMA controls wiring
  els.smaPreset?.addEventListener('change', ()=>{ const v=+els.smaPreset.value; if(Number.isFinite(v)) addCustomSMA(v); els.smaPreset.value=''; });
  els.smaAddBtn?.addEventListener('click', ()=>{ const v=+els.smaCustom.value; if(Number.isFinite(v)) addCustomSMA(v); else showToast('Enter a number'); });
  els.smaCustom?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ const v=+els.smaCustom.value; if(Number.isFinite(v)) addCustomSMA(v); }});
  // Toggle custom chip on click, remove on double click
  els.smaChips?.addEventListener('click', e=>{ const chip=e.target.closest('.chip'); if(!chip) return; chip.classList.toggle('active'); chip.setAttribute('aria-pressed', chip.classList.contains('active')?'true':'false'); renderChart(); });
  els.smaChips?.addEventListener('dblclick', e=>{ const chip=e.target.closest('.chip'); if(!chip) return; const p=+chip.dataset.period; if(Number.isFinite(p)) removeCustomSMA(p); });

    /* ---------- Market Overview minis (DOW / NASDAQ / S&P) ---------- */
    const MKT = [
      { id:'dji',  elId:'mkt-dji',  chgId:'mkt-dji-chg',  sym:'^DJI',  title:'DOW' },
      { id:'ixic', elId:'mkt-ixic', chgId:'mkt-ixic-chg', sym:'^IXIC', title:'NASDAQ' },
      { id:'gspc', elId:'mkt-gspc', chgId:'mkt-gspc-chg', sym:'^GSPC', title:'S&P 500' }
    ];

    // NEW: helpers so minis keep last completed session after-hours
    const toETDay = (ms)=> new Date(new Date(ms).toLocaleString('en-US',{ timeZone:'America/New_York' })).toDateString();
    const getMktCache = (id)=>{ try{ return JSON.parse(localStorage.getItem('mkt:'+id)||'null'); }catch{ return null; } };
    const setMktCache = (id,payload)=>{ try{ localStorage.setItem('mkt:'+id, JSON.stringify(payload)); }catch{} };
    function lastCompletedSession(rows){
      if(!rows?.length) return null;
      const by = new Map();
      for(const r of rows){ const k = toETDay(r.t); (by.get(k) || by.set(k, []).get(k)).push(r); }
      const days = Array.from(by.values());
      let k = days.length - 1; while(k>=0 && !(days[k]?.length)) k--; if(k<0) return null;
      const sessionRows = days[k];
      let prevClose = null; for(let j=k-1;j>=0;j--){ const rr = days[j]; if(rr?.length){ prevClose = rr.at(-1)?.c ?? null; break; } }
      const lastClose = sessionRows.at(-1)?.c ?? null;
      return { sessionRows, prevClose, lastClose };
    }

    function mktLayout(prev, sessionRows){
      const grid = getComputedStyle(document.documentElement).getPropertyValue('--grid').trim()||'#283044';
      // Build Finviz-like time ticks across the bottom starting 9:30AM, then every 30 minutes to 4:00PM ET
      const toET = (ms)=> new Date(new Date(ms).toLocaleString('en-US',{ timeZone:'America/New_York' }));
      // Desired half-hour marks: 9:30 ‚Üí 16:00
      const want = [];
      { let h=9, m=30; while(true){ want.push([h,m]); if(h===16 && m===0) break; m+=30; if(m>=60){ m=0; h++; } } }
      const tickMap = new Map(); // key "h:m" -> ms
      if (Array.isArray(sessionRows)) {
        for (const r of sessionRows) {
          const d = toET(r.t);
          const h = d.getHours(), m = d.getMinutes();
          if ((m===0 || m===30) && (h>9 || (h===9 && m>=30)) && (h<16 || (h===16 && m===0))) {
            const key = h+":"+m;
            if (!tickMap.has(key)) tickMap.set(key, r.t);
          }
        }
      }
      const tickvals = [], ticktext = [];
      for (const [h,m] of want) {
        const t = tickMap.get(h+":"+m);
        if (t) {
          tickvals.push(new Date(t));
          let hh = h % 12; if (hh===0) hh = 12;
          const suf = h<12? 'AM':'PM';
          const lbl = m===0 ? `${hh}${suf}` : `${hh}:30`;
          ticktext.push(lbl);
        }
      }
      return {
        margin:{l:44,r:8,t:8,b:26},
        paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)',
        xaxis:{
          showgrid:true, gridcolor:grid, tickfont:{size:10},
          rangeslider:{ visible:false }, fixedrange:true,
          tickmode: (tickvals.length? 'array':'auto'), tickvals, ticktext
        },
        yaxis:{showgrid:true,gridcolor:grid, zeroline:false, tickfont:{size:10}, side:'right'},
        showlegend:false,
        shapes: prev!=null ? [{type:'line',xref:'paper',yref:'y',x0:0,x1:1,y0:prev,y1:prev,line:{color:'#ef4444',dash:'dot',width:1}}] : []
      };
    }
    function mktCandle(rows){
      const up = getComputedStyle(document.documentElement).getPropertyValue('--c-up').trim()||'#16a34a';
      const dn = getComputedStyle(document.documentElement).getPropertyValue('--c-down').trim()||'#dc2626';
      return {
        type:'candlestick',
        x: rows.map(r=>new Date(r.t)),
        open: rows.map(r=>r.o), high: rows.map(r=>r.h), low: rows.map(r=>r.l), close: rows.map(r=>r.c),
        increasing:{ line:{ color: up, width:1.2 }, fillcolor: up+'33' },
        decreasing:{ line:{ color: dn, width:1.2 }, fillcolor: dn+'33' },
        whiskerwidth: 0.2,
        hovertemplate:'%{x|%I:%M %p}<br>O %{open:.2f} ¬∑ H %{high:.2f}<br>L %{low:.2f} ¬∑ C %{close:.2f}<extra></extra>'
      };
    }
    async function renderMktCard(card){
      const el = document.getElementById(card.elId); if(!el) return;
      try{
        // Wider window so we can always select a completed day
        const rows5d = await fetchRows(card.sym, '5d', '5m');
        const sess = lastCompletedSession(rows5d);
        if(!sess) throw new Error('no session');
        const { sessionRows, prevClose, lastClose } = sess;
        const chg = (Number.isFinite(lastClose)&&Number.isFinite(prevClose)) ? lastClose - prevClose : NaN;
        const pct = (Number.isFinite(lastClose)&&Number.isFinite(prevClose)&&prevClose!==0) ? (chg/prevClose*100) : NaN;
        const col = chg>0? (getComputedStyle(document.documentElement).getPropertyValue('--c-up').trim()||'#16a34a') : chg<0? (getComputedStyle(document.documentElement).getPropertyValue('--c-down').trim()||'#dc2626') : '#cbd5e1';
        const chgEl = document.getElementById(card.chgId);
        if(chgEl){ chgEl.style.color=col; chgEl.textContent = (Number.isFinite(chg)&&Number.isFinite(pct))? `${chg>0?'+':''}${chg.toFixed(2)} (${chg>0?'+':''}${pct.toFixed(2)}%)` : '‚Äî'; }
  await Plotly.react(el, [mktCandle(sessionRows)], mktLayout(prevClose, sessionRows), {displayModeBar:false, responsive:true});
        // Cache for overnight persistence (~78 bars ‚âà 6.5h at 5m)
        setMktCache(card.id, { prev: prevClose, last: lastClose, rows: sessionRows.slice(-78), t: Date.now() });
        return sessionRows;
      }catch(e){
        // Fallback to cache so cards never go blank after-hours
        const cached = getMktCache(card.id);
        if(cached?.rows?.length){
          await Plotly.react(el, [mktCandle(cached.rows)], mktLayout(cached.prev, cached.rows), {displayModeBar:false, responsive:true});
          const chgEl = document.getElementById(card.chgId);
          if(chgEl && Number.isFinite(cached.last) && Number.isFinite(cached.prev)){
            const chg = cached.last - cached.prev; const pct = cached.prev? chg/cached.prev*100 : 0;
            const col = chg>0? (getComputedStyle(document.documentElement).getPropertyValue('--c-up').trim()||'#16a34a') : chg<0? (getComputedStyle(document.documentElement).getPropertyValue('--c-down').trim()||'#dc2626') : '#cbd5e1';
            chgEl.style.color=col; chgEl.textContent = `${chg>0?'+':''}${chg.toFixed(2)} (${chg>0?'+':''}${pct.toFixed(2)}%)`;
          }
          return cached.rows;
        }
        return [];
      }
    }
    function pct(v,total){ return total? (v/total*100) : 0; }
    function clampPct(v){ v = Math.max(0, Math.min(100, v)); return Math.round(v*10)/10; }
    function updateGauges(rowsMap){
      try{
        const d = Array.isArray(rowsMap.d)? rowsMap.d : [];
        const n = Array.isArray(rowsMap.n)? rowsMap.n : [];
        const s = Array.isArray(rowsMap.s)? rowsMap.s : [];
        const all = [...d, ...n, ...s];
        if(all.length < 3) return;
        let adv=0, dec=0, nh=0, nl=0;
        let hi=-Infinity, lo=Infinity;
        // compute advancing/declining and new highs/lows over session
        function scan(arr){ for(let i=1;i<arr.length;i++){ const prev=arr[i-1].c, cur=arr[i].c; if(Number.isFinite(prev)&&Number.isFinite(cur)){ if(cur>prev) adv++; else if(cur<prev) dec++; if(cur>hi){ hi=cur; nh++; } if(cur<lo){ lo=cur; nl++; } } } }
        scan(d); scan(n); scan(s);
        const tot = adv+dec; const advPct = clampPct(pct(adv, tot)); const decPct = clampPct(100 - advPct);
        const tn = nh+nl; const nhPct = clampPct(pct(nh, tn)); const nlPct = clampPct(100 - nhPct);
        const set = (idL,idR,idM,left,right,html)=>{ const L=q(idL), R=q(idR), M=q(idM); if(L) L.style.width = (Number.isFinite(left)? left:0) + '%'; if(R) R.style.width = (Number.isFinite(right)? right:0) + '%'; if(M) M.innerHTML = html; };
        // Advancing/Declining: if tot is zero show placeholder
        if(Number.isFinite(advPct) && Number.isFinite(decPct)){
          set('#g-advance-l','#g-advance-r','#g-advance-m', advPct, decPct, `<span class="g-up">Advancing ${advPct.toFixed(1)}%</span> ¬∑ <span class="g-dn">Declining ${decPct.toFixed(1)}%</span>`);
        } else {
          set('#g-advance-l','#g-advance-r','#g-advance-m', 0,0, `‚Äî`);
        }
        if(Number.isFinite(nhPct) && Number.isFinite(nlPct)){
          set('#g-newhigh-l','#g-newhigh-r','#g-newhigh-m', nhPct, nlPct, `<span class="g-up">New High ${nhPct.toFixed(1)}%</span> ¬∑ <span class="g-dn">New Low ${nlPct.toFixed(1)}%</span>`);
        } else {
          set('#g-newhigh-l','#g-newhigh-r','#g-newhigh-m', 0,0, `‚Äî`);
        }
        // Approximate above/below SMA50/200 using session SMA by index (intraday roughness acceptable for breadth)
        function sma(arr,p){ const out=[]; let sum=0, cnt=0; for(let i=0;i<arr.length;i++){ const v=arr[i]; if(Number.isFinite(v)){ sum+=v; cnt++; } if(i>=p){ const w=arr[i-p]; if(Number.isFinite(w)){ sum-=w; cnt--; } } out[i]= (i>=p-1 && cnt>0)? (sum/cnt) : null; } return out; }
        function abBelow(rows,p){ const closes=rows.map(r=>r.c); const s=sma(closes,p); let ab=0, bl=0; for(let i=0;i<rows.length;i++){ const c=rows[i]?.c; const m=s[i]; if(Number.isFinite(c)&&Number.isFinite(m)){ if(c>=m) ab++; else bl++; } } return {ab,bl}; }
        const a50 = abBelow(d,50); const b50 = abBelow(n,50); const c50 = abBelow(s,50);
        const ab50 = (a50.ab + b50.ab + c50.ab); const bl50 = (a50.bl + b50.bl + c50.bl); const t50 = ab50 + bl50;
        const ab50Pct = t50? clampPct(pct(ab50, t50)) : NaN; const bl50Pct = t50? clampPct(pct(bl50, t50)) : NaN;
        if(t50){ set('#g-sma50-l','#g-sma50-r','#g-sma50-m', ab50Pct, bl50Pct, `<span class="g-up">Above ${ab50Pct.toFixed(1)}%</span> ¬∑ <span class="g-dn">Below ${bl50Pct.toFixed(1)}%</span>`); }
        else { set('#g-sma50-l','#g-sma50-r','#g-sma50-m', 0,0, `‚Äî`); }
        const a200 = abBelow(d,200); const b200 = abBelow(n,200); const c200 = abBelow(s,200);
        const ab200 = (a200.ab + b200.ab + c200.ab); const bl200 = (a200.bl + b200.bl + c200.bl); const t200 = ab200 + bl200;
        const ab200Pct = t200? clampPct(pct(ab200, t200)) : NaN; const bl200Pct = t200? clampPct(pct(bl200, t200)) : NaN;
        if(t200){ set('#g-sma200-l','#g-sma200-r','#g-sma200-m', ab200Pct, bl200Pct, `<span class="g-up">Above ${ab200Pct.toFixed(1)}%</span> ¬∑ <span class="g-dn">Below ${bl200Pct.toFixed(1)}%</span>`); }
        else { set('#g-sma200-l','#g-sma200-r','#g-sma200-m', 0,0, `‚Äî`); }
        // Intraday sentiment mirrors adv/decl for a simple bull/bear split
        const adv0 = Math.round(advPct), dec0 = 100 - adv0;
        set('#g-sentiment-l','#g-sentiment-r','#g-sentiment-m', advPct, decPct, `${adv0}% <span class="g-up">BULL</span>¬†¬†${dec0}% <span class="g-dn">BEAR</span>`);
      }catch{}
    }
    async function renderAllMkt(){
      const rowsList = await Promise.all(MKT.map(renderMktCard));
      if(Array.isArray(rowsList) && rowsList.length===3){ updateGauges({ d: rowsList[0]||[], n: rowsList[1]||[], s: rowsList[2]||[] }); }
      // Try breadth JSON (produced by scheduled job) to populate more accurate Above/Below figures
      try{ await fetchBreadthAndRender(); }catch(e){ /* ignore */ }
    }
    let mktTimer=null; function scheduleMkt(){ clearInterval(mktTimer); mktTimer=setInterval(renderAllMkt, 60000); }
    window.addEventListener('resize', ()=>{ for(const c of MKT){ const el=document.getElementById(c.elId); if(el) try{ Plotly.Plots.resize(el); }catch{} } });
    
    // Buffett Indicator helpers
    function fmtNum(n){ if(!Number.isFinite(n)) return '‚Äî'; if(Math.abs(n)>=1e12) return (n/1e12).toFixed(2)+'T'; if(Math.abs(n)>=1e9) return (n/1e9).toFixed(2)+'B'; if(Math.abs(n)>=1e6) return (n/1e6).toFixed(2)+'M'; return n.toString(); }
    function fmtRatio(r){ if(!Number.isFinite(r)) return '‚Äî'; const pct = (r*100).toFixed(1)+'%'; const times = r.toFixed(2)+'x'; return `${pct} ¬∑ ${times}`; }
    function loadBuffett(){ try{ const s = localStorage.getItem('buffettIndicator'); return s? JSON.parse(s) : null; }catch{return null;} }
    function saveBuffett(obj){ try{ localStorage.setItem('buffettIndicator', JSON.stringify(obj)); }catch{} }

    async function fetchBuffettAuto(){
      try{
        const url = (window.location && window.location.origin) ? (window.location.origin + '/api/buffett') : '/api/buffett';
        const r = await fetch(url);
        if(!r.ok){
          // log status for easier debugging in DevTools
          const txt = await r.text().catch(()=>null);
          console.warn('[buffett] auto fetch failed status', r.status, txt);
          throw new Error('bad');
        }
        const j = await r.json();
        if(j && (j.ratio || j.percent)){
          const obj = { marketCap: j.marketCap||null, gdp: j.gdp||null, ratio: Number(j.ratio|| (j.percent? j.percent/100 : NaN)), t: Date.now(), source: j.source||url };
          saveBuffett(obj);
          return obj;
        }
      }catch(e){ console.warn('[buffett] auto fetch failed', e?.message||e); }
      return null;
    }
    function buffettRemark(pct){
      // pct = percent, e.g. 236.4
      if(!Number.isFinite(pct)) return {text:'‚Äî', color:'var(--muted)'};
      if(pct>=200) return {text:`${pct.toFixed(1)}% ¬∑ Overvalued`, color:getComputedStyle(document.documentElement).getPropertyValue('--c-down').trim()||'#dc2626'};
      if(pct>=100) return {text:`${pct.toFixed(1)}% ¬∑ Stretched`, color:getComputedStyle(document.documentElement).getPropertyValue('--c-div').trim()||'#eab308'};
      if(pct>=70) return {text:`${pct.toFixed(1)}% ¬∑ Bargain`, color:getComputedStyle(document.documentElement).getPropertyValue('--c-up').trim()||'#16a34a'};
      return {text:`${pct.toFixed(1)}% ¬∑ Cheap`, color:getComputedStyle(document.documentElement).getPropertyValue('--c-up').trim()||'#16a34a'};
    }

  async function renderBuffett(){ const elVal = document.getElementById('buffettValueMini'); const elRemark = document.getElementById('buffettRemarkMini'); if(!elVal||!elRemark) return; let d = loadBuffett(); // if nothing in localStorage, try to fetch from server once (best-effort)
    if(!d){ try{ const r = await fetch('/api/buffett'); if(r.ok){ const j = await r.json(); if(j && (j.ratio || j.percent)){ d = { marketCap: j.marketCap||null, gdp: j.gdp||null, ratio: Number(j.ratio||(j.percent? j.percent/100:NaN)), t: Date.now(), source: j.source||'/api/buffett' }; saveBuffett(d); } } }catch(e){ /* ignore */ } }
    if(!d){ elVal.textContent='‚Äî'; elRemark.textContent='No data ‚Äî click Refresh'; setBuffettPillColor('transparent'); return; } const pct = Number(d.ratio)*100; const rem = buffettRemark(pct); elVal.textContent = `${pct.toFixed(1)}%`; elVal.style.color = rem.color; elRemark.textContent = rem.text; elRemark.style.color = rem.color; setBuffettPillColor(rem.color); }
  // set the tiny pill color for at-a-glance status
  function setBuffettPillColor(color){ const p = document.getElementById('buffettPill'); if(!p) return; try{ p.style.background = color || 'transparent'; }catch{} }

  // VIX sparkline helpers ‚Äî store recent samples in localStorage and render a tiny SVG
  function getVixSamples(){ try{ return JSON.parse(localStorage.getItem('vixSamples_v1')||'[]'); }catch{return [];} }
  function saveVixSamples(arr){ try{ localStorage.setItem('vixSamples_v1', JSON.stringify(arr)); }catch{} }
  function renderVixSparkline(arr){ const svg = document.getElementById('vixSpark'); if(!svg) return; try{ arr = arr || getVixSamples(); if(!arr || !arr.length){ svg.innerHTML=''; return; } const w = svg.getAttribute('width')||120; const h = svg.getAttribute('height')||28; const vals = arr.map(x=>x.v); const min = Math.min(...vals); const max = Math.max(...vals); const range = (max - min) || 1; const pad = 2; const step = (w - pad*2) / Math.max(1, arr.length-1); const points = arr.map((pt,i)=>{ const x = pad + i*step; const y = pad + (1 - ((pt.v - min)/range))*(h - pad*2); return `${x},${y}`; }).join(' '); const stroke = vals[vals.length-1] >= vals[0] ? getComputedStyle(document.documentElement).getPropertyValue('--c-up').trim() : getComputedStyle(document.documentElement).getPropertyValue('--c-down').trim(); svg.innerHTML = `<polyline fill="none" stroke="${stroke}" stroke-width="2" points="${points}" stroke-linejoin="round" stroke-linecap="round"/>`; }catch(e){ console.warn('[vixSpark] render failed', e); } }

    // Buffett modal: explicit edit UI (avoids native prompt)
    function openBuffettModal(){
      let m = document.getElementById('buffettModal');
      if(!m){
        // create modal markup
        m = document.createElement('div'); m.id='buffettModal'; m.className='sheet'; m.setAttribute('hidden','');
        m.innerHTML = `<div class="sheet-inner" role="dialog" aria-modal="true" aria-label="Edit Buffett Indicator">
          <div class="sheet-head"><div class="sheet-title">Edit Buffett Indicator</div><button class="sheet-close" data-close="buffettModal">‚úï</button></div>
          <div class="sheet-body">
            <p style="margin:0 0 8px;color:var(--muted)">Enter Buffett Indicator percent (example: <em>236.4</em> for 236.4%). This saves locally in your browser.</p>
            <input id="buffettModalInput" type="number" step="0.1" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--field-bg);color:var(--field-text);" />
            <div style="display:flex;gap:8px;margin-top:10px"><button id="buffettSaveBtn" class="btn">Save</button><button id="buffettClearBtn" class="tool-btn">Clear</button><button id="buffettCloseBtn" class="tool-btn">Close</button></div>
          </div></div>`;
        document.body.appendChild(m);
        // wire close
        m.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', ()=> closeBuffettModal()));
        m.querySelector('#buffettCloseBtn').addEventListener('click', ()=> closeBuffettModal());
        m.querySelector('#buffettSaveBtn').addEventListener('click', ()=> { buffettModalSave(); });
        m.querySelector('#buffettClearBtn').addEventListener('click', ()=> { buffettModalClear(); });
      }
      // populate value
      const cur = loadBuffett(); const input = m.querySelector('#buffettModalInput'); if(input) input.value = cur && Number.isFinite(cur.ratio) ? (cur.ratio*100).toFixed(1) : '';
      m.hidden = false; m.setAttribute('data-open','true'); document.body.style.overflow='hidden';
      setTimeout(()=>{ const inp = m.querySelector('#buffettModalInput'); if(inp) inp.focus(); },50);
    }
    function closeBuffettModal(){ const m=document.getElementById('buffettModal'); if(!m) return; m.hidden=true; m.removeAttribute('data-open'); if(![...document.querySelectorAll('.sheet')].some(s=>!s.hidden)) document.body.style.overflow=''; }
    function buffettModalSave(){ const m=document.getElementById('buffettModal'); if(!m) return; const v = parseFloat(m.querySelector('#buffettModalInput').value); if(!Number.isFinite(v)){ showToast('Invalid value'); return; } const obj = { marketCap:null, gdp:null, ratio: v/100, t: Date.now(), source:'manual' }; saveBuffett(obj); renderBuffett(); closeBuffettModal(); showToast('Buffett saved locally'); }
    function buffettModalClear(){ localStorage.removeItem('buffettIndicator'); renderBuffett(); closeBuffettModal(); showToast('Buffett cleared'); }

    // Try auto-fetch once at load; fall back to any saved value or manual
    (async ()=>{ try{ const a = await fetchBuffettAuto(); if(a) renderBuffett(); else renderBuffett(); }catch(e){ renderBuffett(); } })();

    // VIX helpers: fetch and display + simple buy/sell remark
    function parseQuoteForPrice(j){ try{ if(j?.quoteResponse?.result && j.quoteResponse.result[0]){ return j.quoteResponse.result[0].regularMarketPrice || j.quoteResponse.result[0].regularMarketPriceRaw || j.quoteResponse.result[0].regularMarketPrice?.raw || j.quoteResponse.result[0].regularMarketPrice; } if(j?.quoteSummary?.result && j.quoteSummary.result[0] && j.quoteSummary.result[0].price){ return j.quoteSummary.result[0].price.regularMarketPrice?.raw || j.quoteSummary.result[0].price.regularMarketPrice; } if(j?.chart?.result && j.chart.result[0] && j.chart.result[0].meta){ return j.chart.result[0].meta.regularMarketPrice || j.chart.result[0].meta.regularMarketPriceRaw; } return null; }catch(e){ return null; } }
    async function fetchVIX(){
      try{
        const base = (window.location && window.location.origin) ? window.location.origin : '';
        const r = await fetch(base + '/api/quote?ticker=%5EVIX');
        if(!r.ok){ const txt = await r.text().catch(()=>null); console.warn('[vix] fetch status', r.status, txt); throw new Error('vix fetch bad'); }
        const j = await r.json(); const price = parseQuoteForPrice(j); if(!Number.isFinite(price)) return null; return Number(price);
      }catch(e){ console.warn('[vix] fetch failed', e?.message||e); return null; }
    }
    function vixRemark(val){ if(!Number.isFinite(val)) return {text:'‚Äî', level:'unknown'}; if(val>=30) return {text:'Dangerously High ‚Äî Extreme fear', level:'danger'}; if(val>=22) return {text:'Elevated ‚Äî Caution', level:'warn'}; if(val>=14) return {text:'Normal', level:'ok'}; return {text:'Low ‚Äî Complacency', level:'low'}; }

    // VIX state for intraday delta, baseline, and alerts
    const __vixState = { baseline: null, last: null, lastLevel: null };

    function decideVixAction(v, pctChange){
      // base level by absolute VIX
      let level = 'low';
      if(v>=30) level = 'danger'; else if(v>=22) level = 'warn'; else if(v>=14) level = 'ok';
      // start with base action
      let action = 'Hold';
      if(level==='danger') action = 'Stand Down ‚Äî Hedge / reduce size heavily';
      else if(level==='warn') action = 'Reduce ‚Äî Consider hedges / tighten stops';
      else if(level==='ok') action = 'Hold ‚Äî Normal sizing';
      else action = 'Trade as usual';

      // escalate if intraday jump is significant (percent change vs baseline)
      if(Number.isFinite(pctChange)){
        const pct = Math.abs(pctChange);
        if(pct >= 20){ action = 'Stand Down ‚Äî Vol spike'; }
        else if(pct >= 10 && action !== 'Stand Down ‚Äî Vol spike'){ action = 'Reduce ‚Äî Vol rising'; }
      }
      return { action, level };
    }

    async function renderVix(){
      const elV = document.getElementById('vixValueMini');
      const elR = document.getElementById('vixRemarkMini');
      const elAct = document.getElementById('vixActionMini');
      const elFill = document.getElementById('vixDeltaFill');
      if(!elV||!elR) return;
      const v = await fetchVIX();
      if(!Number.isFinite(v)){ elV.textContent='‚Äî'; elR.textContent='‚Äî'; if(elAct) elAct.textContent='‚Äî'; if(elFill) elFill.style.width='0%'; return; }

      // initialize baseline on first successful fetch
      if(!Number.isFinite(__vixState.baseline)) __vixState.baseline = v;
      const baseline = __vixState.baseline;
      const last = __vixState.last;
      __vixState.last = v;

      // persist sample locally for sparkline (keep last 48)
      try{
        const keyArr = getVixSamples() || [];
        keyArr.push({ t: Date.now(), v });
        if(keyArr.length>48) keyArr.splice(0, keyArr.length-48);
        saveVixSamples(keyArr);
        renderVixSparkline(keyArr);
      }catch(e){ console.warn('[vix] sample save failed', e); }

      const delta = (Number.isFinite(baseline) && baseline!==0) ? (v - baseline) : NaN;
      const pctChange = (Number.isFinite(baseline) && baseline!==0) ? (delta / baseline * 100) : NaN;

      elV.textContent = v.toFixed(2);
      const rem = vixRemark(v);
      elR.textContent = `${rem.text} ¬∑ ${Number.isFinite(pctChange)? (pctChange>=0?'+':'')+pctChange.toFixed(1)+'%':''}`;
      elR.style.color = rem.level==='danger'? getComputedStyle(document.documentElement).getPropertyValue('--c-down').trim() : rem.level==='warn'? getComputedStyle(document.documentElement).getPropertyValue('--c-div').trim() : rem.level==='low'? getComputedStyle(document.documentElement).getPropertyValue('--c-up').trim() : getComputedStyle(document.documentElement).getPropertyValue('--muted').trim();

      // set delta bar width (clamp to +/-50% mapped to 0-100%)
      if(elFill){ const w = Number.isFinite(pctChange)? Math.min(100, Math.abs(pctChange) * 2) : 0; elFill.style.width = w+'%'; elFill.style.background = (pctChange>=0)? 'linear-gradient(90deg,var(--c-down),#ffb4b4)' : 'linear-gradient(90deg,var(--c-up),#b7f5d0)'; }

      // decide action based on v and pctChange
      const { action, level } = decideVixAction(v, pctChange);
      if(elAct) { elAct.textContent = action; elAct.style.color = level==='danger'? getComputedStyle(document.documentElement).getPropertyValue('--c-down').trim() : level==='warn'? getComputedStyle(document.documentElement).getPropertyValue('--c-div').trim() : level==='low'? getComputedStyle(document.documentElement).getPropertyValue('--c-up').trim() : getComputedStyle(document.documentElement).getPropertyValue('--muted').trim(); }

      // Alert on level crossing (only when level changes)
      if(__vixState.lastLevel !== level){ const labelMap = { danger:'‚â•30', warn:'‚â•22', ok:'14‚Äì22', low:'<14' }; showToast(`VIX moved to ${labelMap[level]} ‚Äî ${action}`, 4000); __vixState.lastLevel = level; }
    }
  // Kick off VIX polling (every 60s)
  renderVix(); setInterval(renderVix, 60000);

    // Attempt to load breadth JSON (public/breadth.json) produced by scheduled job
    async function fetchBreadth(){
      try{
        const r = await fetch('/breadth.json', { cache: 'no-store' });
        if(!r.ok) return null;
        const j = await r.json(); return j;
      }catch(e){ return null; }
    }

    async function fetchBreadthAndRender(){
      const j = await fetchBreadth(); if(!j) return;
      const s50 = j.sma50 || {}; const s200 = j.sma200 || {};
      function set(idL,idR,idM,abovePct,belowPct,html){ const L=q(idL), R=q(idR), M=q(idM); if(L) L.style.width = (Number.isFinite(abovePct)? Math.max(0,Math.min(100,abovePct)):0) + '%'; if(R) R.style.width = (Number.isFinite(belowPct)? Math.max(0,Math.min(100,belowPct)):0) + '%'; if(M) M.innerHTML = html; }
      if(Number.isFinite(s50.abovePct) && Number.isFinite(s50.belowPct)){
        set('#g-sma50-l','#g-sma50-r','#g-sma50-m', s50.abovePct, s50.belowPct, `<span class="g-up">Above ${s50.abovePct.toFixed(1)}%</span> ¬∑ <span class="g-dn">Below ${s50.belowPct.toFixed(1)}%</span>`);
      }
      if(Number.isFinite(s200.abovePct) && Number.isFinite(s200.belowPct)){
        set('#g-sma200-l','#g-sma200-r','#g-sma200-m', s200.abovePct, s200.belowPct, `<span class="g-up">Above ${s200.abovePct.toFixed(1)}%</span> ¬∑ <span class="g-dn">Below ${s200.belowPct.toFixed(1)}%</span>`);
      }
    }

    // Boot
    (async function boot(){ try{ await loadSymbols(); }catch{}; els.input.value=state.ticker; renderCustomSMAChips(); refreshRangeFreqDisabledState(); await loadAndRender(); scheduleQuoteAutoRefresh(); await renderAllMkt(); scheduleMkt(); })();
  })();
  </script>
</body>
</html>
