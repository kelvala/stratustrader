<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stratus Trader â€” Chart v.2</title>
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js" defer></script>
<style>
  :root{
    --bg:#0f1115;--panel:#151923;--text:#e5e7eb;--muted:#9ca3af;
    --accent:#22c55e;--focus:#3b82f6;--border:#23283a;--hover:#161a25;
    --metric-bg:#1a1f2e;--metric-border:#2a2f3e;
    --field-bg:#0c0f16;--field-text:#e5e7eb;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#60a5fa;--c-sma200:#f59e0b;
    --c-rsi:#a78bfa;--c-macd:#38bdf8;--c-vol:#10b981;
    --grid:#283044;
    --c-ichi-tenkan:#f59e0b; --c-ichi-kijun:#60a5fa; --c-ichi-chikou:#93c5fd;
    --c-ichi-up:rgba(34,197,94,.38); --c-ichi-down:rgba(239,68,68,.34);
  }
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh;padding:20px}
  .container{max-width:1100px;margin:0 auto}
  .toolbar{position:sticky;top:0;z-index:12000;display:flex;gap:10px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin-bottom:16px;flex-wrap:wrap}
  .ticker-wrap{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
  .ticker-wrap label{font-weight:800;opacity:.9}
  .input-wrap{position:relative;flex:0 1 460px;max-width:460px;width:100%}
  .ticker-input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--field-bg);color:var(--field-text);text-transform:uppercase;font-size:16px}
  .btn{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn.inline{padding:8px 12px}
  .toolsbar{display:flex;align-items:center;gap:8px;margin-left:auto;flex:1 1 100%;justify-content:flex-start;flex-wrap:wrap}
  .tool-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:700;cursor:pointer}
  .tool-btn:hover{background:var(--hover)}
  .theme-toggle{margin-left:auto;cursor:pointer;padding:8px 14px;border-radius:8px;background:var(--panel);color:var(--text);border:1px solid var(--border);font-weight:600}
  .theme-toggle:hover{background:var(--hover)}
  #chartCard{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative}
  #chart{height:68vh;min-height:520px}
  .tf-card{background:rgba(80,90,160,.08);border:1px solid rgba(99,102,241,.25);border-radius:12px;padding:10px;margin-bottom:10px}
  .tf-head{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg, rgba(99,102,241,.16), transparent);border-radius:8px;padding:6px 10px;margin:-4px -2px 8px;font-weight:800}
  .tf-body{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .control label{display:block;font-size:13px;font-weight:800;margin-bottom:6px;color:#cbd5ff}
  .control select{width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px}

  /* toggle chips */
  .toggle-row{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 10px;overflow:visible}
  .chip{border:1px solid #2b3548;border-radius:999px;padding:6px 12px;cursor:pointer;font-weight:700;opacity:.95;user-select:none;transition:background .15s,color .15s,border-color .15s;position:relative;z-index:0;overflow:visible;box-shadow:none}
  .chip[data-k="SMA20"]{border-color:var(--c-sma20);color:var(--c-sma20)}
  .chip[data-k="SMA50"]{border-color:var(--c-sma50);color:var(--c-sma50)}
  .chip[data-k="SMA200"]{border-color:var(--c-sma200);color:var(--c-sma200)}
  .chip[data-k="RSI"]{border-color:var(--c-rsi);color:var(--c-rsi)}
  .chip[data-k="MACD"]{border-color:var(--c-macd);color:var(--c-macd)}
  .chip[data-k="VOL"]{border-color:var(--c-vol);color:var(--c-vol)}
  .chip[data-k="AUTOFIB"]{border-color:#8b5cf6;color:#8b5cf6}
  .chip[data-k="ICHI"]{border-color:#60a5fa;color:#60a5fa}
  .chip.active[data-k="SMA20"]{background:rgba(34,197,94,.12)}
  .chip.active[data-k="SMA50"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SMA200"]{background:rgba(245,158,11,.12)}
  .chip.active[data-k="RSI"]{background:rgba(167,139,250,.12)}
  .chip.active[data-k="MACD"]{background:rgba(56,189,248,.12)}
  .chip.active[data-k="VOL"]{background:rgba(16,185,129,.12)}
  .chip.active[data-k="AUTOFIB"]{background:rgba(139,92,246,.12)}
  .chip.active[data-k="ICHI"]{background:rgba(96,165,250,.12)}

  /* bright glow for active chips */
  .chip.active,
  .chip[aria-pressed="true"],
  .chip[data-on="true"]{
    box-shadow:
      0 0 0 1px rgba(70,209,255,.75) inset,
      0 0 10px rgba(70,209,255,.45),
      0 0 24px rgba(70,209,255,.25);
    border-width:2px;
  }
  .chip.active::after,
  .chip[aria-pressed="true"]::after,
  .chip[data-on="true"]::after{
    content:"";position:absolute;inset:-6px;border-radius:inherit;background:radial-gradient(60% 60% at 50% 50%,rgba(70,209,255,.40) 0%,rgba(70,209,255,0) 70%);
    filter:blur(10px);z-index:-1;pointer-events:none;
  }

  /* remove mobile bottom nav completely */
  .btmnav{display:none !important}
</style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <div class="ticker-wrap">
        <label for="q">Ticker</label>
        <div class="input-wrap">
          <input id="q" class="ticker-input" type="text" placeholder="AAPL, MSFTâ€¦ or BTC" spellcheck="false" autocomplete="off"/>
        </div>
        <button id="searchBtn" class="btn inline" type="button">Search</button>
      </div>
      <div class="toolsbar">
        <button class="tool-btn" id="wideBtn">â†”ï¸Ž <span>Wide</span></button>
        <button class="tool-btn" id="maxBtn">â¤¢ <span>Max</span></button>
        <button class="tool-btn" id="refreshBtn">âŸ³ <span>Refresh</span></button>
        <button id="themeToggle" class="theme-toggle" type="button">ðŸŒ™ Dark</button>
      </div>
    </div>

    <div id="info" class="info" style="background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px">
      <h3 id="headline" style="margin:0 0 6px 0"></h3>
      <div style="opacity:.9;font-size:14px;line-height:1.6">
        <div id="lastLine">Last: â€” Â· Change: â€”</div>
        <div id="prevCloseLine">Yesterdayâ€™s Close: â€”</div>
        <div id="ivLine">Intrinsic Value: â€”</div>
      </div>
    </div>

    <div id="chartCard">
      <div class="tf-card" id="tfCard" data-open="true">
        <div class="tf-head" id="tfHead"><span class="carat">â–¾</span> <span style="font-style:italic">time frame</span></div>
        <div class="tf-body">
          <div class="control">
            <label for="timeSel">Time</label>
            <select id="timeSel">
              <option value="6mo" selected>6 months</option>
              <option value="3mo">3 months</option>
              <option value="1y">1 year</option>
              <option value="2y">2 years</option>
              <option value="5y">5 years</option>
              <option value="max">All Data</option>
            </select>
          </div>
          <div class="control">
            <label for="freqSel">Frequency</label>
            <select id="freqSel">
              <option value="1d" selected>Daily</option>
              <option value="1wk">Weekly</option>
              <option value="1mo">Monthly</option>
            </select>
          </div>
        </div>
      </div>

      <div class="toggle-row" id="toggles">
        <div class="chip active" data-k="SMA20">SMA 20</div>
        <div class="chip active" data-k="SMA50">SMA 50</div>
        <div class="chip active" data-k="SMA200">SMA 200</div>
        <div class="chip active" data-k="RSI">RSI</div>
        <div class="chip active" data-k="MACD">MACD</div>
        <div class="chip active" data-k="VOL">Volume</div>
        <div class="chip" data-k="AUTOFIB">Auto Fib</div>
        <div class="chip active" data-k="ICHI">Ichimoku</div>
      </div>

      <div id="chart"></div>
    </div>
  </div>

<script>
(function(){
  const q = s => document.querySelector(s);
  const els = {
    input:q('#q'), searchBtn:q('#searchBtn'),
    lastLine:q('#lastLine'), prevCloseLine:q('#prevCloseLine'), ivLine:q('#ivLine'),
    headline:q('#headline'),
    chart:q('#chart'), chartCard:q('#chartCard'),
    timeSel:q('#timeSel'), freqSel:q('#freqSel'),
    toggles:q('#toggles'), themeToggle:q('#themeToggle')
  };
  const cssVar = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();

  /* ---- helpers ---- */
  function SMA(vals,w){ const out=new Array(vals.length).fill(null); let sum=0,count=0;
    for(let i=0;i<vals.length;i++){ const v=vals[i]; if(Number.isFinite(v)){sum+=v;count++;}
      if(i>=w){ const old=vals[i-w]; if(Number.isFinite(old)){sum-=old;count--;} }
      if(i>=w-1) out[i]=sum/count;
    } return out;
  }
  function EMA(vals,span){ const out=new Array(vals.length).fill(null),k=2/(span+1); let ema=null;
    for(let i=0;i<vals.length;i++){ const v=vals[i]; if(!Number.isFinite(v)){ out[i]=(i?out[i-1]:null); continue; }
      ema=(ema==null)?v:v*k+ema*(1-k); out[i]=ema; } return out;
  }
  function RSI(values, p=14){
    const rsi=new Array(values.length).fill(null); if(values.length<=p) return rsi;
    let g=0,l=0; for(let i=1;i<=p;i++){ const d=values[i]-values[i-1]; if(d>0) g+=d; else l-=d; }
    g/=p; l/=p; rsi[p]=100-100/(1+(g/(l||1e-10)));
    for(let i=p+1;i<values.length;i++){ const d=values[i]-values[i-1];
      if(d>0){ g=(g*(p-1)+d)/p; l=(l*(p-1))/p; } else { g=(g*(p-1))/p; l=(l*(p-1)-d)/p; }
      rsi[i]=100-100/(1+(g/(l||1e-10)));
    } return rsi;
  }
  function MACD(close,f=12,s=26,sig=9){ const ef=EMA(close,f), es=EMA(close,s);
    const macd=close.map((_,i)=> (ef[i]!=null&&es[i]!=null)? ef[i]-es[i] : null);
    const signal=EMA(macd.map(x=>x==null?null:x),sig);
    const hist=macd.map((m,i)=> (m!=null&&signal[i]!=null)? (m-signal[i]) : null);
    return {macd,signal,hist};
  }

  /* ---- Ichimoku ---- */
  function rollingHigh(a,w){ const out=new Array(a.length).fill(null); for(let i=0;i<a.length;i++){ if(i<w-1) continue; let h=-Infinity; for(let j=i-w+1;j<=i;j++){ if(Number.isFinite(a[j])) h=Math.max(h,a[j]); } out[i]=h>-Infinity?h:null; } return out; }
  function rollingLow(a,w){ const out=new Array(a.length).fill(null); for(let i=0;i<a.length;i++){ if(i<w-1) continue; let l=Infinity; for(let j=i-w+1;j<=i;j++){ if(Number.isFinite(a[j])) l=Math.min(l,a[j]); } out[i]=l<Infinity?l:null; } return out; }
  function shiftFwd(arr,k,n){ const out=new Array(n).fill(null); for(let i=0;i<n;i++) if(i+k<n) out[i+k]=arr[i]; return out; }
  function shiftBack(arr,k,n){ const out=new Array(n).fill(null); for(let i=0;i<n;i++) if(i-k>=0) out[i-k]=arr[i]; return out; }
  function calcIchimoku(rows){
    const n=rows.length, high=rows.map(r=>r.h), low=rows.map(r=>r.l), close=rows.map(r=>r.c);
    const ten=(rollingHigh(high,9).map((h,i)=> (h+rollingLow(low,9)[i])/2));
    const kij=(rollingHigh(high,26).map((h,i)=> (h+rollingLow(low,26)[i])/2));
    const spanA0=ten.map((t,i)=>(t!=null&&kij[i]!=null)?(t+kij[i])/2:null);
    const spanB0=rollingHigh(high,52).map((h,i)=>(h+rollingLow(low,52)[i])/2);
    const spanA=shiftFwd(spanA0,26,n), spanB=shiftFwd(spanB0,26,n), chik=shiftBack(close,26,n);
    return {tenkan:ten,kijun:kij,spanA,spanB,chikou:chik};
  }
  function segmentCloud(a,b){
    const n=a.length, gLow=Array(n).fill(null), gUp=Array(n).fill(null), rLow=Array(n).fill(null), rUp=Array(n).fill(null);
    for(let i=0;i<n;i++){ const A=a[i], B=b[i]; if(!Number.isFinite(A)||!Number.isFinite(B)) continue; if(A>=B){ gLow[i]=B; gUp[i]=A; } else { rLow[i]=A; rUp[i]=B; } }
    return { gLow,gUp,rLow,rUp };
  }

  /* ---- Data fetch (expects your existing /api/* endpoints) ---- */
  async function fetchChart(ticker, range, interval){
    const r=await fetch(`/api/chart?ticker=${encodeURIComponent(ticker)}&range=${range}&interval=${interval}`,{cache:'no-store'});
    if(!r.ok) throw new Error('chart '+r.status);
    const j=await r.json(); const res=j?.chart?.result?.[0]; if(!res) throw new Error('no result');
    const q=res.indicators?.quote?.[0]||{}; const ts=res.timestamp||[]; const adj=res.indicators?.adjclose?.[0]?.adjclose;
    const rows=[];
    for(let i=0;i<ts.length;i++){
      const o=q.open?.[i], h=q.high?.[i], l=q.low?.[i]; const cRaw=(adj && adj[i]!=null)?adj[i]:q.close?.[i]; const v=q.volume?.[i];
      if([o,h,l,cRaw].every(Number.isFinite)) rows.push({date:new Date(ts[i]*1000),o:+o,h:+h,l:+l,c:+cRaw,v:+(v||0)});
    }
    return rows;
  }

  function getVisibleData(full, range){
    const daysMap={'3mo':93,'6mo':182,'1y':365,'2y':730,'5y':1825,'max':36500};
    const days=daysMap[range] ?? 182; const cutoff=new Date(Date.now()-days*864e5);
    return full.filter(r=>r.date>=cutoff);
  }

  function buildData(rows, toggles){
    const x=rows.map(r=>r.date);
    const open=rows.map(r=>r.o), high=rows.map(r=>r.h), low=rows.map(r=>r.l), close=rows.map(r=>r.c), vol=rows.map(r=>r.v);

    const sma20=SMA(close,20), sma50=SMA(close,50), sma200=SMA(close,200);
    const macd=MACD(close), rsi=RSI(close,14);

    const data=[];

    // Ichimoku cloud first so it sits behind candles
    if(toggles.ICHI){
      const ichi=calcIchimoku(rows);
      const cloud=segmentCloud(ichi.spanA, ichi.spanB);
      data.push(
        {type:'scatter',x,y:cloud.gLow,yaxis:'y',line:{width:0},hoverinfo:'skip',showlegend:false,connectgaps:true},
        {type:'scatter',x,y:cloud.gUp ,yaxis:'y',fill:'tonexty',line:{width:0},fillcolor:cssVar('--c-ichi-up'), hoverinfo:'skip',name:'Kumo +',opacity:1,connectgaps:true},
        {type:'scatter',x,y:cloud.rLow,yaxis:'y',line:{width:0},hoverinfo:'skip',showlegend:false,connectgaps:true},
        {type:'scatter',x,y:cloud.rUp ,yaxis:'y',fill:'tonexty',line:{width:0},fillcolor:cssVar('--c-ichi-down'),hoverinfo:'skip',name:'Kumo -',opacity:1,connectgaps:true},
        {type:'scatter',x,y:ichi.tenkan,yaxis:'y',name:'Tenkan',line:{width:1,color:cssVar('--c-ichi-tenkan')}},
        {type:'scatter',x,y:ichi.kijun ,yaxis:'y',name:'Kijun', line:{width:1,color:cssVar('--c-ichi-kijun')}},
        {type:'scatter',x,y:ichi.chikou,yaxis:'y',name:'Chikou',line:{width:1,color:cssVar('--c-ichi-chikou')}}
      );
    }

    data.push({
      type:'candlestick', x, open, high, low, close, name:'Price',
      increasing:{line:{color:cssVar('--c-up'),width:1.15}},
      decreasing:{line:{color:cssVar('--c-down'),width:1.15}},
      whiskerwidth:0.4, opacity:0.95
    });

    if(toggles.SMA20)  data.push({type:'scatter',x,y:sma20, yaxis:'y',name:'SMA 20', line:{width:1.2,color:cssVar('--c-sma20')},connectgaps:true});
    if(toggles.SMA50)  data.push({type:'scatter',x,y:sma50, yaxis:'y',name:'SMA 50', line:{width:1.2,color:cssVar('--c-sma50')},connectgaps:true});
    if(toggles.SMA200) data.push({type:'scatter',x,y:sma200,yaxis:'y',name:'SMA 200',line:{width:1.2,color:cssVar('--c-sma200')},connectgaps:true});

    if(toggles.RSI){
      data.push(
        {type:'scatter',x,y:rsi,yaxis:'y2',name:'RSI',line:{width:1.1,color:cssVar('--c-rsi')}},
        {type:'scatter',x,y:Array(x.length).fill(70),yaxis:'y2',name:'70',line:{width:.8,dash:'dot'}},
        {type:'scatter',x,y:Array(x.length).fill(30),yaxis:'y2',name:'30',line:{width:.8,dash:'dot'}}
      );
    }
    if(toggles.MACD){
      data.push(
        {type:'scatter',x,y:macd.macd,yaxis:'y4',name:'MACD',line:{width:1,color:cssVar('--c-macd')}},
        {type:'scatter',x,y:macd.signal,yaxis:'y4',name:'Signal',line:{width:1}},
        {type:'bar',x,y:macd.hist,yaxis:'y4',name:'Hist',opacity:.4}
      );
    }
    if(toggles.VOL){
      data.push({type:'bar',x,y:vol,yaxis:'y3',name:'Volume',opacity:.4,marker:{color:cssVar('--c-vol')}});
    }

    return data;
  }

  function currentToggles(){
    const t={SMA20:false,SMA50:false,SMA200:false,RSI:false,MACD:false,VOL:false,AUTOFIB:false,ICHI:false};
    els.toggles.querySelectorAll('.chip').forEach(c=>{ if(c.classList.contains('active')) t[c.dataset.k]=true; });
    return t;
  }

  function layoutBase(){
    const panelBg=getComputedStyle(els.chartCard).backgroundColor;
    return {
      margin:{ l:56, r:28, t:18, b:32 },
      paper_bgcolor:panelBg, plot_bgcolor:panelBg,
      xaxis:{ domain:[0,1], showgrid:true, gridcolor:cssVar('--grid'), rangeslider:{visible:false} },
      yaxis:{ title:'Price', side:'right', showgrid:true, gridcolor:cssVar('--grid') },
      yaxis2:{ domain:[0.00, 0.17], title:'RSI',  range:[0,100], gridcolor:cssVar('--grid') },
      yaxis3:{ domain:[0.20, 0.31], title:'Vol',  gridcolor:cssVar('--grid') },
      yaxis4:{ domain:[0.34, 0.49], title:'MACD', gridcolor:cssVar('--grid') },
      legend:{orientation:'h'}
    };
  }

  /* ---- main ---- */
  async function render(sym){
    els.headline.textContent=sym;
    try{
      const full=await fetchChart(sym, els.timeSel.value, '1d');
      const rows=getVisibleData(full, els.timeSel.value);
      const data=buildData(rows, currentToggles());
      await Plotly.newPlot(els.chart, data, layoutBase(), {displayModeBar:true, responsive:true});
    }catch(e){
      els.headline.textContent = 'Error: '+(e.message||e);
    }
  }

  // toggle events
  els.toggles.addEventListener('click', (e)=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    chip.classList.toggle('active');
    if(els.chart.data) { render(q('#q').value.trim().toUpperCase()||'AAPL'); }
  });

  // initial
  q('#q').value='AAPL';
  q('#searchBtn').addEventListener('click', ()=> render(q('#q').value.trim().toUpperCase()||'AAPL'));
  render('AAPL');
})();
</script>
</body>
</html>
