<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Analyzer v.043</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="/assets/stratus-trader-wide.png">

<!-- Plotly (no defer) -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<style>
  :root{
    --bg:#0f1115;--panel:#151923;--text:#e5e7eb;--muted:#9ca3af;
    --accent:#22c55e;--focus:#3b82f6;--border:#23283a;--hover:#161a25;
    --metric-bg:#1a1f2e;--metric-border:#2a2f3e;
    --field-bg:#0c0f16;--field-text:#e5e7eb;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#60a5fa;--c-sma200:#f59e0b; /* back to yellowish 200 SMA */
    --c-rsi:#a78bfa;--c-macd:#38bdf8;--c-vol:#10b981;
    --grid:#283044;
    --lvl-beginner:#22c55e; --lvl-intermediate:#f59e0b; --lvl-advanced:#ef4444;
    --tf-bg:#1c1f35; --tf-head:#1a214e; --tf-glow:#3b82f6;
    --c-ichi-tenkan:#f59e0b; --c-ichi-kijun:#60a5fa; --c-ichi-chikou:#f472b6; /* pinkish chikou like Fidelity */
    --c-ichi-up:rgba(34,197,94,.45);
    --c-ichi-down:rgba(239,68,68,.40);
    --c-ichi-spanA:#22c55e; /* Senkou Span A line */
    --c-ichi-spanB:#ef4444; /* Senkou Span B line */
  }
  .light{
    --bg:#f8fafc;--panel:#fff;--text:#222;--muted:#64748b;
    --accent:#22c55e;--focus:#3b82f3;--border:#e2e8f0;--hover:#f1f5f9;
    --metric-bg:#f1f5f9;--metric-border:#e2e8f0;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#2563eb;--c-sma200:#f59e0b; /* yellowish in light too */
    --c-rsi:#7c3aed;--c-macd:#0ea5e9;--c-vol:#16a34a;
    --grid:#e5e7eb; --tf-bg:#eef2ff; --tf-head:#c7d2fe; --tf-glow:#6366f1;
    --field-bg:#ffffff; --field-text:#111827;
  }
  *{box-sizing:border-box}
  html,body{overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh;padding:20px;transition:background .2s,color .2s}
  .container{max-width:1100px;margin:0 auto}
  .toolbar{position:sticky;top:0;z-index:12000;display:flex;gap:10px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin-bottom:16px;flex-wrap:wrap}
  .ticker-wrap{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
  .ticker-wrap label{font-weight:800;opacity:.9}
  .input-wrap{position:relative;flex:0 1 460px;max-width:460px;width:100%}
  @media (max-width:720px){ .input-wrap{flex:1 1 100%;max-width:100%} }
  .ticker-input{width:100%;min-width:120px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--field-bg);color:var(--field-text);text-transform:uppercase;font-size:16px}
  .btn{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn.inline{padding:8px 12px}
  .toolsbar{display:flex;align-items:center;gap:8px;margin-left:auto;flex:1 1 100%;justify-content:flex-start;flex-wrap:wrap}
  .tool-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:700;cursor:pointer}
  .tool-btn:hover{background:var(--hover)}
  .theme-toggle{margin-left:auto;cursor:pointer;padding:8px 14px;border-radius:8px;background:var(--panel);color:var(--text);border:1px solid var(--border);font-weight:600}
  .theme-toggle:hover{background:var(--hover)}
  .theme-toggle.active{background:var(--accent);color:#fff}
  .ac{position:absolute;left:0;top:calc(100% + 6px);width:100%;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;display:none;max-height:280px;overflow:auto;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:12050}
  .ac.show{display:block}
  /* Give the ticker more room so it doesn't feel cramped */
  .ac-item{padding:12px 14px;display:grid;grid-template-columns:minmax(160px, 240px) 1fr;gap:12px;align-items:center;cursor:pointer;border-bottom:1px solid var(--metric-border)}
  .ac-item:hover,.ac-item.active{background:var(--hover)}
  .ticker{font-weight:800}
  .company{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .info{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;position:relative}
  .info-logo{position:absolute;top:10px;right:12px;height:54px;opacity:.92;pointer-events:none;filter:drop-shadow(0 2px 8px rgba(0,0,0,.35))}
  .light .info-logo{mix-blend-mode:multiply;filter:drop-shadow(0 2px 6px rgba(0,0,0,.12));opacity:.95}
  @media (max-width:640px){ .info-logo{height:42px;right:10px} }
  #chartCard{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative}
  #chart{height:68vh;min-height:520px}
  .container.wide{max-width:100%!important}
  #chartCard.max{position:fixed;inset:12px;z-index:9999;margin:0!important;width:auto!important;height:auto!important;overflow:auto}
  #chartCard.max #chart{height:calc(100vh - 160px)!important;min-height:400px;cursor:zoom-out}
  .tf-card{background:var(--tf-bg);border:1px solid rgba(99,102,241,.25);border-radius:12px;padding:10px;margin-bottom:10px;box-shadow:0 0 0 1px rgba(99,102,241,.15) inset}
  .tf-head{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg, var(--tf-head), transparent);border-radius:8px;padding:6px 10px;margin:-4px -2px 8px;font-weight:800}
  .tf-head .carat{display:inline-block;transform:rotate(-90deg);transition:transform .15s ease}
  .tf-card[data-open="true"] .carat{transform:rotate(0)}
  .tf-body{display:none}
  .tf-card[data-open="true"] .tf-body{display:grid}
  .tf-body{grid-template-columns:1fr 1fr;gap:10px}
  .control label{display:block;font-size:13px;font-weight:800;margin-bottom:6px;color:#cbd5ff}
  .control select{width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px}
  .toggle-row{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 10px}
  .chip{border:1px solid #2b3548;border-radius:999px;padding:6px 12px;cursor:pointer;font-weight:800;opacity:.98;user-select:none;transition:background .15s,color .15s,border-color .15s; -webkit-text-fill-color: currentColor; color: currentColor; background: color-mix(in srgb, var(--panel), #ffffff 3%);} 
  .chip:not(.active){filter: saturate(0.95) brightness(1.02);} 
  /* Chip base colors (fixed typos) */
  .chip[data-k="SMA20"]{border-color:var(--c-sma20);color:var(--c-sma20);} 
  /* fixed var() syntax below */
  .chip[data-k="SMA50"]{border-color:var(--c-sma50);color:var(--c-sma50);} 
  .chip[data-k="SMA200"]{border-color:var(--c-sma200);color:var(--c-sma200);} 
  .chip[data-k="RSI"]{border-color:var(--c-rsi);color:var(--c-rsi);} 
  .chip[data-k="MACD"]{border-color:var(--c-macd);color:var(--c-macd);} 
  .chip[data-k="VOL"]{border-color:var(--c-vol);color:var(--c-vol);} 
  .chip[data-k="AUTOFIB"]{border-color:#8b5cf6;color:#8b5cf6}
  .chip[data-k="ICHI"]{border-color:#60a5fa;color:#60a5fa}
  .chip[data-k="SESS"]{border-color:#93c5fd;color:#93c5fd}
  .chip[data-k="STOCH"]{border-color:#14b8a6;color:#14b8a6}

  /* Active backgrounds (kept) */
  .chip.active[data-k="SMA20"]{background:rgba(34,197,94,.12)}
  .chip.active[data-k="SMA50"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SMA200"]{background:rgba(245,158,11,.12)}
  .chip.active[data-k="RSI"]{background:rgba(167,139,250,.12)}
  .chip.active[data-k="MACD"]{background:rgba(56,189,248,.12)}
  .chip.active[data-k="VOL"]{background:rgba(16,185,129,.12)}
  .chip.active[data-k="AUTOFIB"]{background:rgba(139,92,246,.12)}
  .chip.active[data-k="ICHI"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SESS"]{background:rgba(147,197,253,.12)}
  .chip.active[data-k="STOCH"]{background:rgba(20,184,166,.12)}

  /* Bright glow for active chips only (already present; keep it)
     This guarantees inactive chips have NO glow. */
  .chip{position:relative}
  /* Make active chip glow subtle to match button color */
  .chip.active{border-width:2px; box-shadow:0 0 0 1px currentColor;}
  .chip.active::after{display:none}
  .light .chip.active::after{display:none}
  .chip:focus-visible{outline:2px solid currentColor;outline-offset:3px}
  .section-sep{margin:20px -16px 16px;padding:0 16px}
  .section-sep .rule{height:3px;border-radius:999px;background:linear-gradient(90deg,var(--focus),var(--accent));opacity:.9}
  .sheet{position:fixed;left:0;right:0;bottom:0;top:auto;background:transparent;display:flex;justify-content:center;z-index:2000}
  .sheet[hidden]{display:none!important}
  .sheet-inner{width:min(760px,100%);background:var(--panel);border-top:1px solid var(--border);border-radius:16px 16px 0 0;box-shadow:0 -8px 30px rgba(0,0,0,.35);padding:14px;animation:sheetUp .18s ease-out;padding-bottom:max(14px, env(safe-area-inset-bottom))}
  .sheet-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .sheet-title{font-weight:800;font-size:16px}
  .sheet-close{background:transparent;border:0;color:var(--text);font-size:18px;cursor:pointer}
  .sheet-body{max-height:58vh;overflow:auto}
  @keyframes sheetUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
  .btmnav{position:fixed;left:0;right:0;bottom:0;display:none;background:var(--panel);border-top:1px solid var(--border);padding:6px 10px;z-index:1000}
  .btmnav .tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 8px;border-radius:10px;border:0;background:transparent;color:var(--text);font-weight:700;font-size:13px}
  .btmnav .tab.active{background:var(--hover)}
  .btmnav .tab span{font-size:11px;opacity:.85}
  @media (max-width:720px){ .btmnav{display:flex;gap:8px} body{padding-bottom:64px} }
  .scr-list{display:flex;flex-direction:column;gap:10px}
  .scr-item{
    position:relative; display:flex; gap:12px; align-items:flex-start;
    padding:12px 14px; border:1px solid var(--border); border-radius:12px;
    background:color-mix(in hsl, var(--panel), var(--bg) 35%);
    text-decoration:none; color:inherit; cursor:pointer;
    transition:background .15s,border-color .15s,transform .06s;
  }
  .scr-item:hover{ background:var(--hover); border-color:#2b3548; transform:translateY(-1px); }
  .scr-item::before{ content:""; position:absolute; left:0; top:8px; bottom:8px; width:4px; border-radius:999px; background: var(--lvl-color, #64748b); opacity:.8; }
  .scr-item{ padding-left:16px; }
  .scr-item[data-lvl="Beginner"]     { --lvl-color: var(--lvl-beginner); }
  .scr-item[data-lvl="Intermediate"] { --lvl-color: var(--lvl-intermediate); }
  .scr-item[data-lvl="Advanced"]     { --lvl-color: var(--lvl-advanced); }
  .scr-item .title{ font-weight:800; font-size:14px; line-height:1.25; }
  .scr-item .desc{ font-size:12px; color:var(--muted); margin-top:2px; }
  .badge{ font-size:11px; font-weight:800; padding:2px 8px; border-radius:999px; background:var(--metric-bg); border:1px solid var(--metric-border); color:var(--muted); white-space:nowrap; margin-top:2px; }
  .scr-item .open-btn{ margin-left:8px; padding:6px 10px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); text-decoration:none; font-weight:700; }
  .scr-item .open-btn:hover{ background:var(--hover); }

  /* === Button glow (added) === */
  .btn, .tool-btn, .theme-toggle, .btmnav .tab {
    --glow-color: var(--focus);
    position: relative;
    transition: box-shadow .15s, transform .06s, background .15s, border-color .15s;
  }
  .btn { --glow-color: var(--accent); }
  .btn:hover, .btn:focus-visible,
  .tool-btn:hover, .tool-btn:focus-visible,
  .theme-toggle:hover, .theme-toggle:focus-visible,
  .btmnav .tab:hover, .btmnav .tab:focus-visible {
    box-shadow:
      0 0 0 2px var(--glow-color),
      0 0 10px var(--glow-color),
      0 0 24px 6px var(--glow-color),
      0 0 40px 12px var(--glow-color);
    z-index: 1;
  }
  .btn:hover::after, .btn:focus-visible::after,
  .tool-btn:hover::after, .tool-btn:focus-visible::after,
  .theme-toggle:hover::after, .theme-toggle:focus-visible::after,
  .btmnav .tab:hover::after, .btmnav .tab:focus-visible::after {
    content: "";
    position: absolute;
    inset: -10px;
    border-radius: inherit;
    background: radial-gradient(60% 60% at 50% 50%, var(--glow-color) 0%, rgba(0,0,0,0) 80%);
    filter: blur(12px);
    z-index: -1;
    pointer-events: none;
    opacity: 0.7;
  }

  /* Nicer colorization for autocomplete tickers */
  /* Make tickers a distinct color and keep them on one line */
  .ac-item .ticker{ color: var(--accent); font-weight:900; letter-spacing:.3px; white-space:nowrap; }
  .ac-item:hover .ticker, .ac-item.active .ticker{ color: color-mix(in srgb, var(--accent), #ffffff 14%); }
  /* Company name muted so ticker stands out */
  .ac-item .company{ color: var(--muted); font-weight:700; }
  .ac-item:hover .company, .ac-item.active .company{ color: var(--muted); opacity:.95; }

  /* Toast */
  #toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%) translateY(40px);background:var(--panel);color:var(--text);border:1px solid var(--border);padding:10px 14px;border-radius:12px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;z-index:4000;box-shadow:0 6px 24px -2px rgba(0,0,0,.45)}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* Market Overview mini-cards */
  .mkt-row{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin:14px 0}
  @media (max-width:980px){ .mkt-row{grid-template-columns:1fr;gap:10px} }
  .mkt-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .mkt-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .mkt-title{font-weight:900;letter-spacing:.4px}
  .mkt-chg{font-weight:900}
  .mkt-chart{height:180px}

  /* Stochastics chip colors */
  .chip[data-k="STOCH"]{border-color:#14b8a6;color:#14b8a6}
  .chip.active[data-k="STOCH"]{background:rgba(20,184,166,.12)}
</style>
</head>
<body>
  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="ticker-wrap">
        <label for="q">Ticker</label>
        <div class="input-wrap">
          <input id="q" class="ticker-input" type="text" placeholder="AAPL, MSFT… or BTC" spellcheck="false" autocomplete="off"/>
          <div id="ac" class="ac" role="listbox" aria-label="Suggestions"></div>
        </div>
        <button id="searchBtn" class="btn inline" type="button">Search</button>
      </div>
      <div class="toolsbar" id="toolsBar">
        <button class="tool-btn" id="toolGPTs" aria-label="Open GPTs">🧠 <span class="tool-txt">GPTs</span></button>
        <button class="tool-btn" id="toolScreeners" aria-label="Open Screeners">🔎 <span class="tool-txt">Screeners</span></button>
        <button class="tool-btn" id="wideBtn" aria-label="Toggle Width">↔︎ <span class="tool-txt">Wide</span></button>
        <button class="tool-btn" id="maxBtn" aria-label="Maximize">⤢ <span class="tool-txt">Max</span></button>
        <button class="tool-btn" id="refreshBtn" aria-label="Refresh">⟳ <span class="tool-txt">Refresh</span></button>
      </div>
    </div>

    <!-- Info bar -->
    <div id="info" class="info">
      <h3 id="headline" style="margin:0 0 4px 0"></h3>
      <div id="subInfo" style="font-size:12px;opacity:.7;margin:0 0 6px"></div>
      <div style="opacity:.9;font-size:14px;line-height:1.6">
        <div id="companyLine" style="margin:0 0 4px 0;opacity:.95"></div>
        <div id="lastLine">Last: — · Change: —</div>
        <div id="prevCloseLine">Yesterday’s Close: —</div>
        <div id="ivLine">Intrinsic Value: —</div>
      </div>
      <img id="infoLogo" class="info-logo" src="/assets/stratus-trader-wide.png" alt="Stratus Trader" />
    </div>

    <!-- Market Overview (auto-updating) -->
    <div id="mktRow" class="mkt-row" aria-label="Market overview">
      <div class="mkt-card">
        <div class="mkt-head"><span class="mkt-title">DOW</span><span id="mkt-dji-chg" class="mkt-chg">—</span></div>
        <div id="mkt-dji" class="mkt-chart"></div>
      </div>
      <div class="mkt-card">
        <div class="mkt-head"><span class="mkt-title">NASDAQ</span><span id="mkt-ixic-chg" class="mkt-chg">—</span></div>
        <div id="mkt-ixic" class="mkt-chart"></div>
      </div>
      <div class="mkt-card">
        <div class="mkt-head"><span class="mkt-title">S&P 500</span><span id="mkt-gspc-chg" class="mkt-chg">—</span></div>
        <div id="mkt-gspc" class="mkt-chart"></div>
      </div>
    </div>

    <!-- Chart card -->
    <div id="chartCard">
      <div class="tf-card" id="tfCard" data-open="true">
        <div class="tf-head" id="tfHead"><span class="carat">▾</span> <span style="font-style:italic">time frame</span></div>
        <div class="tf-body">
          <div class="control">
            <label for="timeSel">Time</label>
            <select id="timeSel">
              <option value="1d">1 day</option><option value="2d">2 days</option>
              <option value="5d">5 days</option><option value="10d">10 days</option>
              <option value="sep" disabled>──────────</option>
              <option value="1mo">1 month</option><option value="2mo">2 months</option>
              <option value="3mo">3 months</option><option value="6mo" selected>6 months</option>
              <option value="ytd">YTD</option><option value="1y">1 year</option>
              <option value="2y">2 years</option><option value="3y">3 years</option>
              <option value="4y">4 years</option><option value="5y">5 years</option>
              <option value="10y">1 decade</option><option value="max">All Data</option>
            </select>
          </div>
          <div class="control">
            <label for="freqSel">Frequency</label>
            <select id="freqSel">
              <option value="1m">1-Minute</option><option value="5m">5-Minute</option>
              <option value="15m">15-Minute</option><option value="60m">Hourly</option>
              <option value="sep" disabled>──────────</option>
              <option value="1d" selected>Daily</option><option value="1wk">Weekly</option>
              <option value="1mo">Monthly</option><option value="3mo">Quarterly</option>
              <option value="1y">Yearly</option>
            </select>
          </div>
          <div class="control" style="grid-column:1 / -1">
            <label for="heightSel">Candle height <span id="heightLabel" style="opacity:.7;margin-left:6px">Balanced</span></label>
            <input id="heightSel" type="range" min="0" max="100" value="75" step="1" style="width:100%" />
          </div>
        </div>
      </div>

      <div class="toggle-row" id="toggles">
        <button class="chip" data-k="SMA20" type="button" aria-pressed="false">SMA 20</button>
        <button class="chip" data-k="SMA50" type="button" aria-pressed="false">SMA 50</button>
        <button class="chip" data-k="SMA200" type="button" aria-pressed="false">SMA 200</button>
        <button class="chip" data-k="RSI" type="button" aria-pressed="false">RSI</button>
        <button class="chip" data-k="MACD" type="button" aria-pressed="false">MACD</button>
        <button class="chip" data-k="VOL" type="button" aria-pressed="false">Volume</button>
        <button class="chip" id="autoFib" data-k="AUTOFIB" type="button" aria-pressed="false">Auto Fib</button>
        <button class="chip" data-k="ICHI" type="button" aria-pressed="false">Ichimoku</button>
        <button class="chip" data-k="SESS" type="button" aria-pressed="true" title="Toggle pre/post-market bands">Pre/Post</button>
        <button class="chip active" data-k="STOCH" type="button" aria-pressed="true">Stoch</button>
      </div>

      <div id="chart"></div>
    </div>

    <div class="section-sep" aria-hidden="true"><div class="rule"></div></div>
  </div>

  <!-- GPTs Sheet -->
  <div class="sheet" id="sheetGPTs" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">GPTs</div>
        <button class="sheet-close" data-close="sheetGPTs">✕</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" style="margin-bottom:12px">
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">9 Prompts for Smarter Investing</div>
              <div class="desc">Bundle of prompts to guide smarter investment analysis.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-687b911701a08191aadd69c345a67d17-9-prompts-for-smarter-investing" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">Stock Predictor Prompt GPT</div>
              <div class="desc">Structured prompt flow for scenario-led stock predictions.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-686c5fc3dd948191a0ff9c14cecda1b4-stock-predictor-prompt-gpt" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">High Yield Dividend Sniper</div>
              <div class="desc">Quickly target high-yield dividend candidates.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-6878fe277c5c819180211289d9e16148-high-yield-dividend-sniper" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
        </div>
        <div>
          <textarea id="gptInput" rows="4" placeholder="Ask a question about the current ticker…" style="width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button class="btn" id="askGPT">Ask</button>
            <div style="font-size:12px;color:var(--muted)">Uses the visible chart context when possible.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Screeners Sheet -->
  <div class="sheet" id="sheetScreeners" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">Screeners</div>
        <button class="sheet-close" data-close="sheetScreeners">✕</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" id="scrList"></div>
      </div>
    </div>
  </div>

  <nav class="btmnav" id="btmNav" role="navigation" aria-label="Bottom Navigation">
    <button data-tab="home" class="tab active" aria-label="Home">🏠<span>Home</span></button>
    <button data-tab="screeners" class="tab" aria-label="Screeners">🔎<span>Screeners</span></button>
    <button data-tab="gpts" class="tab" aria-label="GPTs">🧠<span>GPTs</span></button>
    <button data-tab="settings" class="tab" aria-label="Settings">⚙️<span>Settings</span></button>
  </nav>

  <script>
  (() => {
    const q = s => document.querySelector(s);

    /* ---------- Elements ---------- */
    const els = {
      input:q('#q'), list:q('#ac'), searchBtn:q('#searchBtn'),
      headline:q('#headline'), subInfo:q('#subInfo'), lastLine:q('#lastLine'), prevCloseLine:q('#prevCloseLine'), ivLine:q('#ivLine'), companyLine:q('#companyLine'),
      chartCard:q('#chartCard'), chart:q('#chart'),
      timeSel:q('#timeSel'), freqSel:q('#freqSel'), toggles:q('#toggles'),
      themeToggle:q('#themeToggle'), autoFib:q('#autoFib'),
      refreshBtn:q('#refreshBtn'), maxBtn:q('#maxBtn'), wideBtn:q('#wideBtn'),
      tfCard:q('#tfCard'), tfHead:q('#tfHead'),
      btmNav:q('#btmNav'), scrList:q('#scrList'),
      // Added: tool buttons & sheet / input refs for GPTs & Screeners
      toolGPTs:q('#toolGPTs'), toolScreeners:q('#toolScreeners'),
      gptInput:q('#gptInput'), sheetGPTs:q('#sheetGPTs'), sheetScreeners:q('#sheetScreeners'),
      // Added: candle height slider + label
      heightSel:q('#heightSel'), heightLabel:q('#heightLabel')
    };

    /* ---------- Toast ---------- */
    let toast = q('#toast');
    if(!toast){ toast = document.createElement('div'); toast.id='toast'; document.body.appendChild(toast); }
    function showToast(msg, ms=2600){ toast.textContent=msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'), ms); }

    /* ---------- Sheets (GPTs / Screeners) ---------- */
    function openSheet(id){ const el=q('#'+id); if(!el) return; el.hidden=false; el.setAttribute('data-open','true'); document.body.style.overflow='hidden'; if(id==='sheetGPTs' && els.gptInput){ setTimeout(()=>els.gptInput.focus(),50); } }
    function closeSheet(id){ const el=q('#'+id); if(!el) return; el.hidden=true; el.removeAttribute('data-open'); if(![...document.querySelectorAll('.sheet')].some(s=>!s.hidden)) document.body.style.overflow=''; }
    function toggleSheet(id){ const el=q('#'+id); if(!el) return; if(el.hidden) openSheet(id); else closeSheet(id); }

    // Added handlers for Wide / Max / Refresh
    const __container = document.querySelector('.container');
    // Restore persisted wide mode
    if(localStorage.getItem('wideMode')==='1'){ __container?.classList.add('wide'); }
    if(__container?.classList.contains('wide')){ els.wideBtn?.classList.add('active'); els.wideBtn?.setAttribute('aria-pressed','true'); }

    function applyWideToggle(){ if(!__container) return; const on = __container.classList.toggle('wide'); if(on){ localStorage.setItem('wideMode','1'); } else { localStorage.removeItem('wideMode'); } const txt=els.wideBtn?.querySelector('.tool-txt'); if(txt) txt.textContent = on? 'Narrow':'Wide'; els.wideBtn?.setAttribute('aria-pressed', on?'true':'false'); }
    els.wideBtn?.addEventListener('click', ()=>{ applyWideToggle(); setTimeout(()=>{ try{ fitPriceAxisToCandlesStrict(); }catch{} }, 50); });

    function applyMaxToggle(){ const cc=els.chartCard; if(!cc) return; const now = cc.classList.toggle('max'); const txt=els.maxBtn?.querySelector('.tool-txt'); if(txt) txt.textContent = now? 'Restore':'Max'; els.maxBtn?.setAttribute('aria-pressed', now?'true':'false'); document.body.style.overflow = now? 'hidden' : ''; if(now){ setTimeout(()=>{ try{ fitPriceAxisToCandlesStrict(); }catch{} },120); } else { setTimeout(()=>{ try{ fitPriceAxisToCandlesStrict(); }catch{} },60); } }
    els.maxBtn?.addEventListener('click', applyMaxToggle);

    async function manualRefresh(){ els.refreshBtn?.setAttribute('data-busy','1'); try{ await loadAndRender(); showToast('Refreshed'); } catch{ showToast('Refresh failed'); } finally { els.refreshBtn?.removeAttribute('data-busy'); } }
    els.refreshBtn?.addEventListener('click', manualRefresh);

    // Keyboard shortcuts (optional): W=wide, M=max, R=refresh when focused on body & not typing
    document.addEventListener('keydown', e=>{ if(e.target && /INPUT|TEXTAREA|SELECT/.test(e.target.tagName)) return; if(e.metaKey||e.altKey||e.ctrlKey) return; if(e.key==='w'||e.key==='W'){ applyWideToggle(); } else if(e.key==='m'||e.key==='M'){ applyMaxToggle(); } else if(e.key==='r'||e.key==='R'){ manualRefresh(); } });

    // Added: highlightTab + bottom nav wiring (was missing, causing button logic to fail)
    function highlightTab(tab){ if(!els.btmNav) return; els.btmNav.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===tab)); }
    els.btmNav?.addEventListener('click', e=>{ const tab=e.target.closest('.tab'); if(!tab) return; const k=tab.dataset.tab; if(k==='home'){ closeSheet('sheetGPTs'); closeSheet('sheetScreeners'); highlightTab('home'); return; } if(k==='gpts'){ const isOpen = !els.sheetGPTs.hidden; if(isOpen){ closeSheet('sheetGPTs'); highlightTab('home'); } else { openSheet('sheetGPTs'); highlightTab('gpts'); } return; } if(k==='screeners'){ const isOpen = !els.sheetScreeners.hidden; if(isOpen){ closeSheet('sheetScreeners'); highlightTab('home'); } else { ensureScreeners(); openSheet('sheetScreeners'); highlightTab('screeners'); } return; } if(k==='settings'){ showToast('Settings coming soon'); highlightTab('settings'); } });

    document.addEventListener('click', e=>{ const btn=e.target.closest('[data-close]'); if(btn){ closeSheet(btn.getAttribute('data-close')); } });
    // Restored: direct open + tab highlight (no toggle) for consistent UX across devices
    // REPLACED with toggle behavior per request
    els.toolGPTs?.addEventListener('click', ()=>{ const isOpen = !els.sheetGPTs?.hidden; if(isOpen){ closeSheet('sheetGPTs'); highlightTab('home'); } else { openSheet('sheetGPTs'); highlightTab('gpts'); } });
    els.toolScreeners?.addEventListener('click', ()=>{ const isOpen = !els.sheetScreeners?.hidden; if(isOpen){ closeSheet('sheetScreeners'); highlightTab('home'); } else { ensureScreeners(); openSheet('sheetScreeners'); highlightTab('screeners'); } });

    // Escape closes top-most sheet
    document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ const open=[...document.querySelectorAll('.sheet')].filter(s=>!s.hidden).pop(); if(open){ closeSheet(open.id); highlightTab('home'); } } });

    /* ---------- Screeners Populate (Updated with provided SCREENERS list) ---------- */
    const SCREENERS = [
      { id:"oversold_reversal", label:"Oversold Reversal", level:"Beginner", url:"https://finviz.com/screener.ashx?v=111&f=sh_price_o5,sh_relvol_o2,ta_change_u,ta_rsi_os30&ft=4&o=price", filters:["sh_price_o5","sh_relvol_o2","ta_change_u","ta_rsi_os30"] },
      { id:"new_highs", label:"New Highs (momentum)", level:"Beginner", url:"https://finviz.com/screener.ashx?v=141&f=an_recom_buy,sh_price_u7,ta_change_u,ta_highlow20d_nh,ta_highlow50d_nh,ta_highlow52w_nh,ta_perf_dup&ft=4&o=-perf1w", filters:["an_recom_buy","sh_price_u7","ta_change_u","ta_highlow20d_nh","ta_highlow50d_nh","ta_highlow52w_nh","ta_perf_dup"] },
      { id:"sma_crossover", label:"SMA 50 cross 20 (trend start)", level:"Beginner", url:"https://finviz.com/screener.ashx?v=141&f=fa_pe_profitable,sh_avgvol_o400,sh_relvol_o1,sh_short_low,ta_beta_o1,ta_sma50_cross20b&ft=4", filters:["fa_pe_profitable","sh_avgvol_o400","sh_relvol_o1","sh_short_low","ta_beta_o1","ta_sma50_cross20b"] },
      { id:"low_pe_value", label:"Low P/E Value", level:"Beginner", url:"https://finviz.com/screener.ashx?v=141&f=cap_smallunder,fa_pb_low,fa_pe_low,fa_peg_low,fa_roa_pos,fa_roe_pos,sh_price_o5&ft=4&o=-perfytd", filters:["cap_smallunder","fa_pb_low","fa_pe_low","fa_peg_low","fa_roa_pos","fa_roe_pos","sh_price_o5"] },
      { id:"bounce_ma", label:"Bounce at Moving Average", level:"Beginner", url:"https://finviz.com/screener.ashx?v=141&f=sh_avgvol_o400,sh_curvol_o2000,sh_relvol_o1,ta_sma20_pa,ta_sma50_pb&ft=4&o=-perf1w", filters:["sh_avgvol_o400","sh_curvol_o2000","sh_relvol_o1","ta_sma20_pa","ta_sma50_pb"] },
      { id:"high_rel_vol", label:"High Relative Volume", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=131&f=fa_curratio_o1,fa_epsqoq_o15,fa_quickratio_o1,fa_salesqoq_o15,sh_avgvol_o400,sh_price_o5,sh_relvol_o1.5,ta_sma20_pa,ta_sma200_sb50,ta_sma50_sa200&ft=4&o=instown", filters:["fa_curratio_o1","fa_epsqoq_o15","fa_quickratio_o1","fa_salesqoq_o15","sh_avgvol_o400","sh_price_o5","sh_relvol_o1.5","ta_sma20_pa","ta_sma200_sb50","ta_sma50_sa200"] },
      { id:"potential_uptrend_from_weekly_lows", label:"Potential Uptrend from Weekly Lows", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=141&f=sh_avgvol_o400,ta_pattern_channelup,ta_perf_1wdown&ft=4&o=perf1w", filters:["sh_avgvol_o400","ta_pattern_channelup","ta_perf_1wdown"] },
      { id:"weekly_earnings_gap_up", label:"Weekly Earnings Gap Up", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=141&f=earningsdate_tomorrowafter,sh_avgvol_o400,sh_curvol_o50,sh_short_u25,ta_averagetruerange_o0.5,ta_gap_u2&ft=4&o=-perfytd", filters:["earningsdate_tomorrowafter","sh_avgvol_o400","sh_curvol_o50","sh_short_u25","ta_averagetruerange_o0.5","ta_gap_u2"] },
      { id:"shorted_stocks", label:"Heavily Shorted (U.S.)", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=131&f=cap_smallover,geo_usa,sh_avgvol_o500,sh_curvol_o500,sh_opt_optionshort,sh_price_o3,sh_relvol_o1,sh_short_high&o=-shortinterestshare", filters:["cap_smallover","geo_usa","sh_avgvol_o500","sh_curvol_o500","sh_opt_optionshort","sh_price_o3","sh_relvol_o1","sh_short_high"] },
      { id:"short_squeeze", label:"Short Squeeze Setup", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=131&f=sh_avgvol_o100,sh_instown_u50,sh_price_o2,sh_short_o15&ft=4&o=-shortinterestshare", filters:["sh_avgvol_o100","sh_instown_u50","sh_price_o2","sh_short_o15"] },
      { id:"high_sales_growth", label:"High Sales Growth", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=111&f=fa_debteq_u0.5,fa_roe_o15,fa_sales5years_o20,fa_salesqoq_o20,sh_avgvol_o200,sh_instown_o60,sh_price_o5,sh_short_u5&ft=4", filters:["fa_debteq_u0.5","fa_roe_o15","fa_sales5years_o20","fa_salesqoq_o20","sh_avgvol_o200","sh_instown_o60","sh_price_o5","sh_short_u5"] },
      { id:"buy_hold_value", label:"Buy & Hold Value", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=121&f=cap_microover,fa_curratio_o1.5,fa_estltgrowth_o10,fa_peg_o1,fa_roe_o15,ta_beta_o1.5,ta_sma20_pa&ft=4&o=-forwardpe", filters:["cap_microover","fa_curratio_o1.5","fa_estltgrowth_o10","fa_peg_o1","fa_roe_o15","ta_beta_o1.5","ta_sma20_pa"] },
      { id:"undervalued_div_growth", label:"Undervalued Dividend Growth", level:"Intermediate", url:"https://finviz.com/screener.ashx?v=111&f=cap_largeover,fa_div_pos,fa_epsyoy1_o5,fa_estltgrowth_o5,fa_payoutratio_u50,fa_pe_u20,fa_peg_low&ft=4&o=-pe", filters:["cap_largeover","fa_div_pos","fa_epsyoy1_o5","fa_estltgrowth_o5","fa_payoutratio_u50","fa_pe_u20","fa_peg_low"] },
      { id:"oversold_next_earnings_growth", label:"Oversold + Earnings in 5d + Growth", level:"Advanced", url:"https://finviz.com/screener.ashx?v=141&f=cap_smallover,earningsdate_nextdays5,fa_epsqoq_o15,fa_epsyoy_pos,fa_epsyoy1_pos,fa_grossmargin_o20,fa_netmargin_pos,fa_sales5years_o5,fa_salesqoq_pos,sh_avgvol_o750,sh_curvol_o1000,ta_perf_52w10o,ta_rsi_nob50&ft=4&o=perfytd", filters:["cap_smallover","earningsdate_nextdays5","fa_epsqoq_o15","fa_epsyoy_pos","fa_epsyoy1_pos","fa_grossmargin_o20","fa_netmargin_pos","fa_sales5years_o5","fa_salesqoq_pos","sh_avgvol_o750","sh_curvol_o1000","ta_perf_52w10o","ta_rsi_nob50"] },
      { id:"breaking_out_quality", label:"Breaking Out (Quality balance sheet)", level:"Advanced", url:"https://finviz.com/screener.ashx?v=141&f=fa_debteq_u1,fa_roe_o20,sh_avgvol_o100,ta_highlow50d_nh,ta_sma20_pa,ta_sma200_pa,ta_sma50_pa&ft=4&o=-perf1w", filters:["fa_debteq_u1","fa_roe_o20","sh_avgvol_o100","ta_highlow50d_nh","ta_sma20_pa","ta_sma200_pa","ta_sma50_pa"] },
      { id:"high_earnings_growth", label:"High Earnings Growth", level:"Advanced", url:"https://finviz.com/screener.ashx?v=141&f=fa_epsqoq_o25,fa_epsyoy_o25,fa_epsyoy1_o25,fa_salesqoq_o25,sh_avgvol_o400,ta_rsi_nos50,ta_sma200_pa&ft=4&o=-perfytd", filters:["fa_epsqoq_o25","fa_epsyoy_o25","fa_epsyoy1_o25","fa_salesqoq_o25","sh_avgvol_o400","ta_rsi_nos50","ta_sma200_pa"] },
      { id:"consistent_growth_bullish", label:"Consistent Growth on Bullish Trend", level:"Advanced", url:"https://finviz.com/screener.ashx?v=141&f=fa_eps5years_pos,fa_epsqoq_o20,fa_epsyoy_o25,fa_epsyoy1_o15,fa_estltgrowth_pos,fa_roe_o15,sh_instown_o10,sh_price_o15,ta_highlow52w_a90h,ta_rsi_nos50&ft=4&o=-perfytd", filters:["fa_eps5years_pos","fa_epsqoq_o20","fa_epsyoy_o25","fa_epsyoy1_o15","fa_estltgrowth_pos","fa_roe_o15","sh_instown_o10","sh_price_o15","ta_highlow52w_a90h","ta_rsi_nos50"] },
      { id:"canslim", label:"CANSLIM", level:"Advanced", url:"https://finviz.com/screener.ashx?v=111&f=fa_eps5years_o20,fa_epsqoq_o20,fa_epsyoy_o20,fa_sales5years_o20,fa_salesqoq_o20,sh_curvol_o200&ft=4", filters:["fa_eps5years_o20","fa_epsqoq_o20","fa_epsyoy_o20","fa_sales5years_o20","fa_salesqoq_o20","sh_curvol_o200"] }
    ];
    const levelRank = { Beginner:0, Intermediate:1, Advanced:2 };
    function ensureScreeners(){
      if(!els.scrList) return;
      if(els.scrList.dataset.filled) return;
      const ordered=[...SCREENERS].sort((a,b)=> levelRank[a.level]-levelRank[b.level]);
      els.scrList.innerHTML = ordered.map(s=>`<div class="scr-item" data-lvl="${s.level}" data-id="${s.id}">
        <div style=\"flex:1;min-width:0\">
          <div class=\"title\">${s.label}</div>
          <div class=\"desc\" style=\"font-size:11px;opacity:.75\">${(s.filters||[]).join(' • ')}</div>
        </div>
        <div style=\"display:flex;align-items:center;gap:8px\">
          <span class=\"badge\">${s.level}</span>
          <a class=\"open-btn\" href=\"${s.url}\" target=\"_blank\" rel=\"noopener\">Open</a>
        </div>
      </div>`).join('');
      els.scrList.dataset.filled='1';
    }

    /* ---------- State ---------- */
    let CURRENT = { ticker:null, company:"", prevClose:null };
    const state = { ticker: localStorage.getItem('lastTicker')||'AAPL', range:(q('#timeSel')?.value)||'6mo', interval:(q('#freqSel')?.value)||'1d', rows:[], candleTight:+(localStorage.getItem('candleTight')||75), symbols:[], acMatches:[], acIndex:-1, quoteTimer:null, symbolsTried:0 };
    const FUNDAMENTALS = {}; // cache fundamentals per ticker
    let traceMap = {}; // map chips -> trace indices
    // Extra state for overlays/zoom
    state.fibIds = [];
    state.lastXRange = null;

    /* ---------- Utils & Formatters ---------- */
    const css = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    const fmt = v => (Number.isFinite(+v)? (+v).toFixed(2):'—'); // added simple formatter
    const fmtPx = v => Number.isFinite(+v) ? `$${(+v).toFixed(2)}` : '—';
    const fmtPct = v => Number.isFinite(+v) ? `${(+v).toFixed(2)}%` : '—';
    const clampZero = (v,eps=1e-10)=> (Number.isFinite(v)&&Math.abs(v)<eps?0:v);
    const median = (arr)=>{ const a=(arr||[]).map(Number).filter(Number.isFinite).sort((x,y)=>x-y); if(!a.length) return NaN; const m=Math.floor(a.length/2); return a.length%2? a[m] : (a[m-1]+a[m])/2; };
    const $all = (sel, root=document)=> Array.from(root.querySelectorAll(sel));
    const sanitizeTicker = s => String(s||'').split('|')[0].trim().toUpperCase();
    const normalizeTickerForFetch = t => sanitizeTicker(t).replace(/\s+/g,'').replace(/\.([A-Z0-9]{1,3})$/,'-$1'); // BRK.B -> BRK-B, etc.
    // Restrict -USD behavior to known crypto bases only
    const CRYPTO_BASE = new Set(['BTC','ETH','SOL','DOGE','XRP','ADA','LTC','BCH','BNB','SHIB']);
    function isCryptoBase(sym){ return CRYPTO_BASE.has(sym); }
    const isCryptoTicker = (t)=> /-USD$/i.test(String(t||''));
    function hideAC(){ if(els.list){ els.list.classList.remove('show'); els.list.innerHTML=''; } state.acMatches=[]; state.acIndex=-1; }
    function renderAC(){ if(!els.list) return; const items=state.acMatches||[]; if(!items.length){ els.list.innerHTML=''; els.list.classList.remove('show'); return; } const html=items.slice(0,60).map((o,i)=>`<div class="ac-item${i===state.acIndex?' active':''}" role="option" data-t="${o.t}"><span class="ticker">${o.t}</span><span class="company">${o.n||''}</span></div>`).join(''); els.list.innerHTML=html; els.list.classList.add('show'); }
    function updateAC(qstr){ const s=sanitizeTicker(qstr); if(!s){ hideAC(); return; }
      // Ensure symbols are being loaded on first use
      if(!state.symbols.length){
        loadSymbols();
        if(els.list){ els.list.innerHTML='<div style="padding:10px;font-size:12px;opacity:.65">Loading symbols…</div>'; els.list.classList.add('show'); }
        return;
      }
      const sym=state.symbols||[];
      // Normalized matching: treat '.' and '-' as equivalent (BRK.B ~ BRK-B). Only allow BTC->BTC-USD for crypto bases.
      const sN = s.replace(/\./g,'-');
      const base = sN.replace(/-USD$/,'');
      const allowUSDAlt = isCryptoBase(base);
      const sAlt = allowUSDAlt ? (/-USD$/.test(sN) ? base : (base+'-USD')) : sN; // only meaningful if crypto
      const escape = v=> v.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&');
      const re = new RegExp('^'+escape(sN));
      const reAlt = allowUSDAlt ? new RegExp('^'+escape(sAlt)) : null;
      const starts = r=>{
        const t=r.t||''; const tD=t.replace(/-/g,'.'); const tN=t.replace(/\./g,'-');
        return re.test(t) || re.test(tN) || re.test(tD) || (reAlt ? (reAlt.test(t)||reAlt.test(tN)) : false);
      };
      const contains = r=>{
        const t=r.t||''; const tD=t.replace(/-/g,'.'); const tN=t.replace(/\./g,'-');
        const sn=sN.toUpperCase(); return t.includes(s)||tN.includes(sn)||tD.includes(s);
      };
      const nameHits = r=> ((r.n||'').toUpperCase().includes(s)) || ((r.n||'').toUpperCase().includes(sN));
      const pri = sym.filter(starts);
      const sec = sym.filter(r=> !pri.includes(r) && (contains(r)));
      const name = sym.filter(r=> !pri.includes(r) && !sec.includes(r) && nameHits(r));
      const matches=[...pri,...sec,...name];
      // Only add a virtual -USD suggestion for known crypto bases
      if(allowUSDAlt && !matches.some(m=>m.t===sAlt)){
        matches.unshift({t:sAlt, n:'Crypto vs USD'});
      }
      if(!matches.length){ els.list.innerHTML='<div style="padding:10px;font-size:12px;opacity:.65">No matches</div>'; els.list.classList.add('show'); state.acMatches=[]; state.acIndex=-1; return; }
      state.acMatches=matches; state.acIndex=0; renderAC(); }
    function performSearch(t, c){
      t = sanitizeTicker(t);
      if(!t){ showToast('Enter a ticker'); return; }
      // Crypto base -> -USD if needed
      const base = t.replace(/-USD$/,'');
      if(isCryptoBase(base) && !/-USD$/.test(t)) t = base+'-USD';
      const match = (state.symbols||[]).find(r=>r.t===t) || null;
      const name = c || match?.n || '';
      state.ticker = t;
      localStorage.setItem('lastTicker', t);
      els.input.value = t;
      if(els.headline) els.headline.textContent = name ? `${t} — ${name}` : t;
      if(els.companyLine) els.companyLine.textContent = name;
      hideAC();
      try{
        if(typeof go === 'function') return void go(t, name);
        if(typeof loadAndRender === 'function') return void loadAndRender();
      }catch(err){ console.warn('search render error', err); }
    }
    function doSearch(){
      const raw = sanitizeTicker(els.input?.value || '');
      if(!raw){ showToast('Enter a ticker'); return; }
      let t = raw, name = '';
      const s = state.symbols||[];
      const exact = s.find(r=>r.t===raw) || s.find(r=>r.t===raw.replace(/\./g,'-'));
      if(exact){ t = exact.t; name = exact.n||''; }
      else {
        const base = raw.replace(/-USD$/,'');
        if(isCryptoBase(base)) t = base+'-USD';
        const f = s.find(r=>r.t===t); if(f) name=f.n||'';
      }
      performSearch(t, name);
    }

    // Input listeners for autocomplete + keyboard nav
    els.input?.addEventListener('input', (e)=> updateAC(e.target.value));
    els.input?.addEventListener('keydown', (e)=>{
      if(!els.list) return;
      const open = els.list.classList.contains('show');
      if(open && (e.key==='ArrowDown' || e.key==='ArrowUp')){
        e.preventDefault();
        const n = (state.acMatches||[]).length;
        if(!n) return;
        if(e.key==='ArrowDown') state.acIndex = (state.acIndex+1)%n;
        else state.acIndex = (state.acIndex-1+n)%n;
        renderAC();
        return;
      }
      if(open && e.key==='Enter'){
        e.preventDefault();
        const i = state.acIndex>=0 ? state.acIndex : 0;
        const it = (state.acMatches||[])[i];
        if(it){ performSearch(it.t, it.n||''); }
        hideAC();
        return;
      }
      if(e.key==='Enter'){
        e.preventDefault();
        doSearch();
        return;
      }
      if(open && e.key==='Escape'){
        hideAC();
        return;
      }
    });

    // Click selection in autocomplete list
    els.list?.addEventListener('mousedown', (e)=>{
      const item = e.target.closest('.ac-item'); if(!item) return;
      e.preventDefault();
      const t = item.getAttribute('data-t');
      const it = (state.acMatches||[]).find(x=>x.t===t);
      if(it) performSearch(it.t, it.n||'');
    });

    // Search button click
    els.searchBtn?.addEventListener('click', doSearch);

    // Close autocomplete when clicking outside
    document.addEventListener('click', e=>{ if(!els.list) return; if(e.target===els.input || e.target.closest('#ac')) return; hideAC(); });

    // ET helpers
    const dtfET = new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York',hour12:false,hour:'2-digit',minute:'2-digit',weekday:'short'});
    function isRegularSessionET(ms){ const parts=dtfET.formatToParts(new Date(ms)); const get=(t)=> parts.find(p=>p.type===t)?.value; const wd=(parts.find(p=>p.type==='weekday')?.value)||''; if(/Sat|Sun/i.test(wd)) return false; const h=+(get('hour')||'0'); const m=+(get('minute')||'0'); const hm=h+m/60; return hm>=9.5 && hm<=16.0; }
    const isIntraday = (interval)=> /m|h/i.test(String(interval||''));
    const padScaleFromTight = (t)=>{ t = Math.max(0, Math.min(100, +t||0)); return 1.6 - (t/100)*1.2; };

    // Helper: rows currently displayed (respect intraday pre/post chip)
    function getDisplayRows(){
      const rows = state.rows||[];
      const includeAH = q('.chip[data-k="SESS"]')?.classList.contains('active');
      return (isIntraday(state.interval) && !includeAH) ? rows.filter(r=>isRegularSessionET(r.t)) : rows;
    }

    // CSV symbols for autocomplete (robust with fallbacks + retry)
    async function loadSymbols(force){
      if(state.symbols.length && !force) return state.symbols;
      state.symbolsTried++;
      // Prefer absolute path first when served from /public
      const paths = ['/stock_data.csv','stock_data.csv','/public/stock_data.csv'];
      let text = '';
      for(const p of paths){
        try{ const r = await fetch(p,{cache:'no-store'}); if(r.ok){ text = await r.text(); if(text) break; } }catch{/* try next */}
      }
      if(!text){ if(force && state.symbolsTried<4) setTimeout(()=>loadSymbols(true), 800); return state.symbols; }
      try{
        const lines = text.split(/\r?\n/).filter(Boolean);
        const out = []; let start=0; if(/^[\s]*symbol\s*(\||,)/i.test(lines[0]||'')) start=1;
        for(let i=start;i<lines.length;i++){
          const line = lines[i]; const d = line.includes('|') ? '|' : ','; const parts=line.split(d);
          const sym=(parts[0]||'').trim().toUpperCase(); if(!sym) continue; const name=parts.slice(1).join(' ').replace(/\s*\|\s*/g,' ').trim();
          out.push({ t:sym, n:name });
        }
        // Ensure common cryptos and BBBY are present even if CSV lacks them
        const ensure=(t,n)=>{ if(!out.some(x=>x.t===t)) out.unshift({t,n}); };
        ensure('BTC-USD','Bitcoin (USD)');
        ensure('ETH-USD','Ethereum (USD)');
        ensure('SOL-USD','Solana (USD)');
        ensure('DOGE-USD','Dogecoin (USD)');
        ensure('XRP-USD','XRP (USD)');
        ensure('ADA-USD','Cardano (USD)');
        ensure('LTC-USD','Litecoin (USD)');
        ensure('BCH-USD','Bitcoin Cash (USD)');
        ensure('BNB-USD','Binance Coin (USD)');
        ensure('SHIB-USD','Shiba Inu (USD)');
        ensure('BBBY','Bed Bath & Beyond (delisted)');
        state.symbols = out;
      }catch{ state.symbols=[]; }
      if(els.input && els.input.value) updateAC(els.input.value);
      return state.symbols;
    }

    // Kick off symbols load on startup so search works immediately
    loadSymbols().catch(()=>{});

    /* ---------- Fundamentals (intrinsic value) ---------- */
    async function getFundamentals(ticker){
      if(isCryptoTicker(ticker)) return {};
      const modules='defaultKeyStatistics,financialData,earningsTrend';
      // Try proxy first (works on Vercel and locally)
      try{
        const r=await fetch(`/api/summary?ticker=${encodeURIComponent(ticker)}&modules=${encodeURIComponent(modules)}`,{cache:'no-store'});
        if(r.ok){ const j=await r.json(); const res=j?.quoteSummary?.result?.[0]||{}; const ek=res.defaultKeyStatistics||{}, fd=res.financialData||{}, et=res.earningsTrend||{}; const eps=(ek?.trailingEps?.raw ?? fd?.epsTrailingTwelveMonths?.raw); let growth=null; const trends=Array.isArray(et?.trend)?et.trend:[]; const fiveY=trends.find(t=>(t?.period||'').toLowerCase().includes('5y')); if(fiveY?.growth?.raw!=null) growth=fiveY.growth.raw; else if(fd?.growth?.raw!=null) growth=fd.growth.raw; const ivGraham=(Number.isFinite(eps)&&Number.isFinite(growth)) ? eps*(8.5+2*(growth*100)) : null; return { eps:(Number.isFinite(eps)?+eps:null), growth:(Number.isFinite(growth)?+growth:null), ivGraham };
        }
      }catch{}
      // Fallback direct Yahoo (helpful in local dev)
      try{
        const r=await fetch(`https://query1.finance.yahoo.com/v10/finance/quoteSummary/${encodeURIComponent(ticker)}?modules=${encodeURIComponent(modules)}`,{referrerPolicy:'no-referrer'});
        if(!r.ok) throw 0; const j=await r.json(); const res=j?.quoteSummary?.result?.[0]||{}; const ek=res.defaultKeyStatistics||{}, fd=res.financialData||{}, et=res.earningsTrend||{}; const eps=(ek?.trailingEps?.raw ?? fd?.epsTrailingTwelveMonths?.raw); let growth=null; const trends=Array.isArray(et?.trend)?et.trend:[]; const fiveY=trends.find(t=>(t?.period||'').toLowerCase().includes('5y')); if(fiveY?.growth?.raw!=null) growth=fiveY.growth.raw; else if(fd?.growth?.raw!=null) growth=fd.growth.raw; const ivGraham=(Number.isFinite(eps)&&Number.isFinite(growth)) ? eps*(8.5+2*(growth*100)) : null; return { eps:(Number.isFinite(eps)?+eps:null), growth:(Number.isFinite(growth)?+growth:null), ivGraham };
      }catch{}
      return {};
    }

    /* ---------- Market overview (DOW / NASDAQ / S&P 500) ---------- */
    async function renderMini(symbol, elId, chgId){
      try{
        const rows=await fetchChart(symbol,'6mo','1d');
        const el=q('#'+elId); const chgEl=q('#'+chgId);
        if(!rows?.length || !el) return;
        const x=rows.map(r=>r.t); const c=rows.map(r=>r.c);
        // change from previous close
        let prev=null; for(let i=c.length-2;i>=0;i--){ if(Number.isFinite(c[i])){ prev=c[i]; break; } }
        const last=c.at(-1); const pct=(prev&&Number.isFinite(last))? ((last-prev)/prev)*100 : null;
        if(chgEl){ const col = (pct>0)? css('--c-up') : (pct<0? css('--c-down') : '#94a3b8'); chgEl.style.color=col; chgEl.textContent = Number.isFinite(pct)? (pct>0?'+':'')+fmt(pct)+'%' : '—'; }
        const trace={ type:'scatter', x, y:c, mode:'lines', line:{ color:'#93c5fd', width:1.6 } };
        const layout={ margin:{l:28,r:8,t:2,b:20}, xaxis:{ type:'date', showgrid:false, tickfont:{size:10} }, yaxis:{ showgrid:false, tickfont:{size:10} }, paper_bgcolor:getComputedStyle(els.chartCard).backgroundColor, plot_bgcolor:getComputedStyle(els.chartCard).backgroundColor, height:180 };
        await Plotly.newPlot(el,[trace],layout,{displaylogo:false,staticPlot:true,responsive:true});
      }catch(e){ /* ignore; will stay blank if proxy blocked */ }
    }
    async function renderMarketOverview(){
      await Promise.all([
        renderMini('^DJI','mkt-dji','mkt-dji-chg'),
        renderMini('^IXIC','mkt-ixic','mkt-ixic-chg'),
        renderMini('^GSPC','mkt-gspc','mkt-gspc-chg')
      ]);
    }

    /* ---------- Data & Indicator Utilities (added) ---------- */
    async function waitForPlotly(){ let n=0; while(!(window.Plotly)){ await new Promise(r=>setTimeout(r,50)); if((n+=1)>200) break; } }

    function yahooUrl(ticker, range, interval, includePrePost=true){
      const p = new URL(`https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(normalizeTickerForFetch(ticker))}`);
      p.searchParams.set('range', range||'6mo');
      p.searchParams.set('interval', interval||'1d');
      p.searchParams.set('includePrePost', includePrePost? 'true':'false');
      return p.toString();
    }
    async function parseYahooChartJson(j){
      const res = j?.chart?.result?.[0];
      if(!res?.timestamp || !res?.indicators?.quote?.[0]) return [];
      const ts = res.timestamp.map(t=>t*1000);
      const qd = res.indicators.quote[0];
      const o = qd.open||[], h=qd.high||[], l=qd.low||[], c=qd.close||[], v=qd.volume||[];
      const out=[]; for(let i=0;i<ts.length;i++){ const t=ts[i]; const oo=o[i], hh=h[i], ll=l[i], cc=c[i], vv=v[i]; if(t==null) continue; out.push({ t, o:oo??null, h:hh??null, l:ll??null, c:cc??null, v:vv??null }); }
      return out.filter(r=> Number.isFinite(r.c) && Number.isFinite(r.h) && Number.isFinite(r.l));
    }
    async function fetchChartProxy(ticker, range, interval){
      const url = `/api/chart?ticker=${encodeURIComponent(normalizeTickerForFetch(ticker))}&range=${encodeURIComponent(range||'6mo')}&interval=${encodeURIComponent(interval||'1d')}`;
      const r = await fetch(url,{cache:'no-store'});
      if(!r.ok) throw new Error('proxy failed');
      const j = await r.json();
      return parseYahooChartJson(j);
    }
    async function fetchYahooChart(ticker, range, interval, includePrePost=true){
      const url = yahooUrl(ticker, range, interval, includePrePost);
      const r = await fetch(url,{cache:'no-store', referrerPolicy:'no-referrer'});
      if(!r.ok) throw new Error('fetch failed');
      const j = await r.json();
      return parseYahooChartJson(j);
    }

    async function fetchChart(ticker, range, interval){
      try { return await fetchChartProxy(ticker, range, interval); }
      catch { try { return await fetchYahooChart(ticker, range, interval, true); } catch { return []; } }
    }

    async function fetchFullHistory(ticker, range, interval){
      const t = normalizeTickerForFetch(ticker);
      const incAH = true; // fetch everything; filter later
      let rows=[];
      if(isIntraday(interval)){
        // Use longest allowed range for given intraday interval
        const map={ '1m':'7d', '5m':'60d', '15m':'60d', '60m':'730d' };
        const reqRange = map[interval] || '60d';
        rows = await fetchChart(t, reqRange, interval);
      } else {
        rows = await fetchChart(t, 'max', '1d');
        // Resample for weekly/monthly/quarterly/yearly
        rows = resampleOHLC(rows, interval);
      }
      return rows;
    }

    function getVisibleData(rows, range, interval){
      if(range==='max') return rows;
      const now = Date.now();
      const day=86400000;
      const map={ '1d':1*day, '2d':2*day, '5d':5*day, '10d':10*day, '1mo':30*day, '2mo':60*day, '3mo':90*day, '6mo':182*day, 'ytd':'ytd', '1y':365*day, '2y':2*365*day, '3y':3*365*day, '4y':4*365*day, '5y':5*365*day, '10y':10*365*day };
      let dur = map[range];
      if(dur==='ytd'){
        const d = new Date(); const start = Date.UTC(d.getUTCFullYear(),0,1); return rows.filter(r=> r.t>=start);
      }
      if(!dur) return rows;
      const from = now - dur;
      const out = rows.filter(r=> r.t>=from);
      return out.length? out : rows.slice(-Math.max(50, Math.min(400, rows.length)));
    }

    function SMA(arr, n){ n = Math.max(1, n|0); const out=[]; let s=0, q=[]; for(const v of arr){ const val=Number(v); q.push(val); s+=val; if(q.length>n) s-=q.shift(); out.push(q.length<n? (s/q.length) : (s/n)); } return out; }
    function EMA(arr, n){ n=Math.max(1,n|0); const k=2/(n+1); const out=[]; let ema=null; for(const v of arr){ const val=Number(v); ema = (ema==null)? val : (val*k + ema*(1-k)); out.push(ema); } return out; }
    function RSI(closes, n=14){ const out=[]; let gains=0, losses=0; for(let i=1;i<closes.length;i++){ const ch = closes[i]-closes[i-1]; gains += Math.max(0,ch); losses += Math.max(0,-ch); if(i>=n){ const prev=closes[i-n]; const ch2 = closes[i-n+1]-prev; gains -= Math.max(0,ch2); losses -= Math.max(0,-ch2); } const rs = losses===0? 100 : (gains/(losses||1)); const rsi = 100 - 100/(1+rs); out.push(Math.max(0, Math.min(100, rsi))); }
      // pad to same length
      return [out[0]??50, ...out];
    }
    function MACD(closes, fast=12, slow=26, signal=9){ const emaF=EMA(closes,fast), emaS=EMA(closes,slow); const macd=emaF.map((v,i)=> v-emaS[i]); const sig=EMA(macd, signal); const hist=macd.map((v,i)=> v - sig[i]); return { macd, signal:sig, hist }; }
    function STOCH(high, low, close, kPeriod=14, dPeriod=3){ const k=[]; for(let i=0;i<close.length;i++){ const start=Math.max(0, i-kPeriod+1); const hh = Math.max(...high.slice(start,i+1)); const ll = Math.min(...low.slice(start,i+1)); const val = (hh-ll)===0? 50 : ((close[i]-ll)/(hh-ll))*100; k.push(val); } const d=SMA(k, dPeriod); return { k, d } }

    // Ichimoku indicator
    function rollingMid(high, low, len, i){ const s=Math.max(0,i-len+1); const hh=Math.max(...high.slice(s,i+1)); const ll=Math.min(...low.slice(s,i+1)); return (hh+ll)/2; }
    function ICHIMOKU(high, low, close, conv=9, base=26, spanB=52, disp=26){
      const n = close.length;
      const tenkan = Array(n).fill(null);
      const kijun  = Array(n).fill(null);
      const spanA  = Array(n).fill(null);
      const spanBv = Array(n).fill(null);
      const chikou = Array(n).fill(null);
      for(let i=0;i<n;i++){
        tenkan[i] = rollingMid(high, low, conv, i);
        kijun[i]  = rollingMid(high, low, base, i);
        const sa = (tenkan[i] + kijun[i]) / 2;
        // shift forward by disp: store at i+disp if exists
        if(i+disp < n) spanA[i+disp] = sa; // Senkou Span A
        const sb = rollingMid(high, low, spanB, i);
        if(i+disp < n) spanBv[i+disp] = sb; // Senkou Span B
        if(i-disp >= 0) chikou[i-disp] = close[i]; // Chikou back
      }
      return { tenkan, kijun, spanA, spanB:spanBv, chikou };
    }

    /* ---------- Main fetch/render ---------- */
    async function go(ticker, company){
      await waitForPlotly();
      const range = els.timeSel?.value || '6mo';
      const interval = els.freqSel?.value || '1d';
      state.range = range; state.interval = interval;
      const fullRows = await fetchFullHistory(ticker, range, interval);
      if(!fullRows.length){
        if(els.headline) els.headline.textContent = 'No data';
        if(els.lastLine) els.lastLine.textContent = 'Last: — · Change: —';
        return;
      }
      const vis = getVisibleData(fullRows, range, interval);
      state.rows = vis; // store before filtering for pre/post toggle
      // Apply pre/post toggle for intraday rendering
      const dispRows = getDisplayRows();
      const x = dispRows.map(r=>r.t);
      const open = dispRows.map(r=>r.o), high=dispRows.map(r=>r.h), low=dispRows.map(r=>r.l), close=dispRows.map(r=>r.c), vol=dispRows.map(r=>r.v);

      // Indicators computed on displayed rows
      const rsiVals = RSI(close,14);
      const macd = MACD(close,12,26,9);
      const st = STOCH(high, low, close, 14, 3);
      // Ichimoku values
      const ichi = ICHIMOKU(high, low, close, 9, 26, 52, 26);

      // Fundamentals / Intrinsic (Graham) + SMA blend
      if(!FUNDAMENTALS[ticker]){ try{ FUNDAMENTALS[ticker]=await getFundamentals(ticker); }catch{ FUNDAMENTALS[ticker]={}; } }
      const f = FUNDAMENTALS[ticker]||{};

      // Last/Change & previous close
      const last = close.at(-1);
      const prevClose = ['1m','5m','15m','60m'].includes(interval) ? prevDailyCloseFromIntraday(fullRows) : (close.length>=2? close.at(-2): null);
      const ref = prevClose!=null ? prevClose : (close.length>=2? close.at(-2): null);
      const dayChg = ref!=null ? last-ref : null;
      const dayPct = (ref && ref!==0) ? (dayChg/ref)*100 : null;
           const upClr=css('--c-up'), dnClr=css('--c-down');
      const chgClr = (dayChg>0)?upClr:(dayChg<0?dnClr:'#cbd5e1');
      const signChg = dayChg>0?'+':dayChg<0?'-':'';
      const signPct = dayPct>0?'+':dayPct<0?'-':'';
      if(els.headline) els.headline.textContent = company ? `${ticker} — ${company}` : ticker;
      if(els.companyLine) els.companyLine.textContent = company||'';
      if(els.lastLine) els.lastLine.innerHTML = `Last: <b>${fmtPx(last)}</b> · ` + (dayChg==null? 'Change: —' : `<span style="font-weight:800;color:${chgClr}">Change: ${signChg}${fmtPx(Math.abs(dayChg))} <span style=\"opacity:.85\">(${signPct}${fmt(Math.abs(dayPct))}%)</span></span>`);
      if(els.prevCloseLine) els.prevCloseLine.textContent = `Yesterday’s Close: ${prevClose==null? '—' : fmtPx(prevClose)}`;
      // Intrinsic display
      try{
        const sAll50=SMA(fullRows.map(r=>r.c),50), sAll200=SMA(fullRows.map(r=>r.c),200);
        const s50=sAll50.at(-1), s200=sAll200.at(-1);
        const ivs=[]; if(Number.isFinite(f.ivGraham)) ivs.push(f.ivGraham); if(Number.isFinite(s50)&&Number.isFinite(s200)) ivs.push((s50+s200)/2);
        const iv = ivs.length? (ivs.reduce((a,b)=>a+b,0)/ivs.length) : null;
        if(els.ivLine) els.ivLine.textContent = `Intrinsic Value: ${iv==null? '—' : fmtPx(iv)}`;
      }catch{ if(els.ivLine) els.ivLine.textContent = 'Intrinsic Value: —'; }

      // Chart layout
      const layout={
        margin:{l:56,r:28,t:18,b:26},
        xaxis:{ type:'date', domain:[0,1], showgrid:true, gridcolor:css('--grid') },
        yaxis:{ title:'Price', side:'right', showgrid:true, gridcolor:css('--grid'), domain:[0.42,1] },
        yaxis2:{ domain:[0,0.18], anchor:'x', title:'RSI/Stoch', range:[0,100] },
        yaxis3:{ domain:[0.18,0.28], anchor:'x', title:'Vol' },
        yaxis4:{ domain:[0.28,0.42], anchor:'x', title:'MACD' },
        legend:{orientation:'h'},
        paper_bgcolor:getComputedStyle(els.chartCard).backgroundColor,
        plot_bgcolor:getComputedStyle(els.chartCard).backgroundColor
      };

      // Traces
      const trCandles = { type:'candlestick', x, open, high, low, close, name:ticker, yaxis:'y', increasing:{ line:{ color: css('--c-up') } }, decreasing:{ line:{ color: css('--c-down') } }, showlegend:false };
      const trVol = { type:'bar', x, y:vol, name:'Volume', marker:{ color: css('--c-vol'), opacity:0.45 }, yaxis:'y3', opacity:0.45 };
      const trRSI = { type:'scatter', x, y:rsiVals, mode:'lines', name:'RSI', line:{ color: css('--c-rsi'), width:2 }, yaxis:'y2' };
      const trRSI70 = { type:'scatter', x, y:Array(x.length).fill(70), mode:'lines', name:'RSI 70', line:{ color:'#f59e0b', width:1, dash:'dot' }, yaxis:'y2', showlegend:false, hoverinfo:'skip' };
      const trRSI30 = { type:'scatter', x, y:Array(x.length).fill(30), mode:'lines', name:'RSI 30', line:{ color:'#60a5fa', width:1, dash:'dot' }, yaxis:'y2', showlegend:false, hoverinfo:'skip' };
      const trMACD = { type:'scatter', x, y:macd.macd, mode:'lines', name:'MACD', line:{ color: css('--c-macd'), width:2 }, yaxis:'y4' };
      const trSignal = { type:'scatter', x, y:macd.signal, mode:'lines', name:'Signal', line:{ color:'#f59e0b', width:1.5, dash:'dot' }, yaxis:'y4' };
      const trHist = { type:'bar', x, y:macd.hist, name:'MACD Hist', marker:{ color:'#64748b', opacity:0.5 }, yaxis:'y4', opacity:0.5 };
      // Simple SMAs computed on displayed rows
      const trSMA20={ type:'scatter', x, y:SMA(close,20), mode:'lines', name:'SMA 20', line:{ color: css('--c-sma20'), width:2 }, yaxis:'y' };
      const trSMA50={ type:'scatter', x, y:SMA(close,50), mode:'lines', name:'SMA 50', line:{ color: css('--c-sma50'), width:2 }, yaxis:'y' };
      const trSMA200={ type:'scatter', x, y:SMA(close,200), mode:'lines', name:'SMA 200', line:{ color: css('--c-sma200'), width:2 }, yaxis:'y' };
      // Stoch lines in RSI pane
      const trStochK = { type:'scatter', x, y:st.k, mode:'lines', name:'Stoch %K', line:{ color:'#14b8a6', width:2 }, yaxis:'y2' };
      const trStochD = { type:'scatter', x, y:st.d, mode:'lines', name:'Stoch %D', line:{ color:'#f59e0b', width:1.5, dash:'dot' }, yaxis:'y2' };
      const trStoch80 = { type:'scatter', x, y:Array(x.length).fill(80), mode:'lines', name:'Stoch 80', line:{ color:'#94a3b8', width:1, dash:'dot' }, yaxis:'y2', showlegend:false, hoverinfo:'skip' };
      const trStoch20 = { type:'scatter', x, y:Array(x.length).fill(20), mode:'lines', name:'Stoch 20', line:{ color:'#94a3b8', width:1, dash:'dot' }, yaxis:'y2', showlegend:false, hoverinfo:'skip' };
      // Ichimoku traces on price pane
      const trTenkan = { type:'scatter', x, y:ichi.tenkan, mode:'lines', name:'Tenkan', line:{ color: css('--c-ichi-tenkan'), width:1.6 }, yaxis:'y' };
      const trKijun  = { type:'scatter', x, y:ichi.kijun,  mode:'lines', name:'Kijun',  line:{ color: css('--c-ichi-kijun'),  width:1.6 }, yaxis:'y' };
      const trSpanA  = { type:'scatter', x, y:ichi.spanA,  mode:'lines', name:'Span A', line:{ color: css('--c-ichi-spanA'),  width:1 }, yaxis:'y' };
      const trSpanB  = { type:'scatter', x, y:ichi.spanB,  mode:'lines', name:'Span B', line:{ color: css('--c-ichi-spanB'),  width:1 }, yaxis:'y', fill:'tonexty', fillcolor: css('--c-ichi-up'), opacity:0.4 };
      const trChikou = { type:'scatter', x, y:ichi.chikou, mode:'lines', name:'Chikou', line:{ color: css('--c-ichi-chikou'), width:1 }, yaxis:'y' };

      const traces=[ trCandles, trSMA20, trSMA50, trSMA200, trVol, trRSI, trRSI70, trRSI30, trMACD, trSignal, trHist, trStochK, trStochD, trStoch80, trStoch20, trTenkan, trKijun, trSpanA, trSpanB, trChikou ];
      await Plotly.newPlot(els.chart, traces, layout, { responsive:true, scrollZoom:true, displaylogo:false });
      applyChartTheme();
      // Map chips -> traces
      traceMap = { SMA20:1, SMA50:2, SMA200:3, VOL:4, RSI:[5,6,7], MACD:[8,9,10], STOCH:[11,12,13,14], ICHI:[15,16,17,18,19], AUTOFIB:[] };
      applyVisibilityFromChips();
      // Listen for zoom/pan
      try{ els.chart.removeAllListeners?.('plotly_relayout'); }catch{}
      els.chart.on?.('plotly_relayout', (ev)=>{ state.lastXRange = currentXRange(); const chip=q('.chip[data-k="AUTOFIB"]'); if(chip && chip.classList.contains('active')) addOrUpdateAutoFibTraces(); fitPriceAxisToCandlesStrict(); });
      await fitPriceAxisToCandlesStrict();
      const fibChip=q('.chip[data-k="AUTOFIB"]'); if(fibChip?.classList.contains('active')) addOrUpdateAutoFibTraces();

      // Update sub header (time/freq + timestamp ET)
      try{ const nowET = new Date(new Date().toLocaleString('en-US',{timeZone:'America/New_York'})); if(els.subInfo) els.subInfo.textContent = `${range} • ${interval} • ${nowET.toLocaleString('en-US',{hour:'2-digit',minute:'2-digit'})} ET`; }catch{}
      // Render market mini-cards (once per search)
      renderMarketOverview().catch(()=>{});
    }

    function applyVisibilityFromChips(){ if(!els.chart||!window.Plotly) return; Object.entries(traceMap||{}).forEach(([k,idx])=>{ const chip=els.toggles?.querySelector(`.chip[data-k="${k}"]`); if(!chip) return; const vis = chip.classList.contains('active') ? true : 'legendonly'; const ids = Array.isArray(idx)? idx : [idx]; if(ids.length) { try{ Plotly.restyle(els.chart, { visible:vis }, ids); }catch{} } if(k==='AUTOFIB'){ if(chip.classList.contains('active')) addOrUpdateAutoFibTraces(); else clearAutoFib(); } }); }

    // Chip toggles
    els.toggles?.addEventListener('click', (e)=>{ const chip=e.target.closest('.chip'); if(!chip) return; const k=chip.dataset.k; const now=!chip.classList.contains('active'); chip.classList.toggle('active', now); chip.setAttribute('aria-pressed', now?'true':'false'); if(k==='AUTOFIB'){ if(now) addOrUpdateAutoFibTraces(); else clearAutoFib(); } const idx=traceMap[k]; if(idx!=null){ const ids=Array.isArray(idx)?idx:[idx]; const vis= now? true : 'legendonly'; try{ Plotly.restyle(els.chart,{visible:vis},ids); }catch{} } if(k==='SESS'){ // refit if pre/post changed
        restyleForSession();
      } });

    function restyleForSession(){
      if(!els.chart||!state.rows?.length) return;
      const dispRows = getDisplayRows();
      const x = dispRows.map(r=>r.t);
      const open = dispRows.map(r=>r.o), high=dispRows.map(r=>r.h), low=dispRows.map(r=>r.l), close=dispRows.map(r=>r.c), vol=dispRows.map(r=>r.v);
      const rsiVals = RSI(close,14);
      const macd = MACD(close,12,26,9);
      const st = STOCH(high, low, close, 14, 3);
      const ichi = ICHIMOKU(high, low, close, 9, 26, 52, 26);
      try{
        Plotly.restyle(els.chart, { x:[x], open:[open], high:[high], low:[low], close:[close] }, [0]);
        Plotly.restyle(els.chart, { x:[x], y:[SMA(close,20)] }, [1]);
        Plotly.restyle(els.chart, { x:[x], y:[SMA(close,50)] }, [2]);
        Plotly.restyle(els.chart, { x:[x], y:[SMA(close,200)] }, [3]);
        Plotly.restyle(els.chart, { x:[x], y:[vol] }, [4]);
        Plotly.restyle(els.chart, { x:[x], y:[rsiVals] }, [5]);
        Plotly.restyle(els.chart, { x:[x], y:[Array(x.length).fill(70)] }, [6]);
        Plotly.restyle(els.chart, { x:[x], y:[Array(x.length).fill(30)] }, [7]);
        Plotly.restyle(els.chart, { x:[x], y:[macd.macd] }, [8]);
        Plotly.restyle(els.chart, { x:[x], y:[macd.signal] }, [9]);
        Plotly.restyle(els.chart, { x:[x], y:[macd.hist] }, [10]);
        Plotly.restyle(els.chart, { x:[x], y:[st.k] }, [11]);
        Plotly.restyle(els.chart, { x:[x], y:[st.d] }, [12]);
        Plotly.restyle(els.chart, { x:[x], y:[Array(x.length).fill(80)] }, [13]);
        Plotly.restyle(els.chart, { x:[x], y:[Array(x.length).fill(20)] }, [14]);
        Plotly.restyle(els.chart, { x:[x], y:[ichi.tenkan] }, [15]);
        Plotly.restyle(els.chart, { x:[x], y:[ichi.kijun] }, [16]);
        Plotly.restyle(els.chart, { x:[x], y:[ichi.spanA] }, [17]);
        Plotly.restyle(els.chart, { x:[x], y:[ichi.spanB] }, [18]);
        Plotly.restyle(els.chart, { x:[x], y:[ichi.chikou] }, [19]);
      }catch{}
      fitPriceAxisToCandlesStrict();
      const fibChip=document.querySelector('.chip[data-k="AUTOFIB"]'); if(fibChip?.classList.contains('active')) addOrUpdateAutoFibTraces(); else clearAutoFib();
    }

    // Sync initial chip state from aria-pressed
    (function syncChips(){ const chips=$all('#toggles .chip'); chips.forEach(ch=>{ const p=ch.getAttribute('aria-pressed'); if(p==='true') ch.classList.add('active'); else ch.classList.remove('active'); }); })();

    /* ---------- Events & Handlers ---------- */
    // Global error handler (for async errors)
    window.addEventListener('unhandledrejection', e=>{ console.error('Error:', e.reason); showToast('An error occurred. Please try again.'); });

    /* ---------- Init ---------- */
    // Kick off symbols load on startup so search works immediately
    loadSymbols().catch(()=>{});
    // Also draw the market cards on boot
    renderMarketOverview().catch(()=>{});
  })();
  </script>
</body>
</html>