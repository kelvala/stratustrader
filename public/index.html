<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock Analyzer v.042</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="/assets/stratus-trader-wide.png">

<!-- Plotly (no defer) -->
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

<style>
  :root{
    --bg:#0f1115;--panel:#151923;--text:#e5e7eb;--muted:#9ca3af;
    --accent:#22c55e;--focus:#3b82f6;--border:#23283a;--hover:#161a25;
    --metric-bg:#1a1f2e;--metric-border:#2a2f3e;
    --field-bg:#0c0f16;--field-text:#e5e7eb;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#60a5fa;--c-sma200:#f59e0b; /* back to yellowish 200 SMA */
    --c-rsi:#a78bfa;--c-macd:#38bdf8;--c-vol:#10b981;
    --grid:#283044;
    --lvl-beginner:#22c55e; --lvl-intermediate:#f59e0b; --lvl-advanced:#ef4444;
    --tf-bg:#1c1f35; --tf-head:#1a214e; --tf-glow:#3b82f6;
    --c-ichi-tenkan:#f59e0b; --c-ichi-kijun:#60a5fa; --c-ichi-chikou:#f472b6; /* pinkish chikou like Fidelity */
    --c-ichi-up:rgba(34,197,94,.45);
    --c-ichi-down:rgba(239,68,68,.40);
    --c-ichi-spanA:#22c55e; /* Senkou Span A line */
    --c-ichi-spanB:#ef4444; /* Senkou Span B line */
  }
  .light{
    --bg:#f8fafc;--panel:#fff;--text:#222;--muted:#64748b;
    --accent:#22c55e;--focus:#3b82f3;--border:#e2e8f0;--hover:#f1f5f9;
    --metric-bg:#f1f5f9;--metric-border:#e2e8f0;
    --c-up:#16a34a;--c-down:#dc2626;
    --c-sma20:#22c55e;--c-sma50:#2563eb;--c-sma200:#f59e0b; /* yellowish in light too */
    --c-rsi:#7c3aed;--c-macd:#0ea5e9;--c-vol:#16a34a;
    --grid:#e5e7eb; --tf-bg:#eef2ff; --tf-head:#c7d2fe; --tf-glow:#6366f1;
    --field-bg:#ffffff; --field-text:#111827;
  }
  *{box-sizing:border-box}
  html,body{overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh;padding:20px;transition:background .2s,color .2s}
  .container{max-width:1100px;margin:0 auto}
  .toolbar{position:sticky;top:0;z-index:12000;display:flex;gap:10px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin-bottom:16px;flex-wrap:wrap}
  .ticker-wrap{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
  .ticker-wrap label{font-weight:800;opacity:.9}
  .input-wrap{position:relative;flex:0 1 460px;max-width:460px;width:100%}
  @media (max-width:720px){ .input-wrap{flex:1 1 100%;max-width:100%} }
  .ticker-input{width:100%;min-width:120px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--field-bg);color:var(--field-text);text-transform:uppercase;font-size:16px}
  .btn{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn.inline{padding:8px 12px}
  .toolsbar{display:flex;align-items:center;gap:8px;margin-left:auto;flex:1 1 100%;justify-content:flex-start;flex-wrap:wrap}
  .tool-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:700;cursor:pointer}
  .tool-btn:hover{background:var(--hover)}
  .theme-toggle{margin-left:auto;cursor:pointer;padding:8px 14px;border-radius:8px;background:var(--panel);color:var(--text);border:1px solid var(--border);font-weight:600}
  .theme-toggle:hover{background:var(--hover)}
  .theme-toggle.active{background:var(--accent);color:#fff}
  .ac{position:absolute;left:0;top:calc(100% + 6px);width:100%;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;display:none;max-height:280px;overflow:auto;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:12050}
  .ac.show{display:block}
  /* Give the ticker more room so it doesn't feel cramped */
  .ac-item{padding:12px 14px;display:grid;grid-template-columns:minmax(160px, 240px) 1fr;gap:12px;align-items:center;cursor:pointer;border-bottom:1px solid var(--metric-border)}
  .ac-item:hover,.ac-item.active{background:var(--hover)}
  .ticker{font-weight:800}
  .company{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .info{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;position:relative}
  .info-logo{position:absolute;top:10px;right:12px;height:54px;opacity:.92;pointer-events:none;filter:drop-shadow(0 2px 8px rgba(0,0,0,.35))}
  .light .info-logo{mix-blend-mode:multiply;filter:drop-shadow(0 2px 6px rgba(0,0,0,.12));opacity:.95}
  @media (max-width:640px){ .info-logo{height:42px;right:10px} }
  #chartCard{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative}
  #chart{height:68vh;min-height:520px}
  .container.wide{max-width:100%!important}
  #chartCard.max{position:fixed;inset:12px;z-index:9999;margin:0!important;width:auto!important;height:auto!important;overflow:auto}
  #chartCard.max #chart{height:calc(100vh - 160px)!important;min-height:400px;cursor:zoom-out}
  .tf-card{background:var(--tf-bg);border:1px solid rgba(99,102,241,.25);border-radius:12px;padding:10px;margin-bottom:10px;box-shadow:0 0 0 1px rgba(99,102,241,.15) inset}
  .tf-head{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg, var(--tf-head), transparent);border-radius:8px;padding:6px 10px;margin:-4px -2px 8px;font-weight:800}
  .tf-head .carat{display:inline-block;transform:rotate(-90deg);transition:transform .15s ease}
  .tf-card[data-open="true"] .carat{transform:rotate(0)}
  .tf-body{display:none}
  .tf-card[data-open="true"] .tf-body{display:grid}
  .tf-body{grid-template-columns:1fr 1fr;gap:10px}
  .control label{display:block;font-size:13px;font-weight:800;margin-bottom:6px;color:#cbd5ff}
  .control select{width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px}
  .toggle-row{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 10px}
  .chip{border:1px solid #2b3548;border-radius:999px;padding:6px 12px;cursor:pointer;font-weight:800;opacity:.98;user-select:none;transition:background .15s,color .15s,border-color .15s; -webkit-text-fill-color: currentColor; color: currentColor; background: color-mix(in srgb, var(--panel), #ffffff 3%);} 
  .chip:not(.active){filter: saturate(0.95) brightness(1.02);} 
  /* Chip base colors (fixed typos) */
  .chip[data-k="SMA20"]{border-color:var(--c-sma20);color:var(--c-sma20);} 
  /* fixed var() syntax below */
  .chip[data-k="SMA50"]{border-color:var(--c-sma50);color:var(--c-sma50);} 
  .chip[data-k="SMA200"]{border-color:var(--c-sma200);color:var(--c-sma200);} 
  .chip[data-k="RSI"]{border-color:var(--c-rsi);color:var(--c-rsi);} 
  .chip[data-k="MACD"]{border-color:var(--c-macd);color:var(--c-macd);} 
  .chip[data-k="VOL"]{border-color:var(--c-vol);color:var(--c-vol);} 
  .chip[data-k="AUTOFIB"]{border-color:#8b5cf6;color:#8b5cf6}
  .chip[data-k="ICHI"]{border-color:#60a5fa;color:#60a5fa}
  .chip[data-k="SESS"]{border-color:#93c5fd;color:#93c5fd}

  /* Active backgrounds (kept) */
  .chip.active[data-k="SMA20"]{background:rgba(34,197,94,.12)}
  .chip.active[data-k="SMA50"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SMA200"]{background:rgba(245,158,11,.12)}
  .chip.active[data-k="RSI"]{background:rgba(167,139,250,.12)}
  .chip.active[data-k="MACD"]{background:rgba(56,189,248,.12)}
  .chip.active[data-k="VOL"]{background:rgba(16,185,129,.12)}
  .chip.active[data-k="AUTOFIB"]{background:rgba(139,92,246,.12)}
  .chip.active[data-k="ICHI"]{background:rgba(96,165,250,.12)}
  .chip.active[data-k="SESS"]{background:rgba(147,197,253,.12)}

  /* Bright glow for active chips only (already present; keep it)
     This guarantees inactive chips have NO glow. */
  .chip{position:relative}
  /* Make active chip glow subtle to match button color */
  .chip.active{border-width:2px; box-shadow:0 0 0 1px currentColor;}
  .chip.active::after{display:none}
  .light .chip.active::after{display:none}
  .chip:focus-visible{outline:2px solid currentColor;outline-offset:3px}
  .section-sep{margin:20px -16px 16px;padding:0 16px}
  .section-sep .rule{height:3px;border-radius:999px;background:linear-gradient(90deg,var(--focus),var(--accent));opacity:.9}
  .sheet{position:fixed;left:0;right:0;bottom:0;top:auto;background:transparent;display:flex;justify-content:center;z-index:2000}
  .sheet[hidden]{display:none!important}
  .sheet-inner{width:min(760px,100%);background:var(--panel);border-top:1px solid var(--border);border-radius:16px 16px 0 0;box-shadow:0 -8px 30px rgba(0,0,0,.35);padding:14px;animation:sheetUp .18s ease-out;padding-bottom:max(14px, env(safe-area-inset-bottom))}
  .sheet-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .sheet-title{font-weight:800;font-size:16px}
  .sheet-close{background:transparent;border:0;color:var(--text);font-size:18px;cursor:pointer}
  .sheet-body{max-height:58vh;overflow:auto}
  @keyframes sheetUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
  .btmnav{position:fixed;left:0;right:0;bottom:0;display:none;background:var(--panel);border-top:1px solid var(--border);padding:6px 10px;z-index:1000}
  .btmnav .tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 8px;border-radius:10px;border:0;background:transparent;color:var(--text);font-weight:700;font-size:13px}
  .btmnav .tab.active{background:var(--hover)}
  .btmnav .tab span{font-size:11px;opacity:.85}
  @media (max-width:720px){ .btmnav{display:flex;gap:8px} body{padding-bottom:64px} }
  .scr-list{display:flex;flex-direction:column;gap:10px}
  .scr-item{
    position:relative; display:flex; gap:12px; align-items:flex-start;
    padding:12px 14px; border:1px solid var(--border); border-radius:12px;
    background:color-mix(in hsl, var(--panel), var(--bg) 35%);
    text-decoration:none; color:inherit; cursor:pointer;
    transition:background .15s,border-color .15s,transform .06s;
  }
  .scr-item:hover{ background:var(--hover); border-color:#2b3548; transform:translateY(-1px); }
  .scr-item::before{ content:""; position:absolute; left:0; top:8px; bottom:8px; width:4px; border-radius:999px; background: var(--lvl-color, #64748b); opacity:.8; }
  .scr-item{ padding-left:16px; }
  .scr-item[data-lvl="Beginner"]     { --lvl-color: var(--lvl-beginner); }
  .scr-item[data-lvl="Intermediate"] { --lvl-color: var(--lvl-intermediate); }
  .scr-item[data-lvl="Advanced"]     { --lvl-color: var(--lvl-advanced); }
  .scr-item .title{ font-weight:800; font-size:14px; line-height:1.25; }
  .scr-item .desc{ font-size:12px; color:var(--muted); margin-top:2px; }
  .badge{ font-size:11px; font-weight:800; padding:2px 8px; border-radius:999px; background:var(--metric-bg); border:1px solid var(--metric-border); color:var(--muted); white-space:nowrap; margin-top:2px; }
  .scr-item .open-btn{ margin-left:8px; padding:6px 10px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); text-decoration:none; font-weight:700; }
  .scr-item .open-btn:hover{ background:var(--hover); }

  /* === Button glow (added) === */
  .btn, .tool-btn, .theme-toggle, .btmnav .tab {
    --glow-color: var(--focus);
    position: relative;
    transition: box-shadow .15s, transform .06s, background .15s, border-color .15s;
  }
  .btn { --glow-color: var(--accent); }
  .btn:hover, .btn:focus-visible,
  .tool-btn:hover, .tool-btn:focus-visible,
  .theme-toggle:hover, .theme-toggle:focus-visible,
  .btmnav .tab:hover, .btmnav .tab:focus-visible {
    box-shadow:
      0 0 0 2px var(--glow-color),
      0 0 10px var(--glow-color),
      0 0 24px 6px var(--glow-color),
      0 0 40px 12px var(--glow-color);
    z-index: 1;
  }
  .btn:hover::after, .btn:focus-visible::after,
  .tool-btn:hover::after, .tool-btn:focus-visible::after,
  .theme-toggle:hover::after, .theme-toggle:focus-visible::after,
  .btmnav .tab:hover::after, .btmnav .tab:focus-visible::after {
    content: "";
    position: absolute;
    inset: -10px;
    border-radius: inherit;
    background: radial-gradient(60% 60% at 50% 50%, var(--glow-color) 0%, rgba(0,0,0,0) 80%);
    filter: blur(12px);
    z-index: -1;
    pointer-events: none;
    opacity: 0.7;
  }

  /* Nicer colorization for autocomplete tickers */
  /* Make tickers a distinct color and keep them on one line */
  .ac-item .ticker{ color: var(--accent); font-weight:900; letter-spacing:.3px; white-space:nowrap; }
  .ac-item:hover .ticker, .ac-item.active .ticker{ color: color-mix(in srgb, var(--accent), #ffffff 14%); }
  /* Company name muted so ticker stands out */
  .ac-item .company{ color: var(--muted); font-weight:700; }
  .ac-item:hover .company, .ac-item.active .company{ color: var(--muted); opacity:.95; }

  /* Toast */
  #toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%) translateY(40px);background:var(--panel);color:var(--text);border:1px solid var(--border);padding:10px 14px;border-radius:12px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;z-index:4000;box-shadow:0 6px 24px -2px rgba(0,0,0,.45)}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="ticker-wrap">
        <label for="q">Ticker</label>
        <div class="input-wrap">
          <input id="q" class="ticker-input" type="text" placeholder="AAPL, MSFT… or BTC" spellcheck="false" autocomplete="off"/>
          <div id="ac" class="ac" role="listbox" aria-label="Suggestions"></div>
        </div>
        <button id="searchBtn" class="btn inline" type="button">Search</button>
      </div>
      <div class="toolsbar" id="toolsBar">
        <button class="tool-btn" id="toolGPTs" aria-label="Open GPTs">🧠 <span class="tool-txt">GPTs</span></button>
        <button class="tool-btn" id="toolScreeners" aria-label="Open Screeners">🔎 <span class="tool-txt">Screeners</span></button>
        <button class="tool-btn" id="wideBtn" aria-label="Toggle Width">↔︎ <span class="tool-txt">Wide</span></button>
        <button class="tool-btn" id="maxBtn" aria-label="Maximize">⤢ <span class="tool-txt">Max</span></button>
        <button class="tool-btn" id="refreshBtn" aria-label="Refresh">⟳ <span class="tool-txt">Refresh</span></button>
      </div>
    </div>

    <!-- Info bar -->
    <div id="info" class="info">
      <h3 id="headline" style="margin:0 0 4px 0"></h3>
      <div id="subInfo" style="font-size:12px;opacity:.7;margin:0 0 6px"></div>
      <div style="opacity:.9;font-size:14px;line-height:1.6">
        <div id="companyLine" style="margin:0 0 4px 0;opacity:.95"></div>
        <div id="lastLine">Last: — · Change: —</div>
        <div id="prevCloseLine">Yesterday’s Close: —</div>
        <div id="ivLine">Intrinsic Value: —</div>
        <div id="updateLine" style="font-size:12px;opacity:.6;margin-top:2px">Updated: —</div>
      </div>
      <img id="infoLogo" class="info-logo" src="/assets/stratus-trader-wide.png" alt="Stratus Trader" />
    </div>

    <!-- Chart card -->
    <div id="chartCard">
      <div class="tf-card" id="tfCard" data-open="true">
        <div class="tf-head" id="tfHead"><span class="carat">▾</span> <span style="font-style:italic">time frame</span></div>
        <div class="tf-body">
          <div class="control">
            <label for="timeSel">Time</label>
            <select id="timeSel">
              <option value="1d">1 day</option><option value="2d">2 days</option>
              <option value="5d">5 days</option><option value="10d">10 days</option>
              <option value="sep" disabled>──────────</option>
              <option value="1mo">1 month</option><option value="2mo">2 months</option>
              <option value="3mo">3 months</option><option value="6mo" selected>6 months</option>
              <option value="ytd">YTD</option><option value="1y">1 year</option>
              <option value="2y">2 years</option><option value="3y">3 years</option>
              <option value="4y">4 years</option><option value="5y">5 years</option>
              <option value="10y">1 decade</option><option value="max">All Data</option>
            </select>
          </div>
          <div class="control">
            <label for="freqSel">Frequency</label>
            <select id="freqSel">
              <option value="1m">1-Minute</option><option value="5m">5-Minute</option>
              <option value="15m">15-Minute</option><option value="60m">Hourly</option>
              <option value="sep" disabled>──────────</option>
              <option value="1d" selected>Daily</option><option value="1wk">Weekly</option>
              <option value="1mo">Monthly</option><option value="3mo">Quarterly</option>
              <option value="1y">Yearly</option>
            </select>
          </div>
          <div class="control" style="grid-column:1 / -1">
            <label for="heightSel">Candle height <span id="heightLabel" style="opacity:.7;margin-left:6px">Balanced</span></label>
            <input id="heightSel" type="range" min="0" max="100" value="75" step="1" style="width:100%" />
          </div>
        </div>
      </div>

      <div class="toggle-row" id="toggles">
        <button class="chip" data-k="SMA20" type="button" aria-pressed="false">SMA 20</button>
        <button class="chip" data-k="SMA50" type="button" aria-pressed="false">SMA 50</button>
        <button class="chip" data-k="SMA200" type="button" aria-pressed="false">SMA 200</button>
        <button class="chip" data-k="RSI" type="button" aria-pressed="false">RSI</button>
        <button class="chip" data-k="MACD" type="button" aria-pressed="false">MACD</button>
        <button class="chip" data-k="VOL" type="button" aria-pressed="false">Volume</button>
        <button class="chip" id="autoFib" data-k="AUTOFIB" type="button" aria-pressed="false">Auto Fib</button>
        <button class="chip" data-k="ICHI" type="button" aria-pressed="false">Ichimoku</button>
        <button class="chip" data-k="SESS" type="button" aria-pressed="true" title="Toggle pre/post-market bands">Pre/Post</button>
      </div>

      <div id="chart"></div>
    </div>

    <div class="section-sep" aria-hidden="true"><div class="rule"></div></div>
  </div>

  <!-- GPTs Sheet -->
  <div class="sheet" id="sheetGPTs" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">GPTs</div>
        <button class="sheet-close" data-close="sheetGPTs">✕</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" style="margin-bottom:12px">
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">9 Prompts for Smarter Investing</div>
              <div class="desc">Bundle of prompts to guide smarter investment analysis.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-687b911701a08191aadd69c345a67d17-9-prompts-for-smarter-investing" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">Stock Predictor Prompt GPT</div>
              <div class="desc">Structured prompt flow for scenario-led stock predictions.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-686c5fc3dd948191a0ff9c14cecda1b4-stock-predictor-prompt-gpt" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
          <div class="scr-item" data-lvl="Beginner">
            <div style="flex:1;min-width:0">
              <div class="title">High Yield Dividend Sniper</div>
              <div class="desc">Quickly target high-yield dividend candidates.</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge">GPT</span>
              <a class="open-btn" href="https://chatgpt.com/g/g-6878fe277c5c819180211289d9e16148-high-yield-dividend-sniper" target="_blank" rel="noopener">Open</a>
            </div>
          </div>
        </div>
        <div>
          <textarea id="gptInput" rows="4" placeholder="Ask a question about the current ticker…" style="width:100%;background:var(--field-bg);color:var(--field-text);border:1px solid var(--border);border-radius:10px;padding:10px"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button class="btn" id="askGPT">Ask</button>
            <div style="font-size:12px;color:var(--muted)">Uses the visible chart context when possible.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Screeners Sheet -->
  <div class="sheet" id="sheetScreeners" hidden>
    <div class="sheet-inner">
      <div class="sheet-head">
        <div class="sheet-title">Screeners</div>
        <button class="sheet-close" data-close="sheetScreeners">✕</button>
      </div>
      <div class="sheet-body">
        <div class="scr-list" id="scrList"></div>
      </div>
    </div>
  </div>

  <nav class="btmnav" id="btmNav" role="navigation" aria-label="Bottom Navigation">
    <button data-tab="home" class="tab active" aria-label="Home">🏠<span>Home</span></button>
    <button data-tab="screeners" class="tab" aria-label="Screeners">🔎<span>Screeners</span></button>
    <button data-tab="gpts" class="tab" aria-label="GPTs">🧠<span>GPTs</span></button>
    <button data-tab="settings" class="tab" aria-label="Settings">⚙️<span>Settings</span></button>
  </nav>

  <script>
  (() => {
    const q = s => document.querySelector(s);

    /* ---------- Elements ---------- */
    const els = {
      input:q('#q'), list:q('#ac'), searchBtn:q('#searchBtn'),
      headline:q('#headline'), subInfo:q('#subInfo'), lastLine:q('#lastLine'), prevCloseLine:q('#prevCloseLine'), ivLine:q('#ivLine'), companyLine:q('#companyLine'), updateLine:q('#updateLine'),
      chartCard:q('#chartCard'), chart:q('#chart'),
      timeSel:q('#timeSel'), freqSel:q('#freqSel'), toggles:q('#toggles'),
      themeToggle:q('#themeToggle'), autoFib:q('#autoFib'),
      refreshBtn:q('#refreshBtn'), maxBtn:q('#maxBtn'), wideBtn:q('#wideBtn'),
      tfCard:q('#tfCard'), tfHead:q('#tfHead'),
      btmNav:q('#btmNav'), scrList:q('#scrList')
    };

    /* ---------- Toast ---------- */
    let toast = q('#toast');
    if(!toast){ toast = document.createElement('div'); toast.id='toast'; document.body.appendChild(toast); }
    function showToast(msg, ms=2600){ toast.textContent=msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'), ms); }

    /* ---------- Sheets (GPTs / Screeners) ---------- */
    function openSheet(id){ const el=q('#'+id); if(!el) return; el.hidden=false; el.setAttribute('data-open','true'); document.body.style.overflow='hidden'; if(id==='sheetGPTs' && els.gptInput){ setTimeout(()=>els.gptInput.focus(),50); } }
    function closeSheet(id){ const el=q('#'+id); if(!el) return; el.hidden=true; el.removeAttribute('data-open'); if(![...document.querySelectorAll('.sheet')].some(s=>!s.hidden)) document.body.style.overflow=''; }
    function toggleSheet(id){ const el=q('#'+id); if(!el) return; if(el.hidden) openSheet(id); else closeSheet(id); }

    document.addEventListener('click', e=>{ const btn=e.target.closest('[data-close]'); if(btn){ closeSheet(btn.getAttribute('data-close')); } });
    els.toolGPTs?.addEventListener('click', ()=>{ toggleSheet('sheetGPTs'); });
    // Updated: populate screeners before toggle to guarantee visibility
    els.toolScreeners?.addEventListener('click', ()=>{ try{ ensureScreeners(); }catch{} toggleSheet('sheetScreeners'); });

    // Escape closes top-most sheet
    document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ const open=[...document.querySelectorAll('.sheet')].filter(s=>!s.hidden).pop(); if(open){ closeSheet(open.id); highlightTab('home'); } } });

    /* ---------- Bottom Nav ---------- */
    function highlightTab(tab){ if(!els.btmNav) return; els.btmNav.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===tab)); }
    els.btmNav?.addEventListener('click', e=>{ const tab=e.target.closest('.tab'); if(!tab) return; const k=tab.dataset.tab; if(k==='home'){ closeSheet('sheetGPTs'); closeSheet('sheetScreeners'); highlightTab('home'); } else if(k==='gpts'){ openSheet('sheetGPTs'); highlightTab('gpts'); } else if(k==='screeners'){ openSheet('sheetScreeners'); highlightTab('screeners'); } else if(k==='settings'){ showToast('Settings coming soon'); highlightTab('settings'); } });

    /* ---------- Screeners Populate ---------- */
    const screenerDefs=[
      {id:'oversoldUpcomingEarnings', lvl:'Beginner', title:'Oversold + Earnings (≤5d) + Growth', url:'https://finviz.com/screener.ashx?v=141&f=cap_smallover,earningsdate_nextdays5,fa_epsqoq_o15,fa_epsyoy_pos,fa_epsyoy1_pos,fa_grossmargin_o20,fa_netmargin_pos,fa_sales5years_o5,fa_salesqoq_pos,sh_avgvol_o750,sh_curvol_o1000,ta_perf_52w10o,ta_rsi_nob50&ft=4&o=perfytd', desc:'Near-term earnings, improving growth metrics, recovering from oversold.'},
      {id:'potentialUptrendFromLows', lvl:'Beginner', title:'Potential Uptrend From Weekly Lows', url:'https://finviz.com/screener.ashx?v=141&f=sh_avgvol_o400,ta_pattern_channelup,ta_perf_1wdown&ft=4&o=perf1w', desc:'Channel-up pattern after a weak week.'},
      {id:'bounceAtMovingAverage', lvl:'Beginner', title:'Bounce at Moving Average', url:'https://finviz.com/screener.ashx?v=141&f=sh_avgvol_o400,sh_curvol_o2000,sh_relvol_o1,ta_sma20_pa,ta_sma50_pb&ft=4&o=-perf1w', desc:'Price holding 20 SMA while above / bouncing near 50.'},
      {id:'oversoldReversal', lvl:'Beginner', title:'Oversold Reversal', url:'https://finviz.com/screener.ashx?v=111&f=sh_price_o5,sh_relvol_o2,ta_change_u,ta_rsi_os30&ft=4&o=price', desc:'RSI oversold + early price uptick + volume.'},
      {id:'smaCrossover', lvl:'Beginner', title:'SMA 50 Crosses Below 20 (Pullback Watch)', url:'https://finviz.com/screener.ashx?v=141&f=fa_pe_profitable,sh_avgvol_o400,sh_relvol_o1,sh_short_low,ta_beta_o1,ta_sma50_cross20b&ft=4', desc:'Potential pullback/rotation opportunity.'},
      {id:'undervaluedDividendGrowth', lvl:'Beginner', title:'Undervalued Dividend Growth', url:'https://finviz.com/screener.ashx?v=111&f=cap_largeover,fa_div_pos,fa_epsyoy1_o5,fa_estltgrowth_o5,fa_payoutratio_u50,fa_pe_u20,fa_peg_low&ft=4&o=-pe', desc:'Large caps with sustainable dividend + growth.'},
      {id:'lowPEValue', lvl:'Beginner', title:'Low P/E Value Basket', url:'https://finviz.com/screener.ashx?v=141&f=cap_smallunder,fa_pb_low,fa_pe_low,fa_peg_low,fa_roa_pos,fa_roe_pos,sh_price_o5&ft=4&o=-perfytd', desc:'Low valuation + positive profitability set.'},
      {id:'shortedStocks', lvl:'Intermediate', title:'Heavily Shorted Stocks', url:'https://finviz.com/screener.ashx?v=131&f=cap_smallover,geo_usa,sh_avgvol_o500,sh_curvol_o500,sh_opt_optionshort,sh_price_o3,sh_relvol_o1,sh_short_high&o=-shortinterestshare', desc:'High short interest candidates (possible volatility).'},
      {id:'shortSqueeze', lvl:'Intermediate', title:'Short Squeeze Setup', url:'https://finviz.com/screener.ashx?v=131&f=sh_avgvol_o100,sh_instown_u50,sh_price_o2,sh_short_o15&ft=4&o=-shortinterestshare', desc:'Low institutional ownership & elevated short %.'},
      {id:'newHighs', lvl:'Intermediate', title:'New Highs Momentum', url:'https://finviz.com/screener.ashx?v=141&f=an_recom_buy,sh_price_u7,ta_change_u,ta_highlow20d_nh,ta_highlow50d_nh,ta_highlow52w_nh,ta_perf_dup&ft=4&o=-perf1w', desc:'Multi-timeframe breakout / strength.'},
      {id:'breakingOut', lvl:'Intermediate', title:'Fundamentally Backed Breakouts', url:'https://finviz.com/screener.ashx?v=141&f=fa_debteq_u1,fa_roe_o20,sh_avgvol_o100,ta_highlow50d_nh,ta_sma20_pa,ta_sma200_pa,ta_sma50_pa&ft=4&o=-perf1w', desc:'Quality + technical confirmations.'},
      {id:'highEarningsGrowth', lvl:'Intermediate', title:'High Earnings Growth', url:'https://finviz.com/screener.ashx?v=141&f=fa_epsqoq_o25,fa_epsyoy_o25,fa_epsyoy1_o25,fa_salesqoq_o25,sh_avgvol_o400,ta_rsi_nos50,ta_sma200_pa&ft=4&o=-perfytd', desc:'Strong recent & forward growth + above 200 SMA.'},
      {id:'highSalesGrowth', lvl:'Intermediate', title:'High Sales Growth (Quality)', url:'https://finviz.com/screener.ashx?v=111&f=fa_debteq_u0.5,fa_roe_o15,fa_sales5years_o20,fa_salesqoq_o20,sh_avgvol_o200,sh_instown_o60,sh_price_o5,sh_short_u5&ft=4', desc:'Sustained sales acceleration + quality factors.'},
      {id:'buyAndHoldValue', url:'https://finviz.com/screener.ashx?v=121&f=cap_microover,fa_curratio_o1.5,fa_estltgrowth_o10,fa_peg_o1,fa_roe_o15,ta_beta_o1.5,ta_sma20_pa&ft=4&o=-forwardpe', lvl:'Intermediate', title:'Buy & Hold Value', desc:'Reasonable growth + solid value metrics.'},
      {id:'weeklyEarningsGapUp', lvl:'Advanced', title:'Weekly Earnings Gap Up', url:'https://finviz.com/screener.ashx?v=141&f=earningsdate_tomorrowafter,sh_avgvol_o400,sh_curvol_o50,sh_short_u25,ta_averagetruerange_o0.5,ta_gap_u2&ft=4&o=-perfytd', desc:'Upcoming earnings + recent gap move.'},
      {id:'highRelativeVolume', lvl:'Advanced', title:'High Relative Volume Focus', url:'https://finviz.com/screener.ashx?v=131&f=fa_curratio_o1,fa_epsqoq_o15,fa_quickratio_o1,fa_salesqoq_o15,sh_avgvol_o400,sh_price_o5,sh_relvol_o1.5,ta_sma20_pa,ta_sma200_sb50,ta_sma50_sa200&ft=4&o=instown', desc:'Unusual accumulation + structural positioning.'},
      {id:'consistentGrowthBullishTrend', lvl:'Advanced', title:'Consistent Growth in Bullish Trend', url:'https://finviz.com/screener.ashx?v=141&f=fa_eps5years_pos,fa_epsqoq_o20,fa_epsyoy_o25,fa_epsyoy1_o15,fa_estltgrowth_pos,fa_roe_o15,sh_instown_o10,sh_price_o15,ta_highlow52w_a90h,ta_rsi_nos50&ft=4&o=-perfytd', desc:'High quality compounding + near range highs.'},
      {id:'canslim', lvl:'Advanced', title:'CANSLIM Style Candidates', url:'https://finviz.com/screener.ashx?v=111&f=fa_eps5years_o20,fa_epsqoq_o20,fa_epsyoy_o20,fa_sales5years_o20,fa_salesqoq_o20,sh_curvol_o200&ft=4', desc:'Classic CANSLIM growth criteria snapshot.'}
    ];
    const levelRank={Beginner:0, Intermediate:1, Advanced:2};
    function ensureScreeners(){ if(!els.scrList) return; if(els.scrList.dataset.filled) return; const ordered=[...screenerDefs].sort((a,b)=> levelRank[a.lvl]-levelRank[b.lvl]); els.scrList.innerHTML = ordered.map(s=>`<div class="scr-item" data-lvl="${s.lvl}" data-id="${s.id}">
      <div style=\"flex:1;min-width:0\">
        <div class=\"title\">${s.title}</div>
        <div class=\"desc\">${s.desc}</div>
      </div>
      <div style=\"display:flex;align-items:center;gap:8px\">
        <span class=\"badge\">${s.lvl}</span>
        <a class=\"open-btn\" href=\"${s.url}\" target=\"_blank\" rel=\"noopener\" data-openlink=\"${s.id}\">Open</a>
      </div>
    </div>`).join(''); els.scrList.dataset.filled='1'; }
    document.addEventListener('click', e=>{ const ln=e.target.closest('[data-openlink]'); if(!ln) return; /* keep simple, no toast needed */ });

    /* ---------- Existing code continues below (chart, autocomplete, etc.) ---------- */
    /* ---------- State ---------- */
    let CURRENT = { ticker:null, company:"", prevClose:null };
    const state = { ticker: localStorage.getItem('lastTicker')||'AAPL', range:(q('#timeSel')?.value)||'6mo', interval:(q('#freqSel')?.value)||'1d', rows:[], candleTight:+(localStorage.getItem('candleTight')||75), symbols:[], acMatches:[], acIndex:-1, quoteTimer:null, symbolsTried:0 };
    const FUNDAMENTALS = {}; // cache fundamentals per ticker

    /* ---------- Utils & Formatters ---------- */
    const css = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    const fmt = n => (Number.isFinite(+n)? (+n).toFixed(2): '—');
    const fmtPxPos = v => Number.isFinite(+v)? '$'+(+v).toFixed(2): '—';
    const escapeHTML = s => String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    // ---------- Intrinsic Value models (encapsulated) ----------
    const IV = (()=>{
      function _isNum(x){ return Number.isFinite(+x); }
      function medianLocal(arr){ const a=(arr||[]).map(Number).filter(Number.isFinite).sort((x,y)=>x-y); if(!a.length) return NaN; const m=Math.floor(a.length/2); return a.length%2? a[m] : (a[m-1]+a[m])/2; }
      function emaLocal(arr,len){ let e=null,k=2/(len+1); for(const v of arr){ const n=+v; if(!Number.isFinite(n)) continue; e = e==null? n : e + k*(n-e); } return e; }
      function vwapRows(rows){ let num=0,den=0; for(const r of rows||[]){ const v=+r.v||0; if(!v) continue; const tp=((+r.h||0)+(+r.l||0)+(+r.c||0))/3; if(!Number.isFinite(tp)) continue; num+=tp*v; den+=v; } return den>0? num/den:NaN; }
      function vwma(close,vol,len){ let num=0,den=0,n=close.length,s=Math.max(0,n-len); for(let i=s;i<n;i++){ const c=+close[i], v=+vol[i]||0; if(!_isNum(c)||!v) continue; num+=c*v; den+=v; } return den>0? num/den:NaN; }
      function dcfPerShare({ fcf,g,r,years=5,gt=Math.min(0.03,r-0.01),cash=0,debt=0,shares }){ if(!_isNum(fcf)||!_isNum(g)||!_isNum(r)||!_isNum(shares)||shares<=0) return NaN; const clamp=(x,a,b)=>Math.max(a,Math.min(b,x)); g=clamp(g,-0.02,0.12); r=clamp(r,0.07,0.12); gt=Math.min(0.03,r-0.01); let f=fcf,pvSum=0; for(let i=1;i<=years;i++){ f*=(1+g); pvSum+=f/Math.pow(1+r,i); } const tv=(f*(1+gt))/(r-gt); let equity=pvSum+tv/Math.pow(1+r,years); if(_isNum(cash)) equity+=cash; if(_isNum(debt)) equity-=debt; const per=equity/shares; return _isNum(per)&&per>0? per:NaN; }
      function ddmPerShare({D1,r,g}){ if(!_isNum(D1)||!_isNum(r)||!_isNum(g)||r<=g) return NaN; const p0=D1/(r-g); return p0>0? p0:NaN; }
      function grahamPerShare({eps,g,aaaYield}){ if(!_isNum(eps)||!_isNum(g)||!_isNum(aaaYield)||aaaYield<=0) return NaN; return eps*(8.5+2*g)*4.4/aaaYield; }
      function anchorPerShare(rows){ if(!rows||!rows.length) return NaN; const c=rows.map(r=>+r.c), v=rows.map(r=>+r.v||0); const vwapAll=vwapRows(rows); const vwma50=vwma(c,v,50); const ema50=emaLocal(c,50); const med100=medianLocal(c.slice(-100)); const parts=[]; if(_isNum(vwapAll)) parts.push({w:.50,v:vwapAll}); if(_isNum(vwma50)) parts.push({w:.30,v:vwma50}); if(_isNum(ema50)) parts.push({w:.15,v:ema50}); if(_isNum(med100)) parts.push({w:.05,v:med100}); if(!parts.length) return NaN; const W=parts.reduce((a,p)=>a+p.w,0); return parts.reduce((a,p)=>a+p.v*(p.w/W),0); }
      function intrinsicWeighted(fund={},rows=[],w={}){ const W={DCF:.50,DDM:.20,GRAHAM:.20,ANCHOR:.10,...w}; const vals=[]; const vDCF=dcfPerShare({ fcf:fund.fcf, g:fund.gDCF, r:fund.wacc, years:fund.years??5, gt:fund.gt, cash:fund.cash, debt:fund.debt, shares:fund.shares }); if(_isNum(vDCF)) vals.push({k:'DCF',v:vDCF,w:W.DCF}); const vDDM=ddmPerShare({ D1:fund.dividendNext, r:fund.reqReturn??fund.wacc, g:fund.divGrowth }); if(_isNum(vDDM)) vals.push({k:'DDM',v:vDDM,w:W.DDM}); const vGR=grahamPerShare({ eps:fund.epsTTM, g:(fund.growthEPS??fund.gDCF), aaaYield:fund.aaaYield }); if(_isNum(vGR)) vals.push({k:'GRAHAM',v:vGR,w:W.GRAHAM}); const vAN=anchorPerShare(rows); if(_isNum(vAN)) vals.push({k:'ANCHOR',v:vAN,w:W.ANCHOR}); if(!vals.length) return { perShare:NaN, parts:[] }; const wsum=vals.reduce((a,p)=>a+p.w,0); const perShare=vals.reduce((a,p)=>a+p.v*(p.w/wsum),0); return { perShare, parts:vals.map(p=>({model:p.k,value:p.v,weight:p.w/wsum})) }; }
      return { intrinsicWeighted };
    })();

    function computeAndDisplayIntrinsic(){
      try{
        const f = FUNDAMENTALS[CURRENT.ticker]||{};
        const rowsForIV = state.rows && state.rows.length ? state.rows : [];
        const FUND = {
          fcf: f.freeCashFlow, gDCF: f.growthDCF, wacc: f.wacc ?? 0.09, years:5, gt: Math.min(0.03,(f.wacc??0.09)-0.01), cash:f.totalCash, debt:f.totalDebt, shares:f.sharesOutstanding,
          dividendNext:f.nextDividend, divGrowth:f.dividendGrowth, reqReturn:f.reqReturn ?? (f.wacc ?? 0.09), epsTTM:f.eps, growthEPS:f.growthEPS, aaaYield:f.aaaYield ?? 0.055
        };
        const weights = { DCF:.55, DDM:.15, GRAHAM:.15, ANCHOR:.15 };
        const iv = IV.intrinsicWeighted(FUND, rowsForIV, weights);
        const val = Number.isFinite(iv.perShare)? iv.perShare : NaN;
        els.ivLine.textContent = `Intrinsic Value: ${fmtPxPos(val)}`;
        console.debug('IV breakdown', iv.parts);
      }catch(e){ console.debug('IV compute failed', e); }
    }

    async function refreshQuoteOnce(){
      try{
        const r = await fetch(`/api/quote?ticker=${encodeURIComponent(state.ticker)}`, { cache:'no-store' }); if(!r.ok) throw 0; const j=await r.json();
        const R = j?.quoteSummary?.result?.[0]?.price || j?.quoteResponse?.result?.[0] || {};
        let compName = R.longName || R.shortName || '';
        if(!compName){ const found=(state.symbols||[]).find(s=>s.t===state.ticker); if(found?.n) compName=found.n; }
        const exch = R.exchangeName || R.fullExchangeName || R.exchange || '';
        const currency = R.currency || 'USD';
        const regPrice = +(R.regularMarketPrice?.raw ?? R.regularMarketPrice);
        const prevCloseRaw = +(R.regularMarketPreviousClose?.raw ?? R.regularMarketPreviousClose);
        const postPrice = +(R.postMarketPrice?.raw ?? R.postMarketPrice);
        const prePrice  = +(R.preMarketPrice?.raw ?? R.preMarketPrice);
        const postTime  = +((R.postMarketTime?.raw ?? R.postMarketTime) || 0) * 1000;
        const preTime   = +((R.preMarketTime?.raw ?? R.preMarketTime) || 0) * 1000;
        const regTime   = +((R.regularMarketTime?.raw ?? R.regularMarketTime) || 0) * 1000;
        const rowsAll = state.rows||[];
        const dtfET = new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York'});
        const etKey = (ms)=>{ const d=new Date(dtfET.format(ms)); return d.toDateString(); };
        // derive session hi/lo/vol from latest day if missing
        let dayHigh=+(R.regularMarketDayHigh?.raw ?? R.regularMarketDayHigh);
        let dayLow =+(R.regularMarketDayLow?.raw ?? R.regularMarketDayLow);
        let dayVol =+(R.regularMarketVolume?.raw ?? R.regularMarketVolume);
        if(rowsAll.length && (!Number.isFinite(dayHigh)||!Number.isFinite(dayLow)||!Number.isFinite(dayVol))){
          const lastKey = etKey(rowsAll.at(-1).t); let hi=-Infinity, lo=Infinity, vol=0;
          for(const r of rowsAll){ if(etKey(r.t)!==lastKey) continue; if(Number.isFinite(r.h)) hi=Math.max(hi,r.h); if(Number.isFinite(r.l)) lo=Math.min(lo,r.l); if(Number.isFinite(r.v)) vol+=r.v; }
          if(!Number.isFinite(dayHigh) && hi>-Infinity) dayHigh=hi;
          if(!Number.isFinite(dayLow)  && lo< Infinity) dayLow =lo;
          if(!Number.isFinite(dayVol)  && vol>0) dayVol=vol;
        }
        const triples=[{p:regPrice,t:regTime,s:'REG'},{p:postPrice,t:postTime,s:'POST'},{p:prePrice,t:preTime,s:'PRE'}].filter(x=>Number.isFinite(x.p)&&x.t>0).sort((a,b)=>b.t-a.t);
        const best=triples[0]||{p:regPrice,t:regTime,s:'REG'};
        const price = Number.isFinite(best.p)? best.p : (state.rows?.at(-1)?.c ?? NaN);
        let prevClose = Number.isFinite(prevCloseRaw)? prevCloseRaw : (state.rows?.at(-2)?.c ?? NaN);
        const chg=(Number.isFinite(price)&&Number.isFinite(prevClose))? price-prevClose:NaN;
        const pct=(Number.isFinite(chg)&&Number.isFinite(prevClose)&&prevClose!==0)? (chg/prevClose*100):NaN;
        const sessLabel = best.s==='PRE'?'Pre‑Market': best.s==='POST'?'After‑Hours':'Regular';
        els.headline.textContent = compName? `${state.ticker} — ${compName}` : state.ticker;
        if(els.subInfo) els.subInfo.textContent=[exch,currency,`${state.range} · ${state.interval}`,`Session: ${sessLabel}`].filter(Boolean).join(' • ');
        const col = chg>0? css('--c-up') : chg<0? css('--c-down') : (css('--muted')||'#999');
        const changeHTML = Number.isFinite(chg)? `<span style="font-weight:800;color:${col}">${chg>0?'+':''}$${Math.abs(chg).toFixed(2)} (${chg>0?'+':''}${Math.abs(pct).toFixed(2)}%)</span>`:'—';
        els.lastLine.innerHTML = `Last: $${Number.isFinite(price)? price.toFixed(2):'—'} · Change: ${changeHTML}`;
        els.prevCloseLine.textContent = `Yesterday’s Close: ${Number.isFinite(prevClose)? '$'+prevClose.toFixed(2):'—'}`;
        stampUpdate();
        computeAndDisplayIntrinsic();
      }catch(e){ console.error('Quote refresh error', e); els.lastLine.innerHTML='Last: — · Change: —'; }
    }

    async function getFundamentals(ticker){
      if(/^.+-USD$/.test(ticker)) return {}; // skip crypto fundamentals
      try{
        const mods = 'price,summaryProfile,defaultKeyStatistics,financialData,earningsTrend,summaryDetail';
        const r = await fetch(`https://query1.finance.yahoo.com/v10/finance/quoteSummary/${encodeURIComponent(ticker)}?modules=${encodeURIComponent(mods)}`);
        if(!r.ok) throw new Error('summary '+r.status);
        const j = await r.json();
        const res = j?.quoteSummary?.result?.[0] || {};
        const price=res.price||{}, prof=res.summaryProfile||{}, ek=res.defaultKeyStatistics||{}, fd=res.financialData||{}, et=res.earningsTrend||{}, sd=res.summaryDetail||{};
        // EPS & growth
        const eps = (ek.trailingEps?.raw ?? fd.epsTrailingTwelveMonths?.raw);
        let growthEPS = fd.earningsGrowth?.raw; // EPS growth
        // Use earningsTrend for 5y growth if present
        const trends=Array.isArray(et.trend)?et.trend:[]; const fiveY=trends.find(t=>(t.period||'').toLowerCase().includes('5y'));
        const longTermGrowth = fiveY?.growth?.raw ?? fd.growth?.raw ?? growthEPS;
        // Cashflow & capital structure
        const freeCashFlow = fd.freeCashflow?.raw; const totalCash = fd.totalCash?.raw; const totalDebt = fd.totalDebt?.raw; const sharesOutstanding = ek.sharesOutstanding?.raw ?? price.sharesOutstanding?.raw;
        // Dividends
        const nextDividend = sd.dividendRate?.raw; // approximate next annual dividend
        const dividendGrowth = sd.dividendRate?.raw && sd.trailingAnnualDividendRate?.raw ? null : null; // placeholder if growth data not provided
        // Approx WACC (fallback): use 9% if not provided
        const wacc = 0.09;
        // AAA yield fallback constant
        const aaaYield = 0.055;
        return {
          eps: _num(eps), growth: _num(longTermGrowth), ivGraham: null,
          longName: price.longName || price.shortName || '', sector: prof.sector || '', industry: prof.industry || '', marketCap: price.marketCap?.raw ?? null,
          freeCashFlow:_num(freeCashFlow), totalCash:_num(totalCash), totalDebt:_num(totalDebt), sharesOutstanding:_num(sharesOutstanding),
          nextDividend:_num(nextDividend), dividendGrowth:_num(dividendGrowth), wacc, growthDCF:_num(longTermGrowth), growthEPS:_num(growthEPS), aaaYield,
          fcf:_num(freeCashFlow)
        };
      }catch{ return {}; }
      function _num(v){ return Number.isFinite(+v)? +v : null; }
    }

    async function go(ticker, company){
      CURRENT={...CURRENT,ticker,company};
      els.headline.textContent=`${ticker}${company?' — '+company:''}`;
      els.lastLine.textContent='Loading…'; els.prevCloseLine.textContent=''; els.ivLine.textContent=''; if(els.companyLine) els.companyLine.textContent=''; if(els.updateLine) els.updateLine.textContent='Updated: —';
      try{
        if(!FUNDAMENTALS[ticker]){ try{ FUNDAMENTALS[ticker]=await getFundamentals(ticker); }catch{ FUNDAMENTALS[ticker]={}; } }
        await waitForPlotly();
        const rows = await fetchRows(ticker, state.range, state.interval); state.rows = rows;
        await buildSMAAlignedSeries();
        await renderChart();
        await refreshQuoteOnce();
        computeAndDisplayIntrinsic();
        scheduleQuoteAutoRefresh();
      }catch(e){ console.error('Go error', e); els.lastLine.innerHTML='Last: — · Change: —'; }
    }

    /* ---------- Data fetch ---------- */
    async function fetchRows(ticker, range, interval){
      const T = normalizeTickerForFetch(ticker);
      try{
        const r = await fetch(`/api/chart?ticker=${encodeURIComponent(T)}&range=${encodeURIComponent(range)}&interval=${encodeURIComponent(interval)}`, { cache:'no-store' });
        if(r.ok){ const j=await r.json(); const res=j?.chart?.result?.[0]; if(res){ const ts=res.timestamp||[]; const qd=res.indicators?.quote?.[0]||{}; const rows=[]; for(let i=0;i<ts.length;i++){ const c=qd.close?.[i]; if(!Number.isFinite(c)) continue; rows.push({ t:ts[i]*1000, o:qd.open?.[i], h:qd.high?.[i], l:qd.low?.[i], c:+c, v:qd.volume?.[i]||0 }); } return rows; } }
      }catch{}
      throw new Error('chart fetch failed');
    }

    async function loadAndRender(){
      try{ state.rows = await fetchRows(state.ticker, state.range, state.interval); await buildSMAAlignedSeries(); await renderChart(); refreshQuoteOnce(); }
      catch(e){ console.error('Chart error', e); els.lastLine.innerHTML='Last: — · Change: —'; if(els.rangeLine) els.rangeLine.textContent='Range: — (no data)'; }
    }

    // UI wiring (patched search + AC close)
    els.searchBtn?.addEventListener('click', ()=>{ const raw=els.input.value; const t=sanitizeTicker(raw); if(!t){ els.input.focus(); return; } state.ticker=t; localStorage.setItem('lastTicker', t); hideAC(); loadAndRender(); });
    els.input?.addEventListener('input', (e)=>{ updateAC(e.target.value); });
    els.input?.addEventListener('keydown', (e)=>{ if(!['ArrowDown','ArrowUp','Enter','Escape','Tab'].includes(e.key)) return; if(e.key==='Escape'){ hideAC(); return;} if(!state.acMatches.length){ if(e.key==='Enter'){ els.searchBtn?.click(); } return; } if(e.key==='ArrowDown'){ e.preventDefault(); state.acIndex = (state.acIndex+1)%state.acMatches.length; renderAC(); } else if(e.key==='ArrowUp'){ e.preventDefault(); state.acIndex = (state.acIndex-1+state.acMatches.length)%state.acMatches.length; renderAC(); } else if(e.key==='Enter' || e.key==='Tab'){ const idx= state.acIndex<0?0:state.acIndex; pickAC(idx); if(e.key==='Enter'){ e.preventDefault(); els.searchBtn?.click(); } } });
    els.list?.addEventListener('mousedown', (e)=>{ const it=e.target.closest('.ac-item'); if(!it) return; pickAC(state.acMatches.findIndex(x=>x.t===it.dataset.t)); els.searchBtn?.click(); });
    els.timeSel?.addEventListener('change', ()=>{ state.range=els.timeSel.value; loadAndRender(); });
    els.freqSel?.addEventListener('change', ()=>{ state.interval=els.freqSel.value; loadAndRender(); });
    els.toggles?.addEventListener('click', (e)=>{ const chip=e.target.closest('.chip'); if(!chip) return; chip.classList.toggle('active'); chip.setAttribute('aria-pressed', chip.classList.contains('active')?'true':'false'); renderChart(); });
    els.toggles?.addEventListener('click', (e)=>{ const chip=e.target.closest('.chip'); if(!chip) return; if(chip.dataset.k==='AUTOFIB'){ setTimeout(updateAutoFibDebounced, 0); } });

    (async function boot(){ try{ await loadSymbols(); }catch{}; els.input.value=state.ticker; await loadAndRender(); })();
  })();
  </script>
</body>
</html>