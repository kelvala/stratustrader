name: Breadth scan

# Ensure the job has permission to push a commit to the repository
permissions:
  contents: write

on:
  schedule:
    # Run every 15 minutes during US market hours (ET 9:30–16:00 -> UTC 14:30–21:00) Mon-Fri
    - cron: '30,45 14 * * 1-5'   # 14:30, 14:45 UTC (market open 9:30 ET)
    - cron: '*/15 15-20 * * 1-5' # every 15m between 15:00 and 20:59 UTC
    - cron: '0 21 * * 1-5'      # 21:00 UTC (market close 16:00 ET)
  workflow_dispatch: {}

jobs:
  compute-breadth:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run breadth script
        run: |
          chmod +x scripts/compute-breadth.mjs
          node --experimental-fetch scripts/compute-breadth.mjs

      - name: Commit breadth results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/breadth.json || true
          if ! git diff --cached --quiet; then
            git commit -m "chore(breadth): update breadth.json [skip ci]" || true
            # Attempt to push; if branch protections prevent push, log and continue
            if git push origin HEAD:main; then
              echo "pushed breadth.json"
            else
              echo "push failed - branch may be protected or token lacks permissions; skipping push";
            fi
          else
            echo "no changes"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
